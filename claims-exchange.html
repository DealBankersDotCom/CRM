<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DealBankers • Claims Exchange</title>
  <link rel="icon" href="images/icon (1).jpg">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://www.googleapis.com">
  <style>
    body{margin:0;background:#0f1a22;color:#d8e1e8;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:22px;margin:0}
    .card{background:#122330;border:1px solid #1f3a4a;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:18px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1.4fr 1fr;gap:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #284a5f;background:#17384a;color:#dfe9f0;cursor:pointer}
    .btn.primary{background:#1ea060;border-color:#1ea060}
    .btn.warn{background:#3a2b1a;border-color:#7a5d2a}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#1b3140;border:1px solid #264a5f;color:#9ec7dd;font-size:12px}
    iframe{width:100%;height:420px;border:0;border-radius:10px;background:#0a141b}
    .muted{opacity:.7}
    textarea{width:100%;min-height:90px;border-radius:10px;border:1px solid #284a5f;background:#0f1f29;color:#e8f2f9;padding:10px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Claims Exchange</h1>
    <div>
      <a class="btn" href="profile.html">Back to Portal</a>
      <a class="btn" target="_blank" href="https://docs.google.com/document/d/1wVeXyU4vTndZpSNYjBioJnINzEFvLWFuD6zeZFw4V_g/preview">Privacy & Terms</a>
    </div>
  </header>

  <div id="gate" class="card">
    <div>Checking sign-in…</div>
  </div>

  <div id="list"></div>
</div>

<!-- Firebase core (expects config.js + app-auth.js in root as you already have) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>

<!-- New registry + helper -->
<script src="scripts/claims-links.js"></script>

<script>
(async function(){
  const app = firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db   = firebase.database();

  // Sign-in gate
  auth.onAuthStateChanged(async (user)=>{
    const gate = document.getElementById('gate');
    if(!user){
      gate.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <div class="pill">Secure</div>
            <h3 style="margin:8px 0 4px">Sign in required</h3>
            <div class="muted">Use your portal credentials or the Google button on the main login.</div>
          </div>
          <a class="btn primary" href="index.html">Go to Login</a>
        </div>`;
      return;
    }

    gate.innerHTML = `<div class="pill">Signed in as</div>
      <div style="margin-top:6px">${user.email || user.uid}</div>`;

    // Admin bootstrap: sync registry to RTDB if needed
    try { await syncClaimsRegistryIfAdmin(app, db, auth); } catch(e){ console.warn(e); }

    // Load all meta then filter for this user (by uid or email)
    const metaSnap = await db.ref('claims/meta').get();
    const filesSnap = await db.ref('claims/files').get();
    const meta = metaSnap.exists() ? metaSnap.val() : {};
    const files = filesSnap.exists() ? filesSnap.val() : {};

    // Fallback: if database empty, use in-file registry
    const items = [];
    const registry = Object.keys(meta).length ? Object.keys(meta).map(id => ({
      id, ...meta[id], docs: files[id] || []
    })) : CLAIM_LINKS.map(c => ({...c}));

    for(const c of registry){
      const assigned = c.assignedTo || {};
      const match = (assigned.uid && assigned.uid === user.uid) ||
                    (assigned.email && assigned.email.toLowerCase() === (user.email||'').toLowerCase());
      // Admin sees all; users see their own
      const rolesSnap = await db.ref(`roles/${user.uid}`).get();
      const isAdmin = rolesSnap.exists() && rolesSnap.val()==='admin';
      if (isAdmin || match) items.push(c);
    }

    renderClaims(items, user);
  });

  function renderClaims(items, user){
    const list = document.getElementById('list');
    if(!items.length){
      list.innerHTML = `<div class="card">No claims assigned to this account yet.</div>`;
      return;
    }
    list.innerHTML = '';
    for(const c of items){
      const docsHtml = (c.docs||[]).map(d => `
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <div><strong>${d.name}</strong> <span class="pill">Preview</span></div>
            <a class="btn" target="_blank" href="${d.url}">Open in Google Docs</a>
          </div>
          <iframe src="${d.url}" allow="clipboard-write"></iframe>
        </div>
      `).join('');

      const block = document.createElement('div');
      block.className = 'card';
      block.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <div class="pill">Status: ${c.status || 'draft'}</div>
            <h2 style="margin:8px 0 0">${c.title}</h2>
          </div>
        </div>

        ${docsHtml}

        <div class="row">
          <div class="card">
            <h3 style="margin-top:0">Comment to DealBankers</h3>
            <textarea id="msg-${c.id}" placeholder="Share requested edits, missing facts, or questions…"></textarea>
            <div style="display:flex;gap:10px;margin-top:10px">
              <button class="btn" onclick="sendComment('${c.id}','comment')">Send Comment</button>
              <button class="btn primary" onclick="sendDecision('${c.id}','approve')">Approve (as to form)</button>
              <button class="btn warn" onclick="sendDecision('${c.id}','deny')">Deny / Needs changes</button>
            </div>
            <div class="muted" style="margin-top:8px">
              Approving is <em>as to form only</em> and does not constitute a signature.
              You’ll receive an e-signature packet shortly.
            </div>
          </div>

          <div class="card">
            <h3 style="margin-top:0">Thread</h3>
            <div id="thread-${c.id}" class="muted">Loading…</div>
          </div>
        </div>
      `;
      list.appendChild(block);

      // Live thread
      firebase.database().ref(`claims/comments/${c.id}`).on('value', (snap)=>{
        const box = document.getElementById(`thread-${c.id}`);
        if(!snap.exists()){ box.textContent = "No messages yet."; return; }
        const arr = Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
        box.innerHTML = arr.map(m => `
          <div style="padding:8px 0;border-bottom:1px solid #173242">
            <div><strong>${(m.byName||m.byUid||'User')}</strong> · <span class="muted">${new Date(m.ts).toLocaleString()}</span></div>
            <div>${(m.kind==='decision' ? `<span class="pill">${m.decision}</span> — ` : '')}${escapeHtml(m.text||'')}</div>
          </div>
        `).join('');
      });
    }
  }

  window.sendComment = async function(claimId, kind){
    const user = firebase.auth().currentUser;
    const text = document.getElementById(`msg-${claimId}`).value.trim();
    if(!text) return;
    const payload = {
      kind, text,
      byUid: user.uid,
      byName: user.email || user.uid,
      ts: Date.now()
    };
    await firebase.database().ref(`claims/comments/${claimId}`).push(payload);
    document.getElementById(`msg-${claimId}`).value = "";
  }

  window.sendDecision = async function(claimId, decision){
    const user = firebase.auth().currentUser;
    const msgBox = document.getElementById(`msg-${claimId}`);
    const note = (msgBox.value||'').trim();

    // write a comment entry
    await firebase.database().ref(`claims/comments/${claimId}`).push({
      kind: "decision",
      decision,
      text: note,
      byUid: user.uid,
      byName: user.email || user.uid,
      ts: Date.now()
    });

    // status update is admin-only per rules; we record intent here:
    await firebase.database().ref(`claims/comments/${claimId}`).push({
      kind: "status-request",
      decision: decision === 'approve' ? 'approved-pending-esign' : 'needs-revisions',
      text: "(system) user submitted decision; admin review required",
      byUid: user.uid,
      byName: user.email || user.uid,
      ts: Date.now()
    });

    msgBox.value = "";
    alert("Thanks! Your response has been recorded. An e-signature packet will be sent after admin review.");
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));}
})();
</script>
</body>
</html>
