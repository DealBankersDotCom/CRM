<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Claims Exchange • DealBankers</title>
  <link rel="icon" href="images/icon (1).jpg"/>
  <style>
    :root{ --bg:#0b1218; --panel:#0f1c26; --muted:#b8cbe0; --text:#eef6ff; --line:#1f3a50; --gold:#ffd36b;}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b1218,#0e2231 55%,#0b1218); color:var(--text); font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif; min-height:100vh}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo img{width:40px;height:40px;border-radius:10px}
    .crumb{font-weight:900;letter-spacing:.06em}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:#0e2333;color:#d8ecff;font-weight:800;text-decoration:none}
    .pill.gold{background:linear-gradient(180deg,var(--gold),#c89b3a); color:#231b05; border:none}
    .card{border:1px solid rgba(255,255,255,.14);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.55);padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    iframe.viewer{width:100%;height:70vh;border:0;border-radius:12px;background:#fff}
    .muted{color:var(--muted)}
    .list{display:grid;gap:6px;margin-top:8px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <img src="images/icon (1).jpg" alt="DealBankers"/>
        <div>
          <div class="crumb">DEALBANKERS • CLAIMS EXCHANGE</div>
          <div class="muted" id="who">Loading user…</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <a class="pill" href="profile.html">Portal</a>
        <a class="pill gold" href="claims.html">Start New Claim</a>
        <button id="logout" class="pill">Log Out</button>
      </div>
    </header>

    <section class="card">
      <h2 style="margin:6px 0 8px">Your Claim</h2>
      <div class="meta">
        <span class="pill" id="refTag">Ref: —</span>
        <span class="pill" id="statTag">Status: Reviewing</span>
      </div>
      <p class="muted" id="intro">Verifying access…</p>
      <div id="links" class="list" style="display:none"></div>
    </section>

    <section class="grid" id="docGrid" style="margin-top:12px; display:none">
      <div class="card">
        <div style="font-weight:900;margin:6px 0 8px" id="doc1Title">Primary Document</div>
        <iframe class="viewer" id="doc1" title="Claim Document 1"></iframe>
      </div>
      <div class="card">
        <div style="font-weight:900;margin:6px 0 8px" id="doc2Title">Supporting Document</div>
        <iframe class="viewer" id="doc2" title="Claim Document 2"></iframe>
      </div>
    </section>
  </div>

  <!-- Firebase (Auth) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="config.js"></script>
  <script>
    // ---------- PDF helpers ----------
    const originBase = location.origin;
    const pdf = (file)=> `${originBase}/claims/${encodeURIComponent(file)}`;
    const gview = (url)=>`https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;

    // ---------- Assignment map (email OR uid) ----------
    // Each entry has: matcher (email or uid), reference code, status text, docs[ {title, file} ]
    const CLAIMS = [
      {
        matcher: { email: 'mitzidyane@gmail.com' },
        ref: 'DARLENE-001',
        status: 'Received',
        docs: [
          { title: 'Assignment of Claims Agreement', file: 'Darlene-Assignment of Claims Agreement.pdf' },
          { title: 'Statement of Facts Questionnaire', file: 'Darlene-Statement of Facts Questionnaire.pdf' },
        ],
      },
      {
        matcher: { uid: 'bZtK9f6wAwYab20yawDbXRZdG6c2' }, // Alfred
        ref: 'HONCHO-001',
        status: 'Under Review',
        docs: [
          { title: 'Assignment of Claims Agreement', file: 'Honcho-ASSIGNMENT OF CLAIMS AGREEMENT - Google Docs.pdf' },
          { title: 'Statement of Facts Questionnaire', file: 'Honcho-STATEMENT OF FACTS QUESTIONNAIRE - Google Docs.pdf' },
        ],
      },
      {
        // Madison: no email/uid yet — placeholder slot; will render note below.
        matcher: { email: 'pending@placeholder.invalid' },
        ref: 'MADISON-001',
        status: 'Awaiting Account Activation',
        docs: [
          { title: 'Statement of Facts Questionnaire', file: 'Madison-STATEMENT OF FACTS QUESTIONNAIRE.pdf' },
          { title: 'Marketing / Loan Agreement (reference)', file: 'Marketing_Loan_Agreement_Proposal_(1).pdf' },
        ],
      },
    ];

    function findClaimFor(user){
      const em = (user.email||'').toLowerCase().trim();
      const id = user.uid||'';
      // Prefer exact email match, then uid
      let hit = CLAIMS.find(c => c.matcher.email && c.matcher.email.toLowerCase() === em);
      if(!hit) hit = CLAIMS.find(c => c.matcher.uid && c.matcher.uid === id);
      return hit;
    }

    function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }

    const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(window.firebaseConfig || {});
    const auth = firebase.auth();

    auth.onAuthStateChanged(user=>{
      const who = document.getElementById('who');
      if(!user){ who.textContent = 'Not signed in'; location.replace('index.html'); return; }
      who.textContent = `${user.email || user.uid}`;

      const claim = findClaimFor(user);
      const intro = document.getElementById('intro');
      const grid  = document.getElementById('docGrid');
      const links = document.getElementById('links');

      if(!claim){
        // If the user isn't mapped, show neutral guidance
        intro.innerHTML = 'No claim is linked to this account yet. Use <b>Start New Claim</b> or contact your case handler.';
        setText('refTag','Ref: —');
        setText('statTag','Status: —');
        links.style.display = 'none';
        grid.style.display  = 'none';
        return;
      }

      // If this is the Madison placeholder (not yet created), show friendly notice
      const isPlaceholder = claim.matcher.email === 'pending@placeholder.invalid';
      if(isPlaceholder){
        intro.innerHTML = 'This claim is awaiting the claimant’s account activation. Once Madison is invited and signs in, the documents will appear under her login automatically.';
        setText('refTag', `Ref: ${claim.ref}`);
        setText('statTag', `Status: ${claim.status}`);
        // Provide direct links for internal view (useful if you’re testing)
        links.innerHTML = `
          <div class="row"><span class="pill">Preview Links</span>
            <a class="pill" href="${pdf(claim.docs[0].file)}" target="_blank" rel="noopener">${claim.docs[0].title}</a>
            <a class="pill" href="${pdf(claim.docs[1].file)}" target="_blank" rel="noopener">${claim.docs[1].title}</a>
          </div>`;
        links.style.display = 'grid';
        grid.style.display  = 'none';
        return;
      }

      // Normal: render document viewers
      setText('refTag', `Ref: ${claim.ref}`);
      setText('statTag', `Status: ${claim.status}`);
      intro.textContent = 'Your claim documents are available below.';

      // Titles + iframes
      document.getElementById('doc1Title').textContent = claim.docs[0]?.title || 'Primary Document';
      document.getElementById('doc2Title').textContent = claim.docs[1]?.title || 'Supporting Document';
      document.getElementById('doc1').src = gview(pdf(claim.docs[0].file));
      document.getElementById('doc2').src = gview(pdf(claim.docs[1].file));
      grid.style.display  = 'grid';

      // Quick download links
      links.innerHTML = `
        <div class="row"><span class="pill">Downloads</span>
          <a class="pill" href="${pdf(claim.docs[0].file)}" target="_blank" rel="noopener">${claim.docs[0].title}</a>
          <a class="pill" href="${pdf(claim.docs[1].file)}" target="_blank" rel="noopener">${claim.docs[1].title}</a>
        </div>`;
      links.style.display = 'grid';
    });

    document.getElementById('logout').addEventListener('click', ()=>auth.signOut().then(()=>location.href='index.html'));
  </script>
</body>
</html>
