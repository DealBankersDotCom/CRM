<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DealBankers • Claims Exchange</title>
<link rel="icon" href="images/db-badge-64.png" />
<link rel="stylesheet" href="images/db-theme.css" />
<style>
  body{background:#0f2029;color:#d6e7f5;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:980px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .chip{padding:8px 12px;border-radius:14px;background:#132734;border:1px solid #1e3a4a;color:#cfe9ff;text-decoration:none;font-size:13px}
  .card{background:#0e1b25;border:1px solid #1a3243;border-radius:16px;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  iframe{width:100%;height:420px;border:0;border-radius:12px;background:#0a1620}
  textarea{width:100%;min-height:110px;background:#0a1620;border:1px solid #203748;color:#d7e7f5;border-radius:10px;padding:10px}
  button{background:#1f8a5a;border:0;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
  button.warn{background:#853b3b}
  .note{font-size:13px;opacity:.75}
  @media(max-width:860px){ .grid{grid-template-columns:1fr} iframe{height:360px} }
</style>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="config.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div style="display:flex;align-items:center;gap:10px">
      <img src="images/db-badge-64.png" width="36" height="36" style="border-radius:8px">
      <div>
        <div style="font-weight:700;letter-spacing:.4px">CLAIMS EXCHANGE</div>
        <div class="note">Assign/preview claim documents. Secure sign-in required.</div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <a class="chip" href="profile.html">Back to Portal</a>
      <a class="chip" target="_blank" href="https://docs.google.com/document/d/1wVeXyU4vTndZpSNYjBioJnINzEFvLWFuD6zeZFw4V_g/preview">Privacy & Terms</a>
      <a class="chip" id="logoutBtn" href="#">Log Out</a>
    </div>
  </header>

  <section class="card" id="gate">Checking sign-in…</section>

  <section class="card" id="content" style="display:none">
    <div id="who" class="note" style="margin-bottom:10px"></div>
    <div class="grid">
      <div>
        <div style="font-weight:700;margin-bottom:6px">Assignment of Claims (preview)</div>
        <iframe id="assignFrame" allow="clipboard-write *"></iframe>
      </div>
      <div>
        <div style="font-weight:700;margin-bottom:6px">Statement of Facts (preview)</div>
        <iframe id="factsFrame" allow="clipboard-write *"></iframe>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="note" style="margin-bottom:8px">
        Approving here is an **approval as to form only** and does not constitute a signature.  
        An e-signature packet will be sent to you shortly via DocuSign.
      </div>
      <textarea id="reviewNote" placeholder="Comments back to DealBankers (optional)…"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="approveBtn">Approve as to Form</button>
        <button id="denyBtn" class="warn">Needs Changes</button>
      </div>
      <div id="saveStatus" class="note" style="margin-top:8px"></div>
    </div>
  </section>
</div>

<script src="app-auth.js"></script>
<script>
// Map users -> Google Docs previews
const CLAIM_MAP = {
  // Mitzi (Darlene case)
  "mitzidyane@gmail.com": {
    claimKey: "darlene",
    assign: "https://docs.google.com/document/d/1LG0iYsi1YogCTmdFeFLFKQNIDZI-hzoYOQqJ07UHebQ/preview",
    facts:  "https://docs.google.com/document/d/1O8fgDbWstzJUu045_SGg3cxlZRs1nGwjX_Ksr0IBJCk/preview"
  },
  // Alfred (Honcho case) — by UID
  "uid:bZtK9f6wAwYab20yawDbXRZdG6c2": {
    claimKey: "honcho",
    assign: "https://docs.google.com/document/d/1H-sx230TmpKJx-Mst1_sXAS39MJWwUiQXpx75tzuLro/preview",
    facts:  "https://docs.google.com/document/d/1K72u3Fx4OGN3PbncLd1uwEqZ_olYpJrkUxByrDAs7ME/preview"
  },
  // Madison (placeholder until user/email known)
  "tag:madison": {
    claimKey: "madison",
    assign: "https://docs.google.com/document/d/1npndKHg7ejhqixWddrJ0tlrhDPgcva6d-Dl6oYI6KF0/preview",
    facts:  "https://docs.google.com/document/d/1xhyO7RcQNyfSXb7mNHGoxyDKSaGOY1FVhAJyERc4ggM/preview"
  }
};

(async function () {
  await window.firebaseAppReady;

  document.getElementById('logoutBtn').onclick = async (e) => {
    e.preventDefault();
    await auth.signOut(); location.href = 'index.html';
  };

  const user = await waitForUser();
  const gate = document.getElementById('gate');
  const content = document.getElementById('content');
  const who = document.getElementById('who');

  if (!user) { gate.textContent = "Please sign in."; return; }

  // role check for admin visibility
  let isAdmin = false;
  try {
    const rSnap = await db.ref('roles/'+user.uid).get();
    isAdmin = rSnap.exists() && rSnap.val() === 'admin';
  } catch {}

  // resolve assignment
  let key = CLAIM_MAP["uid:"+user.uid] ? "uid:"+user.uid
          : (CLAIM_MAP[user.email||""] ? (user.email||"")
          : null);

  // Fallback: show Madison preview if user is admin and no direct mapping
  if (!key && isAdmin) key = "tag:madison";

  if (!key) {
    gate.innerHTML = "No claims are currently assigned to your account yet.";
    return;
  }

  const map = CLAIM_MAP[key];
  who.innerHTML = `<b>Signed in:</b> ${user.email || user.uid}${isAdmin ? " · <b>Admin</b>":""} — Claim: <b>${map.claimKey}</b>`;
  document.getElementById('assignFrame').src = map.assign;
  document.getElementById('factsFrame').src  = map.facts;

  gate.style.display = 'none';
  content.style.display = '';

  // Review submit
  const statusEl = document.getElementById('saveStatus');
  async function saveReview(status){
    const note = (document.getElementById('reviewNote').value||"").slice(0,4000);
    const payload = { uid:user.uid, email:user.email||null, status, note, ts: Date.now() };
    await db.ref(`claims/reviews/${map.claimKey}/${user.uid}`).set(payload);
    statusEl.textContent = "Saved. Thank you — our team will follow up with DocuSign shortly.";
  }
  document.getElementById('approveBtn').onclick = ()=>saveReview('approved_as_to_form');
  document.getElementById('denyBtn').onclick    = ()=>saveReview('needs_changes');
})();
</script>
</body>
</html>
