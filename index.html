<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>DealBankers â€” Real Estate Command Hub</title>
Â  <link rel="icon" href="icon (1).jpg" />
Â  <link rel="preconnect" href="https://fonts.googleapis.com" />
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
Â  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet" />
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: #060b11;
Â  Â  Â  --accent: #2b74ff; --accent-glow: #4f8cff;
Â  Â  Â  --text: #eaf2ff; --line: #1e2c3a; --muted: #9db2c7; --chrome: #a8c1ff; --neon: #33aaff;
Â  Â  }
Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; }
Â  Â  body {
Â  Â  Â  font-family: "Orbitron", system-ui, sans-serif;
Â  Â  Â  background: radial-gradient(circle at 30% 10%, #0b1523 0%, #050910 100%);
Â  Â  Â  color: var(--text); overflow-x: hidden;
Â  Â  }
Â  Â  header {
Â  Â  Â  display: flex; justify-content: space-between; align-items: center;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-bottom: 1px solid var(--line);
Â  Â  Â  background: linear-gradient(90deg, #070d16, #0e1b30 80%, #070d16);
Â  Â  Â  box-shadow: 0 0 18px rgba(43,116,255,0.25);
Â  Â  }
Â  Â  .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; color: var(--chrome); }
Â  Â  .brand img { width: 42px; height: 42px; border-radius: 10px; box-shadow: 0 0 10px var(--neon); }
Â  Â  nav { display: flex; gap: 10px; }
Â  Â  nav a {
Â  Â  Â  padding: 6px 14px; border-radius: 8px; background: #162238;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #bcd1ff; transition: .25s; text-decoration: none;
Â  Â  }
Â  Â  nav a:hover { background: var(--accent); color: #fff; box-shadow: 0 0 12px var(--accent-glow); }
Â  Â  .status { font-size: .8rem; color: var(--muted); }
Â  Â  main {
Â  Â  Â  display: grid; grid-template-columns: 1.1fr .9fr; gap: 20px;
Â  Â  Â  max-width: 1200px;
Â  Â  Â  margin: 40px auto; padding: 0 16px;
Â  Â  }
Â  Â  .left-col, .right-col {
Â  Â  Â  background: rgba(15,24,35,.4);
Â  Â  Â  border: 1px solid var(--line); border-radius: 14px;
Â  Â  Â  padding: 24px; box-shadow: inset 0 0 20px rgba(43,116,255,.15);
Â  Â  }
Â  Â  .hero { text-align: center; margin-bottom: 24px; }
Â  Â  .hero h1 { font-size: 2.4rem; margin-bottom: 6px; color: var(--chrome); }
Â  Â  .hero p { color: #b5cbe0; margin-bottom: 20px; }
Â  Â  .gbtn {
Â  Â  Â  display: inline-flex; align-items: center; gap: 10px;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 12px; border: 1px solid #747775;
Â  Â  Â  background: #1f1f1f; color: #e8eaed; font-weight: 700; cursor: pointer;
Â  Â  Â  box-shadow: 0 0 10px rgba(43,116,255,.3);
Â  Â  }
Â  Â  .gbtn:hover { background: #2c2c2c; box-shadow: 0 0 14px var(--accent-glow); }
Â  Â  .gbtn img { width: 20px; height: 20px; }
Â  Â  .tiles {
Â  Â  Â  display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
Â  Â  Â  gap: 16px; margin-top: 10px;
Â  Â  }
Â  Â  .tile {
Â  Â  Â  background: linear-gradient(180deg,#111b27,#0c1219);
Â  Â  Â  border: 1px solid #1d2b3a; border-radius: 16px;
Â  Â  Â  padding: 20px; text-align: center; cursor: pointer; transition: .3s;
Â  Â  }
Â  Â  .tile:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(43,116,255,.4); }
Â  Â  .tile h3 { margin: 6px 0; color: #fff; font-size: 1.1rem; }
Â  Â  .tile p { font-size: .9rem; color: #9db2c7; }

Â  Â  /* Townhall Chat */
Â  Â  .chat-container {
Â  Â  Â  border-radius: 14px;
Â  Â  Â  background: rgba(15,24,35,.7); border: 1px solid #1e2c3a; padding: 16px;
Â  Â  Â  display: flex; flex-direction: column; height: 480px;
Â  Â  Â  box-shadow: inset 0 0 12px rgba(43,116,255,.25);
Â  Â  }
Â  Â  .chat-messages { flex: 1; overflow-y: auto; }
Â  Â  .msg {
Â  Â  Â  margin-bottom: 10px; padding: 10px;
Â  Â  Â  border-radius: 10px; background: rgba(255,255,255,.05);
Â  Â  }
Â  Â  .msg strong { color: var(--neon); }
Â  Â  .msg small { color: #9db2c7; font-size: .7rem; margin-left: 4px; }
Â  Â  .chat-input { display: flex; gap: 10px; margin-top: 10px; }
Â  Â  .chat-input input {
Â  Â  Â  flex: 1; padding: 10px; border-radius: 10px;
Â  Â  Â  border: 1px solid #294861;
Â  Â  Â  background: #0e2332; color: #fff;
Â  Â  }
Â  Â  .chat-input button {
Â  Â  Â  padding: 10px 14px;
Â  Â  Â  border-radius: 10px; border: 1px solid var(--accent);
Â  Â  Â  background: #173764; color: #fff; font-weight: 700; cursor: pointer;
Â  Â  }
Â  Â  .chat-input button:hover {
Â  Â  Â  background: var(--accent); box-shadow: 0 0 10px var(--accent-glow);
Â  Â  }

Â  Â  footer { text-align: center; margin: 40px auto; color: #88a5bf; font-size: .9rem; }
Â  Â  footer span { display: block; margin-top: 4px; color: var(--accent); font-weight: 700; }
Â  </style>
</head>
<body>
<header>
Â  <div class="brand">
Â  Â  <img src="icon (1).jpg" /><span>DealBankers</span>
Â  </div>
Â  <nav>
Â  Â  <a href="#">Home</a>
Â  Â  <a href="profile.html">Tools</a>
Â  Â  <a href="#townhall">Townhall</a>
Â  Â  <a href="claims-exchange.html">ClaimChain</a>
Â  </nav>
Â  <div class="status" id="authStatus">Signed out</div>
</header>

<main>
Â  <div class="left-col">
Â  Â  <div class="hero">
Â  Â  Â  <h1>DealBankers</h1>
Â  Â  Â  <p>Your One-Stop Real Estate Portal</p>
Â  Â  Â  <button id="googleBtn" class="gbtn">
Â  Â  Â  Â  <img src="https://developers.google.com/identity/images/g-logo.png" /> Sign in with Google
Â  Â  Â  </button>
Â  Â  </div>
Â 
Â  Â  <div class="tiles">
Â  Â  Â  <div class="tile"><h3>Wholesalers</h3><p>Upload leads, view in street view, edit inline, skip trace.</p></div>
Â  Â  Â  <div class="tile"><h3>Contractors</h3><p>Tools, jobs, micro-loans, and profile filters.</p></div>
Â  Â  Â  <div class="tile"><h3>Realtors</h3><p>Analyze property data, upload listings, refer deals.</p></div>
Â  Â  Â  <div class="tile"><h3>Investors</h3><p>Capital, returns, networking, market pulse.</p></div>
Â  Â  </div>
    <button id="getHelpBtn" class="gbtn" style="margin-top:20px; width:100%; background:#8b0000; border-color:#ff4500;">ðŸš¨ Get Help Now (Live Support)</button>
Â  </div>

Â  <div class="right-col" id="townhall">
Â  Â  <h2 style="text-align:center;color:var(--chrome);text-shadow:0 0 5px var(--accent)">ðŸ”µ Townhall Chat</h2>
Â  Â  <div class="chat-container">
Â  Â  Â  <div id="messages" class="chat-messages"></div>
Â  Â  Â  <div class="chat-input">
Â  Â  Â  Â  <input id="msgInput" placeholder="Sign in to chat..." disabled />
Â  Â  Â  Â  <button id="sendBtn" disabled>Send</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</main>

<footer>
Â  Â© <span id="year"></span> DealBankers.com
Â  <span>Built for Trust. Driven by Data</span>
Â  <div style="margin-top:10px; font-size: 0.85rem;">
Â  Â  <a href="https://drive.google.com/drive/u/2/folders/1x4xbW0Vbb5FSP0292WC7qwMIyzsTzgop"Â 
Â  Â  Â  Â target="_blank"Â 
Â  Â  Â  Â style="color: var(--muted); text-decoration: underline;">
Â  Â  Â  ðŸ“˜ Family Advocacy Docs (Open Source)
Â  Â  </a>
Â  </div>
</footer>

<script src="config.js"></script>

<script type="module">
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
Â  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
Â  import { getDatabase, ref, push, onChildAdded, serverTimestamp, set, onDisconnect, onValue, get } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

Â  // Init with Global Config
Â  const app = initializeApp(window.firebaseConfig);
Â  const auth = getAuth(app);
Â  const db = getDatabase(app);
Â  const provider = new GoogleAuthProvider();

Â  const year = document.getElementById("year");
Â  year.textContent = new Date().getFullYear();
Â  const msgList = document.getElementById("messages");
Â  const msgInput = document.getElementById("msgInput");
Â  const sendBtn = document.getElementById("sendBtn");
Â  const authStatus = document.getElementById("authStatus");
Â  const googleBtn = document.getElementById("googleBtn");
  const getHelpBtn = document.getElementById("getHelpBtn"); // Initialize the button reference

Â  // --- FIXED FUNCTION (No Syntax Error) ---
Â  function esc(s){Â 
Â  Â  Â  return (''+(s||'')).replace(/[&<>"']/g, function(m) {Â 
Â  Â  Â  Â  Â  return {'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m];Â 
Â  Â  Â  });Â 
Â  }

Â  function attachChat(){
Â  Â  const chatRef = ref(db,"townhall/messages");
Â  Â  onChildAdded(chatRef, snap=>{
Â  Â  Â  const d=snap.val()||{};
Â  Â  Â  const t=new Date(d.ts||Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
Â  Â  Â  const div=document.createElement("div");
Â  Â  Â  div.className="msg";
Â  Â  Â  div.innerHTML=`<strong>${esc(d.name||'Anon')}</strong> <small>${t}</small><div>${esc(d.text||'')}</div>`;
Â  Â  Â  msgList.appendChild(div);
Â  Â  Â  msgList.scrollTop = msgList.scrollHeight;
Â  Â  });
Â  }

Â  sendBtn.onclick = ()=>{
Â  Â  if(!auth.currentUser) return alert("Please sign in first.");
Â  Â  const text = msgInput.value.trim();
Â  Â  if(!text) return;
Â  Â  push(ref(db,"townhall/messages"), {
Â  Â  Â  uid: auth.currentUser.uid,
Â  Â  Â  name: auth.currentUser.displayName || auth.currentUser.email,
Â  Â  Â  text,
Â  Â  Â  ts: serverTimestamp()
Â  Â  });
Â  Â  msgInput.value = "";
Â  };

Â  msgInput.addEventListener("keypress", e => {
Â  Â  if(e.key === "Enter"){ e.preventDefault(); sendBtn.click(); }
Â  });

Â  googleBtn.onclick = async () => {
Â  Â  await setPersistence(auth, browserLocalPersistence);
Â  Â  await signInWithPopup(auth, provider);
    // FIXED: Removed window.location.href = "profile.html"; to keep the user on index.html
Â  };

Â  /* =========================================
Â  Â  Â PRESENCE TRACKING (For God Mode) - FIXED
Â  Â  Â (Now updates both required paths for "Live Radar")
Â  ========================================= */
Â  async function setPresence(user) {
Â  Â  // 1. Check Role first
Â  Â  const roleSnap = await get(ref(db, `roles/${user.uid}`));
Â  Â  const userRole = roleSnap.exists() ? roleSnap.val() : "user";

Â  Â  const presRef = ref(db, `presence/global/${user.uid}`);
Â  Â  const userStatusRef = ref(db, `presence/${user.uid}`); 

Â  Â  const connectedRef = ref(db, ".info/connected");

Â  Â  onValue(connectedRef, (snap) => {
Â  Â  Â  if (snap.val() === true) {
Â  Â  Â  Â  // If we disconnect, go offline
Â  Â  Â  Â  onDisconnect(presRef).set({
Â  Â  Â  Â  Â  Â  state: "offline",
Â  Â  Â  Â  Â  Â  lastOnline: serverTimestamp(),
Â  Â  Â  Â  });
        // FIXED: Set onDisconnect for second path
        onDisconnect(userStatusRef).set({
            state: "offline",
            ts: serverTimestamp()
        });

Â  Â  Â  Â  // We are here! Broadcast online status
Â  Â  Â  Â  set(presRef, {
Â  Â  Â  Â  Â  Â  state: "online",
Â  Â  Â  Â  Â  Â  name: user.displayName || user.email,
Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  role: userRole,
Â  Â  Â  Â  Â  Â  ts: serverTimestamp(),
Â  Â  Â  Â  Â  Â  page: "Townhall"Â 
Â  Â  Â  Â  });
        // FIXED: Set online status for second path
        set(userStatusRef, {
            state: "online",
            ts: serverTimestamp()
        });
Â  Â  Â  }
Â  Â  });
Â  }

Â  onAuthStateChanged(auth, user => {
Â  Â  if(user){
Â  Â  Â  authStatus.innerHTML = `Signed in as ${user.displayName||user.email} <a id='logout' style='color:#2b74ff;cursor:pointer;margin-left:6px;'>Sign out</a>`;
Â  Â  Â  msgInput.disabled = false; sendBtn.disabled = false;
Â  Â  Â Â 
Â  Â  Â  attachChat();
Â  Â  Â  setPresence(user); // TRACKING ON

Â  Â  Â  // FIXED LOGOUT: Explicitly redirect to index.html to clear the stuck state
Â  Â  Â  document.getElementById("logout").onclick = () => { 
            signOut(auth); 
            window.location.href = "index.html"; 
        };
Â  Â  } else {
Â  Â  Â  authStatus.textContent = "Signed out";
Â  Â  Â  msgInput.disabled = true; sendBtn.disabled = true;
Â  Â  Â  attachChat(); // read-only
Â  Â  }
Â  });


/* =========================================
   CHAT INITIATION AND NOTIFICATION TRIGGER
   (Attached to the new 'Get Help Now' button)
========================================= */

function initiateSupportChat() {
Â  Â  const user = auth.currentUser;
Â  Â  if (!user) {
Â  Â  Â  Â  alert("Please sign in to start a chat.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // Prevent double-clicking
Â  Â  getHelpBtn.disabled = true;
Â  Â  getHelpBtn.textContent = "Starting Chat...";

Â  Â  // 1. PUSH to /requests to create the ticket (triggers your email Cloud Function)
Â  Â  const newRequestRef = push(ref(db, 'requests'));
Â  Â  const ticketId = newRequestRef.key;

Â  Â  const requestData = {
Â  Â  Â  Â  uid: user.uid,
Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  message: "User initiated live support chat. (Ticket: " + ticketId + ")",
Â  Â  Â  Â  name: user.displayName || user.email,
Â  Â  Â  Â  status: "new",
Â  Â  Â  Â  ts: serverTimestamp(),
Â  Â  Â  Â  type: "Live Chat Support"
Â  Â  };

Â  Â  set(newRequestRef, requestData)
Â  Â  .then(() => {
Â  Â  Â  Â  // 2. Start the chat in /direct_messages/TICKET_ID
Â  Â  Â  Â  const chatRef = ref(db, 'direct_messages/' + ticketId);
Â  Â  Â  Â Â 
Â  Â  Â  Â  push(chatRef, {
Â  Â  Â  Â  Â  Â  text: "Hello, I need assistance.",
Â  Â  Â  Â  Â  Â  sender: user.uid,
Â  Â  Â  Â  Â  Â  ts: serverTimestamp()
Â  Â  Â  Â  });

Â  Â  Â  Â  alert("Chat initiated! A support ticket has been opened for you.");
Â  Â  Â  Â  
Â  Â  Â  Â  // *** ACTION NEEDED AFTER THIS: REDIRECT TO THE PRIVATE CHAT PAGE ***
        // window.location.href = '/private-chat.html?id=' + ticketId; 

Â  Â  Â  Â  // Restore the button state
Â  Â  Â  Â  getHelpBtn.disabled = false;
Â  Â  Â  Â  getHelpBtn.textContent = "ðŸš¨ Get Help Now (Live Support)";
Â  Â  })
Â  Â  .catch((error) => {
Â  Â  Â  Â  console.error("Failed to start chat process:", error);
Â  Â  Â  Â  getHelpBtn.disabled = false;
Â  Â  Â  Â  getHelpBtn.textContent = "ðŸš¨ Get Help Now (Live Support)";
Â  Â  Â  Â  alert("Error starting chat. Check console.");
Â  Â  });
}

// Attach the function to the new button
getHelpBtn.addEventListener('click', initiateSupportChat);
Â Â 
</script>
</body>
</html>
