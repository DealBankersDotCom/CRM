<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers — Wholesale & Discount Deals (Map)</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<!-- Firebase (compat to match your stack) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>

<!-- Your local config/auth -->
<script src="config.js"></script>
<script src="app-auth.js"></script>

<style>
  :root{ --bg:#0b1218; --panel:#0f1823; --line:#1e2c3a; --text:#eaf2ff; --muted:#9db2c7; --accent:#2b74ff; --chip:#0e2332; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; background:linear-gradient(135deg,#0b1218,#0e1a25 60%,#0b1218); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial}

  .header{position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02))}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:36px;height:36px;border-radius:10px;object-fit:cover}
  .chip{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:999px;border:1px solid #294861;background:var(--chip);
        color:#d7ecff;text-decoration:none;font-weight:700}

  .shell{max-width:1180px;margin:14px auto;padding:0 12px}
  .cols{display:grid;grid-template-columns:1fr 320px;gap:14px}
  @media (max-width:980px){ .cols{grid-template-columns:1fr} }

  .panel{border:1px solid var(--line);border-radius:14px;background:var(--panel)}
  #map{height:420px;border-radius:14px}
  .mapbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;padding:10px}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .legend span{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%;background:#2b74ff}

  .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .card{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
  .thumb{aspect-ratio:4/3;width:100%;object-fit:cover;background:#08111a;cursor:pointer}
  .pad{padding:12px}
  .title{font-weight:800;margin:0 0 4px}
  .meta{color:#b5cbe0;font-size:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#102433;color:#dff1ff;font-weight:700;text-decoration:none;cursor:pointer}
  .btn.primary{background:#0f2945}
  .tag{display:inline-flex;align-items:center;gap:6px;background:#0e2332;border:1px solid #294861;border-radius:8px;padding:4px 8px;font-size:12px;color:#cfe3ff}

  .notice{margin:12px 0;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;color:#cfe3ff;background:#0c1a25;font-size:13px}

  .secure{border:1px solid var(--line);border-radius:16px;background:#0f1a24;padding:14px}
  .gbtn{
    display:flex;align-items:center;justify-content:center;gap:10px;
    height:44px;width:100%;border-radius:12px;border:1px solid #747775;
    background:#1f1f1f;color:#e8eaed;font-weight:700;cursor:pointer
  }
  .gbtn img{width:18px;height:18px}
  .status{color:var(--muted);font-size:12px;margin-top:8px}

  @media (max-width:980px){ .cards{grid-template-columns:1fr 1fr} #map{height:360px} }
  @media (max-width:640px){ .cards{grid-template-columns:1fr} #map{height:320px} }

  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
  .lightbox.open{display:flex}
  .lb-inner{position:relative;max-width:min(1000px,92vw);width:100%;padding:0 44px}
  .lb-img{width:100%;max-height:78vh;object-fit:contain;border-radius:12px;background:#08111a}
  .lb-close,.lb-prev,.lb-next{position:absolute;top:50%;transform:translateY(-50%);
    width:38px;height:38px;border-radius:50%;border:1px solid #2a3a4e;background:#0c1a24;color:#dff1ff;display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer}
  .lb-close{top:8px;right:8px;transform:none}
  .lb-prev{left:4px}
  .lb-next{right:4px}
  .lb-cap{margin-top:8px;text-align:center;color:#b5cbe0;font-size:12px}
</style>
</head>
<body>
<header class="header">
  <div class="brand"><img src="icon (1).jpg" alt=""><b>DealBankers</b></div>
  <a class="chip" href="claims-exchange.html">Claims Exchange</a>
</header>

<div class="shell cols">
  <main>
    <div class="panel">
      <div class="mapbar">
        <div><b>Deals Map</b> — tap a pin to open details ↓</div>
        <div class="legend">
          <span><i class="dot"></i> Featured inventory</span>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div class="notice">
      All properties below are under contract and we are assigning our interest as buyer for an assignment fee, or we own the property.
      Wholesalers &amp; Realtors: we JV—tell us upfront and we’ll work with you. To make an offer call/text <b>512-843-5181</b>.
    </div>

    <div id="cards" class="cards"></div>
  </main>

  <aside class="secure">
    <h3 style="margin:0 0 8px">Secure Access</h3>
    <div class="meta" style="margin-bottom:10px">Sign in to continue to your portal.</div>
    <button id="googleBtn" class="gbtn">
      <img src="https://developers.google.com/identity/images/g-logo.png" alt="">
      Continue with Google
    </button>
    <div class="status">Status: <span data-auth-status>signed out</span></div>
    <div class="status" style="margin-top:10px">If pop-ups are blocked we’ll fall back to redirect sign-in.</div>
  </aside>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Photo viewer">
  <div class="lb-inner">
    <button class="lb-close" onclick="closeGallery()" aria-label="Close">✕</button>
    <button class="lb-prev" onclick="navGallery(-1)" aria-label="Previous">‹</button>
    <img id="lbImg" class="lb-img" alt="" draggable="false" referrerpolicy="no-referrer">
    <button class="lb-next" onclick="navGallery(1)" aria-label="Next">›</button>
    <div id="lbCap" class="lb-cap"></div>
  </div>
</div>

<script>
/* ===== Auth card ===== */
(function(){
  const btn = document.getElementById('googleBtn');
  const statusEl = document.querySelector('[data-auth-status]');
  function setStatus(s){ if(statusEl) statusEl.textContent = s; }

  btn?.addEventListener('click', async ()=>{
    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      await firebase.auth().signInWithPopup(provider);
    }catch(e){
      if(e?.code === 'auth/popup-blocked'){
        const provider = new firebase.auth.GoogleAuthProvider();
        return firebase.auth().signInWithRedirect(provider);
      }
      alert('Sign-in failed. Try again.');
    }
  });

  firebase.auth().onAuthStateChanged(u=> setStatus(u ? 'signed in' : 'signed out'));
})();

/* =======================
   DEALS DATA — ONLY YOUR FEATURED ITEMS
======================= */
const deals = [
  {
    id:"booth", group:"featured",
    title:"Booth St, San Antonio, TX",
    address:"Booth St, San Antonio, TX",
    summary:"3/2 • 1,798 sf • AVM ≈ $347k • Seeking money partners & seller-finance buyers",
    price:null,
    photos:["images/deals/booth-st/20250124_171821.jpg","images/deals/booth-st/20250429_194536.jpg"],
    links:{}
  },
  {
    id:"sanluis", group:"featured",
    title:"San Luis St, San Antonio, TX",
    address:"San Luis St, San Antonio, TX",
    summary:"Lot w/ structure • RM-4 • Wholesale — Ask $65,000",
    price:"$65,000",
    photos:["images/deals/san-luis-st/7.png","images/deals/san-luis-st/12.png"],
    links:{}
  },
  {
    id:"veracruz", group:"featured",
    title:"Vera Cruz St, San Antonio, TX",
    address:"Vera Cruz St, San Antonio, TX",
    summary:"Two properties: one vacant lot + one tear-down house • Infill • City utilities",
    price:null,
    photos:["images/deals/vera-cruz-st/12.png","images/deals/vera-cruz-st/7.png"],
    links:{}
  }
];

/* (kept) URL fixer for safety if any future Drive links get added */
function fixURL(u){
  if(!u) return u;
  try{
    if(u.includes('dropboxusercontent.com') || u.startsWith('images/')) return u;
    const m = u.match(/[?&]id=([^&]+)/);
    if(m && m[1]) return `https://drive.google.com/uc?id=${m[1]}`;
    return u;
  }catch{ return u; }
}
deals.forEach(d=>{ if(Array.isArray(d.photos)) d.photos = d.photos.map(fixURL); });

/* =======================
   MAP + GEOCODING
======================= */
const map = L.map('map',{ center:[29.47,-98.52], zoom:11, scrollWheelZoom:true, preferCanvas:true });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(map);

function colorIcon(color){
  return new L.DivIcon({
    className:'pin',
    html:`<div style="width:20px;height:20px;border-radius:50%;border:2px solid #fff;background:${color};box-shadow:0 2px 8px rgba(0,0,0,.45)"></div>`,
    iconSize:[20,20], iconAnchor:[10,10]
  });
}
const ICONS = { featured: colorIcon('#2b74ff') };

async function geocode(addr){
  const key = 'geo:'+addr.toLowerCase();
  const cached = localStorage.getItem(key);
  if(cached) return JSON.parse(cached);
  await new Promise(r=>setTimeout(r,250));
  const url = 'https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(addr);
  const res = await fetch(url,{headers:{'Accept':'application/json'}});
  const js = await res.json();
  if(js && js[0]){ const out={lat:+js[0].lat,lon:+js[0].lon}; localStorage.setItem(key,JSON.stringify(out)); return out; }
  return null;
}

/* ===== Lightbox ===== */
let lbState = { ids:[], index:0, deal:null };
const lbEl = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const lbCap = document.getElementById('lbCap');

function openGallery(dealId, startIndex=0){
  const d = deals.find(x=>x.id===dealId);
  if(!d || !Array.isArray(d.photos) || d.photos.length===0) return;
  lbState.deal = d; lbState.ids = d.photos; lbState.index = Math.max(0, Math.min(startIndex, d.photos.length-1));
  renderLightbox(); lbEl.classList.add('open');
}
function closeGallery(){ lbEl.classList.remove('open'); }
function navGallery(step){ if(!lbState.ids.length) return; lbState.index = (lbState.index + step + lbState.ids.length) % lbState.ids.length; renderLightbox(); }
function renderLightbox(){
  const url = lbState.ids[lbState.index];
  lbImg.src = fixURL(url);
  lbCap.textContent = `${lbState.deal.title} — ${lbState.index+1} / ${lbState.ids.length}`;
}
document.addEventListener('keydown', e=>{ if(!lbEl.classList.contains('open')) return; if(e.key==='Escape') closeGallery(); if(e.key==='ArrowRight') navGallery(1); if(e.key==='ArrowLeft') navGallery(-1); });
lbEl.addEventListener('click', e=>{ if(e.target===lbEl) closeGallery(); });

/* ===== Rendering ===== */
function thumbHTML(d){
  const img = d.photos?.[0];
  if(img){
    const safe = fixURL(img);
    return `<img class="thumb" src="${safe}" alt="" referrerpolicy="no-referrer" loading="lazy"
             onerror="this.outerHTML='<div class=&quot;thumb&quot; style=&quot;display:flex;align-items:center;justify-content:center;color:#9db2c7;font-size:13px&quot;>Photos coming soon</div>'"
             onclick="openGallery('${d.id}',0)">`;
  }
  return `<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:#9db2c7;font-size:13px">Photos coming soon</div>`;
}

function renderCard(d){
  const el = document.createElement('article');
  el.className = 'card'; el.id = 'deal-'+d.id;
  el.innerHTML = `
    ${thumbHTML(d)}
    <div class="pad">
      <div class="title">${d.title}</div>
      <div class="meta">${d.summary || ''}</div>
      ${d.price? `<div class="row"><span class="tag">Price: ${d.price}</span></div>`:''}
      <div class="row" style="margin-top:10px">
        <a class="btn primary" href="tel:+15128435181">I'm Interested</a>
        ${(d.photos && d.photos.length) ? `<button class="btn" onclick="openGallery('${d.id}',0)">Pictures</button>` : ``}
      </div>
      <div class="meta" style="margin-top:8px">📍 ${d.address}</div>
      <div class="meta">Type: Featured</div>
    </div>`;
  document.getElementById('cards').appendChild(el);
}

function popupHTML(d){
  const img = d.photos?.[0] || '';
  return `
    <div style="min-width:220px;max-width:260px">
      ${img ? `<img src="${fixURL(img)}" referrerpolicy="no-referrer" style="width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:6px;cursor:pointer" onclick="openGallery('${d.id}',0)">` : ''}
      <div style="font-weight:800">${d.title}</div>
      <div style="color:#7fb0ff;font-size:12px;margin:2px 0">${d.summary || ''}</div>
      ${d.price ? `<div style="font-size:12px;margin:4px 0">Price: ${d.price}</div>`:''}
      <div style="display:flex;gap:8px;margin-top:8px">
        <a href="#deal-${d.id}" onclick="document.getElementById('deal-${d.id}').scrollIntoView({behavior:'smooth',block:'start'})"
           style="padding:6px 8px;border:1px solid #2a3a4e;border-radius:8px;background:#102433;color:#dff1ff;text-decoration:none;font-weight:700">View</a>
        <a href="tel:+15128435181" style="padding:6px 8px;border:1px solid #2a3a4e;border-radius:8px;background:#0f2945;color:#dff1ff;text-decoration:none;font-weight:700">Call</a>
      </div>
    </div>`;
}

/* boot */
(async function init(){
  deals.forEach(renderCard);
  const bounds = L.latLngBounds([]);
  for(const d of deals){
    try{
      const g = await geocode(d.address);
      if(!g) continue;
      const m = L.marker([g.lat,g.lon], {icon:ICONS.featured}).addTo(map);
      m.bindPopup(popupHTML(d));
      bounds.extend([g.lat,g.lon]);
    }catch(_){}
  }
  if(bounds.isValid()){ map.fitBounds(bounds.pad(0.15)); }
})();
</script>
</body>
</html>
