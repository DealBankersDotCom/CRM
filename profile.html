<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Dashboard</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet"/>

<style>
/* --- CORE DASHBOARD STYLE --- */
:root {
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;
  --line:#254a63;--text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
body {
  margin:0; font-family:"Orbitron",system-ui;
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  color:var(--text); min-height:100vh;
}
.header{display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04))}
.nav{display:flex;gap:10px;flex-wrap:wrap}
.chip{padding:6px 14px;border-radius:100px;border:1px solid rgba(255,255,255,.2);
  background:#0d1823;color:var(--text);text-decoration:none;cursor:pointer}
.chip.primary{background:#133e6a}
.wrap{max-width:900px;padding:24px;margin:0 auto}
.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.15);
  border-radius:20px;padding:20px;margin-top:20px;box-shadow:0 20px 50px rgba(0,0,0,.5)}
.title{font-size:1.4rem;font-weight:700;margin-bottom:10px}
.portal-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:14px}
.plink{padding:14px;border:1px solid rgba(255,255,255,.15);border-radius:14px;
  text-align:center;text-decoration:none;background:#0e2231;color:var(--text);font-weight:700;cursor:pointer}

/* Floating Chat Bubble */
#chatBubble {
  position:fixed;bottom:24px;right:24px;width:54px;height:54px;
  border-radius:50%;background:#133e6a;color:white;border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  box-shadow:0 0 15px rgba(0,138,255,.6);
  z-index: 200; /* Highest */
  transition: transform 0.2s;
}
#chatBubble:hover { transform: scale(1.1); }

/* --- ADMIN RADAR PANEL --- */
#adminPresencePanel {
  position:fixed; bottom:90px; right:24px;
  background:#0e2231; padding:15px; border-radius:12px;
  border: 1px solid var(--accent);
  box-shadow:0 0 20px rgba(0,0,0,0.6); 
  display:none; /* Hidden by default, toggled by bubble */
  color:white;
  min-width:260px; font-size:14px;
  max-height: 400px; overflow-y: auto;
  z-index: 150;
}
.user-row {
  padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: background 0.2s;
  display:flex; justify-content:space-between; align-items:center;
}
.user-row:hover { background: rgba(43, 116, 255, 0.2); }
.user-row strong { color: #00ff6a; } 

/* --- UNIFIED CHAT WINDOW --- */
#chatModal {
  display:none; position:fixed; bottom:90px; right:300px; /* Positioned to left of radar */
  width:320px; height:400px; background:#142838; 
  border:1px solid var(--accent); border-radius:12px 12px 0 0; 
  z-index:160; box-shadow: 0 0 25px rgba(0,0,0,0.8); 
  flex-direction:column;
}
@media (max-width: 600px) {
    #chatModal { right: 20px; bottom: 90px; width: auto; left: 20px; }
}

#chatHeader {
  padding:10px; background:#0b131b; border-bottom:1px solid #254a63; 
  display:flex; justify-content:space-between; align-items:center; border-radius: 12px 12px 0 0;
}
#chatMessages {
  flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:8px;
  background: rgba(0,0,0,0.2);
}
.chat-msg {
  padding:8px 12px; border-radius:12px; max-width:85%; font-size: 0.9rem; word-wrap: break-word;
}
.msg-me { align-self: flex-end; background: var(--accent); color: white; }
.msg-them { align-self: flex-start; background: #254a63; color: #ccc; }

#chatInputArea {
  padding:10px; border-top:1px solid #254a63; display:flex; background:#0b131b;
}
</style>
</head>

<body>
<header class="header">
  <div>DEALBANKERS ‚Ä¢ Dashboard</div>
  <nav class="nav">
    <a class="chip" href="settings.html">‚öô Settings</a>
    <a class="chip primary" href="#" id="logoutBtn">Log Out</a>
  </nav>
</header>

<div class="wrap">
  <section class="card">
    <div class="title">Welcome.</div>
    <div>Select your workspace:</div>
    <div class="portal-links">
      <a class="plink" href="wholesaler.html">üè† Wholesaler</a>
      <a class="plink" href="contractor.html">üîß Contractor</a>
      <a class="plink" href="realtor.html">üìé Realtor</a>
      <a class="plink" href="investor.html">üíº Investor</a>
    </div>
  </section>
</div>

<div id="chatBubble">üí¨</div>

<div id="adminPresencePanel">
  <div style="margin-bottom:10px; color:#c5d3e1; font-weight:bold; border-bottom:1px solid #333; padding-bottom:5px;">
    üì° Radar (Online)
  </div>
  <div id="onlineUsers">Scanning...</div>
</div>

<div id="chatModal">
  <div id="chatHeader">
    <span id="chatTitle" style="font-weight:bold; color:#fff;">Townhall</span>
    <button id="closeChatBtn" style="background:none; border:none; color:#ff5555; cursor:pointer; font-weight:bold;">‚úï</button>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInputArea">
    <input id="chatInput" type="text" placeholder="Message..." style="flex:1; padding:8px; border-radius:6px; border:none; background:#1e2c3a; color:#fff;">
    <button id="chatSendBtn" style="margin-left:5px; padding:0 12px; background:var(--accent); color:#fff; border:none; border-radius:6px; cursor:pointer;">‚û§</button>
  </div>
</div>

<script src="config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getDatabase, ref, get, set, push, onDisconnect, onValue, onChildAdded, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const app = initializeApp(window.firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let myRole = 'user';
let activeChatPath = null; // Stores current firebase path (Townhall or DM)
let activeChatListener = null;

const pingSound = new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3'); 

/* =========================
   AUTH + INIT
========================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  currentUser = user;

  const roleSnap = await get(ref(db, `roles/${user.uid}`));
  myRole = roleSnap.exists() ? roleSnap.val() : "user";
  
  setPresence(user, myRole);

  // If Admin, start the Radar background scanner
  if (isGod()) {
      startRadarScanner(user.uid);
  }
});

function isGod() { return (myRole === 'god' || myRole === 'admin' || currentUser.email === "dealbankers@gmail.com"); }

/* =========================
   BUTTON LOGIC (THE FIX)
========================= */
document.getElementById("chatBubble").onclick = () => {
    if (isGod()) {
        // ADMIN: Toggle the Radar Panel
        const panel = document.getElementById("adminPresencePanel");
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    } else {
        // USER: Open Townhall Chat directly
        openChat('townhall/messages', 'üîµ Townhall');
    }
};

/* =========================
   GOD MODE: RADAR
========================= */
function startRadarScanner(myUid) {
  if (Notification.permission !== "granted") Notification.requestPermission();

  const presRef = ref(db, "presence/global");
  const knownUsers = new Set(); 

  onValue(presRef, (snap) => {
    const data = snap.val() || {};
    const listDiv = document.getElementById("onlineUsers");
    listDiv.innerHTML = "";
    
    Object.keys(data).forEach((uid) => {
      const u = data[uid];
      if (uid === myUid) return; 
      
      if (u.state === "online") {
        const row = document.createElement("div");
        row.className = "user-row";
        // Show Page they are on if available
        const loc = u.page ? `(${u.page})` : '';
        row.innerHTML = `
            <div><strong>‚óè ${u.name}</strong> <small style='color:#ccc'>${loc}</small></div>
            <div style='font-size:1.2em'>üí¨</div>`;
        
        // CLICK USER -> OPEN PRIVATE CHAT
        row.onclick = () => {
            const chatId = [currentUser.uid, uid].sort().join("_");
            openChat(`direct_messages/${chatId}`, u.name);
        };
        listDiv.appendChild(row);

        // Alert
        if (!knownUsers.has(uid)) {
            knownUsers.add(uid);
            pingSound.play().catch(e => {}); 
            if (Notification.permission === "granted") {
                new Notification("Deal Bankers", { body: `${u.name} is Online`, icon: "icon (1).jpg" });
            }
        }
      } else {
        knownUsers.delete(uid);
      }
    });

    if (listDiv.innerHTML === "") listDiv.innerHTML = "<div style='padding:10px;color:#666'>No users online.</div>";
  });
}

/* =========================
   UNIFIED CHAT SYSTEM
========================= */
window.openChat = function(dbPath, title) {
    const modal = document.getElementById("chatModal");
    const titleEl = document.getElementById("chatTitle");
    const msgContainer = document.getElementById("chatMessages");

    activeChatPath = dbPath;
    titleEl.innerText = title;
    modal.style.display = "flex";
    msgContainer.innerHTML = ""; 

    // Listen to messages
    const chatRef = ref(db, dbPath);
    // Note: In production, detach old listener if switching. For now, we just attach new.
    onChildAdded(chatRef, (snapshot) => {
        renderMessage(snapshot.val());
    });
}

function renderMessage(msg) {
    const div = document.createElement("div");
    // Check sender: if it's me OR if it matches my UID (handle both Townhall & DM formats)
    const isMe = (msg.uid === currentUser.uid || msg.sender === currentUser.uid);
    
    div.className = "chat-msg " + (isMe ? "msg-me" : "msg-them");
    
    // Format: Name: Message
    const name = msg.name ? `<strong>${msg.name}</strong><br>` : '';
    div.innerHTML = `${name}${msg.text}`;
    
    const container = document.getElementById("chatMessages");
    container.appendChild(div);
    container.scrollTop = container.scrollHeight; 
}

// Send Logic
document.getElementById("chatSendBtn").onclick = sendMessage;
document.getElementById("chatInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});

function sendMessage() {
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text || !activeChatPath) return;

    push(ref(db, activeChatPath), {
        sender: currentUser.uid, // For DM
        uid: currentUser.uid,    // For Townhall compatibility
        name: currentUser.displayName || currentUser.email,
        text: text,
        ts: serverTimestamp()
    });
    
    input.value = "";
    input.focus();
}

document.getElementById("closeChatBtn").onclick = () => {
    document.getElementById("chatModal").style.display = "none";
    activeChatPath = null;
};

/* =========================
   PRESENCE & LOGOUT
========================= */
function setPresence(user, userRole) {
  const presRef = ref(db, `presence/global/${user.uid}`);
  const connectedRef = ref(db, ".info/connected");
  onValue(connectedRef, (snap) => {
    if (snap.val() === true) {
        onDisconnect(presRef).set({ state: "offline", lastOnline: serverTimestamp() });
        set(presRef, {
            state: "online",
            name: user.displayName || user.email,
            email: user.email,
            role: userRole,
            ts: serverTimestamp(),
            page: "Dashboard"
        });
    }
  });
}

document.getElementById("logoutBtn").addEventListener("click", async () => {
  try { await signOut(auth); window.location.href = "index.html"; } 
  catch (error) { console.error(error); }
});
</script>

</body>
</html>
