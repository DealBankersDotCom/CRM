<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Dashboard</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet"/>

<style>
/* --- CORE DASHBOARD STYLE --- */
:root {
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;
  --line:#254a63;--text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
body {
  margin:0; font-family:"Orbitron",system-ui;
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  color:var(--text); min-height:100vh;
}
.header{display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04))}
.nav{display:flex;gap:10px;flex-wrap:wrap}
.chip{padding:6px 14px;border-radius:100px;border:1px solid rgba(255,255,255,.2);
  background:#0d1823;color:var(--text);text-decoration:none;cursor:pointer}
.chip.primary{background:#133e6a}
.wrap{max-width:900px;padding:24px;margin:0 auto}
.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.15);
  border-radius:20px;padding:20px;margin-top:20px;box-shadow:0 20px 50px rgba(0,0,0,.5)}
.title{font-size:1.4rem;font-weight:700;margin-bottom:10px}
.portal-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:14px}
.plink{padding:14px;border:1px solid rgba(255,255,255,.15);border-radius:14px;
  text-align:center;text-decoration:none;background:#0e2231;color:var(--text);font-weight:700;cursor:pointer}

/* --- THE FLOATING CHAT BUTTON --- */
#chatBubble {
  position:fixed; bottom:20px; right:20px; width:60px; height:60px;
  border-radius:50%; background:var(--accent); color:white;
  border:2px solid #fff; box-shadow:0 0 20px rgba(43,116,255,0.8);
  display:flex; align-items:center; justify-content:center;
  font-size:30px; cursor:pointer; z-index:999;
  transition: transform 0.2s, box-shadow 0.2s;
  /* Visible for everyone now */
  display: flex; 
}
#chatBubble:hover { transform: scale(1.1); box-shadow:0 0 30px rgba(43,116,255,1); }

/* --- SIDEBAR PANEL --- */
.sidebar-panel {
  position: fixed;
  top: 0; right: -360px; width: 340px; height: 100vh;
  background: rgba(11, 24, 37, 0.95);
  backdrop-filter: blur(12px);
  border-left: 1px solid var(--accent);
  box-shadow: -10px 0 40px rgba(0,0,0,0.8);
  transition: right 0.3s ease-in-out;
  z-index: 998;
  display: flex; flex-direction: column;
}
.sidebar-panel.open { right: 0; }

.panel-header {
  padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--line);
  display: flex; justify-content: space-between; align-items: center;
}
.panel-title { color: #fff; font-size: 1.1rem; text-shadow: 0 0 10px var(--accent); }
.close-btn { background: none; border: none; color: #ff5555; font-size: 1.2rem; cursor: pointer; }

/* Radar List (Admin Only View) */
#radarList { flex: 1; overflow-y: auto; padding: 10px; display: none; }
.radar-user {
  padding: 12px; margin-bottom: 8px; border-radius: 8px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  cursor: pointer; display: flex; justify-content: space-between; align-items: center;
}
.radar-user:hover { background: rgba(43,116,255,0.2); border-color: var(--accent); }
.status-dot { width: 8px; height: 8px; background: #00ff6a; border-radius: 50%; box-shadow: 0 0 8px #00ff6a; }

/* Chat Area (User View & Admin Active View) */
#chatArea { flex: 1; display: none; flex-direction: column; background: rgba(0,0,0,0.2); }
#chatMsgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg-bubble { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; word-wrap: break-word; }
.msg-me { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 2px; }
.msg-them { align-self: flex-start; background: #1e2c3a; color: #ddd; border-bottom-left-radius: 2px; }

.chat-input-row { padding: 15px; border-top: 1px solid var(--line); display: flex; gap: 10px; }
.chat-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #080f16; color: white; }
.send-btn { padding: 0 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; }

/* Back Button (Only for Admin) */
#backToRadar { font-size: 0.8rem; color: var(--muted); cursor: pointer; margin-right: 10px; display: none; }
</style>
</head>

<body>
<header class="header">
  <div>DEALBANKERS ‚Ä¢ Dashboard</div>
  <nav class="nav">
    <a class="chip" href="settings.html">‚öô Settings</a>
    <a class="chip primary" href="#" id="logoutBtn">Log Out</a>
  </nav>
</header>

<div class="wrap">
  <section class="card">
    <div class="title">Welcome.</div>
    <div>Select your workspace:</div>
    <div class="portal-links">
      <a class="plink" href="wholesaler.html">üè† Wholesaler</a>
      <a class="plink" href="contractor.html">üîß Contractor</a>
      <a class="plink" href="realtor.html">üìé Realtor</a>
      <a class="plink" href="investor.html">üíº Investor</a>
    </div>
  </section>
</div>

<div id="chatBubble">üí¨</div>

<div id="sidePanel" class="sidebar-panel">
  
  <div class="panel-header">
    <div style="display:flex; align-items:center;">
        <span id="backToRadar">‚óÄ Back</span>
        <span id="panelTitle" class="panel-title">Support Chat</span>
    </div>
    <button class="close-btn" id="closePanel">‚úï</button>
  </div>

  <div id="radarList">
    <div style="padding:20px; text-align:center; color:#666;">Scanning for users...</div>
  </div>

  <div id="chatArea">
    <div id="chatMsgs"></div>
    <div class="chat-input-row">
        <input id="chatInput" class="chat-input" type="text" placeholder="Type a message...">
        <button id="chatSend" class="send-btn">‚û§</button>
    </div>
  </div>

</div>

<script src="config.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getDatabase, ref, get, set, push, onDisconnect, onValue, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const app = initializeApp(window.firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let currentChatPath = null;
let isAdmin = false;

const pingSound = new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3'); 

/* --- AUTH & ROLE CHECK --- */
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = "index.html"; return; }
  currentUser = user;
  
  // 1. Track Presence (So you show up on radar)
  setPresence(user);

  // 2. Check if God/Admin
  const roleSnap = await get(ref(db, `roles/${user.uid}`));
  const role = roleSnap.exists() ? roleSnap.val() : "user";

  if (role === 'admin' || role === 'god' || user.email === "dealbankers@gmail.com") {
      isAdmin = true;
      startRadar(); // Admin Mode: Start scanning
  } else {
      isAdmin = false;
      initUserMode(); // User Mode: Prepare chat
  }
});

/* --- UI INTERACTIONS --- */
const sidePanel = document.getElementById("sidePanel");
const radarList = document.getElementById("radarList");
const chatArea = document.getElementById("chatArea");
const backBtn = document.getElementById("backToRadar");
const title = document.getElementById("panelTitle");

// Toggle Panel
document.getElementById("chatBubble").onclick = () => {
    sidePanel.classList.toggle("open");
    if(sidePanel.classList.contains("open") && !isAdmin) {
        // If regular user opens panel, ensure chat is ready
        initUserMode();
    }
};
document.getElementById("closePanel").onclick = () => sidePanel.classList.remove("open");

// Back Button (Admin Only)
backBtn.onclick = () => {
    radarList.style.display = "block";
    chatArea.style.display = "none";
    backBtn.style.display = "none";
    title.innerText = "üì° Live Radar";
    currentChatPath = null; // Detach from specific chat
};

/* --- USER MODE LOGIC --- */
function initUserMode() {
    // Regular users don't see radar. They see chat immediately.
    radarList.style.display = "none";
    chatArea.style.display = "flex";
    backBtn.style.display = "none";
    title.innerText = "Support Chat";
    
    // User chats in their own specific channel: direct_messages/{USER_UID}
    // Admin will look at this channel when they click the user on radar.
    currentChatPath = `direct_messages/${currentUser.uid}`;
    loadMessages(currentChatPath);
}

/* --- ADMIN MODE LOGIC (RADAR) --- */
function startRadar() {
    title.innerText = "üì° Live Radar";
    radarList.style.display = "block";
    
    // Listen to GLOBAL presence
    onValue(ref(db, "presence/global"), (snap) => {
        const data = snap.val() || {};
        radarList.innerHTML = "";

        Object.keys(data).forEach(uid => {
            if (uid === currentUser.uid) return; // Don't show self
            const u = data[uid];
            if (u.state === "online") {
                // Render User Card
                const div = document.createElement("div");
                div.className = "radar-user";
                const loc = u.page ? `<br><small style="color:#88a5bf">On: ${u.page}</small>` : "";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:#fff">${u.name}</div>
                        <small style="color:#666">${u.email}</small>
                        ${loc}
                    </div>
                    <div class="status-dot"></div>
                `;
                
                // Admin Click -> Enter Chat with this User
                div.onclick = () => {
                    radarList.style.display = "none";
                    chatArea.style.display = "flex";
                    backBtn.style.display = "inline"; // Show back button
                    title.innerText = u.name;
                    
                    // Admin connects to that User's channel
                    currentChatPath = `direct_messages/${uid}`;
                    loadMessages(currentChatPath);
                };
                radarList.appendChild(div);
            } 
        });

        if (radarList.innerHTML === "") radarList.innerHTML = "<div style='padding:20px;text-align:center;color:#666'>No users online.</div>";
    });
}

/* --- MESSAGING LOGIC --- */
function loadMessages(path) {
    const box = document.getElementById("chatMsgs");
    box.innerHTML = ""; // Clear old
    
    // Listen for new messages
    onChildAdded(ref(db, path), (snap) => {
        const msg = snap.val();
        const div = document.createElement("div");
        const isMe = (msg.sender === currentUser.uid);
        div.className = "msg-bubble " + (isMe ? "msg-me" : "msg-them");
        div.innerText = msg.text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });
}

document.getElementById("chatSend").onclick = sendMsg;
document.getElementById("chatInput").addEventListener("keypress", (e) => { if(e.key==="Enter") sendMsg(); });

function sendMsg() {
    const input = document.getElementById("chatInput");
    const txt = input.value.trim();
    if (!txt || !currentChatPath) return;
    
    push(ref(db, currentChatPath), {
        sender: currentUser.uid,
        text: txt,
        ts: serverTimestamp()
    });
    input.value = "";
}

/* --- PRESENCE TRACKING (FIXED) --- */
function setPresence(user) {
    const globalRef = ref(db, `presence/global/${user.uid}`);
    const statusRef = ref(db, `presence/${user.uid}`); 
    const conRef = ref(db, ".info/connected");

    onValue(conRef, (s) => {
        if (s.val() === true) {
            onDisconnect(globalRef).set({state:"offline", last: serverTimestamp()});
            onDisconnect(statusRef).set({state:"offline", ts: serverTimestamp()});

            set(globalRef, {
                state: "online",
                name: user.displayName || user.email,
                email: user.email,
                ts: serverTimestamp(),
                page: "Dashboard"
            });
            set(statusRef, {state:"online", ts: serverTimestamp()});
        }
    });
}

document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    window.location.href = "index.html";
};
</script>

</body>
</html>
