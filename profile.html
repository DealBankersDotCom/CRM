<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Dashboard</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet"/>

<style>
/* --- CORE DASHBOARD STYLE --- */
:root {
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;
  --line:#254a63;--text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
body {
  margin:0; font-family:"Orbitron",system-ui;
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  color:var(--text); min-height:100vh;
}
.header{display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04))}
.nav{display:flex;gap:10px;flex-wrap:wrap}
.chip{padding:6px 14px;border-radius:100px;border:1px solid rgba(255,255,255,.2);
  background:#0d1823;color:var(--text);text-decoration:none;cursor:pointer}
.chip.primary{background:#133e6a}
.wrap{max-width:900px;padding:24px;margin:0 auto}
.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.15);
  border-radius:20px;padding:20px;margin-top:20px;box-shadow:0 20px 50px rgba(0,0,0,.5)}
.title{font-size:1.4rem;font-weight:700;margin-bottom:10px}
.portal-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:14px}
.plink{padding:14px;border:1px solid rgba(255,255,255,.15);border-radius:14px;
  text-align:center;text-decoration:none;background:#0e2231;color:var(--text);font-weight:700;cursor:pointer}
#chatBubble {
  position:fixed;bottom:24px;right:24px;width:54px;height:54px;
  border-radius:50%;background:#133e6a;color:white;border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  box-shadow:0 0 15px rgba(0,138,255,.6);
}
#adminPresencePanel {
  position:fixed; bottom:100px; right:24px;
  background:#0e2231; padding:14px 18px; border-radius:12px;
  box-shadow:0 0 15px rgba(0,138,255,.45); display:none; color:white;
  min-width:240px; font-size:14px;
}
</style>
</head>

<body>
<header class="header">
  <div>DEALBANKERS ‚Ä¢ Dashboard</div>
  <nav class="nav">
    <a class="chip" href="settings.html">‚öô Settings</a>
    <a class="chip primary" href="#" id="logoutBtn">Log Out</a>
  </nav>
</header>

<div class="wrap">
  <section class="card">
    <div class="title">Welcome.</div>
    <div>Select your workspace:</div>
    <div class="portal-links">
      <a class="plink" href="wholesaler.html">üè† Wholesaler</a>
      <a class="plink" href="contractor.html">üîß Contractor</a>
      <a class="plink" href="realtor.html">üìé Realtor</a>
      <a class="plink" href="investor.html">üíº Investor</a>
    </div>
  </section>
</div>

<!-- Floating Chat Button -->
<div id="chatBubble">üí¨</div>

<!-- Admin Presence Panel -->
<div id="adminPresencePanel">
  <strong>üü¢ Online Users</strong>
  <div id="onlineUsers"></div>
</div>

<!-- JAVASCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getDatabase, ref, get, set, onDisconnect, onValue, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
import { firebaseConfig } from "./config.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* =========================
   AUTH + ROLE DETECTION
========================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  // Load role
  const roleSnap = await get(ref(db, `roles/${user.uid}`));
  const userRole = roleSnap.exists() ? roleSnap.val() : "user";

  // Activate presence
  setPresence(user, userRole);

  // Enable admin-only features
  attachAdminPresenceMonitor(userRole);
  attachAdminLoginAlerts(userRole);
});

/* =========================
   PRESENCE TRACKING
========================= */
function setPresence(user, userRole) {
  const presRef = ref(db, `presence/global/${user.uid}`);

  onDisconnect(presRef).set({
    state: "offline",
    lastOnline: serverTimestamp(),
  });

  set(presRef, {
    state: "online",
    name: user.displayName || user.email,
    role: userRole,
    ts: serverTimestamp(),
  });
}

/* =========================
   PRESENCE PANEL (ADMIN)
========================= */
function attachAdminPresenceMonitor(userRole) {
  if (userRole !== "admin" && userRole !== "god") return;
  document.getElementById("adminPresencePanel").style.display = "block";

  onValue(ref(db, "presence/global"), (snap) => {
    const data = snap.val() || {};
    const usersDiv = document.getElementById("onlineUsers");
    usersDiv.innerHTML = "";

    Object.keys(data).forEach((uid) => {
      const u = data[uid];
      if (u.state === "online") {
        usersDiv.innerHTML += `<div>üü¢ <strong>${u.name}</strong> (${u.role})</div>`;
      }
    });
  });
}

/* =========================
   LOGIN ALERTS (ADMIN)
========================= */
function attachAdminLoginAlerts(userRole) {
  if (userRole !== "admin" && userRole !== "god") return;

  onChildAdded(ref(db, "notifications/admin"), (snap) => {
    const n = snap.val();
    alert(`üö® ${n.message}`);
  });
}

/* =========================
   BUTTON HANDLERS
========================= */
document.getElementById("logoutBtn").onclick = () => signOut(auth);
document.getElementById("chatBubble").onclick = () => {
  window.location.href = "townhall.html";
};
</script>
</body>
</html>
