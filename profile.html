<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers • Profile</title>
<link rel="icon" href="images/icon (1).jpg">
<link rel="preconnect" href="https://www.gstatic.com">
<style>
  :root{
    --bg:#0F1A22;--panel:#122330;--line:#1c3848;--muted:#8fb6c9;--text:#e8f3f8;
    --btn:#17394c;--btn-border:#2a5369;--green:#1ea060;--amber:#d6a135;--red:#d9534f;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand img{width:32px;height:32px;border-radius:8px}
  nav{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--panel);color:var(--muted);text-decoration:none}
  .pill.action{background:var(--amber);border-color:#c49324;color:#141b1f;font-weight:600}
  .pill.badge{background:#152b38}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);color:var(--muted);background:#0f1f29;cursor:pointer}
  .tab.active{background:#1a3241;color:var(--text)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  h2{margin:0 0 8px;font-size:18px}
  h3{margin:0 0 8px;font-size:15px;color:var(--muted)}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1f29;color:var(--text)}
  textarea{min-height:80px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--btn-border);background:var(--btn);color:var(--text);cursor:pointer}
  .btn.green{background:var(--green);border-color:var(--green);color:#0f191f}
  .btn.red{background:#752d2a;border-color:#8e3a36}
  .btn.ghost{background:#0f1f29}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  .muted{color:var(--muted)}
  .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#153043;border:1px solid var(--line);font-size:12px;color:#9ec7dd}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img src="images/icon (1).jpg" alt="DB">
      <div>
        <div style="font-weight:700;letter-spacing:.6px">DEALBANKERS • PROFILE</div>
        <div class="muted" id="who"></div>
      </div>
    </div>
    <nav>
      <a class="pill action" href="claims-exchange.html">Claims Exchange</a>
      <a class="pill badge" id="btnSales" href="urgent-intake.html">Sales</a>
      <a class="pill badge" id="btnSupport" href="support.html">Support</a>
      <a class="pill" href="index.html" id="logout">Log Out</a>
    </nav>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="wholesaler">Wholesaler</button>
    <button class="tab" data-tab="contractor">Contractor</button>
    <button class="tab" data-tab="realtor">Realtor</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>

  <!-- OVERVIEW -->
  <section id="tab-overview" class="panel">
    <h2>Overview</h2>
    <div class="muted">Capital Open: <strong>$300k</strong> · Turn: <strong>7–10 days</strong></div>
    <div class="panel" style="margin-top:12px">
      <h3>Townhall (All Users)</h3>
      <div id="town" class="muted">Connecting…</div>
      <div class="row" style="margin-top:10px">
        <input id="say" placeholder="Say something to the room… (press Enter to send)"/>
        <button class="btn" id="send">Send</button>
      </div>
    </div>
  </section>

  <!-- WHOLESALER -->
  <section id="tab-wholesaler" class="panel" hidden>
    <div class="row" style="justify-content:space-between">
      <h2>Wholesaler</h2>
      <div class="row">
        <a class="btn" href="dispo.html">Capital Console</a>
        <button class="btn" id="newDeal">+ New Deal/Offer</button>
      </div>
    </div>
    <div class="panel">
      <h3>Lead filters live in <span class="tag">Settings → Wholesaler</span></h3>
      <div class="muted">Acq/Dispo UI loads below when enabled for your account.</div>
      <div id="wh-area" class="muted" style="margin-top:8px">Initializing…</div>
    </div>
  </section>

  <!-- CONTRACTOR -->
  <section id="tab-contractor" class="panel" hidden>
    <h2>Contractor</h2>
    <div class="grid">
      <div class="panel">
        <h3>Post a Job</h3>
        <input id="ct-title" placeholder="Job title (e.g., Roofing repair)"/>
        <input id="ct-loc" placeholder="Location (city / ZIP)"/>
        <input id="ct-budget" placeholder="Budget (optional)"/>
        <input id="ct-contact" placeholder="Best contact (optional)"/>
        <textarea id="ct-scope" placeholder="Scope / details"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn green" id="postJob">Post Job</button>
          <div class="muted">Jobs appear to vetted trades in your ZIPs.</div>
        </div>
      </div>
      <div class="panel">
        <h3>My Jobs</h3>
        <div id="myJobs" class="muted">Loading…</div>
      </div>
    </div>
    <div class="panel">
      <h3>Open Jobs</h3>
      <div class="row" style="justify-content:space-between">
        <div class="muted">Network feed</div>
        <button class="btn" id="refreshJobs">Refresh</button>
      </div>
      <div id="openJobs" class="muted" style="margin-top:8px">Loading…</div>
    </div>
  </section>

  <!-- REALTOR -->
  <section id="tab-realtor" class="panel" hidden>
    <h2>Realtor</h2>
    <div class="muted">Your realtor portal is active. Add MLS links, buyer needs, and referral preferences in Settings.</div>
  </section>

  <!-- SETTINGS / GOD MODE -->
  <section id="tab-settings" class="panel" hidden>
    <h2>Settings</h2>
    <div class="muted">User role management & branding here.</div>

    <div class="grid" style="margin-top:12px">
      <div class="panel">
        <h3>Roles & Toggles (me)</h3>
        <div class="row">
          <div id="myRole" class="tag">role: …</div>
          <div id="tog-acq" class="tag">acq: …</div>
          <div id="tog-dispo" class="tag">dispo: …</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="enableAcq">Enable Acq</button>
          <button class="btn ghost" id="disableAcq">Disable Acq</button>
          <button class="btn" id="enableDispo">Enable Dispo</button>
          <button class="btn ghost" id="disableDispo">Disable Dispo</button>
        </div>
      </div>

      <div class="panel">
        <h3>Roles & Toggles (by UID / email)</h3>
        <div class="row">
          <input id="lookup" placeholder="Paste UID or email…"/>
          <button class="btn" id="loadUser">Load</button>
        </div>
        <div id="loadedUser" class="muted" style="margin-top:8px">No user loaded.</div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="setAcqOn">Acq ON</button>
          <button class="btn ghost" id="setAcqOff">Acq OFF</button>
          <button class="btn" id="setDispoOn">Dispo ON</button>
          <button class="btn ghost" id="setDispoOff">Dispo OFF</button>
          <button class="btn green" id="makeAdmin">Make Admin</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>User Directory (live)</h3>
      <div class="row">
        <input id="filter" placeholder="Filter by name/email/uid/zip/leads/trades…"/>
        <button class="btn" id="refreshUsers">Refresh</button>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>UID</th><th>Name</th><th>Email</th><th>Acq</th><th>Dispo</th><th>WH Zips</th><th>CT Trades</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="userRows"><tr><td colspan="9" class="muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <h3>Lead Routing (manual)</h3>
      <div class="row">
        <input id="leadUid" placeholder="Target UID"/>
        <select id="leadKind">
          <option value="seller">Seller Lead</option>
          <option value="buyer">Buyer Lead</option>
        </select>
        <button class="btn" id="pushLead">Push to User</button>
        <button class="btn ghost" id="pullLead">Pull from User</button>
      </div>
      <div class="muted" style="margin-top:8px">These call your importer hooks; wire to /scripts/import-leads.html endpoints you added.</div>
    </div>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
<script>
  // Boot
  const app = firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db = firebase.database();

  // Tabs
  const tabBtns = document.querySelectorAll('.tab');
  const tabs = {
    overview: document.getElementById('tab-overview'),
    wholesaler: document.getElementById('tab-wholesaler'),
    contractor: document.getElementById('tab-contractor'),
    realtor: document.getElementById('tab-realtor'),
    settings: document.getElementById('tab-settings'),
  };
  tabBtns.forEach(b=>{
    b.onclick = ()=>{
      tabBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      Object.values(tabs).forEach(p=>p.hidden=true);
      tabs[b.dataset.tab].hidden=false;
    };
  });

  // Header buttons (Sales/Support simply open the forms pages)
  document.getElementById('btnSales').onclick = (e)=>{ /* leave default link */ };
  document.getElementById('btnSupport').onclick = (e)=>{ /* leave default link */ };

  // Auth + who am I
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ location.href="index.html"; return; }
    document.getElementById('who').textContent = user.email || user.uid;

    // Me: role + toggles
    const role = await getRole(user.uid);
    setTag('myRole', `role: ${role || 'user'}`);
    const acq = await db.ref(`toggles/${user.uid}/acq`).get();
    const dispo = await db.ref(`toggles/${user.uid}/dispo`).get();
    setTag('tog-acq', `acq: ${acq.val() ? 'ON' : 'OFF'}`);
    setTag('tog-dispo', `dispo: ${dispo.val() ? 'ON' : 'OFF'}`);

    // Townhall demo
    db.ref('townhall/messages').limitToLast(25).on('value',snap=>{
      const box = document.getElementById('town');
      if(!snap.exists()){ box.textContent = 'No messages yet.'; return; }
      const arr = Object.values(snap.val()).sort((a,b)=>a.ts-b.ts);
      box.innerHTML = arr.map(m=>`<div style="padding:6px 0;border-bottom:1px solid var(--line)"><b>${m.name||m.uid}</b> <span class="muted">${new Date(m.ts).toLocaleString()}</span><br>${escapeHtml(m.text||'')}</div>`).join('');
    });
    document.getElementById('send').onclick = sendTown;
    document.getElementById('say').addEventListener('keydown',e=>{ if(e.key==='Enter') sendTown(); });

    // Users table
    loadUsers();

    // Wire settings controls
    document.getElementById('enableAcq').onclick = ()=> setToggle(user.uid,'acq',true);
    document.getElementById('disableAcq').onclick = ()=> setToggle(user.uid,'acq',false);
    document.getElementById('enableDispo').onclick = ()=> setToggle(user.uid,'dispo',true);
    document.getElementById('disableDispo').onclick = ()=> setToggle(user.uid,'dispo',false);

    document.getElementById('loadUser').onclick = ()=> loadOther(document.getElementById('lookup').value.trim());
    document.getElementById('setAcqOn').onclick = ()=> setOtherToggle('acq',true);
    document.getElementById('setAcqOff').onclick = ()=> setOtherToggle('acq',false);
    document.getElementById('setDispoOn').onclick = ()=> setOtherToggle('dispo',true);
    document.getElementById('setDispoOff').onclick = ()=> setOtherToggle('dispo',false);
    document.getElementById('makeAdmin').onclick = ()=> setOtherRole('admin');

    document.getElementById('refreshUsers').onclick = loadUsers;

    // Lead push/pull placeholders
    document.getElementById('pushLead').onclick = ()=> leadAction('push');
    document.getElementById('pullLead').onclick = ()=> leadAction('pull');

    // New Deal/Offer button placeholder (restores modal later)
    document.getElementById('newDeal').onclick = ()=> alert('New Deal/Offer modal coming back in the next drop. Your click is wired.');
  });

  // Helpers
  function setTag(id,txt){ const el=document.getElementById(id); if(el) el.textContent = txt; }
  async function getRole(uid){ const snap = await db.ref(`roles/${uid}`).get(); return snap.exists()?snap.val():null; }
  async function setToggle(uid,key,val){
    await db.ref(`toggles/${uid}/${key}`).set(!!val);
    setTag(key==='acq'?'tog-acq':'tog-dispo', `${key}: ${val?'ON':'OFF'}`);
  }

  let loadedOther=null;
  async function loadOther(q){
    if(!q) return;
    // Resolve by email → uid
    let uid = q;
    if(q.includes('@')){
      const map = await db.ref('emails').get(); // optional mapping {uid: email}
      if(map.exists()){
        const all = map.val();
        uid = Object.keys(all).find(k=> (all[k]||'').toLowerCase()===q.toLowerCase()) || q;
      }
    }
    const role = await getRole(uid);
    const acq = (await db.ref(`toggles/${uid}/acq`).get()).val() || false;
    const dispo = (await db.ref(`toggles/${uid}/dispo`).get()).val() || false;

    loadedOther = uid;
    document.getElementById('loadedUser').innerHTML =
      `Loaded <b>${uid}</b> · role: <b>${role||'user'}</b> · acq: <b>${acq?'ON':'OFF'}</b> · dispo: <b>${dispo?'ON':'OFF'}</b>`;
  }
  async function setOtherToggle(key,val){
    if(!loadedOther) return alert('Load a user first.');
    await db.ref(`toggles/${loadedOther}/${key}`).set(!!val);
    loadOther(loadedOther);
  }
  async function setOtherRole(role){
    if(!loadedOther) return alert('Load a user first.');
    await db.ref(`roles/${loadedOther}`).set(role);
    loadOther(loadedOther);
  }

  async function loadUsers(){
    const tbody = document.getElementById('userRows');
    tbody.innerHTML = `<tr><td colspan="9" class="muted">Loading…</td></tr>`;
    const usersSnap = await db.ref('presence/global').get(); // minimal live list you already write
    const rows=[];
    if(usersSnap.exists()){
      const obj = usersSnap.val();
      for(const uid of Object.keys(obj)){
        const u = obj[uid] || {};
        const role = (await db.ref(`roles/${uid}`).get()).val() || 'user';
        const acq = (await db.ref(`toggles/${uid}/acq`).get()).val() ? 'ON':'OFF';
        const dispo = (await db.ref(`toggles/${uid}/dispo`).get()).val() ? 'ON':'OFF';
        const wh = (await db.ref(`userSettings/${uid}/wh/zips`).get()).val() || '';
        const ct = (await db.ref(`userSettings/${uid}/ct/trades`).get()).val() || '';
        rows.push({uid,name:u.name||'',email:u.email||'',role,acq,dispo,wh,ct,notes:(u.notes||'')});
      }
    }
    const filter = (document.getElementById('filter').value||'').toLowerCase();
    const filtered = rows.filter(r=> JSON.stringify(r).toLowerCase().includes(filter));
    const html = filtered.map(r=>`
      <tr>
        <td><code>${r.uid}</code></td>
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.email)}</td>
        <td>${r.acq}</td>
        <td>${r.dispo}</td>
        <td>${escapeHtml(r.wh)}</td>
        <td>${escapeHtml(r.ct)}</td>
        <td>${escapeHtml(r.notes)}</td>
        <td><button class="btn" onclick="document.getElementById('lookup').value='${r.uid}';document.getElementById('loadUser').click()">Manage</button></td>
      </tr>`).join('');
    document.getElementById('userRows').innerHTML = html || `<tr><td colspan="9" class="muted">No users.</td></tr>`;
  }

  async function leadAction(kind){
    const uid = document.getElementById('leadUid').value.trim();
    const what = document.getElementById('leadKind').value;
    if(!uid) return alert('Target UID required.');
    // Placeholder queue node your importer reads
    await db.ref(`leadQueue/${kind}`).push({uid,kind:what,ts:Date.now(),by:(auth.currentUser?.uid||'')});
    alert(`Queued ${kind} ${what} lead for ${uid}.`);
  }

  async function sendTown(){
    const user = auth.currentUser; if(!user) return;
    const text = (document.getElementById('say').value||'').trim();
    if(!text) return;
    await db.ref('townhall/messages').push({uid:user.uid,name:user.email||user.uid,text,ts:Date.now()});
    document.getElementById('say').value='';
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));}

  // Logout
  document.getElementById('logout').onclick = async (e)=>{ e.preventDefault(); await auth.signOut(); location.href="index.html"; };
</script>
</body>
</html>
