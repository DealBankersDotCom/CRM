<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DealBankers â€¢ Wholesaler</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<style>
:root {
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;--line:#254a63;
  --text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  margin:0;font-family:Inter,system-ui,Arial;
  color:var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  min-height:100vh;
}

/* HEADER / NAV */
.header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;
  border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04));
}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  padding:6px 14px;border-radius:100px;
  border:1px solid rgba(255,255,255,.22);
  background:#0d1823;color:var(--text);
  text-decoration:none;cursor:pointer;font-weight:600;
  transition:background .2s,transform .2s;
}
.chip:hover{background:#14314d;transform:scale(1.03)}
.chip.primary{background:#133e6a}
.chip.danger{background:#6b1111}

/* LAYOUT */
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.15);
  border-radius:20px;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.top{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.2);
}
.seg{display:flex;border:1px solid rgba(255,255,255,.22);border-radius:999px}
.seg button{
  padding:8px 14px;border:0;background:#0e2332;
  color:#cfe6ff;cursor:pointer
}
.seg button.active{
  background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff
}
.status{font-size:12px;color:#9ab9d6}

/* BODY GRID: LEFT = TABLE, RIGHT = DETAIL / STREET VIEW */
.body{
  padding:14px;
  display:grid;
  grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
  gap:16px;
}
@media (max-width:960px){
  .body{grid-template-columns:1fr}
}

.left-col{}
.right-col{
  background:#0b1825;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  padding:12px;
}

/* SEARCH / TABLE */
.search{
  display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap
}
.input{
  flex:1;background:#0d1f2d;border:1px solid #254a63;
  color:#fff;border-radius:12px;padding:8px 10px;
}
.small{padding:4px 10px;font-size:12px}

/* table wrap for mobile */
.table-wrap{
  overflow-x:auto;
  border-radius:12px;
  -webkit-overflow-scrolling:touch;
}
table{width:100%;border-collapse:collapse;font-size:14px;min-width:600px}
th,td{padding:10px;border-top:1px solid rgba(255,255,255,.2)}
thead th{border-top:0;color:#cfe3ff}
tr.lead-row{cursor:pointer}
tr.lead-row:hover{background:rgba(255,255,255,.06)}
tr.lead-row.selected{background:rgba(43,116,255,.25)}

/* ADMIN BAR */
.adminbar{
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  margin-bottom:8px;
}

/* RIGHT PANEL: CALL HUB */
.detail-header{margin-bottom:6px}
.detail-header h3{margin:0;font-size:16px}
.detail-header .sub{font-size:12px;color:#9ab9d6}

.detail-info{font-size:13px;margin-bottom:10px}
.detail-info div{margin-bottom:3px}

.script-box{
  background:#0d2233;
  border-radius:10px;
  padding:10px;
  font-size:13px;
  line-height:1.5;
  margin-top:8px;
}
.script-box strong{color:#f5fbff}

.detail-actions{
  display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;
}

/* STREET VIEW */
.map-wrap{
  margin-top:10px;
  border-radius:12px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.2);
  background:#050b12;
}
.map-wrap iframe{
  width:100%;height:220px;border:0
}

/* Floating Chat Bubble */
#chatBubble{
  position:fixed;bottom:24px;right:24px;
  width:54px;height:54px;
  border-radius:50%;background:#133e6a;
  color:white;border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 0 15px rgba(0,138,255,.6);
  z-index:999;transition:transform .15s
}
#chatBubble:hover{transform:scale(1.08)}

/* MODALS SHARED */
.modal-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center;
  z-index:9999;
}
.modal{
  background:#0f1b27;border:1px solid #254a63;
  border-radius:16px;padding:16px;max-width:520px;width:92%;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
}
.modal.wide{max-width:720px}
.modal h3{margin:0 0 8px}
.row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
.modal input,.modal select,.modal textarea{
  width:100%;padding:10px;border:1px solid #254a63;
  background:#0d1f2d;color:#fff;border-radius:10px
}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* Lead options */
.lead-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;margin-top:8px
}
.lead-card{
  border:1px solid rgba(255,255,255,.2);
  border-radius:14px;padding:12px;
  background:#0e2332;cursor:pointer
}
.lead-card h4{margin:0 0 4px}
.lead-card p{margin:0;font-size:13px;color:#b6c9e0}
.helper{
  text-align:right;font-size:12px;color:#9fbed8;
  margin-top:8px;cursor:pointer;
}
</style>

<!-- Firebase Core -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
</head>

<body data-portal="wholesaler">

<header class="header">
  <div>DEALBANKERS â€¢ Wholesaler</div>
  <nav class="nav">
    <a class="chip" href="profile.html">Dashboard</a>
    <button class="chip" id="btnGetLeads">Get Leads</button>
    <button class="chip" id="btnBlue">ðŸŒ€ Blue</button>
    <button class="chip danger" id="btnRed">ðŸš¨ Red</button>
    <a class="chip" id="logoutBtn">Log Out</a>
  </nav>
</header>

<!-- Blue/Red Phone Modal -->
<div class="modal-backdrop" id="rbModal">
  <div class="modal">
    <h3 id="rbTitle">Request</h3>
    <div class="row">
      <label>Category</label>
      <select id="rbCategory">
        <option>Acquisition</option><option>Sales</option>
        <option>Contractor</option><option>Realtor</option><option>Website</option>
      </select>
    </div>
    <div class="row"><input id="rbSubject" placeholder="Subject" /></div>
    <div class="row"><textarea id="rbDetails" rows="4" placeholder="Details"></textarea></div>
    <div class="actions">
      <button class="chip" id="rbCancel">Cancel</button>
      <button class="chip primary" id="rbSubmit">Send</button>
    </div>
  </div>
</div>

<!-- Lead Selection Modal -->
<div class="modal-backdrop" id="leadsModal">
  <div class="modal wide">
    <h3>Get Leads</h3>
    <div class="lead-grid">
      <div class="lead-card" data-lead="street"><h4>Street</h4><p>Upload / partner with boots on ground.</p></div>
      <div class="lead-card" data-lead="web"><h4>Web</h4><p>Click campaigns, targeted pipelines.</p></div>
      <div class="lead-card" data-lead="live"><h4>Live</h4><p>Grab inbound and live opportunities.</p></div>
    </div>
    <div class="helper" id="closeLeads">Close</div>
  </div>
</div>

<div class="wrap">
  <section class="card">
    <div class="top">
      <div>
        <div id="crumb">Acquisition</div>
        <div class="status" id="status">Loadingâ€¦</div>
      </div>
      <div class="seg">
        <button id="tabAcq" class="active">Acq</button>
        <button id="tabDispo">Dispo</button>
      </div>
    </div>

    <div class="body">
      <!-- LEFT COLUMN: TABLE / SEARCH -->
      <div class="left-col">
        <div id="adminBar" class="adminbar" style="display:none">
          <span class="status">Admin â€¢ View as UID:</span>
          <input id="impUid" class="input" placeholder="UID (read-only)" />
          <button class="chip small" id="applyImp">Apply</button>
          <button class="chip small" id="clearImp">Clear</button>
        </div>

        <!-- Acquisition Panel -->
        <section id="panel-acq">
          <div class="search">
            <input id="s_q" class="input" placeholder="Search address / owner" />
            <button class="chip small" id="s_reload">Search</button>
            <button class="chip small" id="prevLead">â—€ Prev</button>
            <button class="chip small" id="nextLead">Next â–¶</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Address</th><th>Owner</th><th>Phone</th><th>Status</th><th>Notes</th></tr>
              </thead>
              <tbody id="sellerRows"></tbody>
            </table>
          </div>
        </section>

        <!-- Disposition Panel -->
        <section id="panel-dispo" style="display:none">
          <div class="search">
            <input id="b_q" class="input" placeholder="Search name / criteria" />
            <button class="chip small" id="b_reload">Search</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Name</th><th>Phone</th><th>Criteria</th><th>Status</th><th>Notes</th></tr>
              </thead>
              <tbody id="buyerRows"></tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- RIGHT COLUMN: CALL HUB / STREET VIEW -->
      <div class="right-col" id="detailPanel">
        <div class="detail-header">
          <h3 id="detailTitle">No lead selected</h3>
          <div class="sub" id="detailSub">Click a lead on the left to load Street View and scripts.</div>
        </div>

        <div class="detail-info" id="detailInfo" style="display:none;">
          <div><strong>Address:</strong> <span id="detailAddr"></span></div>
          <div><strong>Owner:</strong> <span id="detailOwner"></span></div>
          <div><strong>Phone:</strong> <span id="detailPhone"></span></div>
          <div><strong>Status:</strong> <span id="detailStatus"></span></div>
        </div>

        <div class="detail-actions" id="detailActions" style="display:none;">
          <button class="chip small" id="openMaps">Open in Maps</button>
          <button class="chip small" id="copyScript">Copy Script</button>
        </div>

        <div class="script-box" id="scriptBox">
          Select a lead to load the Belfort-style opener and call flow.
        </div>

        <div class="map-wrap" id="mapWrap" style="display:none;">
          <iframe id="streetFrame" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="chatBubble">ðŸ’¬</div>

<script>
let UID=null, IS_ADMIN=false, VIEW_AS=null;
let sRef=null, bRef=null;
let sellerList=[];   // all seller leads for this user
let sellerView=[];   // filtered view
let currentIndex=-1;

/* Helpers */
const esc = s => (''+(s||'')).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const activeUid = () => (IS_ADMIN && VIEW_AS) ? VIEW_AS : UID;

firebase.auth().onAuthStateChanged(async (u) => {
  if (!u) { location.href = "index.html"; return; }
  UID=u.uid;
  try{
    const snap = await firebase.database().ref('roles/'+UID).get();
    IS_ADMIN = snap.exists() && snap.val()==='admin';
  }catch(e){ console.warn(e); }
  document.getElementById('adminBar').style.display = IS_ADMIN ? 'flex' : 'none';
  subscribe();
});

/* NAV / UI */
document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();
document.getElementById('tabAcq').onclick = () => switchMode('acq');
document.getElementById('tabDispo').onclick = () => switchMode('dispo');
document.getElementById('s_reload').onclick = () => renderS();
document.getElementById('b_reload').onclick = () => renderB();
document.getElementById('applyImp').onclick = () => { VIEW_AS = impUid.value.trim() || null; subscribe(); };
document.getElementById('clearImp').onclick = () => { VIEW_AS = null; impUid.value=''; subscribe(); };

document.getElementById('prevLead').onclick = () => cycleLead(-1);
document.getElementById('nextLead').onclick = () => cycleLead(1);

/* MODE SWITCH */
function switchMode(m){
  tabAcq.classList.toggle('active',m==='acq');
  tabDispo.classList.toggle('active',m==='dispo');
  panel-acq.style.display = m==='acq'?'block':'none';
  panel-dispo.style.display = m==='dispo'?'block':'none';
  crumb.textContent = m==='acq'?'Acquisition':'Disposition';
  document.getElementById('status').textContent = m==='acq'
    ? 'Acquisition view'
    : 'Disposition view';
}

/* LEAD SUBSCRIPTIONS */
function subscribe(){
  if(!UID) return;
  if(sRef) sRef.off();
  if(bRef) bRef.off();
  const a = activeUid();

  sRef = firebase.database().ref('leads/sellers').orderByChild('assignedTo').equalTo(a);
  sRef.on('value', snap => {
    const obj = snap.val() || {};
    sellerList = Object.entries(obj).map(([id,v])=>({id, ...(v||{})}));
    renderS();
  });

  bRef = firebase.database().ref('leads/buyers').orderByChild('assignedTo').equalTo(a);
  bRef.on('value', snap => {
    const obj = snap.val() || {};
    renderB(obj);
  });
}

/* RENDER SELLERS WITH CLICK + STREET VIEW */
function renderS(){
  const q = (s_q.value||'').toLowerCase();
  sellerView = sellerList.filter(v =>
    !q ||
    (v.address||'').toLowerCase().includes(q) ||
    (v.owner||'').toLowerCase().includes(q)
  );

  const tbody = document.getElementById('sellerRows');
  document.getElementById('status').textContent = 'Acq: '+sellerView.length+' items';

  if(!sellerView.length){
    tbody.innerHTML = '<tr><td colspan="5">No assigned seller leads.</td></tr>';
    currentIndex=-1;
    updateDetail(null);
    return;
  }

  let html='';
  sellerView.forEach((v,idx)=>{
    html += `
      <tr class="lead-row" data-idx="${idx}">
        <td>${esc(v.address)}</td>
        <td>${esc(v.owner)}</td>
        <td>${esc(v.phone)}</td>
        <td>${esc(v.status||'new')}</td>
        <td>${esc(v.notes||'')}</td>
      </tr>`;
  });
  tbody.innerHTML = html;

  tbody.querySelectorAll('tr.lead-row').forEach(row=>{
    row.addEventListener('click',()=>{
      const idx = parseInt(row.dataset.idx,10);
      currentIndex = isNaN(idx)?0:idx;
      updateDetail(sellerView[currentIndex]);
      highlightRow();
    });
  });

  if(currentIndex<0 || currentIndex>=sellerView.length){
    currentIndex=0;
    updateDetail(sellerView[0]);
  }
  highlightRow();
}

function highlightRow(){
  const rows = document.querySelectorAll('#sellerRows tr.lead-row');
  rows.forEach(r=>r.classList.remove('selected'));
  if(currentIndex<0) return;
  const row = document.querySelector(`#sellerRows tr.lead-row[data-idx="${currentIndex}"]`);
  if(row){
    row.classList.add('selected');
    row.scrollIntoView({block:'nearest',behavior:'smooth'});
  }
}

function cycleLead(delta){
  if(!sellerView.length) return;
  currentIndex = (currentIndex + delta + sellerView.length) % sellerView.length;
  updateDetail(sellerView[currentIndex]);
  highlightRow();
}

/* RENDER BUYERS */
function renderB(obj){
  const q = (b_q.value||'').toLowerCase();
  const list = Object.entries(obj||{}).map(([id,v])=>({id, ...(v||{})}));
  const filtered = list.filter(v =>
    !q ||
    (v.name||'').toLowerCase().includes(q) ||
    (v.criteria||'').toLowerCase().includes(q)
  );

  const tbody = document.getElementById('buyerRows');
  document.getElementById('status').textContent = 'Dispo: '+filtered.length+' items';

  if(!filtered.length){
    tbody.innerHTML = '<tr><td colspan="5">No assigned buyer leads.</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.map(v=>`
    <tr>
      <td>${esc(v.name)}</td>
      <td>${esc(v.phone)}</td>
      <td>${esc(v.criteria)}</td>
      <td>${esc(v.status||'new')}</td>
      <td>${esc(v.notes||'')}</td>
    </tr>`).join('');
}

/* DETAIL PANEL + STREET VIEW + SCRIPT */
function updateDetail(lead){
  const title = document.getElementById('detailTitle');
  const sub   = document.getElementById('detailSub');
  const info  = document.getElementById('detailInfo');
  const acts  = document.getElementById('detailActions');
  const mapW  = document.getElementById('mapWrap');
  const frame = document.getElementById('streetFrame');
  const scriptBox = document.getElementById('scriptBox');

  if(!lead){
    title.textContent = 'No lead selected';
    sub.textContent   = 'Click a lead on the left to load Street View and scripts.';
    info.style.display = 'none';
    acts.style.display = 'none';
    mapW.style.display = 'none';
    frame.src = '';
    scriptBox.textContent = 'Select a lead to load the Belfort-style opener and call flow.';
    return;
  }

  const address = lead.address || '';
  const owner   = lead.owner || '';
  const phone   = lead.phone || '';
  const status  = lead.status || 'new';

  title.textContent = owner || 'Owner - Unknown';
  sub.textContent   = address || 'No address provided';

  document.getElementById('detailAddr').textContent   = address;
  document.getElementById('detailOwner').textContent  = owner;
  document.getElementById('detailPhone').textContent  = phone;
  document.getElementById('detailStatus').textContent = status;

  info.style.display = 'block';
  acts.style.display = 'flex';

  // Street view / map
  if(address){
    const url = 'https://www.google.com/maps?q=' + encodeURIComponent(address) + '&output=embed';
    frame.src = url;
    mapW.style.display = 'block';
  }else{
    frame.src = '';
    mapW.style.display = 'none';
  }

  // Belfort-style script
  const firstName = owner ? owner.split(' ')[0] : 'there';
  const propPhrase = address || 'that property';
  const script = `
    <p><strong>Opener:</strong> "Hi ${firstName}, this is ____ with DealBankers. Iâ€™m calling about the property at ${propPhrase}. Did I catch you at a bad time?"</p>
    <p><strong>Frame:</strong> "I work with a small group that specializes in solving problem properties â€” taxes, liens, inherited houses, anything thatâ€™s become more stress than itâ€™s worth. Iâ€™m not a big box buyer, Iâ€™m local and I actually look at each property one by one."</p>
    <p><strong>Qualify:</strong> "Before I waste your time, can I ask â€” whatâ€™s the main thing going on with this property right now? Is it payments, repairs, or just wanting to be done with it?"</p>
    <p><strong>Dig:</strong> "If you did nothing with it for the next 6â€“12 months, what do you see happening?"</p>
    <p><strong>Transition:</strong> "Got it. Based on what youâ€™ve told me, I can either make you an offer myself or plug this into my investors and contractors network to see who can move the fastest. My job is simply to line up the best option and handle the paperwork. Fair enough?"</p>
  `;
  scriptBox.innerHTML = script;

  // actions
  document.getElementById('openMaps').onclick = () => {
    if(!address) return;
    window.open('https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(address),'_blank');
  };
  document.getElementById('copyScript').onclick = async () => {
    try{
      const plain = scriptBox.innerText;
      await navigator.clipboard.writeText(plain);
      alert('Script copied to clipboard.');
    }catch(e){ alert('Could not copy script.'); }
  };
}

/* BLUE / RED PHONE MODAL */
(function(){
  const m = document.getElementById('rbModal');
  btnBlue.onclick = () => show(false);
  btnRed.onclick  = () => show(true);
  rbCancel.onclick = () => m.style.display='none';

  function show(urgent){
    rbTitle.textContent = urgent ? "ðŸš¨ Urgent Request" : "Blue Phone Request";
    rbSubmit.dataset.urgent = urgent ? '1' : '0';
    m.style.display = 'flex';
  }

  rbSubmit.onclick = async () => {
    try{
      const u = firebase.auth().currentUser || {};
      await firebase.database().ref('requests').push({
        portal:'wholesaler',
        urgent:rbSubmit.dataset.urgent === '1',
        cat:rbCategory.value,
        subject:rbSubject.value.trim(),
        details:rbDetails.value.trim(),
        uid:u.uid || null,
        email:u.email || null,
        ts:firebase.database.ServerValue.TIMESTAMP
      });
      alert('Request sent.');
      m.style.display='none';
      rbSubject.value=''; rbDetails.value='';
    }catch(e){ alert('Failed to send.'); }
  };
})();

/* GET LEADS MODAL */
(function(){
  const modal = document.getElementById('leadsModal');
  btnGetLeads.onclick = () => modal.style.display='flex';
  closeLeads.onclick  = () => modal.style.display='none';

  modal.addEventListener('click', async e=>{
    if(e.target===modal) return modal.style.display='none';
    const card = e.target.closest('.lead-card');
    if(!card) return;
    try{
      const u = firebase.auth().currentUser || {};
      await firebase.database().ref('lead_requests').push({
        portal:'wholesaler',
        type:card.dataset.lead,
        uid:u.uid || null,
        email:u.email || null,
        ts:firebase.database.ServerValue.TIMESTAMP
      });
      alert('Lead request sent.');
      modal.style.display='none';
    }catch(err){ alert('Failed to submit.'); }
  });
})();

/* CHAT BUBBLE */
document.getElementById('chatBubble').onclick = () => {
  window.location.href = "townhall.html?from=wholesaler";
};
</script>
</body>
</html>
