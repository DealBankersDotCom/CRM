<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Import Leads (Admin)</title><style>
body{margin:0;font-family:system-ui,Inter,Segoe UI,Roboto,Arial;background:#0b0f14;color:#d6e1ff}.wrap{max-width:960px;margin:0 auto;padding:18px}
.card{border:1px solid #1c2a3a;border-radius:14px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0))}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}.input{flex:1;min-width:280px;padding:10px;border-radius:10px;border:1px solid #1c2a3a;background:#10151d;color:#eaf3ff}
.btn{padding:10px 12px;border-radius:10px;border:1px solid #16314d;background:linear-gradient(180deg,#0f1824,#0c1220);color:#eaf3ff;font-weight:700;cursor:pointer}
pre{white-space:pre-wrap;word-break:break-word;background:#0e1622;border:1px solid #1c2a3a;padding:10px;border-radius:10px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="config.js"></script><script src="app-auth.js"></script></head><body>
<div class="wrap"><h1>Import Leads (Admin)</h1><div class="card">
  <div class="row"><label style="flex:1">Seller CSV URL <input id="sellerUrl" class="input" value="data/Sellerleads.csv"/></label></div>
  <div class="row"><label style="flex:1">Buyer CSV URL <input id="buyerUrl" class="input" value="data/Buyerslist.csv"/></label></div>
  <div class="row"><label>Assign to UID <input id="assignUid" class="input" placeholder="optional"/></label></div>
  <div class="row"><button class="btn" id="importSellers">Import Sellers</button><button class="btn" id="importBuyers">Import Buyers</button></div>
</div><h3>Log</h3><pre id="log">Ready.</pre></div>
<script>
let IS_ADMIN=false; firebase.auth().onAuthStateChanged(async u=>{ if(!u) return; const r=await firebase.database().ref('roles/'+u.uid).get(); IS_ADMIN=r.exists()&&r.val()==='admin'; if(!IS_ADMIN){ alert('Admins only'); location.href='profile.html'; } });
function log(s){ document.getElementById('log').textContent += '\n'+s; }
function parseCSV(text){ const lines=text.replace(/\r/g,'').split('\n').filter(Boolean); if(!lines.length) return {headers:[],rows:[]};
  const headers=split(lines[0]).map(h=>h.trim()); const rows=lines.slice(1).map(l=>{ const parts=split(l); const o={}; headers.forEach((h,i)=>o[h]=parts[i]||''); return o; }); return {headers,rows}; }
function split(l){ const out=[]; let cur='',q=false; for(let i=0;i<l.length;i++){ const c=l[i];
  if(c==='"'){ if(q&&l[i+1]==='"'){cur+='"';i++;} else q=!q; } else if(c===','&&!q){ out.push(cur); cur=''; } else cur+=c; } out.push(cur); return out; }
function slug(s){ return (s||'item').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
async function importCSV(kind,url){ const res=await fetch(url,{cache:'no-store'}); const txt=await res.text(); const {headers,rows}=parseCSV(txt); const H=headers.map(h=>h.toLowerCase()); const assign=(document.getElementById('assignUid').value||'').trim(); let n=0;
  for(const r of rows){ const get=names=>{ for(const nm of names){ const i=H.indexOf(nm); if(i>=0) return (r[headers[i]]||'').trim(); } return ''; };
    if(kind==='sellers'){ const address=get(['address','property address','addr','location']); const owner=get(['owner','name','contact','seller']); const phone=get(['phone','phone number','tel','mobile']); const notes=get(['notes','note','details','memo']); const status=get(['status','state'])||'new';
      const id=slug(address||owner||('seller-'+Date.now())); const rec={address,owner,phone,notes,status}; if(assign) rec.assignedTo=assign; await firebase.database().ref('leads/sellers/'+id).set(rec); n++; }
    else{ const name=get(['name','buyer','contact']); const phone=get(['phone','phone number','tel','mobile']); const criteria=get(['criteria','buy box','focus','notes']); const notes=get(['notes','note','details','memo']); const status=get(['status','state'])||'new';
      const id=slug((name||'buyer')+'-'+(phone||Math.random().toString(36).slice(2,6))); const rec={name,phone,criteria,notes,status}; if(assign) rec.assignedTo=assign; await firebase.database().ref('leads/buyers/'+id).set(rec); n++; } }
  log(`Imported ${n} ${kind} from ${url}`); }
document.getElementById('importSellers').onclick=()=>importCSV('sellers',document.getElementById('sellerUrl').value).catch(e=>log('Error: '+e.message));
document.getElementById('importBuyers').onclick=()=>importCSV('buyers',document.getElementById('buyerUrl').value).catch(e=>log('Error: '+e.message));
</script></body></html>
