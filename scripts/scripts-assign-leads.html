<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Assign Leads (Admin)</title><style>
body{margin:0;font-family:system-ui,Inter,Segoe UI,Roboto,Arial;background:#0b0f14;color:#d6e1ff}.wrap{max-width:1100px;margin:0 auto;padding:18px}
.card{border:1px solid #1c2a3a;border-radius:14px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0))}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}.input{flex:1;min-width:280px;padding:10px;border-radius:10px;border:1px solid #1c2a3a;background:#10151d;color:#eaf3ff}
.btn{padding:10px 12px;border-radius:10px;border:1px solid #16314d;background:linear-gradient(180deg,#0f1824,#0c1220);color:#eaf3ff;font-weight:700;cursor:pointer}
table{width:100%;border-collapse:collapse;font-size:14px}th,td{border-top:1px solid #1c2a3a;padding:8px;text-align:left}thead th{border-top:0;color:#cfe3ff}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="config.js"></script><script src="app-auth.js"></script></head><body>
<div class="wrap"><h1>Assign Leads (Admin)</h1><div class="card">
  <div class="row"><label>Target UID <input id="targetUid" class="input" placeholder="UID to assign to"/></label><button id="assignSelected" class="btn">Assign Selected</button><button id="assignAll" class="btn">Assign All</button></div>
  <div class="row"><label>Filter by UID (view) <input id="filterUid" class="input" placeholder="leave blank = ALL"/></label><button id="reload" class="btn">Reload</button></div>
</div>
<h3>Sellers</h3><table><thead><tr><th><input type="checkbox" id="selAllS"/></th><th>Address</th><th>Owner</th><th>Phone</th><th>assignedTo</th></tr></thead><tbody id="sellers"></tbody></table>
<h3>Buyers</h3><table><thead><tr><th><input type="checkbox" id="selAllB"/></th><th>Name</th><th>Phone</th><th>Criteria</th><th>assignedTo</th></tr></thead><tbody id="buyers"></tbody></table>
</div>
<script>
let IS_ADMIN=false; firebase.auth().onAuthStateChanged(async u=>{ if(!u) return; const r=await firebase.database().ref('roles/'+u.uid).get(); IS_ADMIN=r.exists()&&r.val()==='admin'; if(!IS_ADMIN){ alert('Admins only'); location.href='profile.html'; return; } reload(); });
function esc(s){return(''+(s||'')).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
document.getElementById('reload').onclick=reload; document.getElementById('assignSelected').onclick=()=>assign(false); document.getElementById('assignAll').onclick=()=>assign(true);
document.getElementById('selAllS').addEventListener('change',e=>{ document.querySelectorAll('input[name="s_chk"]').forEach(c=>c.checked=e.target.checked); });
document.getElementById('selAllB').addEventListener('change',e=>{ document.querySelectorAll('input[name="b_chk"]').forEach(c=>c.checked=e.target.checked); });
function reload(){ const fuid=(document.getElementById('filterUid').value||'').trim(); loadList('sellers',fuid); loadList('buyers',fuid); }
function loadList(kind,fuid){ const tb=document.getElementById(kind==='sellers'?'sellers':'buyers'); tb.innerHTML='<tr><td colspan="5">Loadingâ€¦</td></tr>'; let ref=firebase.database().ref('leads/'+kind); if(fuid){ ref=ref.orderByChild('assignedTo').equalTo(fuid); }
  ref.once('value',s=>{ const o=s.val()||{}; const rows=Object.entries(o).map(([id,v])=>({id,...v})).map(v=>{
    return kind==='sellers'?`<tr><td><input type="checkbox" name="s_chk" value="${esc(v.id)}"/></td><td>${esc(v.address||'')}</td><td>${esc(v.owner||'')}</td><td>${esc(v.phone||'')}</td><td>${esc(v.assignedTo||'')}</td></tr>`:
    `<tr><td><input type="checkbox" name="b_chk" value="${esc(v.id)}"/></td><td>${esc(v.name||'')}</td><td>${esc(v.phone||'')}</td><td>${esc(v.criteria||'')}</td><td>${esc(v.assignedTo||'')}</td></tr>`; }).join('');
    tb.innerHTML = rows || '<tr><td colspan="5">No data.</td></tr>';
  },e=>{ tb.innerHTML='<tr><td colspan="5">Error: '+esc(e.message)+'</td></tr>'; });
}
async function assign(all){ const target=(document.getElementById('targetUid').value||'').trim(); if(!target) return alert('Target UID required');
  const sIds = (all? Array.from(document.querySelectorAll('#sellers input[name="s_chk"]')) : Array.from(document.querySelectorAll('#sellers input[name="s_chk"]:checked'))).map(c=>c.value);
  const bIds = (all? Array.from(document.querySelectorAll('#buyers input[name="b_chk"]'))  : Array.from(document.querySelectorAll('#buyers input[name="b_chk"]:checked')) ).map(c=>c.value);
  const ops=[]; sIds.forEach(id=>ops.push(firebase.database().ref('leads/sellers/'+id+'/assignedTo').set(target)));
  bIds.forEach(id=>ops.push(firebase.database().ref('leads/buyers/'+id+'/assignedTo').set(target))); await Promise.all(ops); alert('Assigned '+(sIds.length+bIds.length)+' leads to '+target); reload();
}
</script></body></html>
