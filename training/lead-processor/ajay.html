<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deal Bankers // Internal Ops Console v1.5 (Lead Processor)</title>
  <style>
    :root{
      --bg:#070a0f;
      --panel:#0d121b;
      --panel2:#0b0f16;
      --line:#1c2a3d;
      --ink:#e9f2ff;
      --muted:#9bb2d3;
      --cyan:#59d3ff;
      --green:#2ee59d;
      --yellow:#ffd166;
      --red:#ff4d4d;
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      color:var(--ink);
      font-family:var(--sans);
      background:
        radial-gradient(900px 520px at 18% 14%, rgba(89,211,255,.16), transparent 55%),
        radial-gradient(780px 420px at 82% 20%, rgba(46,229,157,.10), transparent 55%),
        linear-gradient(180deg, #05070c, #070a0f);
    }
    header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.92), rgba(13,18,27,.74));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center; user-select:none}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(89,211,255,.25), rgba(46,229,157,.18));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 26px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--mono); font-weight:900;
      letter-spacing:.08em;
    }
    .t1{font-weight:900; letter-spacing:.12em; text-transform:uppercase; font-size:13px}
    .t2{font-family:var(--mono); color:var(--muted); font-size:12px; margin-top:2px}
    .hdrRight{display:flex; gap:10px; align-items:center}
    .pill{
      font-family:var(--mono);
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,15,.45);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.cyan{border-color: rgba(89,211,255,.35); color:#dff6ff;}
    .pill.green{border-color: rgba(46,229,157,.35); color:#dcfff0;}
    .pill.yellow{border-color: rgba(255,209,102,.35); color:#fff3d6;}
    .pill.red{border-color: rgba(255,77,77,.35); color:#ffe3e3;}

    .wrap{max-width:1500px; margin:0 auto; padding:16px;}
    .layout{
      display:grid;
      grid-template-columns: 290px 1fr 520px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1280px){
      .layout{grid-template-columns: 290px 1fr;}
      .right{grid-column: 1 / -1;}
    }
    @media (max-width: 760px){
      .layout{grid-template-columns: 1fr;}
      .left,.mid,.right{grid-column: 1 / -1;}
    }

    .card{
      border-radius:var(--r);
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.92), rgba(13,18,27,.70));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .chdr{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card .cbody{padding:12px;}
    .title{font-weight:900; letter-spacing:.10em; text-transform:uppercase; font-size:12px;}
    .sub{font-family:var(--mono); font-size:12px; color:var(--muted); margin-top:3px; line-height:1.45;}
    .btn{
      font-family:var(--mono);
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.40);
      color:var(--ink);
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color: rgba(89,211,255,.55)}
    .btn.primary{border-color: rgba(46,229,157,.45)}
    .btn.primary:hover{border-color: rgba(46,229,157,.75)}
    .btn.warn{border-color: rgba(255,209,102,.45)}
    .btn.warn:hover{border-color: rgba(255,209,102,.75)}
    .btn.danger{border-color: rgba(255,77,77,.45)}
    .btn.danger:hover{border-color: rgba(255,77,77,.75)}
    .btn.small{padding:7px 10px; font-size:11px; border-radius:10px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:8px}

    .navBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius:14px;
      text-decoration:none;
      border:1px solid rgba(89,211,255,.25);
      background: linear-gradient(180deg, rgba(7,10,15,.40), rgba(7,10,15,.15));
      color:var(--ink);
      font-family:var(--mono);
      letter-spacing:.02em;
    }
    .navBtn:hover{border-color: rgba(89,211,255,.65)}
    .navBtn span{opacity:.92}
    .navBtn em{font-style:normal; color:var(--muted); font-size:11px}
    .navList{display:flex; flex-direction:column; gap:10px}

    iframe{
      width:100%;
      height:75vh;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background: rgba(7,10,15,.35);
    }

    label{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.45);
      color:var(--ink);
      padding:10px 11px;
      outline:none;
      font-family:var(--mono);
      font-size:12px;
    }
    textarea{min-height:88px; resize:vertical; line-height:1.45;}
    input:focus, textarea:focus, select:focus{border-color: rgba(89,211,255,.65)}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .kpi{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,15,.35);
      padding:10px;
    }
    .kpi .n{font-family:var(--mono); font-size:20px; font-weight:900; letter-spacing:.02em}
    .kpi .l{font-family:var(--mono); font-size:11px; color:var(--muted); margin-top:4px}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0;}
    .mono{font-family:var(--mono); font-size:12px; color:var(--muted); line-height:1.45}
    .sticky{position:sticky; top:78px;}

    .toast{
      position:fixed; right:14px; bottom:14px;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(13,18,27,.88);
      font-family:var(--mono); font-size:12px;
      opacity:0; transform: translateY(8px);
      transition: all .18s ease;
      pointer-events:none;
      max-width: 520px;
      white-space: pre-line;
      z-index:999;
    }
    .toast.show{opacity:1; transform: translateY(0)}
    .mini{font-size:11px;}

    /* Lead queue */
    .queueWrap{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,15,.32);
      overflow:hidden;
    }
    .queueHdr{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .queueHdr .left{
      display:flex; flex-direction:column; gap:2px;
    }
    .queueHdr .left .qtitle{
      font-family:var(--mono);
      font-weight:900;
      letter-spacing:.08em;
      font-size:11px;
      text-transform:uppercase;
    }
    .queueHdr .left .qsub{
      font-family:var(--mono);
      color:var(--muted);
      font-size:11px;
    }
    .queueBody{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .queueTools{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .queueList{
      max-height: 220px;
      overflow:auto;
      padding-right:6px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .qItem{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,15,.35);
      padding:10px;
      cursor:pointer;
    }
    .qItem:hover{border-color: rgba(89,211,255,.55)}
    .qTop{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      font-family:var(--mono);
      font-size:11px;
    }
    .qAddr{color:var(--ink); font-weight:900}
    .qMeta{color:var(--muted); margin-top:6px; font-family:var(--mono); font-size:11px; line-height:1.35}
    .badge{
      font-family:var(--mono);
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.cyan{border-color: rgba(89,211,255,.35); color:#dff6ff;}
    .badge.green{border-color: rgba(46,229,157,.35); color:#dcfff0;}
    .badge.yellow{border-color: rgba(255,209,102,.35); color:#fff3d6;}
    .badge.red{border-color: rgba(255,77,77,.35); color:#ffe3e3;}

    .fileInput{display:none}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">DB</div>
    <div>
      <div class="t1">Deal Bankers // Internal Ops Console</div>
      <div class="t2">Lead Processor Station ¬∑ flow mode (Ajay)</div>
    </div>
  </div>
  <div class="hdrRight">
    <span class="pill cyan" id="clockPill">--:--</span>
    <span class="pill green" id="kpiPill">KPI: 0 traced ¬∑ 0 numbers</span>
    <button class="btn small" id="btnResetKpis">Reset KPIs</button>
  </div>
</header>

<div class="wrap">
  <div class="layout">

    <!-- LEFT -->
    <aside class="card left">
      <div class="chdr">
        <div>
          <div class="title">TOOLS</div>
          <div class="sub">Launcher (Ajay stays in lane)</div>
        </div>
        <span class="pill cyan">v1.5</span>
      </div>
      <div class="cbody">
        <div class="navList" id="leftNav">
          <a class="navBtn" href="#" data-url="https://bexar.tx.publicsearch.us/">
            <span>üèõÔ∏è County Clerk</span><em>deeds / docs</em>
          </a>
          <a class="navBtn" href="#" data-url="https://bexar.acttax.com/act_webdev/bexar/index.jsp">
            <span>üí∞ Tax Assessor</span><em>delinquent</em>
          </a>
          <a class="navBtn" href="#" data-url="https://bexar.trueautomation.com/clientdb/propertysearch.aspx?cid=110">
            <span>üè† BCAD</span><em>owner / mailing</em>
          </a>
          <a class="navBtn" href="#" data-url="https://www.truepeoplesearch.com">
            <span>üîé TruePeopleSearch</span><em>phones</em>
          </a>
          <a class="navBtn" href="#" data-url="https://bexar.acttax.com/act_webdev/bexar/showdetail2.jsp?can=">
            <span>üìÑ ACTTax Detail</span><em>paste CAN</em>
          </a>
        </div>

        <div class="hr"></div>

        <div class="mono">
          <b>Rules:</b><br>
          ‚Ä¢ Ajay produces <b>call-ready</b> leads.<br>
          ‚Ä¢ No negotiation. No calling.<br>
          ‚Ä¢ If unclear ‚Üí <b>Status: Needs Bill Review</b>.<br>
          ‚Ä¢ Export as JSON when done.
        </div>
      </div>
    </aside>

    <!-- MIDDLE -->
    <main class="card mid">
      <div class="chdr">
        <div>
          <div class="title">WORKSPACE</div>
          <div class="sub">Open tools inside the console (one screen)</div>
        </div>
        <div class="row">
          <button class="btn small" id="btnTps">TPS</button>
          <button class="btn small" id="btnBc">BCAD</button>
          <button class="btn small" id="btnTax">ACTTax</button>
          <button class="btn small" id="btnClearFrame">Clear</button>
        </div>
      </div>
      <div class="cbody">
        <iframe id="workFrame" src="https://www.truepeoplesearch.com" title="workspace"></iframe>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="card right sticky">
      <div class="chdr">
        <div>
          <div class="title">WORKFLOW CONSOLE</div>
          <div class="sub">Queue ‚Üí open lead ‚Üí skip trace ‚Üí export ‚Üí log result</div>
        </div>
        <span class="pill yellow" id="draftPill">Draft: none</span>
      </div>

      <div class="cbody">

        <!-- QUEUE -->
        <div class="queueWrap">
          <div class="queueHdr">
            <div class="left">
              <div class="qtitle">Lead Queue</div>
              <div class="qsub"><span id="queueCount">0</span> leads ¬∑ click one to load</div>
            </div>
            <div class="row">
              <span class="badge cyan" id="queueMode">Local</span>
            </div>
          </div>
          <div class="queueBody">
            <div class="queueTools">
              <button class="btn small" id="btnImportJson">Import Leads JSON</button>
              <input class="fileInput" id="fileImport" type="file" accept="application/json" />
              <button class="btn small" id="btnSeedDemo">Seed Demo</button>
              <button class="btn small danger" id="btnClearQueue">Clear Queue</button>
            </div>

            <div class="queueList" id="queueList">
              <!-- items injected -->
            </div>

            <div class="mono mini">
              <b>Import format:</b> JSON array of leads (we‚Äôll standardize later).<br>
              Minimum per lead: <b>address</b>, <b>owner</b> (mailing optional).
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- KPIs -->
        <div class="grid3">
          <div class="kpi">
            <div class="n" id="kpiTraced">0</div>
            <div class="l">Leads Skip Traced</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiNums">0</div>
            <div class="l">Phone Numbers</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiReviewed">0</div>
            <div class="l">Needs Bill Review</div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Lead Intake -->
        <div class="row" style="justify-content:space-between;">
          <div class="title">LEAD INTAKE</div>
          <div class="row">
            <button class="btn small" id="btnNewLead">New Lead</button>
            <button class="btn small" id="btnSaveDraft">Save Draft</button>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="col">
          <div>
            <label>Property Address</label>
            <input id="addr" placeholder="214 W Mandalay Dr, San Antonio, TX">
          </div>

          <div class="grid2">
            <div>
              <label>Owner</label>
              <input id="owner" placeholder="FRANK ANAYA JR">
            </div>
            <div>
              <label>Mailing</label>
              <input id="mailing" placeholder="455 Clower, San Antonio, TX 78212">
            </div>
          </div>

          <div class="grid3">
            <div>
              <label>Source</label>
              <select id="source">
                <option>City Liens</option>
                <option>Foreclosure / Notice</option>
                <option>Probate / Estate</option>
                <option>Code Enforcement</option>
                <option>Golden Nug</option>
                <option>Wholesale Group Deal</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label>Priority</label>
              <select id="priority">
                <option>A (call today)</option>
                <option selected>B (call this week)</option>
                <option>C (low)</option>
              </select>
            </div>
            <div>
              <label>Absentee?</label>
              <select id="absentee">
                <option>Unknown</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Taxes / Red Flag</label>
              <input id="taxes" placeholder="e.g. ~$19,681 delinquent / or $0">
            </div>
            <div>
              <label>Deed / Clue</label>
              <input id="deed" placeholder="Interfamily transfer 7/15/2019 / Deed of Distribution">
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Skip Trace Output -->
        <div class="row" style="justify-content:space-between;">
          <div class="title">SKIP TRACE OUTPUT</div>
          <span class="pill cyan" id="confPill">Confidence: --</span>
        </div>

        <div style="height:10px;"></div>

        <div class="grid2">
          <div>
            <label>Phones (one per line)</label>
            <textarea id="phones" placeholder="(210) 827-8942&#10;(210) 555-0000"></textarea>
          </div>
          <div>
            <label>Verification Notes</label>
            <textarea id="vnotes" placeholder="Relatives checked / name match / age / wireless / VM / disconnects"></textarea>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Confidence</label>
            <select id="confidence">
              <option value="">--</option>
              <option value="‚úÖ Confirmed">‚úÖ Confirmed</option>
              <option value="‚ö†Ô∏è Likely">‚ö†Ô∏è Likely</option>
              <option value="‚ùå Bad Match">‚ùå Bad Match</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="status">
              <option>New</option>
              <option>Skip Traced</option>
              <option>Needs Bill Review</option>
              <option>Bad Match</option>
              <option>Called</option>
              <option>Texted</option>
            </select>
          </div>
          <div>
            <label>CAN / Link (optional)</label>
            <input id="can" placeholder="012470550110 or paste link">
          </div>
        </div>

        <div class="hr"></div>

        <!-- Export -->
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <button class="btn primary" id="btnCopyBill">Copy Bill Format (TAB)</button>
            <button class="btn" id="btnCopySummary">Copy Summary Note</button>
          </div>
          <div class="row">
            <button class="btn warn" id="btnDownloadJson">Download Lead JSON</button>
            <button class="btn" id="btnSaveToQueue">Save to Queue</button>
            <button class="btn" id="btnLogResult">Log + KPI</button>
          </div>
        </div>

        <div style="height:10px;"></div>
        <div class="mono mini" id="previewBox">
          <b>Preview:</b> fill fields to generate export.
        </div>

        <div class="hr"></div>

        <!-- Activity Log -->
        <div class="row" style="justify-content:space-between;">
          <div class="title">ACTIVITY (last 50)</div>
          <button class="btn small danger" id="btnClearLog">Clear Log</button>
        </div>
        <div style="height:10px;"></div>
        <textarea id="logBox" readonly style="min-height:140px;"></textarea>

      </div>
    </aside>

  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
  // -------------------------
  // STORAGE KEYS
  // -------------------------
  const KPI_KEY   = "db_lp_kpis_v1";
  const LOG_KEY   = "db_lp_log_v1";
  const DRAFT_KEY = "db_lp_draft_v1";
  const QUEUE_KEY = "db_lp_queue_v1";   // local queue store

  const toast = document.getElementById('toast');

  // -------------------------
  // HELPERS
  // -------------------------
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toast.classList.remove('show'), 1400);
  }

  function nowStamp(){
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${mm}/${dd}/${yy} ${hh}:${mi}`;
  }

  function cleanPhoneLines(s){
    return (s || "")
      .split(/\r?\n/)
      .map(x=>x.trim())
      .filter(Boolean);
  }

  function setClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    document.getElementById('clockPill').textContent = `${hh}:${mi}`;
  }
  setClock();
  setInterval(setClock, 15000);

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied to clipboard");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      showToast("Copied (fallback)");
    }
  }

  function downloadFile(filename, text, mime="application/json"){
    const blob = new Blob([text], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  // -------------------------
  // WORKSPACE IFRAME CONTROL
  // -------------------------
  const frame = document.getElementById('workFrame');
  const TOOL_URLS = {
    tps: "https://www.truepeoplesearch.com",
    bcad: "https://bexar.trueautomation.com/clientdb/propertysearch.aspx?cid=110",
    acttax: "https://bexar.acttax.com/act_webdev/bexar/index.jsp"
  };

  document.getElementById('btnTps').onclick = ()=> frame.src = TOOL_URLS.tps;
  document.getElementById('btnBc').onclick  = ()=> frame.src = TOOL_URLS.bcad;
  document.getElementById('btnTax').onclick = ()=> frame.src = TOOL_URLS.acttax;
  document.getElementById('btnClearFrame').onclick = ()=> frame.src = "about:blank";

  document.querySelectorAll('#leftNav a.navBtn').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const url = a.getAttribute('data-url');
      if(url && url !== "#"){
        frame.src = url;
        showToast("Opened in workspace");
      }
    });
  });

  // -------------------------
  // FORM FIELDS
  // -------------------------
  function el(id){ return document.getElementById(id); }

  const F = {
    addr: el('addr'), owner: el('owner'), mailing: el('mailing'),
    source: el('source'), priority: el('priority'), absentee: el('absentee'),
    taxes: el('taxes'), deed: el('deed'), phones: el('phones'), vnotes: el('vnotes'),
    confidence: el('confidence'), status: el('status'), can: el('can')
  };

  function syncConfidence(){
    const v = F.confidence.value || "--";
    document.getElementById('confPill').textContent = `Confidence: ${v}`;
  }
  F.confidence.addEventListener('change', syncConfidence);

  function buildBillExport(){
    // Owner \t Phone(s) \t Property \t Notes
    const owner = (F.owner.value || "").trim();
    const addr  = (F.addr.value  || "").trim();
    const phones = cleanPhoneLines(F.phones.value).join(", ");

    const notesBits = [];
    const absentee = F.absentee.value;
    const deed = (F.deed.value || "").trim();
    const taxes = (F.taxes.value || "").trim();
    const src = F.source.value;
    const pri = F.priority.value;
    const mailing = (F.mailing.value || "").trim();
    const conf = (F.confidence.value || "").trim();
    const vnotes = (F.vnotes.value || "").trim();
    const can = (F.can.value || "").trim();

    if(absentee && absentee !== "Unknown") notesBits.push(`Absentee: ${absentee}`);
    if(deed) notesBits.push(deed);
    if(taxes) notesBits.push(taxes);
    if(src) notesBits.push(`Source: ${src}`);
    if(pri) notesBits.push(`Priority: ${pri}`);
    if(mailing) notesBits.push(`Mailing: ${mailing}`);
    if(conf) notesBits.push(conf);
    if(can) notesBits.push(`CAN/Link: ${can}`);
    if(vnotes) notesBits.push(`Verify: ${vnotes}`);

    const notes = notesBits.join(" | ");
    return `${owner}\t${phones}\t${addr}\t${notes}`.trim();
  }

  function buildSummaryNote(){
    const owner = (F.owner.value || "").trim();
    const addr = (F.addr.value || "").trim();
    const phones = cleanPhoneLines(F.phones.value);
    const absentee = F.absentee.value;
    const deed = (F.deed.value || "").trim();
    const taxes = (F.taxes.value || "").trim();
    const src = F.source.value;
    const conf = (F.confidence.value || "").trim();
    const vnotes = (F.vnotes.value || "").trim();
    const mailing = (F.mailing.value || "").trim();

    const phoneLine = phones.length ? phones.join(" / ") : "(no phones yet)";
    const bits = [];
    if(absentee && absentee !== "Unknown") bits.push(`Absentee: ${absentee}`);
    if(deed) bits.push(deed);
    if(taxes) bits.push(taxes);
    if(src) bits.push(src);
    if(conf) bits.push(conf);

    return `${owner}
${phoneLine}
Property: ${addr}

Notes: ${bits.join(". ")}${vnotes ? `. ${vnotes}` : ""}${mailing ? `
Mailing: ${mailing}` : ""}`.trim();
  }

  function currentLeadObject(){
    const phones = cleanPhoneLines(F.phones.value);
    const canVal = (F.can.value || "").trim();

    // Stable-ish ID that we can replace later with Firebase push keys:
    const idSeed = `${(F.addr.value||"").trim()}|${(F.owner.value||"").trim()}`.toLowerCase();
    const id = "lp_" + hash32(idSeed);

    return {
      id,
      updatedAt: new Date().toISOString(),
      address: (F.addr.value||"").trim(),
      owner: (F.owner.value||"").trim(),
      mailing: (F.mailing.value||"").trim(),
      source: F.source.value,
      priority: F.priority.value,
      absentee: F.absentee.value,
      taxes: (F.taxes.value||"").trim(),
      deed: (F.deed.value||"").trim(),
      phones,
      verificationNotes: (F.vnotes.value||"").trim(),
      confidence: (F.confidence.value||"").trim(),
      status: F.status.value,
      canOrLink: canVal,
      billTabExport: buildBillExport(),
      summaryNote: buildSummaryNote()
    };
  }

  function loadLeadIntoForm(lead){
    F.addr.value = lead.address || "";
    F.owner.value = lead.owner || "";
    F.mailing.value = lead.mailing || "";
    F.source.value = lead.source || "City Liens";
    F.priority.value = lead.priority || "B (call this week)";
    F.absentee.value = lead.absentee || "Unknown";
    F.taxes.value = lead.taxes || "";
    F.deed.value = lead.deed || "";
    F.phones.value = (lead.phones || []).join("\n");
    F.vnotes.value = lead.verificationNotes || "";
    F.confidence.value = lead.confidence || "";
    F.status.value = lead.status || "New";
    F.can.value = lead.canOrLink || "";
    syncConfidence();
    updatePreview();
    document.getElementById('draftPill').textContent = `Draft: loaded from queue ${nowStamp()}`;
    showToast("Loaded lead into console");
  }

  function updatePreview(){
    const exp = buildBillExport();
    document.getElementById('previewBox').innerHTML =
      `<b>Preview (tab-delimited):</b><br><span class="mono">${escapeHtml(exp || "fill fields to generate export.")}</span>`;
  }

  Object.values(F).forEach(x=>{
    x.addEventListener('input', updatePreview);
    x.addEventListener('change', updatePreview);
  });
  updatePreview();

  // -------------------------
  // KPIs + LOG
  // -------------------------
  function loadKpis(){
    try{ return JSON.parse(localStorage.getItem(KPI_KEY)) || { traced:0, numbers:0, review:0 }; }
    catch(e){ return { traced:0, numbers:0, review:0 }; }
  }
  function saveKpis(k){ localStorage.setItem(KPI_KEY, JSON.stringify(k)); }
  function renderKpis(){
    const k = loadKpis();
    el('kpiTraced').textContent = k.traced;
    el('kpiNums').textContent = k.numbers;
    el('kpiReviewed').textContent = k.review;
    el('kpiPill').textContent = `KPI: ${k.traced} traced ¬∑ ${k.numbers} numbers`;
  }
  renderKpis();

  function loadLog(){
    try{ return JSON.parse(localStorage.getItem(LOG_KEY)) || []; }
    catch(e){ return []; }
  }
  function saveLog(items){ localStorage.setItem(LOG_KEY, JSON.stringify(items.slice(-50))); }
  function renderLog(){
    const items = loadLog();
    el('logBox').value = items.slice(-50).join("\n");
  }
  renderLog();

  // -------------------------
  // DRAFT
  // -------------------------
  function saveDraft(){
    const d = {};
    Object.keys(F).forEach(k=> d[k] = F[k].value);
    sessionStorage.setItem(DRAFT_KEY, JSON.stringify(d));
    el('draftPill').textContent = `Draft: saved ${nowStamp()}`;
    showToast("Draft saved");
  }
  function loadDraft(){
    try{
      const raw = sessionStorage.getItem(DRAFT_KEY);
      if(!raw) return false;
      const d = JSON.parse(raw);
      Object.keys(F).forEach(k=> { if(d[k] !== undefined) F[k].value = d[k]; });
      syncConfidence();
      updatePreview();
      el('draftPill').textContent = `Draft: loaded ${nowStamp()}`;
      return true;
    }catch(e){ return false; }
  }
  loadDraft();

  // -------------------------
  // QUEUE (LOCAL)
  // -------------------------
  function loadQueue(){
    try{ return JSON.parse(localStorage.getItem(QUEUE_KEY)) || []; }
    catch(e){ return []; }
  }
  function saveQueue(arr){
    localStorage.setItem(QUEUE_KEY, JSON.stringify(arr));
    renderQueue();
  }
  function upsertQueue(lead){
    const q = loadQueue();
    const idx = q.findIndex(x=>x.id === lead.id);
    if(idx >= 0) q[idx] = lead;
    else q.unshift(lead);
    saveQueue(q);
  }
  function clearQueue(){
    localStorage.removeItem(QUEUE_KEY);
    renderQueue();
  }

  function statusBadge(lead){
    const s = (lead.status || "New").toLowerCase();
    if(s.includes("review")) return "yellow";
    if(s.includes("bad")) return "red";
    if(s.includes("skip")) return "green";
    return "cyan";
  }

  function renderQueue(){
    const q = loadQueue();
    el('queueCount').textContent = q.length;
    const list = el('queueList');
    list.innerHTML = "";

    if(q.length === 0){
      const empty = document.createElement('div');
      empty.className = "mono mini";
      empty.textContent = "No leads yet. Import JSON or seed demo.";
      list.appendChild(empty);
      return;
    }

    q.forEach(lead=>{
      const item = document.createElement('div');
      item.className = "qItem";
      item.innerHTML = `
        <div class="qTop">
          <div class="qAddr">${escapeHtml(lead.address || "(no address)")}</div>
          <span class="badge ${statusBadge(lead)}">${escapeHtml(lead.status || "New")}</span>
        </div>
        <div class="qMeta">
          Owner: <b>${escapeHtml(lead.owner || "(unknown)")}</b><br>
          Source: ${escapeHtml(lead.source || "‚Äî")} ¬∑ Priority: ${escapeHtml(lead.priority || "‚Äî")}<br>
          Phones: ${(lead.phones||[]).length} ¬∑ Updated: ${escapeHtml((lead.updatedAt||"").slice(0,19).replace("T"," "))}
        </div>
      `;
      item.onclick = ()=> loadLeadIntoForm(lead);
      list.appendChild(item);
    });
  }
  renderQueue();

  // -------------------------
  // BUTTONS
  // -------------------------
  el('btnSaveDraft').onclick = saveDraft;

  el('btnNewLead').onclick = ()=>{
    if(!confirm("Clear this lead and start new?")) return;
    Object.values(F).forEach(x=> x.value = "");
    F.source.value = "City Liens";
    F.priority.value = "B (call this week)";
    F.absentee.value = "Unknown";
    F.status.value = "New";
    syncConfidence();
    updatePreview();
    sessionStorage.removeItem(DRAFT_KEY);
    el('draftPill').textContent = "Draft: none";
    showToast("New lead ready");
  };

  el('btnCopyBill').onclick = ()=>{
    const exp = buildBillExport();
    if(!exp.trim()){ showToast("Nothing to copy yet"); return; }
    copyToClipboard(exp);
  };

  el('btnCopySummary').onclick = ()=>{
    const note = buildSummaryNote();
    if(!note.trim()){ showToast("Nothing to copy yet"); return; }
    copyToClipboard(note);
  };

  el('btnSaveToQueue').onclick = ()=>{
    const lead = currentLeadObject();
    if(!lead.address || !lead.owner){
      showToast("Need at least Owner + Address");
      return;
    }
    upsertQueue(lead);
    el('draftPill').textContent = `Draft: saved to queue ${nowStamp()}`;
    showToast("Saved to queue");
  };

  el('btnDownloadJson').onclick = ()=>{
    const lead = currentLeadObject();
    if(!lead.address || !lead.owner){
      showToast("Need at least Owner + Address");
      return;
    }
    const safeAddr = (lead.address || "lead").replace(/[^a-z0-9]+/gi,"_").slice(0,40);
    downloadFile(`lead_${safeAddr}_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(lead, null, 2));
    showToast("Downloaded lead JSON");
  };

  el('btnLogResult').onclick = ()=>{
    const addr = (F.addr.value||"").trim();
    const owner = (F.owner.value||"").trim();
    if(!addr || !owner){
      showToast("Need at least Owner + Address");
      return;
    }

    const phones = cleanPhoneLines(F.phones.value);
    const conf = F.confidence.value || "--";
    const status = F.status.value || "New";
    const taxes = (F.taxes.value||"").trim();

    const k = loadKpis();
    const isTraced = ["Skip Traced","Needs Bill Review","Bad Match","Called","Texted"].includes(status);
    if(isTraced) k.traced += 1;
    k.numbers += phones.length;
    if(status === "Needs Bill Review") k.review += 1;
    saveKpis(k);
    renderKpis();

    const items = loadLog();
    items.push(`[${nowStamp()}] ${status} | ${conf} | ${owner} | ${addr} | phones:${phones.length}${taxes ? " | "+taxes : ""}`);
    saveLog(items);
    renderLog();

    // also persist in queue so status changes are remembered
    upsertQueue(currentLeadObject());

    showToast("Logged + KPI updated");
  };

  el('btnClearLog').onclick = ()=>{
    if(!confirm("Clear activity log?")) return;
    localStorage.removeItem(LOG_KEY);
    renderLog();
    showToast("Log cleared");
  };

  el('btnResetKpis').onclick = ()=>{
    if(!confirm("Reset KPIs to 0?")) return;
    localStorage.setItem(KPI_KEY, JSON.stringify({traced:0,numbers:0,review:0}));
    renderKpis();
    showToast("KPIs reset");
  };

  // CAN auto-link
  F.can.addEventListener('blur', ()=>{
    const v = (F.can.value||"").trim();
    if(/^\d{6,}$/.test(v)){
      F.can.value = "https://bexar.acttax.com/act_webdev/bexar/showdetail2.jsp?can=" + v;
      updatePreview();
    }
  });

  // Queue controls
  el('btnClearQueue').onclick = ()=>{
    if(!confirm("Clear lead queue?")) return;
    clearQueue();
    showToast("Queue cleared");
  };

  // Demo seed with your real example style
  el('btnSeedDemo').onclick = ()=>{
    const demo = [
      {
        id:"lp_demo_mandalay",
        updatedAt:new Date().toISOString(),
        address:"214 W Mandalay Dr, San Antonio, TX",
        owner:"FRANK ANAYA JR",
        mailing:"455 Clower, San Antonio, TX",
        source:"City Liens",
        priority:"B (call this week)",
        absentee:"Yes",
        taxes:"~$19,681 delinquent",
        deed:"Interfamily transfer 7/15/2019",
        phones:[],
        verificationNotes:"",
        confidence:"",
        status:"New",
        canOrLink:""
      },
      {
        id:"lp_demo_kings",
        updatedAt:new Date().toISOString(),
        address:"903 W Kings Hwy, San Antonio, TX 78201",
        owner:"JILL JEAN MALONEY",
        mailing:"1531 County Road 129 #4, Alvin, TX 77511-1466",
        source:"Probate / Estate",
        priority:"A (call today)",
        absentee:"Yes",
        taxes:"~$34k delinquent taxes",
        deed:"Deed of Distribution",
        phones:["(832) 693-4674","(832) 518-0779"],
        verificationNotes:"Jemmy Dwyer (45) went VM then disconnects; Thomas Maloney (68) rings",
        confidence:"‚ö†Ô∏è Likely",
        status:"Skip Traced",
        canOrLink:"https://bexar.acttax.com/act_webdev/bexar/showdetail2.jsp?can=017870120470"
      }
    ];
    const q = loadQueue();
    saveQueue(demo.concat(q));
    showToast("Seeded demo leads");
  };

  // Import JSON
  el('btnImportJson').onclick = ()=> el('fileImport').click();
  el('fileImport').addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    try{
      const text = await file.text();
      const data = JSON.parse(text);

      const leads = Array.isArray(data) ? data : [data];
      const normalized = leads.map(x=> normalizeImportedLead(x)).filter(Boolean);

      const q = loadQueue();
      saveQueue(normalized.concat(q));
      showToast(`Imported ${normalized.length} lead(s)`);
    }catch(err){
      console.error(err);
      showToast("Import failed: invalid JSON");
    }finally{
      e.target.value = "";
    }
  });

  function normalizeImportedLead(x){
    if(!x) return null;

    // Accept either your sheet-ish naming or a future standardized one.
    const address = (x.address || x.Address || x.property || x.location || "").toString().trim();
    const owner   = (x.owner || x.Owner || x.name || "").toString().trim();

    if(!address || !owner) return null;

    const idSeed = `${address}|${owner}`.toLowerCase();
    const id = x.id || ("lp_" + hash32(idSeed));

    const phonesRaw = x.phones || x.Phones || x.phone || x.Phone || [];
    const phones = Array.isArray(phonesRaw)
      ? phonesRaw.map(s=>String(s).trim()).filter(Boolean)
      : String(phonesRaw).split(/[,;\n]/).map(s=>s.trim()).filter(Boolean);

    return {
      id,
      updatedAt: new Date().toISOString(),
      address,
      owner,
      mailing: (x.mailing || x.Mailing || x.mail || "").toString().trim(),
      source: (x.source || x.Source || "City Liens").toString().trim(),
      priority: (x.priority || x.Priority || "B (call this week)").toString().trim(),
      absentee: (x.absentee || x.Absentee || "Unknown").toString().trim(),
      taxes: (x.taxes || x.Taxes || "").toString().trim(),
      deed: (x.deed || x.Deed || "").toString().trim(),
      phones,
      verificationNotes: (x.verificationNotes || x.verify || x.Notes || "").toString().trim(),
      confidence: (x.confidence || x.Confidence || "").toString().trim(),
      status: (x.status || x.Status || "New").toString().trim(),
      canOrLink: (x.canOrLink || x.can || x.link || "").toString().trim()
    };
  }

  // Simple deterministic hash for local IDs
  function hash32(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0).toString(16);
  }
</script>
</body>
</html>
