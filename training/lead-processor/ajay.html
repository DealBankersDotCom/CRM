<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deal Bankers // Internal Ops Console (Lead Processor)</title>

  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070a0f;
      --panel:#0b0f16;
      --panel2:#0d121b;
      --line:#1c2a3d;
      --ink:#e9f2ff;
      --muted:#9bb2d3;
      --cyan:#59d3ff;
      --cyan2:#2bbcff;
      --green:#2ee59d;
      --yellow:#ffd166;
      --red:#ff4d4d;
      --shadow:0 18px 46px rgba(0,0,0,.60);
      --shadow2:0 12px 28px rgba(0,0,0,.50);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --orbit: "Orbitron", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --hdrH: 68px;
      --floatHdrH: 58px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      min-height:100vh;
      color:var(--ink);
      font-family:var(--sans);
      background:
        radial-gradient(900px 520px at 18% 14%, rgba(89,211,255,.16), transparent 55%),
        radial-gradient(780px 420px at 82% 20%, rgba(46,229,157,.10), transparent 55%),
        linear-gradient(180deg, #05070c, #070a0f);
      overflow:hidden;
    }

    /* =====================================================
       TOP BAR
    ====================================================== */
    header{
      position:fixed; top:0; left:0; right:0; z-index:60;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.92), rgba(13,18,27,.72));
      backdrop-filter: blur(10px);
      height: var(--hdrH);
    }

    .brand{display:flex; gap:12px; align-items:center; user-select:none}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(89,211,255,.25), rgba(46,229,157,.18));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 26px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--orbit); font-weight:900;
      letter-spacing:.08em;
      cursor:pointer;
    }
    .t1{
      font-family:var(--orbit);
      font-weight:900; letter-spacing:.12em;
      text-transform:uppercase; font-size:13px;
      line-height:1.1;
    }
    .t2{
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
      line-height:1.1;
    }
    .hdrRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}

    .pill{
      font-family:var(--mono);
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,15,.45);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.cyan{border-color: rgba(89,211,255,.35); color:#dff6ff;}
    .pill.green{border-color: rgba(46,229,157,.35); color:#dcfff0;}

    .btn{
      font-family:var(--mono);
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.40);
      color:var(--ink);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .btn:hover{border-color: rgba(89,211,255,.55)}
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:7px 10px; font-size:11px; border-radius:10px;}
    .btn.primary{border-color: rgba(46,229,157,.45)}
    .btn.primary:hover{border-color: rgba(46,229,157,.75)}
    .btn.danger{border-color: rgba(255,77,77,.45)}
    .btn.danger:hover{border-color: rgba(255,77,77,.75)}

    /* =====================================================
       APP LAYOUT
    ====================================================== */
    .app{
      position:absolute;
      top: var(--hdrH);
      left:0; right:0; bottom:0;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap:14px;
      padding:14px;
    }

    /* LEFT: BIG SIMPLE BUTTONS */
    .side{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.90), rgba(13,18,27,.62));
      box-shadow: var(--shadow);
      padding:14px;
      overflow:auto;
    }

    .bigBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:18px 14px;
      min-height:62px;
      border-radius:18px;
      border:1px solid rgba(89,211,255,.55);
      background:
        radial-gradient(280px 160px at 14% 20%, rgba(89,211,255,.16), transparent 58%),
        linear-gradient(180deg, rgba(7,10,15,.55), rgba(7,10,15,.20));
      color:#bfefff;
      font-family:var(--orbit);
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 0 0 1px rgba(0,0,0,.35) inset;
      transition: transform .08s ease, border-color .12s ease, box-shadow .12s ease, color .12s ease;
      margin-bottom:12px;
    }
    .bigBtn:hover{
      border-color: rgba(89,211,255,.95);
      box-shadow: 0 0 0 3px rgba(89,211,255,.16) inset, 0 16px 26px rgba(0,0,0,.25);
      color:#001018;
      background:
        radial-gradient(280px 160px at 14% 20%, rgba(89,211,255,.28), transparent 58%),
        linear-gradient(180deg, rgba(89,211,255,.95), rgba(89,211,255,.70));
    }
    .bigBtn:active{transform: translateY(1px)}
    .bigBtn .ico{font-size:16px}

    /* RIGHT: WORKSPACE */
    .workspace{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.90), rgba(13,18,27,.62));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-width: 0;
    }
    .wHdr{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .wTitle{
      font-family:var(--orbit);
      font-weight:900; letter-spacing:.12em;
      text-transform:uppercase;
      font-size:12px;
    }
    .wHdrLeft{display:flex; flex-direction:column}
    .wHdrRight{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    iframe{
      width:100%;
      height: calc(100% - 56px);
      border:0;
      background: rgba(7,10,15,.35);
    }

    /* Loader (inside workspace) */
    .loader{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(89,211,255,.45);
      background: rgba(0,0,0,.62);
      box-shadow: 0 0 18px rgba(89,211,255,.18);
      font-family:var(--orbit);
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:12px;
      color:#bfefff;
      display:none;
      z-index: 5;
      user-select:none;
    }
    .loader.show{display:block;}

    /* Toast */
    .toast{
      position:fixed; right:14px; bottom:14px;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(13,18,27,.88);
      font-family:var(--mono); font-size:12px;
      opacity:0; transform: translateY(8px);
      transition: all .18s ease;
      pointer-events:none;
      max-width: 520px;
      white-space: pre-line;
      z-index:9999;
    }
    .toast.show{opacity:1; transform: translateY(0)}

    /* =====================================================
       FLOATING "CURRENT LEAD" WINDOW
    ====================================================== */
    .floatLead{
      position:absolute;
      left:330px;
      top:92px;
      width:420px;
      height:640px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(13,18,27,.95), rgba(13,18,27,.78));
      box-shadow: var(--shadow2);
      z-index:80;
      overflow:hidden;
      resize: both;
      min-width: 320px;
      min-height: 420px;
      max-width: min(860px, calc(100vw - 28px));
      max-height: calc(100vh - (var(--hdrH) + 28px));
    }

    .floatLead.min{
      height: var(--floatHdrH) !important;
      min-height: var(--floatHdrH) !important;
      resize: none !important;
    }

    .floatHdr{
      height: var(--floatHdrH);
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(7,10,15,.38), rgba(7,10,15,.14));
      cursor:grab;
      user-select:none;
    }
    .floatHdr:active{cursor:grabbing;}

    .floatHdr .leftBits{
      display:flex; flex-direction:column; line-height:1.12;
    }
    .floatHdr .leftBits b{
      font-family:var(--orbit);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:11px;
    }
    .floatHdr .leftBits span{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .floatHdr .controls{display:flex; gap:8px; align-items:center;}

    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.35);
      color:var(--ink);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-family:var(--mono);
      font-size:12px;
    }
    .iconBtn:hover{border-color: rgba(89,211,255,.55)}
    .iconBtn:active{transform: translateY(1px)}

    .floatBody{
      padding:12px;
      height: calc(100% - var(--floatHdrH));
      overflow:auto;
    }

    label{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.45);
      color:var(--ink);
      padding:10px 11px;
      outline:none;
      font-family:var(--mono);
      font-size:12px;
    }
    textarea{min-height:88px; resize:vertical; line-height:1.45;}
    input:focus, textarea:focus, select:focus{border-color: rgba(89,211,255,.65)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0;}
    .title{
      font-family:var(--orbit);
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:12px;
    }
    .mini{font-size:11px; color:var(--muted); font-family:var(--mono); line-height:1.45;}

    .kpiRow{display:flex; gap:10px; flex-wrap:wrap}
    .kpi{
      flex:1;
      min-width: 120px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,15,.35);
      padding:10px;
    }
    .kpi .n{font-family:var(--mono); font-size:18px; font-weight:900}
    .kpi .l{font-family:var(--mono); font-size:11px; color:var(--muted); margin-top:4px}

    .preview{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,15,.30);
      padding:10px;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      white-space:pre-wrap;
      line-height:1.45;
    }

    @media (max-width: 980px){
      .app{grid-template-columns: 1fr;}
      .side{display:none;}
      .floatLead{left:14px; top:82px;}
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo" id="brandLogo" title="DealBankers.com">DB</div>
    <div>
      <div class="t1">Deal Bankers // Internal Ops Console</div>
      <div class="t2">Lead Processor Station ¬∑ BIG tools + floating lead</div>
    </div>
  </div>

  <div class="hdrRight">
    <span class="pill cyan" id="clockPill">--:--</span>
    <span class="pill green" id="kpiPill">KPI: 0 traced ¬∑ 0 numbers</span>
    <button class="btn small" id="btnBringToFront">Lead Window: Front</button>
    <button class="btn small" id="btnResetKpis">Reset KPIs</button>
  </div>
</header>

<div class="app">
  <!-- LEFT: BIG BUTTONS -->
  <aside class="side">
    <button class="bigBtn" data-url="https://bexar.tx.publicsearch.us/">
      <span class="ico">üìú</span><span>County Clerk Portal</span>
    </button>

    <button class="bigBtn" data-url="https://bexar.tx.publicsearch.us/results?department=RP&docTypes=LIEN&limit=50&offset=0&parties=%7B%22grantee%22%3A%5B%7B%22term%22%3A%22San%20Antonio%22%2C%22types%22%3A%5B%22grantee%22%5D%7D%5D%7D&recordedDateRange=18000101%2C20251001&searchType=advancedSearch&sort=desc&sortBy=recordedDate">
      <span class="ico">üèõÔ∏è</span><span>City Liens Search</span>
    </button>

    <button class="bigBtn" data-url="https://bexar.trueautomation.com/clientdb/propertysearch.aspx?cid=110">
      <span class="ico">üè†</span><span>BCAD Property Search</span>
    </button>

    <button class="bigBtn" data-url="https://bexar.acttax.com/act_webdev/bexar/index.jsp">
      <span class="ico">üí∞</span><span>Tax Assessor</span>
    </button>

    <button class="bigBtn" data-url="https://www.google.com/maps/d/embed?mid=1I6zf3DbwJ9kgNP8kCnEa0jb7FUtfoDo&ll=29.444831639713456,-98.50898675&z=11">
      <span class="ico">üó∫Ô∏è</span><span>City Lien Leads Map</span>
    </button>

    <button class="bigBtn" data-url="https://docs.google.com/spreadsheets/d/1ZZATvHr9pfa6s4aQ-y0XxZZ6wLKMuM2HORz8LsGAMLE/edit?gid=187512055#gid=187512055">
      <span class="ico">üìä</span><span>QR Database</span>
    </button>

    <button class="bigBtn" data-url="https://www.zillow.com/">
      <span class="ico">üè°</span><span>Zillow</span>
    </button>

    <button class="bigBtn" data-url="https://www.truepeoplesearch.com">
      <span class="ico">üîé</span><span>Skip Trace</span>
    </button>
  </aside>

  <!-- WORKSPACE -->
  <section class="workspace">
    <div class="wHdr">
      <div class="wHdrLeft">
        <div class="wTitle">Workspace</div>
      </div>
      <div class="wHdrRight">
        <button class="btn small" id="btnTps">TPS</button>
        <button class="btn small" id="btnBc">BCAD</button>
        <button class="btn small" id="btnTax">ACTTax</button>
        <button class="btn small" id="btnClearFrame">Clear</button>
      </div>
    </div>

    <div class="loader" id="loader">LOADING‚Ä¶</div>
    <iframe id="workFrame" src="https://www.truepeoplesearch.com" title="workspace"></iframe>

    <!-- FLOATING LEAD WINDOW -->
    <div class="floatLead" id="leadFloat">
      <div class="floatHdr" id="leadFloatHeader">
        <div class="leftBits">
          <b>Current Lead</b>
          <span id="leadIndexPill">Queue: 0 / 0</span>
        </div>
        <div class="controls">
          <button class="iconBtn" id="btnPrev" title="Previous lead">‚óÄ</button>
          <button class="iconBtn" id="btnNext" title="Next lead">‚ñ∂</button>
          <button class="iconBtn" id="btnCenter" title="Center window">‚åñ</button>
          <button class="iconBtn" id="btnMin" title="Minimize / Restore">‚Äî</button>
        </div>
      </div>

      <div class="floatBody" id="leadFloatBody">
        <!-- KPIs -->
        <div class="kpiRow">
          <div class="kpi">
            <div class="n" id="kpiTraced">0</div>
            <div class="l">Leads traced</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiNums">0</div>
            <div class="l">Phone numbers</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiReviewed">0</div>
            <div class="l">Needs review</div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Lead Queue Loader -->
        <div class="title">Lead Queue</div>
        <div class="mini">
          Paste leads (one per line). Format:
          <br><b>owner | property address | mailing</b>
        </div>
        <div style="height:8px;"></div>
        <textarea id="queueBox" placeholder="OWNER | PROPERTY | MAILING&#10;OWNER | PROPERTY | MAILING"></textarea>
        <div class="grid2" style="margin-top:10px;">
          <button class="btn primary" id="btnLoadQueue">Load Queue</button>
          <button class="btn danger" id="btnClearQueue">Clear Queue</button>
        </div>

        <div class="hr"></div>

        <!-- Lead Intake -->
        <div class="title">Lead Intake</div>
        <div style="height:10px;"></div>

        <div>
          <label>Property Address</label>
          <input id="addr" placeholder="214 W Mandalay Dr, San Antonio, TX">
        </div>

        <div class="grid2">
          <div>
            <label>Owner</label>
            <input id="owner" placeholder="FRANK ANAYA JR">
          </div>
          <div>
            <label>Mailing</label>
            <input id="mailing" placeholder="455 Clower, San Antonio, TX 78212">
          </div>
        </div>

        <div class="grid3">
          <div>
            <label>Source</label>
            <select id="source">
              <option>City Liens</option>
              <option>Foreclosure / Notice</option>
              <option>Probate / Estate</option>
              <option>Code Enforcement</option>
              <option>Golden Nug</option>
              <option>Wholesale Group Deal</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label>Priority</label>
            <select id="priority">
              <option>A (call today)</option>
              <option selected>B (call this week)</option>
              <option>C (low)</option>
            </select>
          </div>
          <div>
            <label>Absentee?</label>
            <select id="absentee">
              <option>Unknown</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Taxes / Red Flag</label>
            <input id="taxes" placeholder="e.g. ~$19,681 delinquent / or $0">
          </div>
          <div>
            <label>Deed / Clue</label>
            <input id="deed" placeholder="Interfamily transfer 7/15/2019 / Trustee‚Äôs deed">
          </div>
        </div>

        <div class="hr"></div>

        <div class="title">Skip Trace Output</div>
        <div style="height:10px;"></div>

        <div class="grid2">
          <div>
            <label>Phones (one per line)</label>
            <textarea id="phones" placeholder="(210) 827-8942&#10;(210) 555-0000"></textarea>
          </div>
          <div>
            <label>Verification Notes</label>
            <textarea id="vnotes" placeholder="Relatives checked / name match / age / wireless / VM / disconnects"></textarea>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Confidence</label>
            <select id="confidence">
              <option value="">--</option>
              <option value="‚úÖ Confirmed">‚úÖ Confirmed</option>
              <option value="‚ö†Ô∏è Likely">‚ö†Ô∏è Likely</option>
              <option value="‚ùå Bad Match">‚ùå Bad Match</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="status">
              <option>New</option>
              <option>Skip Traced</option>
              <option>Needs Bill Review</option>
              <option>Bad Match</option>
              <option>Called</option>
              <option>Texted</option>
            </select>
          </div>
          <div>
            <label>CAN / Link (optional)</label>
            <input id="can" placeholder="012470550110 or paste link">
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <button class="btn primary" id="btnCopyBill">Copy Bill Format (TAB)</button>
          <button class="btn" id="btnCopySummary">Copy Summary Note</button>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <button class="btn" id="btnSaveDraft">Save Draft</button>
          <button class="btn" id="btnLogResult">Log Result + KPI</button>
        </div>

        <div style="height:10px;"></div>
        <div class="preview" id="previewBox">Preview: fill fields‚Ä¶</div>

        <div class="hr"></div>

        <div class="title">Activity</div>
        <div style="height:8px;"></div>
        <textarea id="logBox" readonly style="min-height:120px;"></textarea>
      </div>
    </div>
  </section>
</div>

<div class="toast" id="toast">Saved</div>

<script>
  // =========================================================
  // Helpers
  // =========================================================
  const toast = document.getElementById('toast');
  const loader = document.getElementById('loader');
  const el = (id)=>document.getElementById(id);

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toast.classList.remove('show'), 1400);
  }
  function nowStamp(){
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${mm}/${dd}/${yy} ${hh}:${mi}`;
  }
  function cleanPhoneLines(s){
    return (s||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  }

  // Brand click
  el('brandLogo').addEventListener('click', ()=> window.open('https://dealbankers.com','_blank'));

  // Clock
  function setClock(){
    const d = new Date();
    el('clockPill').textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  setClock(); setInterval(setClock, 15000);

  // =========================================================
  // Workspace
  // =========================================================
  const frame = el('workFrame');
  const TOOL_URLS = {
    tps: "https://www.truepeoplesearch.com",
    bcad: "https://bexar.trueautomation.com/clientdb/propertysearch.aspx?cid=110",
    acttax: "https://bexar.acttax.com/act_webdev/bexar/index.jsp"
  };

  function openInWorkspace(url, label){
    loader.classList.add('show');
    frame.src = url;
    if(label) showToast(label);
  }

  frame.addEventListener('load', ()=> loader.classList.remove('show'));

  el('btnTps').onclick = ()=> openInWorkspace(TOOL_URLS.tps, "TPS opened");
  el('btnBc').onclick  = ()=> openInWorkspace(TOOL_URLS.bcad, "BCAD opened");
  el('btnTax').onclick = ()=> openInWorkspace(TOOL_URLS.acttax, "ACTTax opened");
  el('btnClearFrame').onclick = ()=>{
    loader.classList.remove('show');
    frame.src = "about:blank";
    showToast("Workspace cleared");
  };

  // Sidebar big buttons -> open in iframe
  document.querySelectorAll('.bigBtn[data-url]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const url = btn.getAttribute('data-url');
      openInWorkspace(url, "Opened in workspace");
    });
  });

  // =========================================================
  // Floating lead window: drag + state
  // =========================================================
  const leadFloat = el('leadFloat');
  const leadHdr   = el('leadFloatHeader');
  const leadBody  = el('leadFloatBody');

  // bring to front
  function bringToFront(){
    const prev = leadFloat.style.zIndex;
    leadFloat.style.zIndex = 9999;
    setTimeout(()=> leadFloat.style.zIndex = prev || 80, 250);
  }
  el('btnBringToFront').onclick = bringToFront;

  // drag
  let drag = {on:false, dx:0, dy:0};
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  leadHdr.addEventListener('mousedown', (e)=>{
    if(e.target.closest('button')) return;
    drag.on = true;
    const r = leadFloat.getBoundingClientRect();
    drag.dx = e.clientX - r.left;
    drag.dy = e.clientY - r.top;
    leadHdr.style.cursor = "grabbing";
    bringToFront();
  });

  window.addEventListener('mousemove', (e)=>{
    if(!drag.on) return;
    const r = leadFloat.getBoundingClientRect();
    const w = r.width, h = r.height;
    let x = e.clientX - drag.dx;
    let y = e.clientY - drag.dy;
    x = clamp(x, 10, window.innerWidth - w - 10);
    y = clamp(y, 80, window.innerHeight - h - 10);
    leadFloat.style.left = x + "px";
    leadFloat.style.top  = y + "px";
  });

  window.addEventListener('mouseup', ()=>{
    if(!drag.on) return;
    drag.on = false;
    leadHdr.style.cursor = "grab";
    saveFloat();
  });

  // center
  el('btnCenter').onclick = ()=>{
    const r = leadFloat.getBoundingClientRect();
    leadFloat.style.left = Math.max(10, (window.innerWidth - r.width)/2) + "px";
    leadFloat.style.top  = Math.max(80, (window.innerHeight - r.height)/2) + "px";
    saveFloat();
    showToast("Centered");
  };

  // minimize / restore (fixed)
  const FLOAT_KEY = "db_lp_float_v2";
  let minimized = false;
  let lastExpandedH = null;  // px

  function loadFloat(){
    try{ return JSON.parse(localStorage.getItem(FLOAT_KEY)); }catch(e){ return null; }
  }

  function saveFloat(){
    const r = leadFloat.getBoundingClientRect();
    const data = {
      x: r.left,
      y: r.top,
      w: r.width,
      minimized: minimized,
      expandedH: lastExpandedH ?? (minimized ? null : r.height)
    };

    // If not minimized, update expandedH from current height
    if(!minimized){
      data.expandedH = r.height;
      lastExpandedH = r.height;
    }

    localStorage.setItem(FLOAT_KEY, JSON.stringify(data));
  }

  function applyFloatState(d){
    if(!d) return;
    if(typeof d.x === "number") leadFloat.style.left = d.x + "px";
    if(typeof d.y === "number") leadFloat.style.top  = d.y + "px";
    if(typeof d.w === "number") leadFloat.style.width = d.w + "px";

    if(typeof d.expandedH === "number") lastExpandedH = d.expandedH;

    minimized = !!d.minimized;
    if(minimized){
      leadFloat.classList.add('min');
      leadBody.style.display = "none";
    }else{
      leadFloat.classList.remove('min');
      leadBody.style.display = "block";
      if(typeof lastExpandedH === "number") leadFloat.style.height = lastExpandedH + "px";
    }
  }

  // init float state
  (function initFloat(){
    const d = loadFloat();
    applyFloatState(d);
  })();

  el('btnMin').onclick = ()=>{
    if(!minimized){
      // capture expanded height BEFORE minimizing
      const r = leadFloat.getBoundingClientRect();
      lastExpandedH = r.height;
      minimized = true;
      leadFloat.classList.add('min');
      leadBody.style.display = "none";
      showToast("Minimized");
    }else{
      minimized = false;
      leadFloat.classList.remove('min');
      leadBody.style.display = "block";
      if(typeof lastExpandedH === "number") leadFloat.style.height = lastExpandedH + "px";
      showToast("Restored");
    }
    saveFloat();
    bringToFront();
  };

  // save on resize (user drags corner) ‚Äî but don't overwrite while minimized
  const ro = new ResizeObserver(()=>{
    if(minimized) return;
    saveFloat();
  });
  ro.observe(leadFloat);

  // =========================================================
  // Lead form logic
  // =========================================================
  const KPI_KEY = "db_lp_kpis_v1";
  const LOG_KEY = "db_lp_log_v1";
  const DRAFT_KEY = "db_lp_draft_v1";

  const F = {
    addr: el('addr'), owner: el('owner'), mailing: el('mailing'),
    source: el('source'), priority: el('priority'), absentee: el('absentee'),
    taxes: el('taxes'), deed: el('deed'), phones: el('phones'), vnotes: el('vnotes'),
    confidence: el('confidence'), status: el('status'), can: el('can'),
  };

  function buildBillExport(){
    const owner = (F.owner.value||"").trim();
    const addr  = (F.addr.value||"").trim();
    const phones = cleanPhoneLines(F.phones.value).join(", ");
    const notesBits = [];

    const absentee = F.absentee.value;
    const deed = (F.deed.value||"").trim();
    const taxes = (F.taxes.value||"").trim();
    const src = F.source.value;
    const pri = F.priority.value;
    const mailing = (F.mailing.value||"").trim();
    const conf = (F.confidence.value||"").trim();
    const vnotes = (F.vnotes.value||"").trim();
    const can = (F.can.value||"").trim();

    if(absentee && absentee !== "Unknown") notesBits.push(`Absentee: ${absentee}`);
    if(deed) notesBits.push(deed);
    if(taxes) notesBits.push(taxes);
    if(src) notesBits.push(`Source: ${src}`);
    if(pri) notesBits.push(`Priority: ${pri}`);
    if(mailing) notesBits.push(`Mailing: ${mailing}`);
    if(conf) notesBits.push(conf);
    if(can) notesBits.push(`CAN/Link: ${can}`);
    if(vnotes) notesBits.push(`Verify: ${vnotes}`);

    return `${owner}\t${phones}\t${addr}\t${notesBits.join(" | ")}`.trim();
  }

  function buildSummaryNote(){
    const owner = (F.owner.value||"").trim();
    const addr = (F.addr.value||"").trim();
    const phones = cleanPhoneLines(F.phones.value);
    const absentee = F.absentee.value;
    const deed = (F.deed.value||"").trim();
    const taxes = (F.taxes.value||"").trim();
    const src = F.source.value;
    const conf = (F.confidence.value||"").trim();
    const vnotes = (F.vnotes.value||"").trim();
    const mailing = (F.mailing.value||"").trim();
    const phoneLine = phones.length ? phones.join(" / ") : "(no phones yet)";

    const bits = [];
    if(absentee && absentee !== "Unknown") bits.push(`Absentee: ${absentee}`);
    if(deed) bits.push(deed);
    if(taxes) bits.push(taxes);
    if(src) bits.push(src);
    if(conf) bits.push(conf);

    return `${owner}\n${phoneLine}\nProperty: ${addr}\n\nNotes: ${bits.join(". ")}${vnotes ? `. ${vnotes}` : ""}${mailing ? `\nMailing: ${mailing}` : ""}`.trim();
  }

  function updatePreview(){
    const exp = buildBillExport();
    el('previewBox').textContent = exp ? `Preview (TAB):\n${exp}` : "Preview: fill fields‚Ä¶";
  }

  Object.values(F).forEach(x=>{
    x.addEventListener('input', updatePreview);
    x.addEventListener('change', updatePreview);
  });
  updatePreview();

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); ta.remove();
      showToast("Copied (fallback)");
    }
  }

  el('btnCopyBill').onclick = ()=>{
    const t = buildBillExport();
    if(!t.trim()) return showToast("Nothing to copy");
    copyToClipboard(t);
  };
  el('btnCopySummary').onclick = ()=>{
    const t = buildSummaryNote();
    if(!t.trim()) return showToast("Nothing to copy");
    copyToClipboard(t);
  };

  function loadKpis(){
    try{ return JSON.parse(localStorage.getItem(KPI_KEY)) || { traced:0, numbers:0, review:0 }; }
    catch(e){ return { traced:0, numbers:0, review:0 }; }
  }
  function saveKpis(k){ localStorage.setItem(KPI_KEY, JSON.stringify(k)); }
  function renderKpis(){
    const k = loadKpis();
    el('kpiTraced').textContent = k.traced;
    el('kpiNums').textContent = k.numbers;
    el('kpiReviewed').textContent = k.review;
    el('kpiPill').textContent = `KPI: ${k.traced} traced ¬∑ ${k.numbers} numbers`;
  }
  renderKpis();

  function loadLog(){
    try{ return JSON.parse(localStorage.getItem(LOG_KEY)) || []; }
    catch(e){ return []; }
  }
  function saveLog(items){ localStorage.setItem(LOG_KEY, JSON.stringify(items.slice(-50))); }
  function renderLog(){
    el('logBox').value = loadLog().slice(-50).join("\n");
  }
  renderLog();

  el('btnLogResult').onclick = ()=>{
    const addr = (F.addr.value||"").trim();
    const owner = (F.owner.value||"").trim();
    if(!addr || !owner) return showToast("Need Owner + Address");

    const phones = cleanPhoneLines(F.phones.value);
    const status = F.status.value || "New";
    const conf = F.confidence.value || "--";
    const taxes = (F.taxes.value||"").trim();

    const k = loadKpis();
    const isTraced = ["Skip Traced","Needs Bill Review","Bad Match","Called","Texted"].includes(status);
    if(isTraced) k.traced += 1;
    k.numbers += phones.length;
    if(status === "Needs Bill Review") k.review += 1;
    saveKpis(k);
    renderKpis();

    const items = loadLog();
    items.push(`[${nowStamp()}] ${status} | ${conf} | ${owner} | ${addr} | phones:${phones.length}${taxes ? " | "+taxes : ""}`);
    saveLog(items);
    renderLog();

    showToast("Logged + KPI");
  };

  el('btnResetKpis').onclick = ()=>{
    if(!confirm("Reset KPIs to 0?")) return;
    localStorage.setItem(KPI_KEY, JSON.stringify({traced:0,numbers:0,review:0}));
    renderKpis();
    showToast("KPIs reset");
  };

  el('btnSaveDraft').onclick = ()=>{
    const d = {}; Object.keys(F).forEach(k=> d[k] = F[k].value);
    sessionStorage.setItem(DRAFT_KEY, JSON.stringify(d));
    showToast("Draft saved");
  };

  // CAN -> link
  F.can.addEventListener('blur', ()=>{
    const v = (F.can.value||"").trim();
    if(/^\d{6,}$/.test(v)){
      F.can.value = "https://bexar.acttax.com/act_webdev/bexar/showdetail2.jsp?can=" + v;
      updatePreview();
    }
  });

  // =========================================================
  // Lead Queue: Next/Prev + load current lead into form
  // =========================================================
  const QUEUE_KEY = "db_lp_queue_v1";
  let queue = [];
  let idx = -1;

  function parseQueue(text){
    const lines = (text||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    return lines.map(line=>{
      const parts = line.split("|").map(s=>s.trim());
      return {
        owner: parts[0] || "",
        addr:  parts[1] || "",
        mailing: parts[2] || ""
      };
    });
  }

  function setQueuePill(){
    el('leadIndexPill').textContent = `Queue: ${queue.length ? (idx+1) : 0} / ${queue.length}`;
  }

  function loadLead(i){
    if(!queue.length) return;
    idx = Math.max(0, Math.min(queue.length-1, i));
    const L = queue[idx];

    // Only set key intake fields; do not wipe skip-trace fields automatically.
    F.owner.value = L.owner || "";
    F.addr.value = L.addr || "";
    F.mailing.value = L.mailing || "";

    updatePreview();
    setQueuePill();
    saveQueueState();
    showToast("Lead loaded");
  }

  function saveQueueState(){
    localStorage.setItem(QUEUE_KEY, JSON.stringify({ queue, idx, raw: el('queueBox').value }));
  }

  function loadQueueState(){
    try{
      const d = JSON.parse(localStorage.getItem(QUEUE_KEY));
      if(!d) return;
      queue = Array.isArray(d.queue) ? d.queue : [];
      idx = typeof d.idx === "number" ? d.idx : -1;
      if(typeof d.raw === "string") el('queueBox').value = d.raw;
      setQueuePill();
      if(queue.length && idx >= 0) loadLead(idx);
    }catch(e){}
  }
  loadQueueState();

  el('btnLoadQueue').onclick = ()=>{
    queue = parseQueue(el('queueBox').value);
    idx = queue.length ? 0 : -1;
    saveQueueState();
    setQueuePill();
    if(queue.length) loadLead(0);
    showToast(queue.length ? `Queue loaded: ${queue.length}` : "Queue empty");
  };

  el('btnClearQueue').onclick = ()=>{
    if(!confirm("Clear the queue?")) return;
    queue = []; idx = -1;
    el('queueBox').value = "";
    localStorage.removeItem(QUEUE_KEY);
    setQueuePill();
    showToast("Queue cleared");
  };

  el('btnNext').onclick = ()=>{ if(queue.length) loadLead(idx+1); };
  el('btnPrev').onclick = ()=>{ if(queue.length) loadLead(idx-1); };

  // Keyboard shortcuts (when not typing)
  window.addEventListener('keydown', (e)=>{
    const tag = (document.activeElement && document.activeElement.tagName) || "";
    if(["INPUT","TEXTAREA","SELECT"].includes(tag)) return;
    if(e.key === "ArrowRight") el('btnNext').click();
    if(e.key === "ArrowLeft") el('btnPrev').click();
    if(e.key === "Escape" && !minimized) el('btnMin').click();
  });

  // Keep float inside viewport on resize
  window.addEventListener('resize', ()=>{
    const r = leadFloat.getBoundingClientRect();
    const maxX = window.innerWidth - r.width - 10;
    const maxY = window.innerHeight - r.height - 10;
    const x = clamp(r.left, 10, maxX);
    const y = clamp(r.top, 80, maxY);
    leadFloat.style.left = x + "px";
    leadFloat.style.top = y + "px";
    saveFloat();
  });
</script>
</body>
</html>
