<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deal Bankers // Internal Ops Console v1.5 (Lead Processor)</title>
  <style>
    :root{
      --bg:#070a0f;
      --panel:#0d121b;
      --panel2:#0b0f16;
      --line:#1c2a3d;
      --ink:#e9f2ff;
      --muted:#9bb2d3;
      --cyan:#59d3ff;
      --green:#2ee59d;
      --yellow:#ffd166;
      --red:#ff4d4d;
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --shadow2:0 10px 24px rgba(0,0,0,.45);
      --r:16px;
      --r2:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      color:var(--ink);
      font-family:var(--sans);
      background:
        radial-gradient(900px 520px at 18% 14%, rgba(89,211,255,.16), transparent 55%),
        radial-gradient(780px 420px at 82% 20%, rgba(46,229,157,.10), transparent 55%),
        linear-gradient(180deg, #05070c, #070a0f);
      overflow-x:hidden;
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.92), rgba(13,18,27,.74));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center; user-select:none}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(89,211,255,.25), rgba(46,229,157,.18));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 26px rgba(0,0,0,.35);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--mono); font-weight:900;
      letter-spacing:.08em;
    }
    .t1{font-weight:900; letter-spacing:.12em; text-transform:uppercase; font-size:13px}
    .t2{font-family:var(--mono); color:var(--muted); font-size:12px; margin-top:2px}

    .hdrRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      font-family:var(--mono);
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,10,15,.45);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.cyan{border-color: rgba(89,211,255,.35); color:#dff6ff;}
    .pill.green{border-color: rgba(46,229,157,.35); color:#dcfff0;}
    .pill.yellow{border-color: rgba(255,209,102,.35); color:#fff3d6;}
    .pill.red{border-color: rgba(255,77,77,.35); color:#ffe3e3;}

    /* Buttons */
    .btn{
      font-family:var(--mono);
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.40);
      color:var(--ink);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .btn:hover{border-color: rgba(89,211,255,.55)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color: rgba(46,229,157,.45)}
    .btn.primary:hover{border-color: rgba(46,229,157,.75)}
    .btn.danger{border-color: rgba(255,77,77,.45)}
    .btn.danger:hover{border-color: rgba(255,77,77,.75)}
    .btn.small{padding:7px 10px; font-size:11px; border-radius:10px;}
    .btn.ghost{background: rgba(7,10,15,.22)}
    .btn.on{border-color: rgba(46,229,157,.75); box-shadow: 0 0 0 3px rgba(46,229,157,.12) inset;}

    /* Layout */
    .wrap{max-width:1500px; margin:0 auto; padding:16px;}
    .layout{
      display:grid;
      grid-template-columns: 1fr 460px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1080px){
      .layout{grid-template-columns: 1fr;}
      .right{grid-column: 1 / -1;}
    }

    /* Cards */
    .card{
      border-radius:var(--r2);
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(13,18,27,.92), rgba(13,18,27,.70));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .chdr{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .card .cbody{padding:12px;}
    .title{font-weight:900; letter-spacing:.10em; text-transform:uppercase; font-size:12px;}
    .sub{font-family:var(--mono); font-size:12px; color:var(--muted); margin-top:3px; line-height:1.45;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .col{display:flex; flex-direction:column; gap:8px}
    .hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0;}
    .mono{font-family:var(--mono); font-size:12px; color:var(--muted); line-height:1.45;}
    .mini{font-size:11px;}
    .sticky{position:sticky; top:78px;}

    /* Workspace */
    iframe{
      width:100%;
      height:76vh;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(7,10,15,.35);
    }
    .workspaceTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .seg{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    /* Forms */
    label{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.45);
      color:var(--ink);
      padding:10px 11px;
      outline:none;
      font-family:var(--mono);
      font-size:12px;
    }
    textarea{min-height:88px; resize:vertical; line-height:1.45;}
    input:focus, textarea:focus, select:focus{border-color: rgba(89,211,255,.65)}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .kpi{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(7,10,15,.35);
      padding:10px;
    }
    .kpi .n{font-family:var(--mono); font-size:20px; font-weight:900; letter-spacing:.02em}
    .kpi .l{font-family:var(--mono); font-size:11px; color:var(--muted); margin-top:4px}

    /* Toast */
    .toast{
      position:fixed; right:14px; bottom:14px;
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(13,18,27,.88);
      font-family:var(--mono); font-size:12px;
      opacity:0; transform: translateY(8px);
      transition: all .18s ease;
      pointer-events:none;
      max-width: 520px;
      white-space: pre-line;
      z-index:9999;
    }
    .toast.show{opacity:1; transform: translateY(0)}

    /* Floating draggable tool palette */
    .float{
      position:fixed;
      left:18px; top:92px;
      width:280px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(13,18,27,.92), rgba(13,18,27,.78));
      box-shadow: var(--shadow2);
      z-index:200;
      overflow:hidden;
      user-select:none;
    }
    .float.min{height:auto;}
    .floatHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      cursor:grab;
    }
    .floatHeader:active{cursor:grabbing;}
    .floatTitle{
      display:flex; flex-direction:column;
      line-height:1.15;
    }
    .floatTitle b{
      font-family:var(--mono);
      letter-spacing:.08em;
      font-size:11px;
      text-transform:uppercase;
    }
    .floatTitle span{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .floatControls{display:flex; gap:8px; align-items:center;}
    .iconBtn{
      width:32px;height:32px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(7,10,15,.35);
      color:var(--ink);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-family:var(--mono);
      font-size:12px;
    }
    .iconBtn:hover{border-color: rgba(89,211,255,.55)}
    .floatBody{padding:10px;}
    .toolGrid{display:grid; grid-template-columns:1fr; gap:10px;}
    .toolBtn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(89,211,255,.22);
      background: linear-gradient(180deg, rgba(7,10,15,.38), rgba(7,10,15,.16));
      font-family:var(--mono);
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
    }
    .toolBtn:hover{border-color: rgba(89,211,255,.60)}
    .toolBtn:active{transform: translateY(1px)}
    .toolBtn em{font-style:normal; color:var(--muted); font-size:11px}
    .toolBtn .l{display:flex; align-items:center; gap:10px;}
    .dot{
      width:9px; height:9px; border-radius:99px;
      background: rgba(89,211,255,.65);
      box-shadow: 0 0 0 4px rgba(89,211,255,.12);
      flex:0 0 auto;
    }
    .dot.g{background: rgba(46,229,157,.80); box-shadow:0 0 0 4px rgba(46,229,157,.12);}
    .dot.y{background: rgba(255,209,102,.90); box-shadow:0 0 0 4px rgba(255,209,102,.12);}
    .dot.r{background: rgba(255,77,77,.90); box-shadow:0 0 0 4px rgba(255,77,77,.12);}

    .float.min .floatBody{display:none;}
    .float.slim{width:210px;}
    .float.slim .toolBtn em{display:none;}
    .float.slim .floatTitle span{display:none;}

    /* Snap hint */
    .snapHint{
      position:fixed;
      inset:0;
      pointer-events:none;
      border:2px dashed rgba(89,211,255,.18);
      opacity:0;
      transition: opacity .12s ease;
      z-index:180;
    }
    .snapHint.show{opacity:1;}

    /* Focus Mode */
    .focus .layout{grid-template-columns: 1fr;}
    .focus .right{display:none;}
    .focus .wrap{max-width:1750px;}
    .focus iframe{height:82vh;}

    /* Small helper: keep float visible on mobile */
    @media (max-width:760px){
      .float{left:10px; right:10px; width:auto;}
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo">DB</div>
    <div>
      <div class="t1">Deal Bankers // Internal Ops Console</div>
      <div class="t2">Lead Processor Station ¬∑ flow mode</div>
    </div>
  </div>

  <div class="hdrRight">
    <span class="pill cyan" id="clockPill">--:--</span>
    <span class="pill green" id="kpiPill">KPI: 0 traced ¬∑ 0 numbers</span>
    <button class="btn small ghost" id="btnFocus">Focus: Off</button>
    <button class="btn small" id="btnResetKpis">Reset KPIs</button>
  </div>
</header>

<!-- Floating draggable tool palette -->
<div class="snapHint" id="snapHint"></div>

<div class="float" id="toolFloat" aria-label="Tool palette">
  <div class="floatHeader" id="toolFloatHeader">
    <div class="floatTitle">
      <b>TOOLS</b>
      <span>Drag ‚Ä¢ open inside workspace</span>
    </div>
    <div class="floatControls">
      <button class="iconBtn" id="btnSlim" title="Compact">‚â°</button>
      <button class="iconBtn" id="btnMin" title="Minimize">‚Äî</button>
      <button class="iconBtn" id="btnDock" title="Snap to edge">‚§ì</button>
    </div>
  </div>
  <div class="floatBody">
    <div class="toolGrid" id="toolGrid">
      <div class="toolBtn" data-url="https://bexar.tx.publicsearch.us/" title="County Clerk">
        <div class="l"><span class="dot"></span>üèõÔ∏è County Clerk</div>
        <em>deeds / docs</em>
      </div>
      <div class="toolBtn" data-url="https://bexar.acttax.com/act_webdev/bexar/index.jsp" title="ACTTax">
        <div class="l"><span class="dot y"></span>üí∞ Tax Assessor</div>
        <em>delinquent</em>
      </div>
      <div class="toolBtn" data-url="https://bexar.trueautomation.com/clientdb/propertysearch.aspx?cid=110" title="BCAD">
        <div class="l"><span class="dot g"></span>üè† BCAD</div>
        <em>owner / mailing</em>
      </div>
      <div class="toolBtn" data-url="https://www.truepeoplesearch.com" title="TruePeopleSearch">
        <div class="l"><span class="dot"></span>üîé TruePeopleSearch</div>
        <em>phones</em>
      </div>
      <div class="toolBtn" data-url="https://bexar.acttax.com/act_webdev/bexar/showdetail2.jsp?can=" title="ACTTax Detail">
        <div class="l"><span class="dot r"></span>üìÑ ACTTax Detail</div>
        <em>paste CAN</em>
      </div>

      <div class="hr"></div>

      <div class="mono">
        <b>Rule:</b> Ajay produces call-ready leads. No negotiation. No calling.<br>
        If unclear ‚Üí set status <b>Needs Bill Review</b>.
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="layout">

    <!-- MIDDLE: embedded browser / iframe workspace -->
    <main class="card mid">
      <div class="chdr">
        <div>
          <div class="title">WORKSPACE</div>
          <div class="sub">Open tools inside the console (one screen)</div>
        </div>

        <div class="workspaceTop">
          <div class="seg">
            <button class="btn small" id="btnTps">TPS</button>
            <button class="btn small" id="btnBc">BCAD</button>
            <button class="btn small" id="btnTax">ACTTax</button>
            <button class="btn small" id="btnClearFrame">Clear</button>
          </div>
          <div class="seg">
            <span class="pill yellow" id="draftPill">Draft: none</span>
          </div>
        </div>
      </div>
      <div class="cbody">
        <iframe id="workFrame" src="https://www.truepeoplesearch.com" title="workspace"></iframe>
      </div>
    </main>

    <!-- RIGHT: FLOW CONSOLE -->
    <aside class="card right sticky">
      <div class="chdr">
        <div>
          <div class="title">WORKFLOW CONSOLE</div>
          <div class="sub">Lead intake ‚Üí skip trace ‚Üí export ‚Üí log result</div>
        </div>
        <span class="pill cyan" id="confPill">Confidence: --</span>
      </div>

      <div class="cbody">

        <!-- KPIs -->
        <div class="grid3">
          <div class="kpi">
            <div class="n" id="kpiTraced">0</div>
            <div class="l">Leads Skip Traced</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiNums">0</div>
            <div class="l">Phone Numbers</div>
          </div>
          <div class="kpi">
            <div class="n" id="kpiReviewed">0</div>
            <div class="l">Needs Bill Review</div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Lead Intake -->
        <div class="row" style="justify-content:space-between;">
          <div class="title">LEAD INTAKE</div>
          <div class="row">
            <button class="btn small" id="btnNewLead">New Lead</button>
            <button class="btn small" id="btnSaveDraft">Save Draft</button>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="col">
          <div>
            <label>Property Address</label>
            <input id="addr" placeholder="214 W Mandalay Dr, San Antonio, TX">
          </div>

          <div class="grid2">
            <div>
              <label>Owner</label>
              <input id="owner" placeholder="FRANK ANAYA JR">
            </div>
            <div>
              <label>Mailing</label>
              <input id="mailing" placeholder="455 Clower, San Antonio, TX 78212">
            </div>
          </div>

          <div class="grid3">
            <div>
              <label>Source</label>
              <select id="source">
                <option>City Liens</option>
                <option>Foreclosure / Notice</option>
                <option>Probate / Estate</option>
                <option>Code Enforcement</option>
                <option>Golden Nug</option>
                <option>Wholesale Group Deal</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label>Priority</label>
              <select id="priority">
                <option>A (call today)</option>
                <option selected>B (call this week)</option>
                <option>C (low)</option>
              </select>
            </div>
            <div>
              <label>Absentee?</label>
              <select id="absentee">
                <option>Unknown</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div>
              <label>Taxes / Red Flag</label>
              <input id="taxes" placeholder="e.g. ~$19,681 delinquent / or $0">
            </div>
            <div>
              <label>Deed / Clue</label>
              <input id="deed" placeholder="Interfamily transfer 7/15/2019 / Deed of Distribution">
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Skip Trace Output -->
        <div class="row" style="justify-content:space-between;">
          <div class="title">SKIP TRACE OUTPUT</div>
          <div class="row">
            <label style="margin:0; display:flex; gap:8px; align-items:center;">
              <span class="pill green" style="padding:6px 10px;">Quick Paste</span>
            </label>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="grid2">
          <div>
            <label>Phones (one per line)</label>
            <textarea id="phones" placeholder="(210) 827-8942&#10;(210) 555-0000"></textarea>
          </div>
          <div>
            <label>Verification Notes</label>
            <textarea id="vnotes" placeholder="Relatives checked / name match / age / wireless / VM / disconnects"></textarea>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label>Confidence</label>
            <select id="confidence">
              <option value="">--</option>
              <option value="‚úÖ Confirmed">‚úÖ Confirmed</option>
              <option value="‚ö†Ô∏è Likely">‚ö†Ô∏è Likely</option>
              <option value="‚ùå Bad Match">‚ùå Bad Match</option>
            </select>
          </div>
          <div>
            <label>Status</label>
            <select id="status">
              <option>New</option>
              <option>Skip Traced</option>
              <option>Needs Bill Review</option>
              <option>Bad Match</option>
              <option>Called</option>
              <option>Texted</option>
            </select>
          </div>
          <div>
            <label>CAN / Link (optional)</label>
            <input id="can" placeholder="012470550110 or paste link">
          </div>
        </div>

        <div class="hr"></div>

        <!-- Export -->
        <div class="row">
          <button class="btn primary" id="btnCopyBill">Copy Bill Format (TAB)</button>
          <button class="btn" id="btnCopySummary">Copy Summary Note</button>
          <button class="btn" id="btnLogResult">Log Result + Update KPI</button>
        </div>

        <div style="height:10px;"></div>

        <div class="mono mini" id="previewBox">
          <b>Preview:</b> fill fields to generate export.
        </div>

        <div class="hr"></div>

        <!-- Activity Log -->
        <div class="row" style="justify-content:space-between;">
          <div class="title">ACTIVITY (last 50)</div>
          <button class="btn small danger" id="btnClearLog">Clear Log</button>
        </div>
        <div style="height:10px;"></div>
        <textarea id="logBox" readonly style="min-height:140px;"></textarea>

      </div>
    </aside>

  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
  // =========================================================
  // STORAGE KEYS
  // =========================================================
  const KPI_KEY   = "db_lp_kpis_v1";
  const LOG_KEY   = "db_lp_log_v1";
  const DRAFT_KEY = "db_lp_draft_v1"; // session draft
  const UI_KEY    = "db_lp_ui_v1";    // float palette position/state
  const toast     = document.getElementById('toast');

  // =========================================================
  // HELPERS
  // =========================================================
  function el(id){ return document.getElementById(id); }
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(window.__t);
    window.__t = setTimeout(()=>toast.classList.remove('show'), 1400);
  }
  function nowStamp(){
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    return `${mm}/${dd}/${yy} ${hh}:${mi}`;
  }
  function cleanPhoneLines(s){
    return (s || "")
      .split(/\r?\n/)
      .map(x=>x.trim())
      .filter(Boolean);
  }
  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // =========================================================
  // CLOCK
  // =========================================================
  function setClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    el('clockPill').textContent = `${hh}:${mi}`;
  }
  setClock();
  setInterval(setClock, 15000);

  // =========================================================
  // WORKSPACE IFRAME CONTROL
  // =========================================================
  const frame = el('workFrame');
  const TOOL_URLS = {
    tps: "https://www.truepeoplesearch.com",
    bcad: "https://bexar.trueautomation.com/clientdb/propertysearch.aspx?cid=110",
    acttax: "https://bexar.acttax.com/act_webdev/bexar/index.jsp"
  };

  el('btnTps').onclick = ()=> { frame.src = TOOL_URLS.tps; showToast("TPS opened"); };
  el('btnBc').onclick  = ()=> { frame.src = TOOL_URLS.bcad; showToast("BCAD opened"); };
  el('btnTax').onclick = ()=> { frame.src = TOOL_URLS.acttax; showToast("ACTTax opened"); };
  el('btnClearFrame').onclick = ()=> { frame.src = "about:blank"; showToast("Workspace cleared"); };

  // Floating palette opens tools inside iframe
  document.querySelectorAll('#toolGrid .toolBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const url = btn.getAttribute('data-url');
      if(!url) return;
      frame.src = url;
      showToast("Opened in workspace");
    });
  });

  // =========================================================
  // FORM FIELDS
  // =========================================================
  const F = {
    addr: el('addr'), owner: el('owner'), mailing: el('mailing'),
    source: el('source'), priority: el('priority'), absentee: el('absentee'),
    taxes: el('taxes'), deed: el('deed'), phones: el('phones'), vnotes: el('vnotes'),
    confidence: el('confidence'), status: el('status'), can: el('can')
  };

  function syncConfidence(){
    const v = F.confidence.value || "--";
    el('confPill').textContent = `Confidence: ${v}`;
  }
  F.confidence.addEventListener('change', syncConfidence);

  function buildBillExport(){
    // One tab-delimited line:
    // Owner \t Phone(s) \t Property \t Notes
    const owner = (F.owner.value || "").trim();
    const addr  = (F.addr.value  || "").trim();
    const phones = cleanPhoneLines(F.phones.value).join(", ");

    const notesBits = [];
    const absentee = F.absentee.value;
    const deed = (F.deed.value || "").trim();
    const taxes = (F.taxes.value || "").trim();
    const src = F.source.value;
    const pri = F.priority.value;
    const mailing = (F.mailing.value || "").trim();
    const conf = (F.confidence.value || "").trim();
    const vnotes = (F.vnotes.value || "").trim();
    const can = (F.can.value || "").trim();

    if(absentee && absentee !== "Unknown") notesBits.push(`Absentee: ${absentee}`);
    if(deed) notesBits.push(deed);
    if(taxes) notesBits.push(taxes);
    if(src) notesBits.push(`Source: ${src}`);
    if(pri) notesBits.push(`Priority: ${pri}`);
    if(mailing) notesBits.push(`Mailing: ${mailing}`);
    if(conf) notesBits.push(conf);
    if(can) notesBits.push(`CAN/Link: ${can}`);
    if(vnotes) notesBits.push(`Verify: ${vnotes}`);

    const notes = notesBits.join(" | ");
    return `${owner}\t${phones}\t${addr}\t${notes}`.trim();
  }

  function buildSummaryNote(){
    const owner = (F.owner.value || "").trim();
    const addr = (F.addr.value || "").trim();
    const phones = cleanPhoneLines(F.phones.value);
    const absentee = F.absentee.value;
    const deed = (F.deed.value || "").trim();
    const taxes = (F.taxes.value || "").trim();
    const src = F.source.value;
    const conf = (F.confidence.value || "").trim();
    const vnotes = (F.vnotes.value || "").trim();
    const mailing = (F.mailing.value || "").trim();

    const phoneLine = phones.length ? phones.join(" / ") : "(no phones yet)";
    const bits = [];
    if(absentee && absentee !== "Unknown") bits.push(`Absentee: ${absentee}`);
    if(deed) bits.push(deed);
    if(taxes) bits.push(taxes);
    if(src) bits.push(src);
    if(conf) bits.push(conf);

    return `${owner}\n${phoneLine}\nProperty: ${addr}\n\nNotes: ${bits.join(". ")}${vnotes ? `. ${vnotes}` : ""}${mailing ? `\nMailing: ${mailing}` : ""}`.trim();
  }

  function updatePreview(){
    const exp = buildBillExport();
    el('previewBox').innerHTML =
      `<b>Preview (tab-delimited):</b><br><span class="mono">${escapeHtml(exp || "fill fields to generate export.")}</span>`;
  }

  Object.values(F).forEach(x=>{
    x.addEventListener('input', updatePreview);
    x.addEventListener('change', updatePreview);
  });
  updatePreview();

  // =========================================================
  // KPIs + LOG
  // =========================================================
  function loadKpis(){
    try{
      return JSON.parse(localStorage.getItem(KPI_KEY)) || { traced:0, numbers:0, review:0 };
    }catch(e){ return { traced:0, numbers:0, review:0 }; }
  }
  function saveKpis(k){ localStorage.setItem(KPI_KEY, JSON.stringify(k)); }
  function renderKpis(){
    const k = loadKpis();
    el('kpiTraced').textContent = k.traced;
    el('kpiNums').textContent = k.numbers;
    el('kpiReviewed').textContent = k.review;
    el('kpiPill').textContent = `KPI: ${k.traced} traced ¬∑ ${k.numbers} numbers`;
  }
  renderKpis();

  function loadLog(){
    try{ return JSON.parse(localStorage.getItem(LOG_KEY)) || []; }
    catch(e){ return []; }
  }
  function saveLog(items){ localStorage.setItem(LOG_KEY, JSON.stringify(items.slice(-50))); }
  function renderLog(){
    const items = loadLog();
    el('logBox').value = items.slice(-50).join("\n");
  }
  renderLog();

  // =========================================================
  // DRAFT (session)
  // =========================================================
  function saveDraft(){
    const d = {};
    Object.keys(F).forEach(k=> d[k] = F[k].value);
    sessionStorage.setItem(DRAFT_KEY, JSON.stringify(d));
    el('draftPill').textContent = `Draft: saved ${nowStamp()}`;
    showToast("Draft saved");
  }
  function loadDraft(){
    try{
      const raw = sessionStorage.getItem(DRAFT_KEY);
      if(!raw) return false;
      const d = JSON.parse(raw);
      Object.keys(F).forEach(k=> { if(d[k] !== undefined) F[k].value = d[k]; });
      syncConfidence();
      updatePreview();
      el('draftPill').textContent = `Draft: loaded ${nowStamp()}`;
      return true;
    }catch(e){ return false; }
  }
  loadDraft();

  // =========================================================
  // BUTTON ACTIONS
  // =========================================================
  el('btnSaveDraft').onclick = saveDraft;

  el('btnNewLead').onclick = ()=>{
    if(!confirm("Clear this lead and start new?")) return;
    Object.values(F).forEach(x=> x.value = "");
    F.source.value = "City Liens";
    F.priority.value = "B (call this week)";
    F.absentee.value = "Unknown";
    F.status.value = "New";
    syncConfidence();
    updatePreview();
    sessionStorage.removeItem(DRAFT_KEY);
    el('draftPill').textContent = "Draft: none";
    showToast("New lead ready");
  };

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast("Copied to clipboard");
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      showToast("Copied (fallback)");
    }
  }

  el('btnCopyBill').onclick = ()=>{
    const exp = buildBillExport();
    if(!exp.trim()){ showToast("Nothing to copy yet"); return; }
    copyToClipboard(exp);
  };

  el('btnCopySummary').onclick = ()=>{
    const note = buildSummaryNote();
    if(!note.trim()){ showToast("Nothing to copy yet"); return; }
    copyToClipboard(note);
  };

  el('btnLogResult').onclick = ()=>{
    const addr = (F.addr.value||"").trim();
    const owner = (F.owner.value||"").trim();
    if(!addr || !owner){
      showToast("Need at least Owner + Address");
      return;
    }

    const phones = cleanPhoneLines(F.phones.value);
    const conf = F.confidence.value || "--";
    const status = F.status.value || "New";
    const taxes = (F.taxes.value||"").trim();

    const k = loadKpis();
    const isTraced = ["Skip Traced","Needs Bill Review","Bad Match","Called","Texted"].includes(status);
    if(isTraced) k.traced += 1;
    k.numbers += phones.length;
    if(status === "Needs Bill Review") k.review += 1;

    saveKpis(k);
    renderKpis();

    const items = loadLog();
    items.push(`[${nowStamp()}] ${status} | ${conf} | ${owner} | ${addr} | phones:${phones.length}${taxes ? " | "+taxes : ""}`);
    saveLog(items);
    renderLog();

    showToast("Logged + KPI updated");
  };

  el('btnClearLog').onclick = ()=>{
    if(!confirm("Clear activity log?")) return;
    localStorage.removeItem(LOG_KEY);
    renderLog();
    showToast("Log cleared");
  };

  el('btnResetKpis').onclick = ()=>{
    if(!confirm("Reset KPIs to 0?")) return;
    localStorage.setItem(KPI_KEY, JSON.stringify({traced:0,numbers:0,review:0}));
    renderKpis();
    showToast("KPIs reset");
  };

  // Autofill CAN link if user pastes digits only
  F.can.addEventListener('blur', ()=>{
    const v = (F.can.value||"").trim();
    if(/^\d{6,}$/.test(v)){
      F.can.value = "https://bexar.acttax.com/act_webdev/bexar/showdetail2.jsp?can=" + v;
      updatePreview();
    }
  });

  // =========================================================
  // FOCUS MODE (maximize workspace)
  // =========================================================
  const focusBtn = el('btnFocus');
  function setFocus(on){
    document.body.classList.toggle('focus', !!on);
    focusBtn.textContent = `Focus: ${on ? "On" : "Off"}`;
    focusBtn.classList.toggle('on', !!on);
    saveUI();
  }
  focusBtn.onclick = ()=>{
    const on = !document.body.classList.contains('focus');
    setFocus(on);
  };

  // =========================================================
  // DRAGGABLE FLOAT PALETTE
  // =========================================================
  const floatEl = el('toolFloat');
  const floatHeader = el('toolFloatHeader');
  const snapHint = el('snapHint');

  let drag = { on:false, dx:0, dy:0 };

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function saveUI(){
    const rect = floatEl.getBoundingClientRect();
    const ui = {
      x: rect.left,
      y: rect.top,
      min: floatEl.classList.contains('min'),
      slim: floatEl.classList.contains('slim'),
      focus: document.body.classList.contains('focus'),
      dock: floatEl.dataset.dock || ""
    };
    localStorage.setItem(UI_KEY, JSON.stringify(ui));
  }

  function loadUI(){
    try{
      const raw = localStorage.getItem(UI_KEY);
      if(!raw) return;
      const ui = JSON.parse(raw);
      if(typeof ui.x === "number" && typeof ui.y === "number"){
        floatEl.style.left = ui.x + "px";
        floatEl.style.top  = ui.y + "px";
      }
      floatEl.classList.toggle('min', !!ui.min);
      floatEl.classList.toggle('slim', !!ui.slim);
      if(ui.focus) setFocus(true);
      if(ui.dock){ floatEl.dataset.dock = ui.dock; }
    }catch(e){}
  }
  loadUI();

  function snapToEdge(){
    const rect = floatEl.getBoundingClientRect();
    const midX = rect.left + rect.width/2;
    const leftSnap = midX < window.innerWidth/2;
    const x = leftSnap ? 10 : (window.innerWidth - rect.width - 10);
    floatEl.style.left = clamp(x, 6, window.innerWidth - rect.width - 6) + "px";
    floatEl.style.top  = clamp(rect.top, 80, window.innerHeight - rect.height - 10) + "px";
    floatEl.dataset.dock = leftSnap ? "left" : "right";
    showToast("Snapped to edge");
    saveUI();
  }

  floatHeader.addEventListener('mousedown', (e)=>{
    // ignore if clicking control buttons
    if(e.target.closest('button')) return;
    drag.on = true;
    const rect = floatEl.getBoundingClientRect();
    drag.dx = e.clientX - rect.left;
    drag.dy = e.clientY - rect.top;
    snapHint.classList.add('show');
  });

  window.addEventListener('mousemove', (e)=>{
    if(!drag.on) return;
    const w = floatEl.getBoundingClientRect().width;
    const h = floatEl.getBoundingClientRect().height;

    let x = e.clientX - drag.dx;
    let y = e.clientY - drag.dy;

    // clamp
    x = clamp(x, 6, window.innerWidth - w - 6);
    y = clamp(y, 72, window.innerHeight - h - 10);

    floatEl.style.left = x + "px";
    floatEl.style.top  = y + "px";

    // if near edges, hint snap
    const nearEdge = (x < 20) || (x > window.innerWidth - w - 20);
    snapHint.style.opacity = nearEdge ? "1" : "";
  });

  window.addEventListener('mouseup', ()=>{
    if(!drag.on) return;
    drag.on = false;
    snapHint.classList.remove('show');

    // auto snap if close
    const rect = floatEl.getBoundingClientRect();
    if(rect.left < 18 || rect.right > window.innerWidth - 18){
      snapToEdge();
    }else{
      floatEl.dataset.dock = "";
      saveUI();
    }
  });

  // Controls
  el('btnMin').onclick = ()=>{
    floatEl.classList.toggle('min');
    saveUI();
  };
  el('btnSlim').onclick = ()=>{
    floatEl.classList.toggle('slim');
    saveUI();
  };
  el('btnDock').onclick = snapToEdge;

  // keep float in bounds on resize
  window.addEventListener('resize', ()=>{
    const rect = floatEl.getBoundingClientRect();
    floatEl.style.left = clamp(rect.left, 6, window.innerWidth - rect.width - 6) + "px";
    floatEl.style.top  = clamp(rect.top, 72, window.innerHeight - rect.height - 10) + "px";
    saveUI();
  });

  // =========================================================
  // INIT
  // =========================================================
  syncConfidence();
  renderKpis();
  renderLog();
</script>
</body>
</html>
