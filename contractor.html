<!-- =============== contractor.html (Post, Claim & Photo Uploads) =============== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Contractor • Jobs</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
  <style>
    :root{ --bg:#0d1620; --panel:#0f1a24; --line:#1b3245; --text:#eaf1f6; --muted:#9fb3c7; --green:#26cf84; --blue:#2b74ff; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;padding:12px}
    .wrap{max-width:1100px;margin:0 auto}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:#10222e;border:1px solid var(--line);border-radius:16px;padding:12px}
    .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .muted{color:var(--muted)}
    input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);background:#0f1a24;color:#eaf1f6;border-radius:10px}
    textarea{min-height:100px;resize:vertical}
    .btn{padding:10px 12px;border:1px solid var(--line);background:#0f1a24;color:#cfe2f3;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
    .btn.blue{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:12px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .job{border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px;background:#0f1a24}
    .job h4{margin:0 0 6px}
    .chip{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#0e2030;margin-right:6px}
    .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px}
    .thumbs img{width:100%;height:90px;object-fit:cover;border-radius:8px;background:#0b141b}
    dialog{border:none;border-radius:16px;background:#0f1a24;color:#eaf1f6;padding:14px;max-width:900px;width:92%}
    .gal{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .gal img{width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:10px;background:#0b141b}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <section class="card">
      <div class="head"><h3 style="margin:0">Post a Job</h3><div class="muted" id="meLine">...</div></div>
      <div class="row">
        <input id="jobTitle" placeholder="Job title (e.g., Roofing repair)"/>
        <input id="jobLoc" placeholder="Location (city / ZIP)"/>
      </div>
      <div class="row">
        <input id="jobBudget" placeholder="Budget (optional)"/>
        <input id="jobContact" placeholder="Best contact (optional)"/>
      </div>
      <textarea id="jobDesc" placeholder="Scope / details"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="postBtn" class="btn primary">Post Job</button>
        <span id="postMsg" class="muted"></span>
      </div>
    </section>

    <section class="card">
      <div class="head"><h3 style="margin:0">My Jobs</h3></div>
      <div id="myJobs" class="muted">Loading…</div>
    </section>
  </div>

  <section class="card" style="margin-top:12px">
    <div class="head"><h3 style="margin:0">Open Jobs</h3>
      <div class="row">
        <button class="btn blue" id="refresh">Refresh</button>
      </div>
    </div>
    <div id="openJobs">Loading…</div>
  </section>
</div>

<!-- Simple gallery dialog -->
<dialog id="galDlg">
  <h3 style="margin:0 0 8px">Job Photos</h3>
  <div id="galGrid" class="gal"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
    <button id="galClose" class="btn">Close</button>
  </div>
</dialog>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<!-- NEW: Storage for photos -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
<script>
  const config={apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"};
  if(!firebase.apps.length) firebase.initializeApp(config);
  const auth=firebase.auth(), db=firebase.database(), storage=firebase.storage();

  const $=s=>document.querySelector(s);
  const jobsRef = db.ref('contractor/jobs');

  /* ---------- UI helpers ---------- */
  function msg(el, text){ el.textContent=text; setTimeout(()=>el.textContent='',1600); }

  /* ---------- Render a list of jobs ---------- */
  function renderJobs(listEl, jobs){
    if(!jobs.length){ listEl.innerHTML='<div class="muted">None.</div>'; return; }
    listEl.innerHTML='';
    const me=auth.currentUser?.uid;

    jobs.forEach(j=>{
      const mine = j.postedBy?.uid===me;
      const claimedByMe = j.claimedBy?.uid===me;

      const div=document.createElement('div'); div.className='job';
      div.innerHTML=`
        <h4>${j.title||'Untitled'}</h4>
        <div class="chip">Loc: ${j.location||'-'}</div>
        <div class="chip">Budget: ${j.budget||'-'}</div>
        <div class="chip">Status: ${j.status||'open'}</div>
        <div style="margin-top:6px" class="muted">${(j.desc||'').replace(/\n/g,'<br>')}</div>

        ${(Array.isArray(j.photos) && j.photos.length) ? `
          <div class="thumbs">
            ${j.photos.slice(0,3).map(u=>`<img src="${u}" alt="photo" loading="lazy"/>`).join('')}
          </div>
        `: ''}

        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          ${(!j.status || j.status==='open')?'<button class="btn blue claim">Claim</button>':''}
          ${(j.status==='claimed' && claimedByMe)?'<button class="btn primary done">Mark Done</button>':''}
          <button class="btn view">View Photos</button>
          ${(mine || claimedByMe) ? `
            <label class="btn">
              ＋ Add Photos
              <input type="file" accept="image/*" multiple data-up="${j.id}" style="display:none"/>
            </label>` : '' }
          ${mine?'<button class="btn" style="border-color:#7b3232" data-del>Delete</button>':''}
        </div>

        <div class="muted" style="margin-top:6px">Posted by: ${j.postedBy?.email||j.postedBy?.uid||'unknown'} ${j.claimedBy?('• Claimed by: '+(j.claimedBy.email||j.claimedBy.uid)) : ''}</div>
      `;

      // Wire buttons
      div.querySelector('.claim')?.addEventListener('click',()=>claimJob(j.id));
      div.querySelector('.done')?.addEventListener('click',()=>completeJob(j.id));
      div.querySelector('[data-del]')?.addEventListener('click',()=>deleteJob(j.id));
      div.querySelector('.view')?.addEventListener('click',()=>openGallery(j));

      const up=div.querySelector('input[type="file"][data-up]');
      if(up){
        up.addEventListener('change', async (e)=>{
          if(!e.target.files?.length) return;
          up.disabled=true;
          try{
            await uploadPhotos(j.id, e.target.files);
            loadJobs();
          }catch(err){ alert('Upload failed.'); }
          finally{ up.value=''; up.disabled=false; }
        });
      }

      listEl.appendChild(div);
    });
  }

  /* ---------- Actions ---------- */
  async function claimJob(id){
    const me=auth.currentUser; if(!me) return alert('Sign in required');
    await jobsRef.child(id).transaction(j=>{
      if(!j || j.status==='done') return j;
      if(j.status==='open' || !j.status){ j.status='claimed'; j.claimedBy={uid:me.uid,email:me.email||''}; }
      return j;
    });
  }
  async function completeJob(id){ await jobsRef.child(id).update({status:'done'}); }
  async function deleteJob(id){ if(!confirm('Delete this job?')) return; await jobsRef.child(id).remove(); }

  /* ---------- Upload photos to Firebase Storage ---------- */
  async function uploadPhotos(jobId, fileList){
    const uploads=[];
    for(const f of fileList){
      const safeName = f.name.replace(/[^\w.\-]+/g,'_');
      const path = `contractor-jobs/${jobId}/${Date.now()}-${safeName}`;
      const ref = storage.ref().child(path);
      await ref.put(f);
      const url = await ref.getDownloadURL();
      uploads.push(url);
    }
    if(uploads.length){
      await jobsRef.child(jobId).child('photos').transaction(arr=>{
        arr = Array.isArray(arr)?arr:[];
        return arr.concat(uploads);
      });
      alert(`Uploaded ${uploads.length} photo${uploads.length>1?'s':''}.`);
    }
  }

  /* ---------- Gallery dialog ---------- */
  const galDlg = $('#galDlg'), galGrid = $('#galGrid');
  $('#galClose').onclick = ()=>galDlg.close();
  function openGallery(job){
    galGrid.innerHTML = (Array.isArray(job.photos) && job.photos.length)
      ? job.photos.map(u=>`<img src="${u}" loading="lazy"/>`).join('')
      : `<div class="muted">No photos yet.</div>`;
    galDlg.showModal();
  }

  /* ---------- Load jobs ---------- */
  function loadJobs(){
    jobsRef.orderByChild('ts').limitToLast(200).once('value',snap=>{
      const me=auth.currentUser?.uid;
      const list=[];
      snap.forEach(ch=>{ const j=ch.val(); j.id=ch.key; list.push(j); });
      list.sort((a,b)=>b.ts-a.ts);
      renderJobs($('#openJobs'), list.filter(j=>!j.status || j.status==='open' || j.status==='claimed'));
      renderJobs($('#myJobs'),   list.filter(j=>j.postedBy?.uid===me || j.claimedBy?.uid===me));
    });
  }
  $('#refresh').onclick=loadJobs;

  /* ---------- Post job ---------- */
  $('#postBtn').onclick=async ()=>{
    const me=auth.currentUser; if(!me){ alert('Please sign in.'); return; }
    const j={
      title: $('#jobTitle').value.trim(),
      location: $('#jobLoc').value.trim(),
      budget: $('#jobBudget').value.trim(),
      contact: $('#jobContact').value.trim(),
      desc: $('#jobDesc').value.trim(),
      status:'open',
      postedBy:{uid:me.uid,email:me.email||''},
      photos: [],       // ready for uploads
      ts: Date.now()
    };
    if(!j.title){ alert('Add a title.'); return; }
    await jobsRef.push(j);
    msg($('#postMsg'),'Posted.');
    $('#jobTitle').value=''; $('#jobLoc').value=''; $('#jobBudget').value=''; $('#jobContact').value=''; $('#jobDesc').value='';
    loadJobs();
  };

  auth.onAuthStateChanged(u=>{ $('#meLine').textContent = u ? (u.email||u.uid) : 'Not signed in'; loadJobs(); });
</script>
</body>
</html>
