<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DealBankers ‚Ä¢ Contractor</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<style>
:root{
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;
  --line:#254a63;--text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
*{box-sizing:border-box;margin:0;padding:0}

body{
  margin:0;font-family:Inter,system-ui,Arial;
  color:var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  min-height:100vh;
}

/* HEADER / NAV */
.header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;
  border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04));
}
.nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.chip{
  padding:6px 14px;border-radius:100px;
  border:1px solid rgba(255,255,255,.22);
  background:#0d1823;color:var(--text);
  text-decoration:none;cursor:pointer;font-weight:600;
  transition:background .2s,transform .2s;
}
.chip:hover{background:#14314d;transform:scale(1.03)}
.chip.primary{background:#133e6a}
.chip.danger{background:#6b1111}

/* Gear Icon */
.icon-btn {
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.25);
  border-radius: 50%;
  width: 34px;height: 34px;font-size: 18px;
  color: white;cursor: pointer;
  display: flex;align-items: center;justify-content: center;
  position:relative;
}
.icon-btn:hover { background: rgba(255,255,255,0.25); }

/* Pulse (for onboarding) */
.pulse{ animation:pulse 1.2s infinite; }
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(45,124,255,.65); }
  70%{ box-shadow:0 0 0 10px rgba(45,124,255,0); }
  100%{ box-shadow:0 0 0 0 rgba(45,124,255,0); }
}

/* MAIN LAYOUT */
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.15);
  border-radius:20px;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.top{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.2)
}
.seg{display:flex;border:1px solid rgba(255,255,255,.22);border-radius:999px;overflow:hidden}
.seg button{
  padding:8px 14px;border:0;background:#0e2332;
  color:#cfe6ff;cursor:pointer
}
.seg button.active{
  background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff
}
.body{
  padding:14px;
  display:grid;
  grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
  gap:16px;
}
@media(max-width:960px){ .body{grid-template-columns:1fr} }

/* LIST */
.list{
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  overflow:hidden;
}
.row{
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  cursor:pointer;
  background:rgba(10,20,30,.35);
}
.row:hover{background:rgba(20,45,70,.35)}
.row.active{background:rgba(43,116,255,.22)}
.row .t{font-weight:800}
.row .m{font-size:12px;opacity:.85;margin-top:2px}
.pill{
  display:inline-block;
  font-size:11px;
  padding:3px 8px;
  border:1px solid rgba(255,255,255,.18);
  border-radius:999px;
  opacity:.9;
}

/* DETAILS */
.panel{
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:12px;
  background:rgba(10,20,30,.35);
}
.panel h3{margin:0 0 6px}
.kv{font-size:13px;line-height:1.45;opacity:.95}
.kv b{opacity:1}
.small{font-size:12px;opacity:.85}
.hr{height:1px;background:rgba(255,255,255,.12);margin:10px 0}

/* EMPTY STATE */
.empty-state {text-align:center;padding:40px;color:#cfe3ff;}
.empty-box {
  display:inline-block;background:#122334;
  padding:25px 30px;border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
}
.empty-actions button {
  margin:10px;padding:10px 16px;background:#2563eb;
  color:#fff;border:none;border-radius:6px;
  cursor:pointer;font-weight:600;
}

/* Setup Banner */
.banner{
  display:none;
  margin:12px 14px 0;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(12,24,36,.75);
  color:#d9ecff;
  font-size:14px;
}
.banner b{color:#fff}
.banner .row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;border:0;background:transparent;cursor:default;padding:0}
.banner .btn{
  padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.22);
  background:#133e6a;color:#fff;font-weight:700;cursor:pointer;
}

/* CHAT BUBBLE */
#chatBubble{
  position:fixed;bottom:24px;right:24px;width:54px;height:54px;
  border-radius:50%;background:#133e6a;color:white;
  border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 0 15px rgba(0,138,255,.6);
  z-index:999;transition:transform .15s
}
#chatBubble:hover{transform:scale(1.08)}

/* MODALS */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center;z-index:9999}
.modal{
  background:#0f1b27;border:1px solid #254a63;border-radius:16px;
  padding:16px;max-width:760px;width:92%;
  box-shadow:0 28px 70px rgba(0,0,0,.55)
}
.modal .grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media(max-width:720px){ .modal .grid{grid-template-columns:1fr} }

.modal input,.modal select,.modal textarea{
  width:100%;padding:10px;border:1px solid #254a63;
  background:#0d1f2d;color:#fff;border-radius:10px;margin:6px 0;
}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
.actions .danger{background:#6b1111}
.hr{height:1px;background:rgba(255,255,255,.12);margin:10px 0}

/* Toggle */
.toggle{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;padding:10px 12px;border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(13,31,45,.6);
}
.switch{
  width:46px;height:26px;border-radius:999px;
  background:rgba(255,255,255,.18);
  position:relative;cursor:pointer;border:1px solid rgba(255,255,255,.18);
}
.knob{
  width:22px;height:22px;border-radius:50%;
  background:#fff;position:absolute;top:1px;left:1px;
  transition:transform .15s ease;
}
.switch.on{background:rgba(43,116,255,.55);border-color:rgba(43,116,255,.65)}
.switch.on .knob{transform:translateX(20px)}

/* Onboarding overlay/callout */
#setupOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  z-index:10000;
  display:none;
}
#setupCallout{
  position:absolute;width:320px;max-width:calc(100vw - 24px);
  padding:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(10,20,30,.96);
  border-radius:16px;
  box-shadow:0 18px 60px rgba(0,0,0,.6);
  color:#eaf3ff;
}
#setupCallout .title{ font-weight:800; margin-bottom:4px; font-size:16px; }
#setupCallout .msg{ opacity:.92; margin-bottom:10px; font-size:13px; line-height:1.3; }
#setupCallout .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
#setupCallout button{
  height:38px; padding:0 12px; border-radius:12px; border:0; cursor:pointer;
  font-weight:800;
}
#setupCallout .primary{ background:#2d7cff; color:white; }
#setupCallout .ghost{ background:transparent; color:#d7e7ff; border:1px solid rgba(255,255,255,.16); }

/* God Mode admin strip */
.admin-strip{
  display:none;
  margin:12px 14px 0;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(20,40,60,.55);
}
.admin-strip .row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
.admin-strip .btn{
  padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.22);
  background:#133e6a;color:#fff;font-weight:800;cursor:pointer;
}
.admin-strip .btn:hover{background:#1b4e86}
</style>
</head>

<body data-portal="contractor">

<header class="header">
  <div>DEALBANKERS ‚Ä¢ Contractor</div>
  <nav class="nav">
    <a class="chip" href="profile.html">Dashboard</a>
    <button class="chip" id="btnBlue">üåÄ Blue</button>
    <button class="chip danger" id="btnRed">üö® Red</button>
    <button class="icon-btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
    <a class="chip" id="logoutBtn">Log Out</a>
  </nav>
</header>

<!-- Onboarding Callout Overlay -->
<div id="setupOverlay" aria-hidden="true">
  <div id="setupCallout" role="dialog" aria-label="Complete setup">
    <div class="title">One quick step</div>
    <div class="msg">Complete your contractor profile so DealBankers can route jobs to you.</div>
    <div class="actions">
      <button id="setupLater" class="ghost">Not now</button>
      <button id="setupGo" class="primary">Open Settings</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-backdrop" id="settingsModal">
  <div class="modal wide">
    <h3>Contractor Account Setup</h3>
    <p class="small">30-second setup. This helps us route jobs to you correctly.</p>

    <div class="hr"></div>

    <div class="grid">
      <div>
        <label class="small">Business Name</label>
        <input id="bizName" placeholder="Business Name" />
      </div>

      <div>
        <label class="small">Trades You Perform</label>
        <input id="trades" placeholder="Drywall, Painting, Flooring‚Ä¶" />
      </div>

      <div style="grid-column:1 / -1">
        <label class="small">Service Areas</label>
        <input id="serviceArea" placeholder="Cities, Zip Codes (ex: San Antonio, 78210, 78212)" />
      </div>

      <div>
        <label class="small">Phone</label>
        <input id="contactPhone" placeholder="(210) 555-1234" inputmode="tel" />
      </div>

      <div>
        <label class="small">Email</label>
        <input id="contactEmail" placeholder="you@email.com" inputmode="email" />
      </div>

      <div>
        <label class="small">Preferred Contact</label>
        <select id="prefContact">
          <option value="text">Text</option>
          <option value="call">Call</option>
          <option value="email">Email</option>
        </select>
      </div>

      <div>
        <label class="small">Trust Badges</label>
        <div style="display:flex;gap:14px;align-items:center;margin-top:8px;flex-wrap:wrap">
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="isLicensed" />
            <span>Licensed</span>
          </label>
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="isInsured" />
            <span>Insured</span>
          </label>
        </div>
      </div>

      <div style="grid-column:1 / -1">
        <div class="toggle">
          <div>
            <div style="font-weight:800">Accepting Jobs</div>
            <div class="small">Turn this on to receive new job offers.</div>
          </div>
          <div class="switch" id="acceptSwitch" aria-label="Accepting Jobs Toggle">
            <div class="knob"></div>
          </div>
        </div>
      </div>

    </div>

    <div class="actions">
      <button class="chip" id="closeSettings">Cancel</button>
      <button class="chip primary" id="saveSettings">Save</button>
    </div>
  </div>
</div>

<!-- Blue/Red Request Modal -->
<div class="modal-backdrop" id="rbModal">
  <div class="modal">
    <h3 id="rbTitle">Request</h3>
    <label class="small">Category</label>
    <select id="rbCategory">
      <option>Acquisition</option>
      <option>Sales</option>
      <option>Contractor</option>
      <option>Realtor</option>
      <option>Website</option>
    </select>
    <label class="small">Subject</label>
    <input id="rbSubject" placeholder="Short summary" />
    <label class="small">Details</label>
    <textarea id="rbDetails" rows="4" placeholder="What do you need?"></textarea>
    <div class="actions">
      <button class="chip" id="rbCancel">Cancel</button>
      <button class="chip primary" id="rbSubmit">Send</button>
    </div>
  </div>
</div>

<!-- Job Admin Modal (God Mode only) -->
<div class="modal-backdrop" id="jobModal">
  <div class="modal wide">
    <h3 id="jobModalTitle">Create Job</h3>
    <p class="small">God Mode only. Writes to <span style="opacity:.95">/jobs/&lt;jobId&gt;</span>.</p>

    <div class="hr"></div>

    <div class="grid">
      <div style="grid-column:1 / -1">
        <label class="small">Title</label>
        <input id="jobTitle" placeholder="e.g., Patch & paint 2 bedrooms" />
      </div>

      <div>
        <label class="small">Status</label>
        <select id="jobStatus">
          <option value="active">Active</option>
          <option value="upcoming">Upcoming</option>
          <option value="archived">Archived</option>
        </select>
      </div>

      <div>
        <label class="small">Trade</label>
        <input id="jobTrade" placeholder="Drywall / Paint / Flooring" />
      </div>

      <div style="grid-column:1 / -1">
        <label class="small">Address</label>
        <input id="jobAddress" placeholder="Street, City, State ZIP" />
      </div>

      <div>
        <label class="small">City</label>
        <input id="jobCity" placeholder="San Antonio" />
      </div>

      <div>
        <label class="small">ZIP</label>
        <input id="jobZip" placeholder="78210" inputmode="numeric" />
      </div>

      <div>
        <label class="small">Target Date</label>
        <input id="jobDate" placeholder="Optional (e.g., 2025-12-26)" />
      </div>

      <div>
        <label class="small">Budget</label>
        <input id="jobBudget" placeholder="Optional (e.g., $1,200)" />
      </div>

      <div style="grid-column:1 / -1">
        <label class="small">Description</label>
        <textarea id="jobDesc" rows="4" placeholder="Scope, access notes, photos link, etc."></textarea>
      </div>
    </div>

    <div class="actions" style="justify-content:space-between">
      <button class="chip danger" id="jobDeleteBtn" style="display:none;">Delete</button>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="chip" id="jobCancel">Cancel</button>
        <button class="chip primary" id="jobSave">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="wrap">
  <section class="card">

    <!-- Setup Banner -->
    <div class="banner" id="setupBanner">
      <div class="row">
        <div>
          <b>Setup incomplete.</b> Add service areas + trades + a contact method to start receiving jobs.
        </div>
        <button class="btn" id="bannerFix">Finish Setup</button>
      </div>
    </div>

    <!-- God Mode Admin Strip -->
    <div class="admin-strip" id="adminStrip">
      <div class="row">
        <div>
          <b>God Mode:</b> Create / edit / delete jobs.
          <span class="small" style="margin-left:8px;opacity:.85">Only visible to dealbankers@gmail.com</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btnNewJob">+ New Job</button>
          <button class="btn" id="btnEditJob" disabled>Edit Selected</button>
        </div>
      </div>
    </div>

    <div class="top">
      <div>
        <div id="crumb">Active Jobs</div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>
      <div class="seg">
        <button id="tabActive" class="active">Active</button>
        <button id="tabUpcoming">Upcoming</button>
      </div>
    </div>

    <div class="body" id="jobContent">
      <div class="left-col" id="jobTable">Loading jobs...</div>
      <div class="right-col" id="detailPanel">Select a job to view details...</div>
    </div>
  </section>

  <div id="emptyState" class="empty-state" style="display:none;">
    <div class="empty-box">
      <h2>üöÄ No jobs yet</h2>
      <p>Get started by setting up your profile.</p>
      <div class="empty-actions">
        <button id="setupServices">üìç Enter My Service Areas</button>
      </div>
    </div>
  </div>
</div>

<div id="chatBubble">üí¨</div>

<!-- SCRIPTS -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>

<script>
/* ==========================
   AUTH & STATE
========================== */
let UID = null;
let USER_EMAIL = null;

let lastSettings = null;
let rbUrgent = false;
let acceptingJobs = true;

let isGodMode = false;

let jobsCache = {};           // jobId -> job object
let selectedJobId = null;
let currentTab = 'active';

const GOD_EMAIL = 'dealbankers@gmail.com';
const REQUIRED_HINT = "Please enter: Service Areas + Trades + a contact method (Phone or Email).";

/* ==========================
   HELPERS
========================== */
function esc(s){return(''+(s||'')).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

function normalizePhone(p){
  const d = (p||"").replace(/[^\d]/g,'');
  if(d.length===10) return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
  return (p||"").trim();
}

function needsSetup(s){
  if(!s) return true;
  const hasCoverage = !!(s.serviceArea && s.serviceArea.trim().length);
  const hasTrades = !!(s.trades && s.trades.trim().length);
  const hasContact = !!((s.phone && s.phone.trim().length) || (s.email && s.email.trim().length));
  return !(hasCoverage && hasTrades && hasContact);
}

function setSwitch(el, on){
  if(on){ el.classList.add('on'); }
  else{ el.classList.remove('on'); }
  acceptingJobs = !!on;
}

function showSettingsModal(){ settingsModal.style.display='flex'; }
function hideSettingsModal(){ settingsModal.style.display='none'; }

function setBannerVisible(v){ setupBanner.style.display = v ? 'block' : 'none'; }

function showOnboardingCallout(){
  const gear = document.getElementById('btnSettings');
  if(!gear) return;

  const overlay = document.getElementById('setupOverlay');
  overlay.style.display = 'block';
  overlay.setAttribute('aria-hidden','false');

  gear.classList.add('pulse');

  const r = gear.getBoundingClientRect();
  const callout = document.getElementById('setupCallout');
  const top = Math.max(12, r.bottom + 10);
  const left = Math.min(window.innerWidth - callout.offsetWidth - 12, Math.max(12, r.left - 220));
  callout.style.top = `${top}px`;
  callout.style.left = `${left}px`;

  setupGo.onclick = ()=>{
    overlay.style.display='none';
    overlay.setAttribute('aria-hidden','true');
    gear.classList.remove('pulse');
    showSettingsModal();
  };
  setupLater.onclick = ()=>{
    overlay.style.display='none';
    overlay.setAttribute('aria-hidden','true');
    gear.classList.remove('pulse');
  };

  overlay.addEventListener('click', (e)=>{
    if(e.target === overlay){
      overlay.style.display='none';
      overlay.setAttribute('aria-hidden','true');
      gear.classList.remove('pulse');
    }
  }, { once:true });
}

/* ==========================
   GOD MODE: JOB ADMIN UI
========================== */
function setAdminVisible(v){
  adminStrip.style.display = v ? 'block' : 'none';
  btnEditJob.disabled = !v || !selectedJobId;
}
function openJobModal(mode){
  // mode: 'new' | 'edit'
  jobModal.style.display = 'flex';
  const isEdit = (mode === 'edit');

  jobModalTitle.textContent = isEdit ? 'Edit Job' : 'Create Job';

  if(isEdit){
    const j = jobsCache[selectedJobId];
    if(!j){ alert('No job selected'); return; }
    jobTitle.value = j.title || '';
    jobStatus.value = j.status || 'active';
    jobTrade.value = j.trade || '';
    jobAddress.value = j.address || '';
    jobCity.value = j.city || '';
    jobZip.value = j.zip || '';
    jobDate.value = j.targetDate || '';
    jobBudget.value = j.budget || '';
    jobDesc.value = j.description || '';
    jobDeleteBtn.style.display = 'inline-flex';
  }else{
    selectedJobId = selectedJobId; // keep selection unchanged
    jobTitle.value = '';
    jobStatus.value = currentTab === 'upcoming' ? 'upcoming' : 'active';
    jobTrade.value = '';
    jobAddress.value = '';
    jobCity.value = '';
    jobZip.value = '';
    jobDate.value = '';
    jobBudget.value = '';
    jobDesc.value = '';
    jobDeleteBtn.style.display = 'none';
  }

  jobSave.dataset.mode = mode;
}
function closeJobModal(){ jobModal.style.display='none'; }

function jobPayload(){
  return {
    title: jobTitle.value.trim(),
    status: jobStatus.value,
    trade: jobTrade.value.trim(),
    address: jobAddress.value.trim(),
    city: jobCity.value.trim(),
    zip: jobZip.value.trim(),
    targetDate: jobDate.value.trim(),
    budget: jobBudget.value.trim(),
    description: jobDesc.value.trim(),
    updatedAt: new Date().toISOString(),
    updatedBy: USER_EMAIL || null
  };
}

/* ==========================
   JOB LIST + DETAILS
========================== */
function setTab(tab){
  currentTab = tab;
  tabActive.classList.toggle('active', tab === 'active');
  tabUpcoming.classList.toggle('active', tab === 'upcoming');
  crumb.textContent = tab === 'active' ? 'Active Jobs' : 'Upcoming Jobs';
  renderJobs();
}

function jobMatchesTab(j){
  if(!j) return false;
  if(currentTab === 'active') return (j.status || 'active') === 'active';
  if(currentTab === 'upcoming') return (j.status || 'active') === 'upcoming';
  return true;
}

function renderJobs(){
  const ids = Object.keys(jobsCache)
    .filter(id => jobMatchesTab(jobsCache[id]))
    .sort((a,b)=>{
      const ta = jobsCache[a]?.createdAt || jobsCache[a]?.updatedAt || '';
      const tb = jobsCache[b]?.createdAt || jobsCache[b]?.updatedAt || '';
      return (tb > ta ? 1 : -1);
    });

  if(ids.length === 0){
    jobTable.innerHTML = `<div style="padding:14px;opacity:.9">No ${currentTab} jobs.</div>`;
    detailPanel.innerHTML = `Select a job to view details...`;
    selectedJobId = null;
    if(isGodMode) btnEditJob.disabled = true;
    return;
  }

  let html = `<div class="list">`;
  for(const id of ids){
    const j = jobsCache[id] || {};
    const active = (id === selectedJobId) ? 'active' : '';
    const meta = [j.trade, j.city || j.zip, j.targetDate].filter(Boolean).join(' ‚Ä¢ ');
    html += `
      <div class="row ${active}" data-jobid="${esc(id)}">
        <div class="t">${esc(j.title || '(Untitled job)')}</div>
        <div class="m">${esc(meta || '')}</div>
        <div class="m"><span class="pill">${esc((j.status||'active').toUpperCase())}</span></div>
      </div>
    `;
  }
  html += `</div>`;
  jobTable.innerHTML = html;

  // auto-select first if none selected
  if(!selectedJobId){
    selectedJobId = ids[0];
  }
  renderJobDetail(selectedJobId);
  if(isGodMode) btnEditJob.disabled = !selectedJobId;
}

function renderJobDetail(id){
  const j = jobsCache[id];
  if(!j){
    detailPanel.innerHTML = `Select a job to view details...`;
    return;
  }
  detailPanel.innerHTML = `
    <div class="panel">
      <h3>${esc(j.title || '(Untitled job)')}</h3>
      <div class="kv"><b>Status:</b> ${esc(j.status || 'active')}</div>
      <div class="kv"><b>Trade:</b> ${esc(j.trade || '')}</div>
      <div class="kv"><b>Address:</b> ${esc(j.address || '')}</div>
      <div class="kv"><b>City/ZIP:</b> ${esc([j.city, j.zip].filter(Boolean).join(' '))}</div>
      <div class="kv"><b>Target Date:</b> ${esc(j.targetDate || '')}</div>
      <div class="kv"><b>Budget:</b> ${esc(j.budget || '')}</div>
      <div class="hr"></div>
      <div class="kv"><b>Description:</b><br/>${esc(j.description || '').replace(/\n/g,'<br/>')}</div>
      <div class="hr"></div>
      <div class="small">Updated: ${esc(j.updatedAt || '')}</div>
    </div>
  `;

  // highlight selection
  document.querySelectorAll('.row[data-jobid]').forEach(r=>{
    r.classList.toggle('active', r.dataset.jobid === id);
  });
}

/* ==========================
   FIREBASE: LOAD JOBS
========================== */
function subscribeJobs(){
  status.textContent = 'Loading‚Ä¶';

  firebase.database().ref('jobs').on('value', snap=>{
    jobsCache = snap.val() || {};
    status.textContent = 'Loaded';
    renderJobs();
  }, err=>{
    console.warn(err);
    status.textContent = 'Error loading jobs';
  });
}

/* ==========================
   UX: SETTINGS LOAD/SAVE
========================== */
async function loadSettings() {
  const snap = await firebase.database().ref(`users/${UID}/contractorSettings`).once('value');
  const s = snap.val();
  lastSettings = s || null;

  if (s) {
    bizName.value = s.businessName || "";
    serviceArea.value = s.serviceArea || "";
    trades.value = s.trades || "";

    contactPhone.value = s.phone || "";
    contactEmail.value = s.email || "";
    prefContact.value = s.preferredContact || "text";
    isLicensed.checked = !!s.licensed;
    isInsured.checked = !!s.insured;

    const on = (typeof s.acceptingJobs === 'boolean')
      ? s.acceptingJobs
      : (typeof s.liveShare === 'boolean' ? s.liveShare : true);

    setSwitch(acceptSwitch, on);
    emptyState.style.display = "none";
  } else {
    emptyState.style.display = "block";
    setSwitch(acceptSwitch, true);
    prefContact.value = "text";
  }

  const missing = needsSetup(s);
  setBannerVisible(missing);

  if(missing){
    showOnboardingCallout();
  }
}

saveSettings.onclick = async () => {
  const payload = {
    businessName: bizName.value.trim(),
    serviceArea: serviceArea.value.trim(),
    trades: trades.value.trim(),

    phone: normalizePhone(contactPhone.value),
    email: contactEmail.value.trim(),
    preferredContact: prefContact.value,

    licensed: !!isLicensed.checked,
    insured: !!isInsured.checked,

    acceptingJobs: !!acceptingJobs,

    updatedAt: new Date().toISOString()
  };

  if(needsSetup(payload)){
    alert(REQUIRED_HINT);
    return;
  }

  await firebase.database().ref(`users/${UID}/contractorSettings`).set(payload);

  alert("Settings saved!");
  hideSettingsModal();
  emptyState.style.display = "none";
  setBannerVisible(false);
  lastSettings = payload;
};

/* ==========================
   BLUE/RED REQUESTS
========================== */
function showRBModal(urgent){
  rbUrgent = !!urgent;
  rbModal.style.display='flex';
  rbTitle.textContent = urgent ? 'üö® Urgent Request' : 'üåÄ Blue Request';
}
function hideRBModal(){ rbModal.style.display='none'; }

rbSubmit.onclick = async ()=>{
  await firebase.database().ref('requests').push({
    portal:'contractor',
    cat:rbCategory.value,
    subject:rbSubject.value,
    details:rbDetails.value,
    urgent: rbUrgent,
    uid:UID,
    email: USER_EMAIL || null,
    ts:firebase.database.ServerValue.TIMESTAMP
  });
  alert('Request Sent!');
  hideRBModal();
};

/* ==========================
   EVENTS / WIRING
========================== */
bannerFix.onclick = ()=> showSettingsModal();
acceptSwitch.onclick = ()=> setSwitch(acceptSwitch, !acceptSwitch.classList.contains('on'));

btnSettings.onclick = ()=> showSettingsModal();
closeSettings.onclick = ()=> hideSettingsModal();
setupServices.onclick = ()=> showSettingsModal();

tabActive.onclick = ()=> setTab('active');
tabUpcoming.onclick = ()=> setTab('upcoming');

document.addEventListener('click',e=>{
  if(e.target.id==='btnRed') showRBModal(true);
  if(e.target.id==='btnBlue') showRBModal(false);
  if(e.target.id==='rbCancel') hideRBModal();

  // job list row click
  const row = e.target.closest && e.target.closest('.row[data-jobid]');
  if(row){
    selectedJobId = row.dataset.jobid;
    renderJobDetail(selectedJobId);
    if(isGodMode) btnEditJob.disabled = !selectedJobId;
  }
});

// Job modal buttons
btnNewJob.onclick = ()=> openJobModal('new');
btnEditJob.onclick = ()=> {
  if(!selectedJobId) return alert('Select a job first');
  openJobModal('edit');
};
jobCancel.onclick = ()=> closeJobModal();

// Save job
jobSave.onclick = async ()=>{
  if(!isGodMode) return alert('Not authorized');
  const mode = jobSave.dataset.mode || 'new';
  const payload = jobPayload();

  if(!payload.title){
    alert('Title is required');
    return;
  }

  if(mode === 'edit'){
    if(!selectedJobId) return alert('No job selected');
    await firebase.database().ref(`jobs/${selectedJobId}`).update(payload);
    closeJobModal();
    return;
  }

  // new
  const ref = firebase.database().ref('jobs').push();
  const jobId = ref.key;
  const created = {
    ...payload,
    createdAt: new Date().toISOString(),
    createdBy: USER_EMAIL || null
  };
  await firebase.database().ref(`jobs/${jobId}`).set(created);
  selectedJobId = jobId;
  closeJobModal();
};

// Delete job
jobDeleteBtn.onclick = async ()=>{
  if(!isGodMode) return alert('Not authorized');
  if(!selectedJobId) return;
  const ok = confirm('Delete this job permanently?');
  if(!ok) return;
  await firebase.database().ref(`jobs/${selectedJobId}`).remove();
  selectedJobId = null;
  closeJobModal();
};

/* ==========================
   CHAT + PRESENCE + AUTH
========================== */
chatBubble.onclick = ()=>location.href="townhall.html?from=contractor";

document.getElementById('logoutBtn').onclick = ()=> firebase.auth().signOut();

firebase.auth().onAuthStateChanged(async u => {
  if (!u) return location.href = "index.html";
  UID = u.uid;
  USER_EMAIL = (u.email || '').toLowerCase();
  isGodMode = (USER_EMAIL === GOD_EMAIL);

  setAdminVisible(isGodMode);

  await loadSettings();
  subscribeJobs();

  // presence tracking
  const userStatusRef=firebase.database().ref(`/presence/${UID}`);
  const isOffline={state:'offline',last_changed:firebase.database.ServerValue.TIMESTAMP};
  const isOnline={
    state:'online',
    last_changed:firebase.database.ServerValue.TIMESTAMP,
    portal:document.body.dataset.portal,email:u.email
  };
  firebase.database().ref('.info/connected').on('value',snap=>{
    if(snap.val()==false) return;
    userStatusRef.onDisconnect().set(isOffline).then(()=>userStatusRef.set(isOnline));
  });

  firebase.database().ref('adminNotifications').push({
    msg:`${u.email} logged into Contractor Portal`,
    ts:firebase.database.ServerValue.TIMESTAMP
  });
});
</script>

</body>
</html>
