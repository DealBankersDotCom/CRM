<!-- ======================= DealBankers • Capital Console ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers • Capital Console</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
/* (styles unchanged) */
:root{ --bg:#0b1118; --bg2:#0f1a24; --panel:#0f1f2b; --line:#254a63;
  --text:#e9f3ff; --muted:#a9c3db; --gold:#ffd36b; --green:#26cf84; --blue:#2b74ff; --red:#ff5e6c;
  --chip:#0e2030; --shadow:0 26px 60px rgba(0,0,0,.55); --r:14px;}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{background:
  radial-gradient(900px 420px at 100% -10%, rgba(71,180,255,.15) 0%, transparent 60%),
  linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);
  color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;}
/* … keep all your original styles … */
</style>

<!-- Firebase (to pull displayName by uid) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>
<!-- … keep your exact HTML structure (header/cards/etc.) … -->

<script>
/* ===================== CONFIG ===================== */
const DATA_ENDPOINT = "YOUR_WEB_APP_URL_HERE";
const LOG_ENDPOINT  = "YOUR_WEB_APP_URL_HERE";
const SHEET_TAB     = "SA";
const PAGE_SIZE     = 1000;

/* Firebase (for pulling displayName by uid) */
const firebaseConfig = {
  apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
  authDomain:"deal-bankers.firebaseapp.com",
  databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
  projectId:"deal-bankers"
};
let ccApp=null, ccDb=null;
try{ ccApp = firebase.initializeApp(firebaseConfig, "capitalConsole"); ccDb = ccApp.database(); }catch(_){}

/* ===================== STATE ===================== */
const $ = s => document.querySelector(s);
const toast = msg => { const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1400); };

const params   = new URL(location.href).searchParams;
const uidParam = params.get("uid")  || "";
const urlName  = (params.get("name")||"").trim();

let agentName = localStorage.getItem("db_agent_name") || "";
let dialMode  = localStorage.getItem("db_dial_mode") || "device"; // device|textnow|gvoice
let all = []; let filtered = []; let cur = -1; let calls = Number(localStorage.getItem("db_call_count")||0);

const Scripts = {
  intro:  "Hey, this is {{agent}} with DealBankers. We place private capital into quick, secured deals—short terms, strong collateral, and clarity on exit. Are you open to reviewing a couple live opportunities this week?",
  terms:  "We target 8–12% effective returns on short paper (30–180 days) or profit-share on highly secured flips. First-lien or JV, you choose. Funds are wired to title/escrow only.",
  seller: "We also structure clean seller-finance exits for retail buyers. If you like paper, we’ll place you in 1st position with conservative LTV and real security.",
  close:  "I’ll send a one-pager with the next two deals. What’s the best email, and do you prefer daily or weekly inventory updates?"
};

/* ===================== HELPERS ===================== */
const onlyDigits = s => (s||"").replace(/[^\d+]/g,"");
const fmtPhone   = s => {
  const d = (s||"").replace(/[^\d]/g,"");
  if(d.length===11 && d.startsWith("1")) return `+1 ${d.slice(1,4)}-${d.slice(4,7)}-${d.slice(7)}`;
  if(d.length===10) return `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
  return s||"";
};
const phoneHref = (number) => {
  const num = onlyDigits(number);
  if(!num) return "#";
  if(dialMode==="device") return `tel:${num}`;
  if(dialMode==="textnow"){ navigator.clipboard.writeText(num); return "https://www.textnow.com/messaging"; }
  if(dialMode==="gvoice"){ navigator.clipboard.writeText(num); return "https://voice.google.com/u/0/messages"; }
  return `tel:${num}`;
};
function scriptText(key, prospect){
  const first = (prospect?.first||"").trim() || (prospect?.name||"").split(" ")[0] || "there";
  return (Scripts[key]||"").replace(/\{\{agent\}\}/g, agentName || "our team").replace(/\{\{first\}\}/g, first);
}
function setDialMode(m){
  dialMode = m; localStorage.setItem("db_dial_mode",m);
  $("#dialModeBtn").textContent = m==="device"?"Device":(m==="textnow"?"TextNow":"Google Voice");
  $("#dialModeText").textContent = $("#dialModeBtn").textContent;
}
function hotKey(e,k,fn){ if(e.key.toLowerCase()===k && !e.altKey && !e.ctrlKey && !e.metaKey){ e.preventDefault(); fn(); }}

/* -------- Agent name resolver: NO PROMPTS ON LOAD -------- */
async function initAgentName(){
  // 1) URL override
  if(urlName){
    agentName = urlName; localStorage.setItem("db_agent_name", agentName); return;
  }
  // 2) Local storage
  if(agentName){ return; }
  // 3) Firebase profile (displayName → email prefix)
  try{
    if(ccDb && uidParam){
      const snap = await ccDb.ref(`userSettings/${uidParam}/profile`).get();
      const v = snap.val()||{};
      const cloud = (v.displayName||"").trim() || (v.email||"").split("@")[0] || "";
      if(cloud){
        agentName = cloud; localStorage.setItem("db_agent_name", agentName); return;
      }
    }
  }catch(e){ console.warn("displayName load failed", e); }
  // 4) Fallback: brand name
  agentName = "DealBankers";
  localStorage.setItem("db_agent_name", agentName);
}

/* ===================== RENDER (unchanged) ===================== */
function drawList(){ /* ... keep your implementation exactly ... */ }
function pick(){ /* ... keep your implementation exactly ... */ }
function next(d=+1){ /* ... keep your implementation exactly ... */ }

/* ===================== DATA / EVENTS / SAVE (unchanged) ===================== */
/* Keep the rest of your original JS exactly as you pasted it,
   except for: 
   - remove/omit the old ensureAgentPrompt() function
   - at the very bottom init with initAgentName().then(loadData)
*/

$("#dialModeBtn").onclick=()=>{ const order=["device","textnow","gvoice"]; const i=order.indexOf(dialMode); setDialMode(order[(i+1)%order.length]); };

/* Change + persist name on demand (manual prompt only when clicking the button) */
$("#setName").onclick=async()=>{
  const nm = prompt("Set your display name (shown in script):", agentName||"");
  if(nm===null) return;
  agentName = (nm||"").trim();
  localStorage.setItem("db_agent_name", agentName);
  if(ccDb && uidParam){
    try{ await ccDb.ref(`userSettings/${uidParam}/profile/displayName`).set(agentName); }catch(e){ console.warn("displayName save failed", e); }
  }
  if(cur>=0){ const activeKey=document.querySelector(".tab.active")?.dataset.k || "intro"; $("#scriptBox").textContent = scriptText(activeKey, filtered[cur]); }
};

/* … keep all other event handlers and functions the same … */

/* ===================== INIT ===================== */
setDialMode(dialMode);
$("#callsStat").textContent = "Calls: " + calls;
initAgentName().then(loadData);
</script>
</body>
</html>
