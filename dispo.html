<!-- ======================= DealBankers ‚Ä¢ Capital Console (admin queue control, per-user import, local+cloud persistence) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Capital Console</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

<style>
:root{
  --bg:#0b1118; --bg2:#0f1a24; --panel:#0f1f2b; --line:#254a63;
  --text:#e9f3ff; --muted:#a9c3db; --gold:#ffd36b; --green:#26cf84; --blue:#2b74ff; --red:#ff5e6c;
  --chip:#0e2030; --shadow:0 26px 60px rgba(0,0,0,.55); --r:14px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  background:
    radial-gradient(900px 420px at 100% -10%, rgba(71,180,255,.15) 0%, transparent 60%),
    linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);
  color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;
}
header{
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  border-bottom:1px solid var(--line);
}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.3px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6}
.kb{opacity:.8}
.topbtn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0e2433;color:#cfe3f6;text-decoration:none;cursor:pointer}
.topbtn.primary{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.topbtn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.topbtn.red{background:linear-gradient(180deg,#ff7b85,#d24652);border:none;color:#fff}
.wrap{padding:12px}
.grid{display:grid;gap:12px;grid-template-columns:1.1fr 1fr 1fr}
@media (max-width:1200px){ .grid{grid-template-columns:1fr} }

.card{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.card .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06))}
.card .body{padding:10px}

input,textarea,select{
  width:100%;background:#0f1a24;border:1px solid var(--line);color:#e9f3ff;border-radius:10px;
  padding:10px 12px;font-size:14px
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f2434;color:#cfe3f6;cursor:pointer;text-decoration:none;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);border:none;color:#211a05}
.btn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.btn.blue{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.btn.red{background:linear-gradient(180deg,#ff7b85,#d24652);border:none;color:#fff}
.small{padding:8px 10px;font-size:13px}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0f2a3a;border:1px solid var(--line);font-size:12px}

.list{display:flex;flex-direction:column;gap:8px;max-height:66vh;overflow:auto;padding:10px}
.item{border:1px solid var(--line);border-radius:12px;background:#0f1a24;padding:10px;cursor:pointer}
.item.active{outline:2px solid #52a6ff}
.item .name{font-weight:800}
.muted{color:var(--muted)}
.kbd{font-family:ui-monospace,Consolas,monospace;font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:#0b1a24;color:#cfe3f6}
.right{justify-content:flex-end}

.scriptTabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.scriptTabs button{border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6;border-radius:999px;padding:6px 10px;cursor:pointer}
.scriptTabs button.active{background:linear-gradient(180deg,var(--blue),#0a58ca);color:#fff;border:none}
.scriptBox{background:#0e2231;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:180px;line-height:1.45}
.flagrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.statusDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#718aa1}
.statusDot.hot{background:#ffb34f}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 14px;border-radius:12px;background:#0b1218;border:1px solid rgba(255,255,255,.2);display:none;z-index:40}

/* Admin bar */
.adminBar{display:none;gap:8px;align-items:center;flex-wrap:wrap;padding:8px 12px;border-bottom:1px dashed var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
.adminBar .seg{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.adminBar input[type="text"]{height:38px}

/* Disabled overlay for non-admin users */
.disabledNote{margin:12px 0;padding:10px 12px;border-radius:10px;border:1px dashed #6d2d2d;background:#1a0f12;color:#ffb4b4;display:none}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <span style="font-size:18px">‚ö°Ô∏è DealBankers</span>
    <span class="badge">Capital Console</span>
    <span class="kb">Search <span class="kbd">/</span> ‚Ä¢ Next <span class="kbd">N</span> ‚Ä¢ Save <span class="kbd">S</span></span>
  </div>
  <div class="row">
    <button id="dialModeBtn" class="topbtn">Device</button>
    <button id="importBtn" class="topbtn">‚¨ÜÔ∏è Import</button>
    <button id="exportHot" class="topbtn">Export Hotlist</button>
    <button id="setName" class="topbtn">Set My Name</button>
  </div>
</header>

<!-- ADMIN BAR (only visible to admins) -->
<div id="adminBar" class="adminBar">
  <div class="seg">
    <span class="badge">Admin</span>
    <input id="targetUid" type="text" placeholder="Target UID (leave blank for me)" style="min-width:340px"/>
    <button id="loadTarget" class="topbtn">Load</button>
  </div>
  <div class="seg">
    <button id="toggleQueue" class="topbtn">Queue: ‚Äî</button>
    <button id="pushCloud" class="topbtn">Push to Cloud</button>
    <button id="pullCloud" class="topbtn">Pull from Cloud</button>
  </div>
</div>

<div class="wrap">
  <div id="disabledNote" class="disabledNote">This buyer queue is currently <b>OFF</b> for your account. Ask an admin to enable it.</div>

  <div class="grid">
    <!-- LEFT: Prospects -->
    <section class="card">
      <div class="head">
        <div>Prospects / Buyers</div>
        <div class="row">
          <span class="tag"><span class="statusDot hot"></span> Hot</span>
          <span class="tag" id="callsStat">Calls: 0</span>
        </div>
      </div>
      <div class="body">
        <input id="search" placeholder="Search name, phone, email, notes‚Ä¶ ( / )"/>
        <div class="row" style="margin-top:8px">
          <button id="randomBtn" class="btn small">üé≤ Random</button>
          <button id="clearFilter" class="btn small">All</button>
        </div>
        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- CENTER: Contact / Actions -->
    <section class="card">
      <div class="head">
        <div id="curName" style="font-weight:900">‚Äî</div>
        <div class="row">
          <span class="tag" id="curStatus">Status: ‚Äî</span>
          <span class="tag" id="lastSeen">Last: ‚Äî</span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <button id="callBtn" class="btn gold">üìû Call</button>
          <button id="textBtn" class="btn gold">üí¨ Text</button>
          <button id="copyBtn" class="btn">üìã Copy Number</button>
        </div>

        <!-- Basic identity edits (added so you can clean entries after import) -->
        <div class="row" style="margin-top:10px">
          <div style="flex:1;min-width:220px">
            <label>Name</label>
            <input id="editName" placeholder="Name"/>
          </div>
          <div style="flex:1;min-width:180px">
            <label>Phone</label>
            <input id="editPhone" placeholder="Phone"/>
          </div>
          <div style="flex:1;min-width:220px">
            <label>Email</label>
            <input id="editEmail" placeholder="Email"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Soft Commit ($)</label>
            <input id="softCommit" placeholder="e.g., 50,000"/>
          </div>
          <div style="flex:1">
            <label>Tag / Status</label>
            <select id="statusSel">
              <option value="">‚Äî</option>
              <option>Interested</option>
              <option>Follow-up</option>
              <option>Bad Number</option>
              <option>DNC</option>
            </select>
          </div>
        </div>

        <label style="display:block;margin-top:8px">Notes</label>
        <textarea id="notes"></textarea>

        <div class="row right" style="margin-top:10px">
          <button id="saveBtn" class="btn green">üíæ Save</button>
          <button id="prevBtn" class="btn">‚óÄ Prev</button>
          <button id="nextBtn" class="btn">Next ‚ñ∂</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Dial mode is <b id="dialModeText">Device</b>.
          Click ‚ÄúDevice‚Äù to switch Device / TextNow / Google Voice.
          ‚ÄúCopy Number‚Äù places the number on clipboard for web dialers.
        </div>
      </div>
    </section>

    <!-- RIGHT: Script -->
    <section class="card">
      <div class="head">
        <div>Pitch / Script</div>
      </div>
      <div class="body">
        <div class="scriptTabs">
          <button class="tab active" data-k="intro">Intro</button>
          <button class="tab" data-k="terms">Terms</button>
          <button class="tab" data-k="seller">Seller Finance</button>
          <button class="tab" data-k="close">Close</button>
        </div>
        <div id="scriptBox" class="scriptBox"></div>

        <div class="flagrow">
          <button class="btn green small" id="flagInterested">‚úî Interested</button>
          <button class="btn small" id="flagFollow">üóì Follow-up</button>
          <button class="btn red small" id="flagBad">‚ùå Bad Number</button>
          <button class="btn small" id="flagDnc">üö´ DNC</button>
        </div>
      </div>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== CONFIG ===================== */
// Optional: Apps Script GET/POST (kept here if you still want a sheet pull)
// Leave blank "" to skip.
const DATA_ENDPOINT = "";          // e.g. https://script.google.com/.../exec
const LOG_ENDPOINT  = "";          // POST edits if you want a server log
const SHEET_TAB     = "SA";
const PAGE_SIZE     = 1000;

/* Firebase */
const firebaseConfig = {
  apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
  authDomain:"deal-bankers.firebaseapp.com",
  databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
  projectId:"deal-bankers"
};
let app = null, auth = null, db = null;
try{ app=firebase.initializeApp(firebaseConfig, "cc"); auth=app.auth(); db=app.database(); }catch(_){}

/* ===================== STATE ===================== */
const $ = s => document.querySelector(s);
const on = (id, ev, fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener(ev, fn); };
const toast = msg => { const t=$("#toast"); if(!t) return; t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1400); };
const params   = new URL(location.href).searchParams;

let meUid = "", meEmail = "";
let isAdmin = false;

let workUid = "";             // whose queue we're editing/using
let queueEnabled = false;

let agentName = localStorage.getItem("db_agent_name") || (params.get("name")||"").trim() || "DealBankers";
let dialMode  = localStorage.getItem("db_dial_mode") || "device"; // device|textnow|gvoice
let all = [];          // all prospects
let filtered = [];     // filtered list
let cur = -1;          // index into filtered
let calls = Number(localStorage.getItem("db_call_count")||0);

const Scripts = {
  intro:  "Hey, this is {{agent}} with DealBankers. We place private capital into quick, secured deals‚Äîshort terms, strong collateral, and clarity on exit. Are you open to reviewing a couple live opportunities this week?",
  terms:  "We target 8‚Äì12% effective returns on short paper (30‚Äì180 days) or profit-share on highly secured flips. First-lien or JV, you choose. Funds are wired to title/escrow only.",
  seller: "We also structure clean seller-finance exits for retail buyers. If you like paper, we‚Äôll place you in 1st position with conservative LTV and real security.",
  close:  "I‚Äôll send a one-pager with the next two deals. What‚Äôs the best email, and do you prefer daily or weekly inventory updates?"
};

/* ===================== HELPERS ===================== */
const onlyDigits = s => (s||"").replace(/[^\d+]/g,"");
const fmtPhone   = s => {
  const d = (s||"").replace(/[^\d]/g,"");
  if(d.length===11 && d.startsWith("1")) return `+1 ${d.slice(1,4)}-${d.slice(4,7)}-${d.slice(7)}`;
  if(d.length===10) return `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
  return s||"";
};
const phoneHref = (number) => {
  const num = onlyDigits(number);
  if(!num) return "#";
  if(dialMode==="device") return `tel:${num}`;
  if(dialMode==="textnow"){ navigator.clipboard.writeText(num); return "https://www.textnow.com/messaging"; }
  if(dialMode==="gvoice"){ navigator.clipboard.writeText(num); return "https://voice.google.com/u/0/messages"; }
  return `tel:${num}`;
};
const scriptText = (key, p) => (Scripts[key]||"").replace(/\{\{agent\}\}/g, agentName || "our team").replace(/\{\{first\}\}/g, ((p?.first||"").trim() || (p?.name||"there").split(" ")[0]));

/* Local storage (per user queue) */
const STORE_KEY = uid => `db_cc_queue_${uid||'anon'}`;
function loadLocal(uid){
  try{ const raw = localStorage.getItem(STORE_KEY(uid)); if(!raw) return false;
       const arr = JSON.parse(raw); if(Array.isArray(arr)){ all = arr; filtered=[...all]; cur=filtered.length?0:-1; drawList(); pick(); return true; }
  }catch(e){ console.warn("Local load failed",e); }
  return false;
}
function persistLocal(uid){ try{ localStorage.setItem(STORE_KEY(uid), JSON.stringify(all)); }catch(e){ console.warn("Persist failed", e); } }

/* Cloud paths */
const Q_PATH = uid => `capitalConsole/${uid}/queue`;
const E_PATH = uid => `capitalConsole/${uid}/enabled`;
const R_PATH = uid => `roles/${uid}`;

async function cloudLoad(uid){
  if(!db || !uid) return {enabled:false, rows:[]};
  const [q,e] = await Promise.all([db.ref(Q_PATH(uid)).get(), db.ref(E_PATH(uid)).get()]);
  const obj = q.val()||{};
  const rows = Object.keys(obj).map(k=>({...obj[k], id:k}));
  return {enabled: !!e.val(), rows};
}
async function cloudSave(uid){
  if(!db || !uid) return;
  const obj={}; for(const r of all){ obj[r.id||crypto.randomUUID()] = {...r, id: undefined}; }
  await db.ref(Q_PATH(uid)).set(obj);
}
async function cloudSetEnabled(uid, val){
  if(!db || !uid) return;
  await db.ref(E_PATH(uid)).set(!!val);
}

/* debounce */
function debounce(fn, ms){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const saveCloudDebounced = debounce(()=>cloudSave(workUid).catch(()=>{}), 600);

/* UI state */
function setDialMode(m){
  dialMode = m; localStorage.setItem("db_dial_mode",m);
  const btn=$("#dialModeBtn"); const txt=$("#dialModeText");
  const label = m==="device"?"Device":(m==="textnow"?"TextNow":"Google Voice");
  if(btn) btn.textContent = label; if(txt) txt.textContent = label;
}
function updateAdminBar(){
  const bar=$("#adminBar"); if(!bar) return;
  bar.style.display = isAdmin ? "flex" : "none";
  const tgt=$("#targetUid"); if(tgt && workUid) tgt.value = workUid===meUid? "": workUid;
  const tbtn=$("#toggleQueue"); if(tbtn) tbtn.textContent = `Queue: ${queueEnabled ? "ON" : "OFF"}`;
}
function updateDisabledNote(){
  const note=$("#disabledNote");
  if(!note) return;
  const iAmWorkingOnMe = (workUid===meUid);
  note.style.display = (!isAdmin && iAmWorkingOnMe && !queueEnabled) ? "block" : "none";
}

/* ===================== RENDER ===================== */
function drawList(){
  const L=$("#list"); if(!L) return;
  L.innerHTML="";
  filtered.forEach((p,i)=>{
    const d=document.createElement("div"); d.className="item"+(i===cur?" active":"");
    d.innerHTML = `
      <div class="name">${p.name||"Unknown"}</div>
      <div class="muted">${fmtPhone(p.phone)} ${p.email?(" ‚Ä¢ "+p.email):""}</div>
    `;
    d.onclick=()=>{ cur=i; pick(); };
    L.appendChild(d);
  });
}
function pick(){
  const p = filtered[cur];
  const curName=$("#curName"), curStatus=$("#curStatus"), lastSeen=$("#lastSeen"),
        soft=$("#softCommit"), statSel=$("#statusSel"), notes=$("#notes"),
        box=$("#scriptBox"), nameEl=$("#editName"), phoneEl=$("#editPhone"), emailEl=$("#editEmail");

  if(!p){ if(curName) curName.textContent="‚Äî"; return; }

  curName.textContent = p.name||"‚Äî";
  curStatus.textContent = "Status: " + (p.status||"‚Äî");
  lastSeen.textContent  = "Last: " + (p.updatedAt? new Date(p.updatedAt).toLocaleString() : "‚Äî");

  nameEl.value  = p.name  || "";
  phoneEl.value = p.phone || "";
  emailEl.value = p.email || "";

  soft.value = p.softCommit||"";
  statSel.value  = p.status||"";
  notes.value    = p.notes||"";

  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  const introBtn = document.querySelector('.tab[data-k="intro"]'); if(introBtn) introBtn.classList.add("active");
  box.textContent = scriptText("intro",p);

  drawList(); // refresh highlight
}
function next(d=+1){
  if(!filtered.length) return;
  cur = (cur + d + filtered.length) % filtered.length;
  pick();
}

/* ===================== DATA LOADING ===================== */
async function loadWorkUid(uid){
  workUid = uid || meUid || "";
  if(!workUid) return;

  // 1) Try cloud
  try{
    const c = await cloudLoad(workUid);
    queueEnabled = !!c.enabled;
    if(c.rows && c.rows.length){
      all = c.rows.map(r=>({ id:r.id || crypto.randomUUID(), ...r }));
      filtered=[...all]; cur=filtered.length?0:-1;
      drawList(); pick();
      updateAdminBar(); updateDisabledNote();
      persistLocal(workUid);
      return;
    }
  }catch(e){ console.warn("cloud load failed", e); }

  // 2) Try local
  if(loadLocal(workUid)){ updateAdminBar(); updateDisabledNote(); return; }

  // 3) Optional sheet
  if(DATA_ENDPOINT){
    await loadFromSheet();
    persistLocal(workUid);
    updateAdminBar(); updateDisabledNote();
    return;
  }

  // 4) Demo
  demo();
  persistLocal(workUid);
  updateAdminBar(); updateDisabledNote();
}

async function loadFromSheet(){
  let url = DATA_ENDPOINT;
  const q = new URLSearchParams({ sheet: SHEET_TAB, limit: PAGE_SIZE });
  url += (url.includes("?")?"&":"?")+q.toString();
  try{
    const res = await fetch(url,{mode:"cors"});
    const json = await res.json();
    all = (json.rows||[]).map(r=>{
      const id = r.id || r.row || r._id || crypto.randomUUID();
      const first = r.first || r.FirstName || "";
      const last  = r.last  || r.LastName  || r["Last Name"] || "";
      const name  = (r.name || `${first} ${last}`).trim();
      return {
        id, first, last, name,
        phone: r.phone || r.Phone || "",
        email: r.email || r.Email || "",
        notes: r.notes || r.Notes || "",
        mailing: r.mailing || r.Mailing || "",
        status: r.status || r.Status || "",
        softCommit: r.softCommit || "",
        updatedAt: r.updatedAt || 0
      };
    });
    filtered=[...all];
    cur = filtered.length?0:-1;
    drawList(); pick();
    toast("Loaded from sheet");
  }catch(err){
    console.error(err); demo();
  }
}
function demo(){
  all = [
    {id:"1",name:"Alex Reyes",    phone:"2105550101", email:"alex@example.com", notes:"TX based.",                                    status:"", softCommit:""},
    {id:"2",name:"Brenda K",      phone:"5125550199", email:"",                 notes:"Likes 1st lien.",                               status:"", softCommit:""},
    {id:"3",name:"Caleb & Dana",  phone:"8305550117", email:"calebdana@example.com", notes:"1031 funds; lien-first only.",           status:"", softCommit:""}
  ];
  filtered=[...all]; cur=0; drawList(); pick();
}

/* ===================== EVENTS ===================== */
on("dialModeBtn","click",()=>{
  const order = ["device","textnow","gvoice"];
  const i = order.indexOf(dialMode);
  setDialMode(order[(i+1)%order.length]);
});

on("setName","click",async()=>{
  const nm = prompt("Set your display name (shown in script):", agentName||"");
  if(nm===null) return;
  agentName = (nm||"").trim();
  localStorage.setItem("db_agent_name", agentName);
  if(cur>=0){
    const activeKey=document.querySelector(".tab.active")?.dataset.k || "intro";
    const box=$("#scriptBox"); if(box) box.textContent = scriptText(activeKey, filtered[cur]);
  }
});

on("importBtn","click",async()=>{
  // If admin, we import into current workUid (can be your own or target)
  const csv = prompt("Paste CSV. Columns supported:\nFirstName, Last Name, Phone, Email, Notes (order flexible).\nOne contact per line.");
  if(!csv) return;

  // super-lightweight split (CSV or TSV)
  const lines = csv.split(/\r?\n/).filter(l=>l.trim().length);
  const parse = (s)=> s.split(/\t|,/); // allow comma OR tab
  lines.forEach(raw=>{
    const r=parse(raw);
    // Try to auto-detect
    let f="", l="", p="", e="", n="";
    if(r.length>=5){ [f,l,p,e,n] = r; }
    else if(r.length===4){ [f,l,p,e]=r; }
    else if(r.length===3){ [f,l,p]=r; }
    else { [f,p,e]=[r[0]||"",r[1]||"",r[2]||""]; }

    const name = (`${(f||"").trim()} ${(l||"").trim()}`).trim() || (e||p||"New Contact");
    all.push({
      id: crypto.randomUUID(),
      first:f||"", last:l||"", name,
      phone: (p||"").trim(), email:(e||"").trim(), notes:(n||"").trim(),
      status:"", softCommit:"", updatedAt: 0
    });
  });

  filtered=[...all]; cur = filtered.length? (filtered.length-1) : -1;
  drawList(); pick();
  persistLocal(workUid);
  saveCloudDebounced();          // queue stays OFF until you toggle it
  toast("Imported");
});

on("exportHot","click",()=>{
  const rows = all.filter(p=>p.status==="Interested"||p.status==="Follow-up");
  const header = ["Name","Phone","Email","Status","SoftCommit","Notes"];
  const lines = [header.join(",")].concat(rows.map(p=>[
    p.name, p.phone, p.email, p.status||"",
    (p.softCommit||"").toString().replace(/,/g,""),
    (p.notes||"").replace(/[\r\n,]+/g," ")
  ].join(",")));
  const blob = new Blob([lines.join("\n")],{type:"text/csv"});
  const url  = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="hotlist.csv"; a.click();
  URL.revokeObjectURL(url);
});

const searchEl = $("#search");
if(searchEl){
  searchEl.addEventListener("input",()=>{
    const q = searchEl.value.toLowerCase().trim();
    filtered = all.filter(p=>{
      const hay = [p.name,p.phone,p.email,p.notes].join(" ").toLowerCase();
      return !q || hay.includes(q);
    });
    cur = filtered.length?0:-1;
    drawList(); pick();
  });
}
on("clearFilter","click",()=>{ if(!searchEl) return; searchEl.value=""; filtered=[...all]; cur=0; drawList(); pick(); });
on("randomBtn","click",()=>{ if(!filtered.length) return; cur = Math.floor(Math.random()*filtered.length); pick(); });

on("callBtn","click",()=>{
  const p = filtered[cur]; if(!p) return;
  calls++; localStorage.setItem("db_call_count", String(calls));
  const cs=$("#callsStat"); if(cs) cs.textContent = "Calls: " + calls;
  window.open(phoneHref(p.phone), "_blank");
});
on("textBtn","click",()=>{ window.open("https://www.textnow.com/messaging","_blank"); });
on("copyBtn","click",()=>{ const p = filtered[cur]; if(!p) return; navigator.clipboard.writeText(onlyDigits(p.phone)).then(()=>toast("Number copied")); });

on("saveBtn","click",saveCurrent);
on("prevBtn","click",()=>next(-1));
on("nextBtn","click",()=>next(+1));

document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const box=$("#scriptBox"); if(box) box.textContent = scriptText(b.dataset.k, filtered[cur]);
  });
});

on("flagInterested","click",()=>{ const s=$("#statusSel"); if(s){ s.value="Interested"; } saveCurrent(); });
on("flagFollow","click",    ()=>{ const s=$("#statusSel"); if(s){ s.value="Follow-up";  } saveCurrent(); });
on("flagBad","click",       ()=>{ const s=$("#statusSel"); if(s){ s.value="Bad Number"; } saveCurrent(); });
on("flagDnc","click",       ()=>{ const s=$("#statusSel"); if(s){ s.value="DNC";        } saveCurrent(); });

document.addEventListener("keydown",(e)=>{
  if(document.activeElement===searchEl){ if(e.key==="Escape"){ searchEl.blur(); } return; }
  if(e.key==="/"){ e.preventDefault(); if(searchEl) searchEl.focus(); return; }
  const hot=(k,fn)=>{ if(e.key.toLowerCase()===k && !e.ctrlKey && !e.metaKey && !e.altKey){ e.preventDefault(); fn(); } };
  hot("n",()=>next(+1));
  hot("p",()=>next(-1));
  hot("s",()=>saveCurrent());
});

/* ===================== SAVE / POST ===================== */
async function saveCurrent(){
  const p = filtered[cur]; if(!p) return;

  const nameEl=$("#editName"), phoneEl=$("#editPhone"), emailEl=$("#editEmail");
  const soft=$("#softCommit"), statSel=$("#statusSel"), notes=$("#notes");

  p.name       = nameEl?.value.trim()   ?? p.name;
  p.phone      = phoneEl?.value.trim()  ?? p.phone;
  p.email      = emailEl?.value.trim()  ?? p.email;
  p.softCommit = soft?.value.trim()     ?? p.softCommit;
  p.status     = statSel?.value.trim()  ?? p.status;
  p.notes      = notes?.value.trim()    ?? p.notes;
  p.updatedAt  = Date.now();

  // reflect in master
  const idx = all.findIndex(x=>x.id===p.id);
  if(idx>=0) all[idx] = {...p};

  const curStatus=$("#curStatus"), lastSeen=$("#lastSeen");
  if(curStatus) curStatus.textContent = "Status: "+(p.status||"‚Äî");
  if(lastSeen)  lastSeen.textContent  = "Last: "+new Date(p.updatedAt).toLocaleString();
  drawList(); // update left panel with name/phone
  toast("Saved");

  persistLocal(workUid);
  saveCloudDebounced();

  if(LOG_ENDPOINT){
    try{
      await fetch(LOG_ENDPOINT,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"log",
          rowId:p.id, name:p.name, phone:p.phone, email:p.email,
          status:p.status, softCommit:p.softCommit, notes:p.notes,
          agent:agentName, ts:p.updatedAt, workUid
        })
      });
    }catch(e){ console.warn("log failed",e); }
  }
}

/* ===================== ADMIN CONTROLS ===================== */
on("loadTarget","click",async()=>{
  const t = ($("#targetUid")?.value||"").trim();
  await loadWorkUid(t || meUid);
});

on("toggleQueue","click",async()=>{
  queueEnabled = !queueEnabled;
  try{ await cloudSetEnabled(workUid, queueEnabled); }catch(e){ console.warn(e); }
  updateAdminBar(); updateDisabledNote();
  toast(queueEnabled? "Queue enabled" : "Queue disabled");
});

on("pushCloud","click",async()=>{
  try{ await cloudSave(workUid); toast("Pushed to cloud"); }
  catch(e){ console.warn(e); toast("Push failed"); }
});

on("pullCloud","click",async()=>{
  try{
    const c = await cloudLoad(workUid);
    queueEnabled = !!c.enabled;
    all = (c.rows||[]).map(r=>({id:r.id||crypto.randomUUID(),...r}));
    filtered=[...all]; cur=filtered.length?0:-1;
    drawList(); pick();
    persistLocal(workUid);
    updateAdminBar(); updateDisabledNote();
    toast("Pulled from cloud");
  }catch(e){ console.warn(e); toast("Pull failed"); }
});

/* ===================== INIT (auth + choose workUid) ===================== */
function setDialAndCalls(){ setDialMode(dialMode); const cs=$("#callsStat"); if(cs) cs.textContent = "Calls: " + calls; }
setDialAndCalls();

if(auth){
  auth.onAuthStateChanged(async u=>{
    if(!u){ // if not signed in, run in local/offline mode
      meUid = ""; meEmail = ""; isAdmin=false;
      await loadWorkUid(meUid);
      return;
    }
    meUid   = u.uid;
    meEmail = (u.email||"").toLowerCase();

    // admin check
    isAdmin = (meEmail==="dealbankers@gmail.com");
    try{
      const r = await db.ref(R_PATH(meUid)).get();
      if((r.val()||"")==="admin") isAdmin = true;
    }catch(_){}

    // choose initial workUid (query ?uid= overrides if admin)
    const qUid = (params.get("uid")||"").trim();
    workUid = (isAdmin && qUid) ? qUid : meUid;

    updateAdminBar();
    await loadWorkUid(workUid);
  });
}else{
  // no auth available
  (async()=>{ await loadWorkUid(""); })();
}
</script>
</body>
</html>
