<!-- ======================= DealBankers ‚Ä¢ Capital Console (with Firebase queue, ON/OFF, admin staging) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Capital Console</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
:root{
  --bg:#0b1118; --bg2:#0f1a24; --panel:#0f1f2b; --line:#254a63;
  --text:#e9f3ff; --muted:#a9c3db; --gold:#ffd36b; --green:#26cf84; --blue:#2b74ff; --red:#ff5e6c;
  --chip:#0e2030; --shadow:0 26px 60px rgba(0,0,0,.55); --r:14px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  background:
    radial-gradient(900px 420px at 100% -10%, rgba(71,180,255,.15) 0%, transparent 60%),
    linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);
  color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;
}
header{
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  border-bottom:1px solid var(--line);
}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.3px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6}
.kb{opacity:.8}
.topbtn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0e2433;color:#cfe3f6;text-decoration:none;cursor:pointer}
.topbtn.primary{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.topbtn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.topbtn.red{background:linear-gradient(180deg,#ff7b85,#d24652);border:none;color:#fff}
.wrap{padding:12px}
.grid{display:grid;gap:12px;grid-template-columns:1.1fr 1fr 1fr}
@media (max-width:1080px){ .grid{grid-template-columns:1fr} }

.card{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.card .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06))}
.card .body{padding:10px}

input,textarea,select{
  width:100%;background:#0f1a24;border:1px solid var(--line);color:#e9f3ff;border-radius:10px;
  padding:10px 12px;font-size:14px
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f2434;color:#cfe3f6;cursor:pointer;text-decoration:none;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);border:none;color:#211a05}
.btn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.btn.blue{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.btn.red{background:linear-gradient(180deg,#ff7b85,#d24652);border:none;color:#fff}
.small{padding:8px 10px;font-size:13px}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0f2a3a;border:1px solid var(--line);font-size:12px}

.list{display:flex;flex-direction:column;gap:8px;max-height:66vh;overflow:auto;padding:10px}
.item{border:1px solid var(--line);border-radius:12px;background:#0f1a24;padding:10px;cursor:pointer}
.item.active{outline:2px solid #52a6ff}
.item .name{font-weight:800}
.muted{color:var(--muted)}
.kbd{font-family:ui-monospace,Consolas,monospace;font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:#0b1a24;color:#cfe3f6}
.right{justify-content:flex-end}

.scriptTabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.scriptTabs button{border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6;border-radius:999px;padding:6px 10px;cursor:pointer}
.scriptTabs button.active{background:linear-gradient(180deg,var(--blue),#0a58ca);color:#fff;border:none}
.scriptBox{background:#0e2231;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:180px;line-height:1.45}
.flagrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.statusDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#718aa1}
.statusDot.hot{background:#ffb34f}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 14px;border-radius:12px;background:#0b1218;border:1px solid rgba(255,255,255,.2);display:none;z-index:40}

/* Admin bar */
.adminbar{display:flex;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px dashed var(--line);background:#0b1a24}
.adminbar input{min-width:320px}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a}
.warn{color:#ffd36b}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <span style="font-size:18px">‚ö°Ô∏è DealBankers</span>
    <span class="badge">Capital Console</span>
    <span class="kb">Search <span class="kbd">/</span> ‚Ä¢ Next <span class="kbd">N</span> ‚Ä¢ Save <span class="kbd">S</span></span>
  </div>
  <div class="row">
    <button id="dialModeBtn" class="topbtn">Device</button>
    <button id="importBtn" class="topbtn">‚¨ÜÔ∏è Import</button>
    <button id="exportHot" class="topbtn">Export Hotlist</button>
    <button id="setName" class="topbtn">Set My Name</button>
  </div>
</header>

<!-- Queue/Admin bar (shows for everyone; target UID controls only visible for admins) -->
<div id="qbar" class="adminbar" style="display:flex">
  <span class="badge">Queue</span>
  <span class="pill">State: <b id="queueState">‚Äî</b></span>
  <button id="toggleQueue" class="topbtn small">Toggle ON/OFF</button>
  <button id="pullCloud" class="topbtn small">Pull</button>
  <button id="pushCloud" class="topbtn small green">Push</button>
  <span id="stagingMsg" class="kb warn" style="display:none">Staging mode (edits stay local until Push)</span>
  <span style="flex:1"></span>
  <span id="adminOnly" style="display:none" class="row">
    <span class="badge">Admin</span>
    <input id="targetUid" placeholder="Target UID (leave blank for yourself)"/>
    <button id="loadTarget" class="topbtn small">Load</button>
  </span>
</div>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Prospects -->
    <section class="card">
      <div class="head">
        <div>Prospects / Buyers</div>
        <div class="row">
          <span class="tag"><span class="statusDot hot"></span> Hot</span>
          <span class="tag" id="callsStat">Calls: 0</span>
        </div>
      </div>
      <div class="body">
        <input id="search" placeholder="Search name, phone, email, notes‚Ä¶ ( / )"/>
        <div class="row" style="margin-top:8px">
          <button id="randomBtn" class="btn small">üé≤ Random</button>
          <button id="clearFilter" class="btn small">All</button>
        </div>
        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- CENTER: Contact / Actions -->
    <section class="card">
      <div class="head">
        <div id="curName" style="font-weight:900">‚Äî</div>
        <div class="row">
          <span class="tag" id="curStatus">Status: ‚Äî</span>
          <span class="tag" id="lastSeen">Last: ‚Äî</span>
        </div>
      </div>
      <div class="body">

        <div class="row">
          <button id="callBtn" class="btn gold">üìû Call</button>
          <button id="textBtn" class="btn gold">üí¨ Text</button>
          <button id="copyBtn" class="btn">üìã Copy Number</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Name</label>
            <input id="name" placeholder="Name"/>
          </div>
          <div style="flex:1">
            <label>Phone</label>
            <input id="phone" placeholder="Phone"/>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Email</label>
            <input id="email" placeholder="Email"/>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Soft Commit ($)</label>
            <input id="softCommit" placeholder="e.g., 50,000"/>
          </div>
          <div style="flex:1">
            <label>Tag / Status</label>
            <select id="statusSel">
              <option value="">‚Äî</option>
              <option>Interested</option>
              <option>Follow-up</option>
              <option>Bad Number</option>
              <option>DNC</option>
            </select>
          </div>
        </div>

        <label style="display:block;margin-top:8px">Notes</label>
        <textarea id="notes"></textarea>

        <div class="row right" style="margin-top:10px">
          <button id="saveBtn" class="btn green">üíæ Save</button>
          <button id="prevBtn" class="btn">‚óÄ Prev</button>
          <button id="nextBtn" class="btn">Next ‚ñ∂</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Dial mode is <b id="dialModeText">Device</b>.
          Click ‚ÄúDevice‚Äù to switch Device / TextNow / Google Voice.
          ‚ÄúCopy Number‚Äù places the number on clipboard for web dialers.
        </div>
      </div>
    </section>

    <!-- RIGHT: Script -->
    <section class="card">
      <div class="head">
        <div>Pitch / Script</div>
      </div>
      <div class="body">
        <div class="scriptTabs">
          <button class="tab active" data-k="intro">Intro</button>
          <button class="tab" data-k="terms">Terms</button>
          <button class="tab" data-k="seller">Seller Finance</button>
          <button class="tab" data-k="close">Close</button>
        </div>
        <div id="scriptBox" class="scriptBox"></div>

        <div class="flagrow">
          <button class="btn green small" id="flagInterested">‚úî Interested</button>
          <button class="btn small" id="flagFollow">üóì Follow-up</button>
          <button class="btn red small" id="flagBad">‚ùå Bad Number</button>
          <button class="btn small" id="flagDnc">üö´ DNC</button>
        </div>
      </div>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== CONFIG ===================== */
/* Optional: keep these blank if you don't use a Google Sheet */
const DATA_ENDPOINT = "";        // GET buyers list (Apps Script Web App), optional
const LOG_ENDPOINT  = "";        // POST logs back to Apps Script, optional
const SHEET_TAB     = "SA";
const PAGE_SIZE     = 1000;

/* Firebase */
const firebaseConfig = {
  apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
  authDomain:"deal-bankers.firebaseapp.com",
  databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
  projectId:"deal-bankers"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ===================== STATE ===================== */
const $ = s => document.querySelector(s);
const on = (id, ev, fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener(ev, fn); };
const toast = msg => { const t=$("#toast"); if(!t) return; t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1400); };

const params   = new URL(location.href).searchParams;
const uidParam = params.get("uid") || "";
const urlName  = (params.get("name")||"").trim();

let currentUid = "";      // signed in user
let targetUid  = "";      // whose queue we are viewing/editing
let isAdmin    = false;
let staging    = false;   // true when admin editing another user's queue

let agentName = localStorage.getItem("db_agent_name") || "";
let dialMode  = localStorage.getItem("db_dial_mode") || "device";
let all = [];          // all prospects
let filtered = [];     // filtered list
let cur = -1;          // index into filtered
let calls = Number(localStorage.getItem("db_call_count")||0);

const Scripts = {
  intro:  "Hey, this is {{agent}} with DealBankers. We place private capital into quick, secured deals‚Äîshort terms, strong collateral, and clarity on exit. Are you open to reviewing a couple live opportunities this week?",
  terms:  "We target 8‚Äì12% effective returns on short paper (30‚Äì180 days) or profit-share on highly secured flips. First-lien or JV, you choose. Funds are wired to title/escrow only.",
  seller: "We also structure clean seller-finance exits for retail buyers. If you like paper, we‚Äôll place you in 1st position with conservative LTV and real security.",
  close:  "I‚Äôll send a one-pager with the next two deals. What‚Äôs the best email, and do you prefer daily or weekly inventory updates?"
};

const onlyDigits = s => (s||"").replace(/[^\d+]/g,"");
const fmtPhone   = s => {
  const d = (s||"").replace(/[^\d]/g,"");
  if(d.length===11 && d.startsWith("1")) return `+1 ${d.slice(1,4)}-${d.slice(4,7)}-${d.slice(7)}`;
  if(d.length===10) return `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
  return s||"";
};
const phoneHref = (number) => {
  const num = onlyDigits(number);
  if(!num) return "#";
  if(dialMode==="device") return `tel:${num}`;
  if(dialMode==="textnow"){ navigator.clipboard.writeText(num); return "https://www.textnow.com/messaging"; }
  if(dialMode==="gvoice"){ navigator.clipboard.writeText(num); return "https://voice.google.com/u/0/messages"; }
  return `tel:${num}`;
};
function scriptText(key, prospect){
  const first = (prospect?.first||"").trim() || (prospect?.name||"").split(" ")[0] || "there";
  return (Scripts[key]||"").replace(/\{\{agent\}\}/g, agentName || "our team").replace(/\{\{first\}\}/g, first);
}
function setDialMode(m){
  dialMode = m; localStorage.setItem("db_dial_mode",m);
  const btn=$("#dialModeBtn"); const txt=$("#dialModeText");
  const label = m==="device"?"Device":(m==="textnow"?"TextNow":"Google Voice");
  if(btn) btn.textContent = label; if(txt) txt.textContent = label;
}
function hotKey(e,k,fn){ if(e.key.toLowerCase()===k && !e.altKey && !e.ctrlKey && !e.metaKey){ e.preventDefault(); fn(); }}

/* Drafts (local, per target) */
const draftKey = uid => `db_queue_draft_${uid}`;
function saveDraft(){ try{ localStorage.setItem(draftKey(targetUid||"anon"), JSON.stringify(all)); }catch{} }
function loadDraft(){ try{ return JSON.parse(localStorage.getItem(draftKey(targetUid||"anon"))||"[]"); }catch{return [];} }

/* ===================== RENDER ===================== */
function drawList(){
  const L=$("#list"); if(!L) return;
  L.innerHTML="";
  filtered.forEach((p,i)=>{
    const d=document.createElement("div"); d.className="item"+(i===cur?" active":"");
    d.innerHTML = `<div class="name">${p.name||"Unknown"}</div>
                   <div class="muted">${fmtPhone(p.phone)} ${p.email?(" ‚Ä¢ "+p.email):""}</div>`;
    d.onclick=()=>{ cur=i; pick(); };
    L.appendChild(d);
  });
}
function pick(){
  const p = filtered[cur];
  const curName=$("#curName"), curStatus=$("#curStatus"), lastSeen=$("#lastSeen"),
        name=$("#name"), phone=$("#phone"), email=$("#email"),
        soft=$("#softCommit"), statSel=$("#statusSel"), notes=$("#notes"),
        box=$("#scriptBox");
  if(!p || !curName) return;
  curName.textContent = p.name||"‚Äî";
  curStatus.textContent = "Status: " + (p.status||"‚Äî");
  lastSeen.textContent  = "Last: " + (p.updatedAt? new Date(p.updatedAt).toLocaleString() : "‚Äî");
  name.value  = p.name||"";
  phone.value = p.phone||"";
  email.value = p.email||"";
  soft.value  = p.softCommit||"";
  statSel.value  = p.status||"";
  notes.value    = p.notes||"";

  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  const introBtn = document.querySelector('.tab[data-k="intro"]'); if(introBtn) introBtn.classList.add("active");
  if(box) box.textContent = scriptText("intro",p);
  drawList();
}
function next(d=+1){
  if(!filtered.length) return;
  cur = (cur + d + filtered.length) % filtered.length;
  pick();
}

/* ===================== CLOUD (Firebase) ===================== */
const qPath = uid => `queues/${uid}`;
const itemsPath = uid => `${qPath(uid)}/items`;
const enabledPath = uid => `${qPath(uid)}/enabled`;

async function getRole(uid){
  try{ const snap = await db.ref(`roles/${uid}`).get(); return snap.val()||""; }
  catch{ return ""; }
}
async function loadQueue(uid){
  // enabled state
  try{
    const en = (await db.ref(enabledPath(uid)).get()).val();
    $("#queueState").textContent = en ? "ON" : "OFF";
  }catch{ $("#queueState").textContent="‚Äî"; }

  // items
  try{
    const snap = await db.ref(itemsPath(uid)).get();
    const obj = snap.val()||{};
    const arr = Object.keys(obj).map(id=>({ id, ...obj[id] }));
    if(arr.length){
      all = arr;
      filtered=[...all]; cur = filtered.length?0:-1; drawList(); pick();
      return;
    }
  }catch(e){ console.warn("loadQueue failed", e); }
  // If no cloud items, try local draft
  const draft = loadDraft();
  all = Array.isArray(draft)? draft : [];
  filtered=[...all]; cur = filtered.length?0:-1; drawList(); pick();
}
async function pushQueue(uid){
  const map={};
  all.forEach(p=>{ const id=p.id||(p.id=crypto.randomUUID()); map[id]=p; });
  await db.ref(itemsPath(uid)).set(map);
  await db.ref(qPath(uid)).update({ updatedAt: Date.now() });
  toast("Pushed to cloud");
}
async function pullQueue(uid){ await loadQueue(uid); toast("Pulled from cloud"); }
async function setQueueEnabled(uid, on){
  await db.ref(enabledPath(uid)).set(!!on);
  $("#queueState").textContent = on ? "ON" : "OFF";
}

/* When saving a single row: push immediately unless we're staging (admin on someone else) */
async function saveOneToCloud(uid, p){
  if(staging) return; // keep local until Push
  const id = p.id || (p.id=crypto.randomUUID());
  await db.ref(`${itemsPath(uid)}/${id}`).set(p);
  await db.ref(qPath(uid)).update({ updatedAt: Date.now() });
}

/* ===================== AGENT NAME ===================== */
async function initAgentName(){
  if(urlName){ agentName=urlName; localStorage.setItem("db_agent_name",agentName); return; }
  if(agentName){ return; }
  try{
    if(currentUid){
      const snap = await db.ref(`userSettings/${currentUid}/profile`).get();
      const v = snap.val()||{};
      const cloud = (v.displayName||"").trim() || (v.email||"").split("@")[0] || "";
      if(cloud){ agentName=cloud; localStorage.setItem("db_agent_name",agentName); return; }
    }
  }catch(e){ console.warn("name load failed", e); }
  agentName = "DealBankers";
  localStorage.setItem("db_agent_name", agentName);
}

/* ===================== DATA (optional sheet source) ===================== */
async function loadFromSheet(){
  let url = DATA_ENDPOINT;
  if(!url){ demo(); return; }
  const q = new URLSearchParams({ sheet: SHEET_TAB, limit: PAGE_SIZE });
  url += (url.includes("?")?"&":"?")+q.toString();
  try{
    const res = await fetch(url,{mode:"cors"}); const json = await res.json();
    all = (json.rows||[]).map(r=>({
      id: r.id || r.row || r._id || crypto.randomUUID(),
      first: r.first || r.FirstName || "",
      last:  r.last  || r.LastName  || r["Last Name"] || "",
      name:  (r.name || `${r.FirstName||r.first||""} ${r["Last Name"]||r.last||""}`).trim(),
      phone: r.phone || r.Phone || "",
      email: r.email || r.Email || "",
      notes: r.notes || r.Notes || "",
      mailing: r.mailing || r.Mailing || "",
      status: r.status || r.Status || "",
      softCommit: r.softCommit || "",
      updatedAt: r.updatedAt || 0
    }));
    filtered=[...all]; cur = filtered.length?0:-1; drawList(); pick();
  }catch(err){ console.error(err); demo(); }
}
function demo(){
  all = [
    {id:"1",name:"Alex Reyes", phone:"2105550101", email:"alex@example.com", notes:"TX based.", status:"", softCommit:""},
    {id:"2",name:"Brenda K",   phone:"5125550199", email:"", notes:"Likes 1st lien.", status:"", softCommit:""},
    {id:"3",name:"Caleb & Dana", phone:"8305550117", email:"calebdana@example.com", notes:"1031 funds pending; wants lien-first only.", status:"", softCommit:""}
  ];
  filtered=[...all]; cur=0; drawList(); pick();
}

/* ===================== EVENTS ===================== */
on("dialModeBtn","click",()=>{
  const order = ["device","textnow","gvoice"];
  const i = order.indexOf(dialMode);
  setDialMode(order[(i+1)%order.length]);
});

on("setName","click",async()=>{
  const nm = prompt("Set your display name (shown in script):", agentName||"");
  if(nm===null) return;
  agentName = (nm||"").trim();
  localStorage.setItem("db_agent_name", agentName);
  if(currentUid){
    try{ await db.ref(`userSettings/${currentUid}/profile/displayName`).set(agentName); }catch(e){ console.warn("displayName save failed", e); }
  }
  if(cur>=0){
    const activeKey=document.querySelector(".tab.active")?.dataset.k || "intro";
    const box=$("#scriptBox"); if(box) box.textContent = scriptText(activeKey, filtered[cur]);
  }
});

on("importBtn","click",async()=>{
  const csv = prompt("Paste CSV (FirstName,Last Name,Phone,Email,Notes):","");
  if(!csv) return;
  const rows = csv.split(/\r?\n/).map(r=>r.split(","));
  rows.forEach(r=>{
    const [f,l,p,e,n]=r;
    if((f||l||p||e||n) && r.length>=1){
      const name = (`${f||""} ${l||""}`).trim() || (p?`Buyer ${onlyDigits(p).slice(-4)}`:"");
      all.push({id:crypto.randomUUID(), first:f, last:l, name, phone:p||"", email:e||"", notes:n||"", status:"", softCommit:""});
    }
  });
  filtered=[...all]; cur = filtered.length?0:-1; drawList(); pick();
  saveDraft();
  toast(staging ? "Imported (staged). Press Push to publish." : "Imported");
});
on("exportHot","click",()=>{
  const rows = all.filter(p=>p.status==="Interested"||p.status==="Follow-up");
  const header = ["Name","Phone","Email","Status","SoftCommit","Notes"];
  const lines = [header.join(",")].concat(rows.map(p=>[
    (p.name||"").replace(/,/g," "),
    (p.phone||""),
    (p.email||""),
    p.status||"",
    (p.softCommit||"").toString().replace(/,/g,""),
    (p.notes||"").replace(/[\r\n,]+/g," ")
  ].join(",")));
  const blob = new Blob([lines.join("\n")],{type:"text/csv"}); const url  = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="hotlist.csv"; a.click(); URL.revokeObjectURL(url);
});

const searchEl = $("#search");
if(searchEl){
  searchEl.addEventListener("input",()=>{
    const q = searchEl.value.toLowerCase().trim();
    filtered = all.filter(p=>{
      const hay = [p.name,p.phone,p.email,p.notes].join(" ").toLowerCase();
      return !q || hay.includes(q);
    });
    cur = filtered.length?0:-1;
    drawList(); pick();
  });
}
on("clearFilter","click",()=>{ if(!searchEl) return; searchEl.value=""; filtered=[...all]; cur=0; drawList(); pick(); });
on("randomBtn","click",()=>{ if(!filtered.length) return; cur = Math.floor(Math.random()*filtered.length); pick(); });

on("callBtn","click",()=>{
  const p = filtered[cur]; if(!p) return;
  calls++; localStorage.setItem("db_call_count", String(calls));
  const cs=$("#callsStat"); if(cs) cs.textContent = "Calls: " + calls;
  window.open(phoneHref(p.phone), "_blank");
});
on("textBtn","click",()=>{ window.open("https://www.textnow.com/messaging","_blank"); });
on("copyBtn","click",()=>{ const p = filtered[cur]; if(!p) return; navigator.clipboard.writeText(onlyDigits(p.phone)).then(()=>toast("Number copied")); });

on("saveBtn","click",saveCurrent);
on("prevBtn","click",()=>next(-1));
on("nextBtn","click",()=>next(+1));

document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const box=$("#scriptBox"); if(box) box.textContent = scriptText(b.dataset.k, filtered[cur]);
  });
});

on("flagInterested","click",()=>{ const s=$("#statusSel"); if(s){ s.value="Interested"; } saveCurrent(); });
on("flagFollow","click",    ()=>{ const s=$("#statusSel"); if(s){ s.value="Follow-up";  } saveCurrent(); });
on("flagBad","click",       ()=>{ const s=$("#statusSel"); if(s){ s.value="Bad Number"; } saveCurrent(); });
on("flagDnc","click",       ()=>{ const s=$("#statusSel"); if(s){ s.value="DNC";        } saveCurrent(); });

document.addEventListener("keydown",(e)=>{
  if(document.activeElement===searchEl){ if(e.key==="Escape"){ searchEl.blur(); } return; }
  if(e.key==="/"){ e.preventDefault(); if(searchEl) searchEl.focus(); return; }
  hotKey(e,"n",()=>next(+1));
  hotKey(e,"p",()=>next(-1));
  hotKey(e,"s",()=>saveCurrent());
});

/* Queue/Admin bar */
on("pullCloud","click",()=>pullQueue(targetUid));
on("pushCloud","click",()=>pushQueue(targetUid));
on("toggleQueue","click",async()=>{
  try{
    const snap = await db.ref(enabledPath(targetUid)).get();
    await setQueueEnabled(targetUid, !(snap.val()===true));
  }catch{ await setQueueEnabled(targetUid, true); }
});
on("loadTarget","click",()=>boot(targetUidInput()));
function targetUidInput(){ return ($("#targetUid")?.value||"").trim(); }

/* ===================== SAVE ===================== */
async function saveCurrent(){
  const p = filtered[cur]; if(!p) return;
  const name=$("#name"), phone=$("#phone"), email=$("#email"),
        soft=$("#softCommit"), statSel=$("#statusSel"), notes=$("#notes");
  p.name       = (name?.value||"").trim();
  p.phone      = (phone?.value||"").trim();
  p.email      = (email?.value||"").trim();
  p.softCommit = soft?.value.trim() ?? "";
  p.status     = statSel?.value.trim() ?? "";
  p.notes      = notes?.value.trim() ?? "";
  p.updatedAt  = Date.now();

  const idx = all.findIndex(x=>x.id===p.id);
  if(idx>=0) all[idx] = {...p};

  const curStatus=$("#curStatus"), lastSeen=$("#lastSeen");
  if(curStatus) curStatus.textContent = "Status: "+(p.status||"‚Äî");
  if(lastSeen)  lastSeen.textContent  = "Last: "+new Date(p.updatedAt).toLocaleString();

  saveDraft();
  await saveOneToCloud(targetUid, p);

  if(LOG_ENDPOINT){
    try{
      await fetch(LOG_ENDPOINT,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"log",
          rowId:p.id, name:p.name, phone:p.phone, email:p.email,
          status:p.status, softCommit:p.softCommit, notes:p.notes,
          agent:agentName, ts:p.updatedAt, uid:targetUid
        })
      });
    }catch(e){ console.warn("log failed",e); }
  }
  toast(staging ? "Saved (local only). Push to publish." : "Saved");
}

/* ===================== BOOT ===================== */
function setStaging(){
  staging = isAdmin && targetUid && currentUid && targetUid !== currentUid;
  $("#stagingMsg").style.display = staging ? "inline-block" : "none";
}
async function boot(forceUid){
  targetUid = (forceUid || targetUid || "").trim() || currentUid || uidParam || "anon";
  setStaging();
  saveDraft(); // keep previous target's draft before switching
  $("#callsStat").textContent = "Calls: " + calls;
  $("#queueState").textContent = "‚Ä¶";
  await loadQueue(targetUid);
}

auth.onAuthStateChanged(async u=>{
  currentUid = u?.uid || uidParam || "";
  // Admin check: email or role
  isAdmin = (u?.email||"").toLowerCase()==="dealbankers@gmail.com";
  if(!isAdmin && currentUid){
    try{ isAdmin = (await getRole(currentUid))==="admin"; }catch{}
  }
  // Show admin controls if admin
  if(isAdmin){ $("#adminOnly").style.display=""; } else { $("#adminOnly").style.display="none"; }

  await initAgentName();
  await boot();

  // dial mode / calls UI
  setDialMode(dialMode);
  $("#callsStat").textContent = "Calls: " + calls;
});

/* fallback if auth never fires (rare) */
setTimeout(()=>{ if(!currentUid){ currentUid = uidParam || "anon"; boot(); } }, 1500);
</script>
</body>
</html>
