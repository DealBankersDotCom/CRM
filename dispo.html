<!-- ======================= DealBankers ‚Ä¢ Capital Console (Firebase + Push/Pull + Safe Import + Select All + Admin Gate) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Capital Console</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
:root{
  --bg:#0b1118; --bg2:#0f1a24; --panel:#0f1f2b; --line:#254a63;
  --text:#e9f3ff; --muted:#a9c3db; --gold:#ffd36b; --green:#26cf84; --blue:#2b74ff; --red:#ff5e6c;
  --chip:#0e2030; --shadow:0 26px 60px rgba(0,0,0,.55); --r:14px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  background:
    radial-gradient(900px 420px at 100% -10%, rgba(71,180,255,.15) 0%, transparent 60%),
    linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);
  color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;
}
header{
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  border-bottom:1px solid var(--line);
}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.3px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6}
.kb{opacity:.8}
.toprow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.topbtn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0e2433;color:#cfe3f6;text-decoration:none;cursor:pointer}
.topbtn.primary{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.topbtn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.topbtn.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);border:none;color:#211a05}
.stat{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a;font-size:12px}

/* Admin-only elements are hidden by default to prevent flash before auth resolves. */
.admin-only{display:none !important;}

.wrap{padding:12px}
.grid{display:grid;gap:12px;grid-template-columns:1.1fr 1fr 1fr}
@media (max-width:1080px){ .grid{grid-template-columns:1fr} }

.card{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.card .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06))}
.card .body{padding:10px}

input,textarea,select{
  width:100%;background:#0f1a24;border:1px solid var(--line);color:#e9f3ff;border-radius:10px;
  padding:10px 12px;font-size:14px
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f2434;color:#cfe3f6;cursor:pointer;text-decoration:none;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);border:none;color:#211a05}
.btn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.btn.blue{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.btn.red{background:linear-gradient(180deg,#ff7b85,#d24652);border:none;color:#fff}
.small{padding:8px 10px;font-size:13px}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0f2a3a;border:1px solid var(--line);font-size:12px}

.list{display:flex;flex-direction:column;gap:8px;max-height:66vh;overflow:auto;padding:10px}
.item{border:1px solid var(--line);border-radius:12px;background:#0f1a24;padding:10px;cursor:pointer;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:start}
.item.active{outline:2px solid #52a6ff}
.item .name{font-weight:800}
.item .muted{color:var(--muted)}
.chk{margin-top:3px}

.kbd{font-family:ui-monospace,Consolas,monospace;font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:#0b1a24;color:#cfe3f6}
.right{justify-content:flex-end}

.scriptTabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.scriptTabs button{border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6;border-radius:999px;padding:6px 10px;cursor:pointer}
.scriptTabs button.active{background:linear-gradient(180deg,var(--blue),#0a58ca);color:#fff;border:none}
.scriptBox{background:#0e2231;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:180px;line-height:1.45}
.flagrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.statusDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#718aa1}
.statusDot.hot{background:#ffb34f}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 14px;border-radius:12px;background:#0b1218;border:1px solid rgba(255,255,255,.2);display:none;z-index:40}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <span style="font-size:18px">‚ö°Ô∏è DealBankers</span>
    <span class="badge">Capital Console</span>
    <span class="kb">Search <span class="kbd">/</span> ‚Ä¢ Next <span class="kbd">N</span> ‚Ä¢ Save <span class="kbd">S</span></span>
  </div>
  <div class="toprow">
    <span class="stat">Queue: <b id="queueState">‚Äî</b></span>
    <button id="queueToggle" class="topbtn">Toggle ON/OFF</button>

    <span class="stat admin-only" id="selStat">Selected: 0</span>
    <button id="selectAllBtn" class="topbtn admin-only">Select All</button>
    <button id="clearSelBtn" class="topbtn admin-only">Clear Sel</button>

    <button id="pullBtn" class="topbtn admin-only">Pull</button>
    <button id="pushBtn" class="topbtn admin-only">Push</button>

    <button id="dialModeBtn" class="topbtn">Device</button>
    <button id="importBtn"  class="topbtn">‚¨ÜÔ∏è Import</button>
    <button id="exportHot"  class="topbtn">Export Hotlist</button>
    <button id="setName"    class="topbtn">Set My Name</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Prospects -->
    <section class="card">
      <div class="head">
        <div>Prospects / Buyers</div>
        <div class="row">
          <span class="tag"><span class="statusDot hot"></span> Hot</span>
          <span class="tag" id="callsStat">Calls: 0</span>
        </div>
      </div>
      <div class="body">
        <input id="search" placeholder="Search name, phone, email, notes‚Ä¶ ( / )"/>
        <div class="row" style="margin-top:8px">
          <button id="randomBtn" class="btn small">üé≤ Random</button>
          <button id="clearFilter" class="btn small">All</button>
        </div>
        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- CENTER: Contact / Actions -->
    <section class="card">
      <div class="head">
        <div id="curName" style="font-weight:900">‚Äî</div>
        <div class="row">
          <span class="tag" id="curStatus">Status: ‚Äî</span>
          <span class="tag" id="lastSeen">Last: ‚Äî</span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <button id="callBtn" class="btn gold">üìû Call</button>
          <button id="textBtn" class="btn gold">üí¨ Text</button>
          <button id="copyBtn" class="btn">üìã Copy Number</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Name</label>
            <input id="nameField" placeholder="Name"/>
          </div>
          <div style="flex:1">
            <label>Phone</label>
            <input id="phoneField" placeholder="Phone"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Email</label>
            <input id="emailField" placeholder="Email"/>
          </div>
          <div style="flex:1">
            <label>Tag / Status</label>
            <select id="statusSel">
              <option value="">‚Äî</option>
              <option>Interested</option>
              <option>Follow-up</option>
              <option>Bad Number</option>
              <option>DNC</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Soft Commit ($)</label>
            <input id="softCommit" placeholder="e.g., 50,000"/>
          </div>
        </div>

        <label style="display:block;margin-top:8px">Notes</label>
        <textarea id="notes"></textarea>

        <div class="row right" style="margin-top:10px">
          <button id="saveBtn" class="btn green">üíæ Save</button>
          <button id="prevBtn" class="btn">‚óÄ Prev</button>
          <button id="nextBtn" class="btn">Next ‚ñ∂</button>
        </div>

        <div class="muted" style="margin-top:10px">
          Dial mode is <b id="dialModeText">Device</b>.
          Click ‚ÄúDevice‚Äù to switch Device / TextNow / Google Voice.
          ‚ÄúCopy Number‚Äù places the number on clipboard for web dialers.
        </div>
      </div>
    </section>

    <!-- RIGHT: Script -->
    <section class="card">
      <div class="head">
        <div>Pitch / Script</div>
      </div>
      <div class="body">
        <div class="scriptTabs">
          <button class="tab active" data-k="intro">Intro</button>
          <button class="tab" data-k="terms">Terms</button>
          <button class="tab" data-k="seller">Seller Finance</button>
          <button class="tab" data-k="close">Close</button>
        </div>
        <div id="scriptBox" class="scriptBox"></div>

        <div class="flagrow">
          <button class="btn green small" id="flagInterested">‚úî Interested</button>
          <button class="btn small" id="flagFollow">üóì Follow-up</button>
          <button class="btn red small" id="flagBad">‚ùå Bad Number</button>
          <button class="btn small" id="flagDnc">üö´ DNC</button>
        </div>
      </div>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== Firebase ===================== */
const firebaseConfig = {
  apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
  authDomain:"deal-bankers.firebaseapp.com",
  databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
  projectId:"deal-bankers"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

/* ===================== DEFAULT SCRIPTS (prevents undefined errors; your external Scripts can override) ===================== */
(function ensureScripts(){
  const defaults = {
    intro:  "Hey {{first}}, this is {{agent}} with DealBankers. Do you have a quick second?",
    terms:  "We typically look at price, timing, and any special terms you care about. What are you aiming for?",
    seller: "We can do seller finance if it helps ‚Äî low down, flexible terms. What would make this a win for you?",
    close:  "Sounds good. I‚Äôll follow up with next steps. Best number to text a quick summary?"
  };
  if (!window.Scripts) window.Scripts = defaults;
  else {
    // Fill any missing keys so scriptText never crashes.
    for (const k of ["intro","terms","seller","close"]) {
      if (typeof window.Scripts[k] !== "string") window.Scripts[k] = defaults[k];
    }
  }
})();

/* ===================== STATE ===================== */
const $ = s => document.querySelector(s);
const on = (id, ev, fn)=>{ const el=document.getElementById(id); if(el) el.addEventListener(ev, fn); };
const toast = msg => { const t=$("#toast"); if(!t) return; t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600); };

const params   = new URL(location.href).searchParams;
let myUid      = params.get("uid") || "";
let myEmail    = "";
let isGod      = false;

let agentName  = localStorage.getItem("db_agent_name") || (params.get("name")||"").trim() || "DealBankers";
let dialMode   = localStorage.getItem("db_dial_mode") || "device"; // device|textnow|gvoice
let all = [];          // all prospects (current user's)
let filtered = [];     // filtered list
let cur = -1;          // index into filtered
let calls = Number(localStorage.getItem("db_call_count")||0);
const selected = new Set(); // row ids for Push
let queueEnabled = false;

const GOD_EMAIL = "dealbankers@gmail.com";   // admin email (case-insensitive)

/* ===================== Helpers ===================== */
const onlyDigits = s => (s||"").replace(/[^\d+]/g,"");
const fmtPhone   = s => {
  const d = (s||"").replace(/[^\d]/g,"");
  if(d.length===11 && d.startsWith("1")) return `+1 ${d.slice(1,4)}-${d.slice(4,7)}-${d.slice(7)}`;
  if(d.length===10) return `${d.slice(0,3)}-${d.slice(3,6)}-${d.slice(6)}`;
  return s||"";
};
const phoneHref = (number) => {
  const num = onlyDigits(number);
  if(!num) return "#";
  if(dialMode==="device") return `tel:${num}`;
  if(dialMode==="textnow"){ navigator.clipboard.writeText(num); return "https://www.textnow.com/messaging"; }
  if(dialMode==="gvoice"){ navigator.clipboard.writeText(num); return "https://voice.google.com/u/0/messages"; }
  return `tel:${num}`;
};
function setDialMode(m){
  dialMode = m; localStorage.setItem("db_dial_mode",m);
  const btn=$("#dialModeBtn"); const txt=$("#dialModeText");
  const label = m==="device"?"Device":(m==="textnow"?"TextNow":"Google Voice");
  if(btn) btn.textContent = label; if(txt) txt.textContent = label;
}
function hotKey(e,k,fn){ if(e.key.toLowerCase()===k && !e.altKey && !e.ctrlKey && !e.metaKey){ e.preventDefault(); fn(); }}

/* CSV/TSV robust parser */
function parseSeparated(text){
  const tabs = (text.match(/\t/g)||[]).length;
  const commas = (text.match(/,/g)||[]).length;
  if(tabs>commas) return text.split(/\r?\n/).filter(x=>x.length).map(r=>r.split("\t"));

  const rows=[]; let row=[], cell="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c==='"' && n==='"'){ cell+='"'; i++; continue; }
      if(c==='"'){ inQ=false; continue; }
      cell+=c; continue;
    }
    if(c==='"'){ inQ=true; continue; }
    if(c===','){ row.push(cell); cell=""; continue; }
    if(c==='\n'){ row.push(cell); rows.push(row); row=[]; cell=""; continue; }
    if(c==='\r'){ continue; }
    cell+=c;
  }
  if(cell!==""){ row.push(cell); }
  if(row.length){ rows.push(row); }
  return rows.filter(r=>r.some(x=>String(x||"").trim()!==""));
}

/* Header mapping */
function normalizeHeader(h){
  h = (h||"").toString().trim().toLowerCase();
  return h.replace(/\s+/g,' ').replace(/[-_]+/g,' ').replace(/[^a-z0-9 ]/g,'').trim();
}
function mapHeaders(headers){
  const idx = {};
  headers.forEach((h,i)=>{
    const n=normalizeHeader(h);
    if(['firstname','first name','first'].includes(n)) idx.first=i;
    else if(['lastname','last name','last','surname','family name'].includes(n)) idx.last=i;
    else if(['name','fullname','full name'].includes(n)) idx.name=i;
    else if(['phone','phone number','tel','telephone','mobile','cell'].includes(n)) idx.phone=i;
    else if(['email','e mail'].includes(n)) idx.email=i;
    else if(['notes','note','potential notes','potential','comments'].includes(n)) idx.notes=i;
    else if(['location','mailing','address','addr'].includes(n)) idx.mailing=i;
    else if(['age'].includes(n)) idx.age=i;
    else if(['contacted','contact'].includes(n)) idx.contacted=i;
  });
  return idx;
}

/* Compose person from row */
function buildPerson(row, idx){
  const at = (k)=> (idx[k]!==undefined ? (row[idx[k]]||"").toString().trim() : "");
  const first = at('first'), last=at('last'), nm = at('name');
  const name = (nm || `${first} ${last}`.trim()).replace(/\s+/g,' ').trim();
  const phone = at('phone');
  const email = at('email');
  const notes = [at('notes'), at('mailing')].filter(Boolean).join(' ‚Äî ');
  const mailing = at('mailing');
  const age = at('age');
  const contacted = at('contacted');

  if(!name && !phone && !email) return null;
  return {
    id: (crypto && crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2))),
    name, first, last,
    phone, email, notes, mailing, age, contacted,
    status:"", softCommit:"", updatedAt:0
  };
}

/* Firebase paths */
const buyersPath    = (uid)=> `capital/buyers/${uid}`;
const queueFlagPath = (uid)=> `userSettings/${uid}/queueEnabled`;

/* ===================== Cloud I/O ===================== */
async function cloudLoadMine(){
  const snap = await db.ref(buyersPath(myUid)).get();
  const v = snap.val()||{};
  const list = Object.values(v);
  list.sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0));
  return list;
}
async function cloudSaveOne(uid, person){
  const id = person.id || (crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)));
  await db.ref(`${buyersPath(uid)}/${id}`).set({...person, id});
}
async function cloudSaveMany(uid, rows){
  const patch={};
  rows.forEach(p=>{
    const id=p.id || (crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)));
    patch[id] = {...p, id};
  });
  if(Object.keys(patch).length) await db.ref(buyersPath(uid)).update(patch);
}
async function cloudDeleteMany(uid, ids){
  const patch={}; ids.forEach(id=>patch[id]=null);
  await db.ref(buyersPath(uid)).update(patch);
}

/* ===================== Selection helpers ===================== */
function updateSelStat(){ const el=$("#selStat"); if(el) el.textContent = `Selected: ${selected.size}`; }

/* ===================== Render ===================== */
function drawList(){
  const L=$("#list"); if(!L) return;
  L.innerHTML="";
  filtered.forEach((p,i)=>{
    const d=document.createElement("div"); d.className="item"+(i===cur?" active":"");
    const chk=document.createElement("input"); chk.type="checkbox"; chk.className="chk";
    chk.checked = selected.has(p.id);
    chk.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(ev.target.checked) selected.add(p.id); else selected.delete(p.id);
      updateSelStat();
    });
    d.appendChild(chk);

    const container=document.createElement("div");
    container.innerHTML = `
      <div class="name">${p.name||"Unknown"}</div>
      <div class="muted">${fmtPhone(p.phone)} ${p.email?(" ‚Ä¢ "+p.email):""}${p.notes?(" ‚Ä¢ "+p.notes):""}</div>`;
    d.appendChild(container);

    d.onclick=()=>{ cur=i; pick(); };
    L.appendChild(d);
  });
}
function scriptText(key, prospect){
  const first = (prospect?.first||"").trim() || (prospect?.name||"").split(" ")[0] || "there";
  return (window.Scripts && window.Scripts[key]) ? window.Scripts[key].replace(/\{\{agent\}\}/g, agentName || "our team").replace(/\{\{first\}\}/g, first) : "";
}
function pick(){
  const p = filtered[cur]; 
  const curName=$("#curName"), curStatus=$("#curStatus"), lastSeen=$("#lastSeen"),
        soft=$("#softCommit"), statSel=$("#statusSel"), notes=$("#notes"),
        box=$("#scriptBox"),
        nameField=$("#nameField"), phoneField=$("#phoneField"), emailField=$("#emailField");
  if(!p || !curName) return;

  curName.textContent = p.name||"‚Äî";
  curStatus.textContent = "Status: " + (p.status||"‚Äî");
  lastSeen.textContent  = "Last: " + (p.updatedAt? new Date(p.updatedAt).toLocaleString() : "‚Äî");
  nameField.value  = p.name||"";
  phoneField.value = p.phone||"";
  emailField.value = p.email||"";
  soft.value = p.softCommit||"";
  statSel.value  = p.status||"";
  notes.value    = p.notes||"";

  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
  const introBtn = document.querySelector('.tab[data-k="intro"]');
  if(introBtn){ introBtn.classList.add("active"); }
  box.textContent = scriptText("intro",p);

  drawList(); // refresh highlight
}
function next(d=+1){
  if(!filtered.length) return;
  cur = (cur + d + filtered.length) % filtered.length;
  pick();
}

/* ===================== Admin guard ===================== */
function applyGodModeUI(){
  // Inline style cannot beat stylesheet !important, so toggle a helper attribute instead.
  document.querySelectorAll(".admin-only").forEach(el=>{
    if (isGod) el.removeAttribute("style");
    else el.setAttribute("style","display:none;");
  });
}
function requireGod(){
  if(!isGod){ toast("Only admin can do that."); return false; }
  return true;
}

/* ===================== Import / Export / Push / Pull ===================== */
async function importFlow(){
  const text = prompt("Paste CSV/TSV from your sheet.\nHeaders should include FirstName, Last Name, Phone, Email, Notes/Location, etc.","");
  if(!text) return;

  const rows = parseSeparated(text);
  if(!rows.length){ toast("Nothing to import"); return; }
  const headers = rows[0];
  const idx = mapHeaders(headers);

  const out=[];
  for(let i=1;i<rows.length;i++){
    const p = buildPerson(rows[i], idx);
    if(p) out.push(p);
  }
  if(!out.length){ toast("No valid rows"); return; }

  // Non-admins can import ONLY into themselves; admin can choose target UID.
  let target = myUid;
  if(isGod){
    const ans = prompt("Import into which UID? Leave blank for yourself.", myUid) || myUid;
    target = (ans||"").trim() || myUid;
  }

  const existingSnap = await db.ref(buyersPath(target)).get();
  const existing = existingSnap.val()||{};
  const seenPhone = new Set(Object.values(existing).map(x=>onlyDigits(x.phone||"")).filter(Boolean));
  const seenEmail = new Set(Object.values(existing).map(x=>String(x.email||"").toLowerCase()).filter(Boolean));

  const toSave = out.filter(p=>{
    const ph = onlyDigits(p.phone||"");
    const em = String(p.email||"").toLowerCase();
    if(ph && seenPhone.has(ph)) return false;
    if(em && seenEmail.has(em)) return false;
    if(ph) seenPhone.add(ph);
    if(em) seenEmail.add(em);
    return true;
  });

  await cloudSaveMany(target, toSave);
  toast(`Imported ${toSave.length} to ${target===myUid?'your list':('UID '+target)}`);

  if(target===myUid){
    all = await cloudLoadMine(); filtered=[...all]; cur=filtered.length?0:-1; drawList(); pick();
  }
}

async function pushFlow(){
  if(!requireGod()) return;
  if(!selected.size){ toast("Select some buyers (checkbox or Select All) first."); return; }
  let target = prompt("Push selected buyers to which UID?",""); if(!target) return;
  target = target.trim(); if(!target) return;

  const rows = all.filter(p=>selected.has(p.id));
  if(!rows.length){ toast("Nothing selected"); return; }

  const existingSnap = await db.ref(buyersPath(target)).get();
  const existing = existingSnap.val()||{};
  const seenPhone = new Set(Object.values(existing).map(x=>onlyDigits(x.phone||"")).filter(Boolean));
  const seenEmail = new Set(Object.values(existing).map(x=>String(x.email||"").toLowerCase()).filter(Boolean));
  const toSave = rows.filter(p=>{
    const ph = onlyDigits(p.phone||"");
    const em = String(p.email||"").toLowerCase();
    if(ph && seenPhone.has(ph)) return false;
    if(em && seenEmail.has(em)) return false;
    if(ph) seenPhone.add(ph);
    if(em) seenEmail.add(em);
    p.assignedBy = myUid;
    p.updatedAt = Date.now();
    return true;
  });

  await cloudSaveMany(target, toSave);
  toast(`Pushed ${toSave.length} to ${target}`);
}

async function pullFlow(){
  if(!requireGod()) return;
  let source = prompt("Pull buyers from which UID into your list?",""); if(!source) return;
  source = source.trim(); if(!source) return;

  const srcSnap = await db.ref(buyersPath(source)).get();
  const src = Object.values(srcSnap.val()||{});

  if(!src.length){ toast("Source empty"); return; }

  const mineSnap = await db.ref(buyersPath(myUid)).get();
  const mine = mineSnap.val()||{};
  const seenPhone = new Set(Object.values(mine).map(x=>onlyDigits(x.phone||"")).filter(Boolean));
  const seenEmail = new Set(Object.values(mine).map(x=>String(x.email||"").toLowerCase()).filter(Boolean));

  const toSave = src.filter(p=>{
    const ph = onlyDigits(p.phone||"");
    const em = String(p.email||"").toLowerCase();
    if(ph && seenPhone.has(ph)) return false;
    if(em && seenEmail.has(em)) return false;
    if(ph) seenPhone.add(ph);
    if(em) seenEmail.add(em);
    p.assignedBy = source;
    p.updatedAt = Date.now();
    p.id = (crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)));
    return true;
  });

  await cloudSaveMany(myUid, toSave);
  toast(`Pulled ${toSave.length} from ${source}`);

  all = await cloudLoadMine(); filtered=[...all]; cur=filtered.length?0:-1; drawList(); pick();
}

/* ===================== Save ===================== */
async function saveCurrent(){
  const p = filtered[cur]; if(!p) return;
  const soft=$("#softCommit"), statSel=$("#statusSel"), notes=$("#notes");
  const nm=$("#nameField"), ph=$("#phoneField"), em=$("#emailField");

  p.name       = (nm?.value||"").trim();
  p.phone      = (ph?.value||"").trim();
  p.email      = (em?.value||"").trim();
  p.softCommit = soft?.value.trim() ?? "";
  p.status     = statSel?.value.trim() ?? "";
  p.notes      = notes?.value.trim() ?? "";
  p.updatedAt  = Date.now();

  const idx = all.findIndex(x=>x.id===p.id);
  if(idx>=0) all[idx] = {...p};

  await cloudSaveOne(myUid, p);

  const curStatus=$("#curStatus"), lastSeen=$("#lastSeen");
  if(curStatus) curStatus.textContent = "Status: "+(p.status||"‚Äî");
  if(lastSeen)  lastSeen.textContent  = "Last: "+new Date(p.updatedAt).toLocaleString();
  toast("Saved");
}

/* ===================== Queue toggle ===================== */
function renderQueue(){ $("#queueState").textContent = queueEnabled ? "ON" : "OFF"; }
async function loadQueueFlag(){
  const snap = await db.ref(queueFlagPath(myUid)).get();
  queueEnabled = !!snap.val();
  renderQueue();
}
async function toggleQueueFlag(){
  queueEnabled = !queueEnabled;
  await db.ref(queueFlagPath(myUid)).set(queueEnabled);
  renderQueue();
  toast(queueEnabled?"Queue ON":"Queue OFF");
}

/* ===================== Events ===================== */
on("dialModeBtn","click",()=>{
  const order = ["device","textnow","gvoice"];
  const i = order.indexOf(dialMode);
  setDialMode(order[(i+1)%order.length]);
});
on("setName","click",async()=>{
  const nm = prompt("Set your display name (shown in script):", agentName||"");
  if(nm===null) return;
  agentName = (nm||"").trim();
  localStorage.setItem("db_agent_name", agentName);
});
on("importBtn","click", importFlow);
on("pushBtn","click",   pushFlow);
on("pullBtn","click",   pullFlow);
on("queueToggle","click", toggleQueueFlag);

on("selectAllBtn","click", ()=>{
  if(!requireGod()) return;
  filtered.forEach(p=>selected.add(p.id));
  updateSelStat();
  drawList();
  toast(`Selected ${filtered.length} visible`);
});
on("clearSelBtn","click", ()=>{
  if(!requireGod()) return;
  selected.clear();
  updateSelStat();
  drawList();
  toast("Selection cleared");
});

const searchEl = $("#search");
if(searchEl){
  searchEl.addEventListener("input",()=>{
    const q = searchEl.value.toLowerCase().trim();
    filtered = all.filter(p=>{
      const hay = [p.name,p.phone,p.email,p.notes].join(" ").toLowerCase();
      return !q || hay.includes(q);
    });
    cur = filtered.length?0:-1;
    drawList(); if(cur>=0) pick();
  });
}
on("clearFilter","click",()=>{ if(!searchEl) return; searchEl.value=""; filtered=[...all]; cur=0; drawList(); pick(); });
on("randomBtn","click",()=>{ if(!filtered.length) return; cur = Math.floor(Math.random()*filtered.length); pick(); });

on("callBtn","click",()=>{
  const p = filtered[cur]; if(!p) return;
  calls++; localStorage.setItem("db_call_count", String(calls));
  const cs=$("#callsStat"); if(cs) cs.textContent = "Calls: " + calls;
  window.open(phoneHref(p.phone), "_blank");
});
on("textBtn","click",()=>{ window.open("https://www.textnow.com/messaging","_blank"); });
on("copyBtn","click",()=>{
  const p = filtered[cur]; if(!p) return;
  navigator.clipboard.writeText(onlyDigits(p.phone)).then(()=>toast("Number copied"));
});

on("saveBtn","click",saveCurrent);
on("prevBtn","click",()=>next(-1));
on("nextBtn","click",()=>next(+1));

document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const box=$("#scriptBox"); if(box) box.textContent = scriptText(b.dataset.k, filtered[cur]);
  });
});
on("flagInterested","click",()=>{ const s=$("#statusSel"); if(s){ s.value="Interested"; } saveCurrent(); });
on("flagFollow","click",    ()=>{ const s=$("#statusSel"); if(s){ s.value="Follow-up";  } saveCurrent(); });
on("flagBad","click",       ()=>{ const s=$("#statusSel"); if(s){ s.value="Bad Number"; } saveCurrent(); });
on("flagDnc","click",       ()=>{ const s=$("#statusSel"); if(s){ s.value="DNC";        } saveCurrent(); });

document.addEventListener("keydown",(e)=>{
  if(document.activeElement===searchEl){ if(e.key==="Escape"){ searchEl.blur(); } return; }
  if(e.key==="/"){ e.preventDefault(); if(searchEl) searchEl.focus(); return; }
  hotKey(e,"n",()=>next(+1));
  hotKey(e,"p",()=>next(-1));
  hotKey(e,"s",()=>saveCurrent());
});

/* ===================== Auth + Init ===================== */
async function boot(){
  setDialMode(dialMode);
  const cs=$("#callsStat"); if(cs) cs.textContent = "Calls: " + calls;

  // Always listen for auth (to determine admin email) ‚Äî even if UID was passed via URL.
  await new Promise(res=>{
    auth.onAuthStateChanged(u=>{
      myEmail = ((u && u.email) || "").toLowerCase();
      isGod   = (myEmail === GOD_EMAIL);
      // If uid not supplied via URL, adopt signed-in user's UID for their own list.
      if(!myUid && u) myUid = u.uid;
      applyGodModeUI();   // reveal admin-only buttons if applicable
      res();
    });
  });

  if(!myUid){
    alert("No UID. Open from profile (which passes uid) or sign in first.");
    return;
  }

  await loadQueueFlag();
  all = await cloudLoadMine();
  filtered=[...all];
  cur = filtered.length?0:-1;
  updateSelStat();
  drawList(); if(cur>=0) pick();
}
boot();
</script>
</body>
</html>
