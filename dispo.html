<!-- ======================= DealBankers ‚Ä¢ Capital Console (Dispo Only ‚Ä¢ Live-only, no legacy) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers ‚Ä¢ Capital Console</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
:root{
  --bg:#0b1118; --bg2:#0f1a24; --panel:#0f1f2b; --line:#254a63;
  --text:#e9f3ff; --muted:#a9c3db; --gold:#ffd36b; --green:#26cf84; --blue:#2b74ff; --red:#ff5e6c;
  --chip:#0e2030; --shadow:0 26px 60px rgba(0,0,0,.55); --r:14px;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  background:
    radial-gradient(900px 420px at 100% -10%, rgba(71,180,255,.15) 0%, transparent 60%),
    linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);
  color:var(--text); font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;
}
header{
  display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  border-bottom:1px solid var(--line);
}
.brand{display:flex;gap:10px;align-items:center;font-weight:900;letter-spacing:.3px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6}
.kb{opacity:.8}
.toprow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.topbtn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#0e2433;color:#cfe3f6;text-decoration:none;cursor:pointer}
.topbtn.primary{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.topbtn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.topbtn.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);border:none;color:#211a05}
.stat{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f2a3a;font-size:12px}

.wrap{padding:12px}
.grid{display:grid;gap:12px;grid-template-columns:1.15fr 1fr 1fr}
@media (max-width:1080px){ .grid{grid-template-columns:1fr} }

.card{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.18);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.card .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06))}
.card .body{padding:10px}

input,textarea,select{
  width:100%;background:#0f1a24;border:1px solid var(--line);color:#e9f3ff;border-radius:10px;
  padding:10px 12px;font-size:14px
}
textarea{min-height:110px;resize:vertical}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#0f2434;color:#cfe3f6;cursor:pointer;text-decoration:none;user-select:none}
.btn:hover{filter:brightness(1.08)}
.btn.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);border:none;color:#211a05}
.btn.green{background:linear-gradient(180deg,var(--green),#1a9b61);border:none;color:#fff}
.btn.blue{background:linear-gradient(180deg,var(--blue),#0a58ca);border:none;color:#fff}
.btn.red{background:linear-gradient(180deg,#ff7b85,#d24652);border:none;color:#fff}
.small{padding:8px 10px;font-size:13px}
.tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#0f2a3a;border:1px solid var(--line);font-size:12px}

.list{display:flex;flex-direction:column;gap:8px;max-height:66vh;overflow:auto;padding:10px}
.item{border:1px solid var(--line);border-radius:12px;background:#0f1a24;padding:10px;cursor:pointer;display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:start}
.item.active{outline:2px solid #52a6ff}
.item .name{font-weight:800}
.item .muted{color:var(--muted)}
.chk{margin-top:3px}

.kbd{font-family:ui-monospace,Consolas,monospace;font-size:12px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:#0b1a24;color:#cfe3f6}
.right{justify-content:flex-end}

.scriptTabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.scriptTabs button{border:1px solid var(--line);background:#0f2a3a;color:#cfe3f6;border-radius:999px;padding:6px 10px;cursor:pointer}
.scriptTabs button.active{background:linear-gradient(180deg,var(--blue),#0a58ca);color:#fff;border:none}
.scriptBox{background:#0e2231;border:1px solid var(--line);border-radius:12px;padding:10px;min-height:160px;line-height:1.45}
.flagrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.gallery img{width:100%;height:110px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#0e1822}

.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;padding:10px 14px;border-radius:12px;background:#0b1218;border:1px solid rgba(255,255,255,.2);display:none;z-index:40}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <span style="font-size:18px">‚ö°Ô∏è DealBankers</span>
    <span class="badge">Capital Console</span>
    <span class="kb">Search <span class="kbd">/</span> ‚Ä¢ Next <span class="kbd">N</span> ‚Ä¢ Save <span class="kbd">S</span></span>
  </div>
  <div class="toprow">
    <span class="stat">Queue: <b id="queueState">‚Äî</b></span>
    <button id="queueToggle" class="topbtn" title="Acq queue ON/OFF">‚è±Ô∏è</button>

    <span class="stat admin-only" id="selStat" style="display:none">Selected: 0</span>
    <button id="selectAllBtn" class="topbtn admin-only" style="display:none">Select All</button>
    <button id="clearSelBtn" class="topbtn admin-only" style="display:none">Clear Sel</button>

    <button id="pullBtn" class="topbtn admin-only" style="display:none">Pull</button>
    <button id="pushBtn" class="topbtn admin-only" style="display:none">Push</button>

    <button id="dialModeBtn" class="topbtn">Device</button>
    <button id="importBtn"  class="topbtn">‚¨ÜÔ∏è Import</button>
    <button id="exportHot"  class="topbtn">Export Hotlist</button>
    <button id="setName"    class="topbtn">Set My Name</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: Deal list -->
    <section class="card">
      <div class="head">
        <div>Disposition</div>
        <div class="row">
          <button id="newDealBtn" class="btn green small">+ New Deal</button>
          <button id="newOffBtn" class="btn blue small">+ New Offering</button>
          <button id="buyersQueueBtn" class="btn small">üìû Buyers List Queue</button>
        </div>
      </div>
      <div class="body">
        <input id="search" placeholder="Search deals‚Ä¶ address, tags, notes ( / )"/>
        <div class="row" style="margin-top:8px">
          <button id="clearFilter" class="btn small">All</button>
        </div>
        <div id="list" class="list"></div>
      </div>
    </section>

    <!-- CENTER: Deal edit -->
    <section class="card">
      <div class="head">
        <div id="curTitle" style="font-weight:900">‚Äî</div>
        <label class="tag"><input id="liveToggle" type="checkbox" style="margin-right:6px">Live</label>
      </div>
      <div class="body">
        <div class="row">
          <div style="flex:1">
            <label>Title</label>
            <input id="dTitle" placeholder="e.g., $48,000 üî• Fixer-Upper ‚Äî 2 lots in San Antonio"/>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Asking / Pricing meta</label>
            <input id="dPrice" placeholder="e.g., 48,000 ask ‚Ä¢ 15k terms negotiable"/>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Address</label>
            <input id="dAddr" placeholder="Street, City, ST ZIP"/>
          </div>
        </div>

        <label style="display:block;margin-top:8px">Description / Notes</label>
        <textarea id="dNotes" placeholder="Bullets, features, anything buyers should know‚Ä¶"></textarea>

        <div class="row" style="margin-top:8px">
          <div style="flex:1">
            <label>Photo URLs (Google, comma-separated)</label>
            <input id="dPhotos" placeholder="https://... , https://..."/>
          </div>
        </div>
        <div id="gal" class="gallery"></div>

        <div class="row" style="margin-top:10px;justify-content:flex-end">
          <button id="saveBtn" class="btn green">üíæ Save</button>
          <button id="delBtn"  class="btn red">üóë Delete</button>
        </div>
      </div>
    </section>

    <!-- RIGHT: Scripts (unchanged ‚Äì your working version) -->
    <section class="card">
      <div class="head"><div>Pitch / Script</div></div>
      <div class="body">
        <div class="scriptTabs">
          <button class="tab active" data-k="intro">Intro</button>
          <button class="tab" data-k="terms">Terms</button>
          <button class="tab" data-k="seller">Seller Finance</button>
          <button class="tab" data-k="close">Close</button>
        </div>
        <div id="scriptBox" class="scriptBox"></div>

        <div class="flagrow">
          <button class="btn green small" id="flagInterested">‚úî Interested</button>
          <button class="btn small" id="flagFollow">üóì Follow-up</button>
          <button class="btn red small" id="flagBad">‚ùå Bad Number</button>
          <button class="btn small" id="flagDnc">üö´ DNC</button>
        </div>
      </div>
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===================== Firebase ===================== */
const firebaseConfig = {
  apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
  authDomain:"deal-bankers.firebaseapp.com",
  databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
  projectId:"deal-bankers"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

/* ===================== Helpers ===================== */
const $ = s => document.querySelector(s);
const toast = msg => { const t=$("#toast"); if(!t) return; t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1600); };
const onlyDigits = s => (s||"").replace(/[^\d+]/g,"");
function chip(str){ return (str||"").trim(); }
function parsePhotos(line){ return (line||"").split(",").map(s=>s.trim()).filter(Boolean); }

/* ===================== State ===================== */
const params   = new URL(location.href).searchParams;
let myUid      = params.get("uid") || "";
let myEmail    = "";
let isGod      = false;

let allDeals   = [];  // {id,title,price,addr,notes,photos[],shareLive,updatedAt}
let filtered   = [];
let cur        = -1;

const GOD_EMAIL = "dealbankers@gmail.com";

/* ===================== Paths ===================== */
const dealsPath    = (uid)=> `dispo/deals/${uid}`;
const queueFlagPath= (uid)=> `userSettings/${uid}/queueEnabled`;

/* ===================== Render ===================== */
function drawList(){
  const L=$("#list");
  if(!L) return; L.innerHTML="";
  filtered.forEach((d,i)=>{
    const item=document.createElement("div");
    item.className="item"+(i===cur?" active":"");
    const left=document.createElement("div");
    left.className="chkWrap";
    const nm=document.createElement("div");
    nm.className="name"; nm.textContent = d.title||"Untitled";
    const mt=document.createElement("div");
    mt.className="muted";
    mt.textContent = [d.price, d.addr, (d.shareLive?'LIVE':'')].filter(Boolean).join(" ‚Ä¢ ");
    item.append(nm, mt);
    item.onclick=()=>{ cur=i; pick(); };
    L.appendChild(item);
  });
}

function previewGallery(arr){
  const gal=$("#gal"); if(!gal) return;
  gal.innerHTML="";
  (arr||[]).slice(0,9).forEach(u=>{
    const img=document.createElement("img");
    img.src = u; img.alt="photo";
    gal.appendChild(img);
  });
}

function pick(){
  const d = filtered[cur];
  const title=$("#dTitle"), price=$("#dPrice"), addr=$("#dAddr"), notes=$("#dNotes"), photos=$("#dPhotos");
  const curTitle=$("#curTitle"), live=$("#liveToggle");
  if(!d) return;

  if(curTitle) curTitle.textContent = d.title||"‚Äî";
  if(title) title.value = d.title||"";
  if(price) price.value = d.price||"";
  if(addr)  addr.value  = d.addr||"";
  if(notes) notes.value = d.notes||"";
  if(photos)photos.value= (d.photos||[]).join(", ");
  if(live){ live.checked = !!d.shareLive; }

  previewGallery(d.photos||[]);
  drawList();
}

/* ===================== Cloud I/O ===================== */
async function loadDeals(){
  const snap = await db.ref(dealsPath(myUid)).get();
  const v = snap.val()||{};
  const list = Object.values(v);
  list.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
  return list;
}
async function saveDeal(uid, deal){
  const id = deal.id || crypto.randomUUID();
  await db.ref(`${dealsPath(uid)}/${id}`).set({...deal, id});
}
async function deleteDeal(uid, id){
  await db.ref(`${dealsPath(uid)}/${id}`).remove();
}

/* ===================== Events ===================== */
$("#newDealBtn").onclick = async ()=>{
  const d = {
    id: crypto.randomUUID(),
    type: "deal",
    title: "New Deal",
    price: "",
    addr: "",
    notes: "",
    photos: [],
    shareLive:false,
    updatedAt: Date.now()
  };
  await saveDeal(myUid, d);
  allDeals = await loadDeals();
  filtered=[...allDeals];
  cur = 0;
  drawList(); pick();
  toast("New deal created");
};

$("#newOffBtn").onclick = async ()=>{
  const d = {
    id: crypto.randomUUID(),
    type: "offering",
    title: "New Offering",
    price: "",
    addr: "",
    notes: "",
    photos: [],
    shareLive:false,
    updatedAt: Date.now()
  };
  await saveDeal(myUid, d);
  allDeals = await loadDeals();
  filtered=[...allDeals];
  cur = 0; drawList(); pick();
  toast("New offering created");
};

$("#saveBtn").onclick = async ()=>{
  const d = filtered[cur]; if(!d) return;
  d.title = chip($("#dTitle").value);
  d.price = chip($("#dPrice").value);
  d.addr  = chip($("#dAddr").value);
  d.notes = $("#dNotes").value||"";
  d.photos= parsePhotos($("#dPhotos").value);
  d.shareLive = !!$("#liveToggle").checked;
  d.updatedAt = Date.now();
  await saveDeal(myUid, d);
  const ct=$("#curTitle"); if(ct) ct.textContent=d.title||"‚Äî";
  previewGallery(d.photos);
  toast("Saved");
};

$("#delBtn").onclick = async ()=>{
  const d = filtered[cur]; if(!d) return;
  if(!confirm("Delete this item?")) return;
  await deleteDeal(myUid, d.id);
  allDeals = await loadDeals();
  filtered=[...allDeals]; cur = filtered.length?0:-1;
  drawList(); if(cur>=0) pick();
  toast("Deleted");
};

$("#clearFilter").onclick=()=>{ const s=$("#search"); if(s) s.value=""; filtered=[...allDeals]; cur=filtered.length?0:-1; drawList(); if(cur>=0) pick();};
$("#search").addEventListener("input",()=>{
  const q=$("#search").value.toLowerCase().trim();
  filtered = allDeals.filter(d=>{
    const hay=[d.title,d.price,d.addr,d.notes,(d.shareLive?'live':'')].join(" ").toLowerCase();
    return !q || hay.includes(q);
  });
  cur = filtered.length?0:-1; drawList(); if(cur>=0) pick();
});

/* ===================== Script box (reuse) ===================== */
const Scripts = {
  intro:  "Hey {{first}}, this is {{agent}} with DealBankers. Do you have a quick second?",
  terms:  "We typically look at price, timing, and any special terms you care about. What are you aiming for?",
  seller: "We can do seller finance if it helps ‚Äî low down, flexible terms. What would make this a win for you?",
  close:  "Sounds good. I‚Äôll follow up with next steps. Best number to text a quick summary?"
};
function scriptText(key){ return (Scripts[key]||"").replace(/\{\{agent\}\}/g,"our team").replace(/\{\{first\}\}/g,"there"); }
document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    $("#scriptBox").textContent = scriptText(b.dataset.k);
  });
});
$("#scriptBox").textContent = scriptText("intro");

/* ===================== Auth + Init ===================== */
async function boot(){
  await new Promise(res=>{
    auth.onAuthStateChanged(u=>{
      myEmail=((u&&u.email)||"").toLowerCase();
      if(!myUid && u) myUid=u.uid;
      isGod = (myEmail===GOD_EMAIL);
      // show admin-only buttons if god
      document.querySelectorAll(".admin-only").forEach(el=>el.style.display = isGod?"":"none");
      res();
    });
  });
  if(!myUid){ alert("Sign in first"); return; }
  allDeals = await loadDeals();
  filtered=[...allDeals];
  cur=filtered.length?0:-1;
  drawList(); if(cur>=0) pick();
}
boot();
</script>
</body>
</html>
