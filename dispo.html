<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DealBankers | Live Deals</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* --- COMPACT DARK THEME --- */
    body { margin: 0; font-family: 'Inter', sans-serif; background: #0b0f14; color: #e5e7eb; font-size: 14px; }
    
    header { 
      padding: 12px 20px; background: #111827; border-bottom: 1px solid #1f2937; 
      display: flex; align-items: center; justify-content: space-between; 
      position: sticky; top: 0; z-index: 50;
    }
    header h1 { margin: 0; font-size: 1.1rem; letter-spacing: 0.5px; color: #3b82f6; font-weight: 800; text-transform: uppercase; }
    
    .nav-links a { color: #9ca3af; text-decoration: none; margin-left: 15px; font-size: 0.85rem; transition: color 0.2s; }
    .nav-links a:hover { color: #fff; }

    /* COMPACT GRID */
    .deal-container { 
      padding: 20px; 
      display: grid; 
      /* Smaller min-width (300px) allows more cards per row */
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
      gap: 20px; 
      max-width: 1600px; margin: 0 auto;
    }
    
    .deal-card { 
      background: #161e2b; border: 1px solid #1f2937; border-radius: 8px; overflow: hidden; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); 
      display: flex; flex-direction: column;
    }
    
    /* CAROUSEL */
    .deal-gallery { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; }
    .deal-gallery img { width: 100%; height: 100%; object-fit: cover; display: block; }
    
    .carousel-btn {
      position: absolute; top: 50%; transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.6); color: white;
      border: none; cursor: pointer; padding: 0;
      font-size: 16px; font-weight: bold; z-index: 10;
      border-radius: 50%; width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .carousel-btn:hover { background: rgba(37, 99, 235, 0.9); }
    .prev-btn { left: 8px; }
    .next-btn { right: 8px; }
    
    .photo-counter {
      position: absolute; bottom: 8px; right: 8px;
      background: rgba(0,0,0,0.7); color: #fff;
      font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; pointer-events: none;
    }

    .deal-details { padding: 12px; flex: 1; display: flex; flex-direction: column; }
    .deal-title { font-size: 1rem; font-weight: 700; margin: 0 0 4px 0; color: #f3f4f6; }
    .deal-location { font-size: 0.8rem; color: #9ca3af; margin-bottom: 8px; }
    .deal-price { font-size: 1.1rem; color: #10b981; font-weight: 700; margin-bottom: 8px; }
    .deal-notes { font-size: 0.85rem; color: #d1d5db; white-space: pre-line; margin-bottom: 12px; line-height: 1.3; flex: 1; }
    
    .viewDealBtn { 
      width: 100%; padding: 10px; border: none; 
      background: #2563eb; color: #fff; cursor: pointer; 
      border-radius: 6px; font-weight: 600; font-size: 0.9rem;
      transition: background 0.2s;
    }
    .viewDealBtn:hover { background: #1d4ed8; }

    /* CHAT BUBBLE */
    #chatBubble {
      position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px;
      border-radius: 50%; background: #2563eb; color: white;
      border: 2px solid #fff; box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
      align-items: center; justify-content: center;
      font-size: 24px; cursor: pointer; z-index: 9999; display: none;
    }
    
    .chat-panel {
      position: fixed; bottom: 80px; right: 20px; width: 320px; height: 450px;
      background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px);
      border: 1px solid #374151; border-radius: 12px;
      display: none; flex-direction: column; z-index: 9999;
    }
    .chat-panel.open { display: flex; }
    .chat-header { padding: 12px; border-bottom: 1px solid #374151; background: rgba(0,0,0,0.2); font-weight: 700; display: flex; justify-content: space-between; }
    .chat-body { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .chat-input-area { padding: 12px; border-top: 1px solid #374151; display: flex; gap: 8px; }
    .chat-input { flex: 1; background: #374151; border: none; padding: 8px; border-radius: 6px; color: white; outline: none; }
    .chat-send { background: #2563eb; border: none; color: white; padding: 0 12px; border-radius: 6px; cursor: pointer; }
    .msg { padding: 6px 10px; border-radius: 8px; max-width: 85%; font-size: 0.85rem; word-wrap: break-word; }
    .msg.me { align-self: flex-end; background: #2563eb; color: white; }
    .msg.them { align-self: flex-start; background: #374151; color: #e5e7eb; }
  </style>
</head>
<body>
  <header>
    <h1>DealBankers <span style="color:#fff; font-weight:300;">| Live Deals</span></h1>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="wholesaler.html">Wholesaler</a>
      <a href="contractor.html">Contractor</a>
    </nav>
  </header>

  <div id="dealsContainer" class="deal-container">
    <div style="color:#9ca3af; text-align:center; grid-column: 1/-1; padding: 40px;">Loading live deals...</div>
  </div>

  <div id="chatBubble">üí¨</div>
  
  <div id="chatPanel" class="chat-panel">
    <div class="chat-header">
      <span>Support / Inquiries</span>
      <span style="cursor:pointer;" onclick="document.getElementById('chatPanel').classList.remove('open')">‚úï</span>
    </div>
    <div id="chatBody" class="chat-body">
      <div style="text-align:center; color:#6b7280; font-size:0.8rem; margin-top:20px;">
        Start a conversation with us.<br>We are online.
      </div>
    </div>
    <div class="chat-input-area">
      <input id="chatInput" class="chat-input" placeholder="Ask about a deal..." />
      <button id="chatSend" class="chat-send">‚û§</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, onChildAdded, serverTimestamp, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
      authDomain: "deal-bankers.firebaseapp.com",
      databaseURL: "https://deal-bankers-default-rtdb.firebaseio.com",
      projectId: "deal-bankers",
      storageBucket: "deal-bankers.appspot.com",
      messagingSenderId: "485110155601",
      appId: "1:485110155601:web:b4c38350ac58c1a2ecab70"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const dealsContainer = document.getElementById('dealsContainer');

    /* FRAME DETECTION */
    if (window.self === window.top) {
        document.getElementById('chatBubble').style.display = 'flex';
    }

    /* DEAL LOADING & CAROUSEL */
    const dealsRef = ref(db, 'deals');
    window.dealPhotos = {}; 

    onValue(dealsRef, (snapshot) => {
      dealsContainer.innerHTML = '';
      if (!snapshot.exists()) {
        dealsContainer.innerHTML = `<p style="padding:20px; text-align:center;">No active deals found.</p>`;
        return;
      }

      snapshot.forEach(uidSnap => {
        uidSnap.forEach(dealSnap => {
          const deal = dealSnap.val();
          if (!deal || (deal.status && deal.status.toLowerCase() !== 'active')) return;

          const dealId = dealSnap.key;
          const photos = Array.isArray(deal.photos) ? deal.photos : [];
          
          if(photos.length === 0) photos.push('https://via.placeholder.com/400x225?text=No+Images');

          window.dealPhotos[dealId] = { images: photos, index: 0 };

          const dealData = {
            title: deal.title || 'Untitled Deal',
            location: deal.location || deal.address || 'Unknown',
            price: deal.price ? `$${Number(deal.price).toLocaleString()}` : 'Contact for Price',
            notes: deal.notes || '',
          };

          const card = document.createElement('div');
          card.classList.add('deal-card');
          
          const showArrows = photos.length > 1 ? '' : 'display:none;';
          
          card.innerHTML = `
            <div class="deal-gallery" id="gallery-${dealId}">
              <img src="${photos[0]}" id="img-${dealId}" alt="Deal Image" loading="lazy" />
              <button class="carousel-btn prev-btn" style="${showArrows}" onclick="changePhoto('${dealId}', -1)">&#10094;</button>
              <button class="carousel-btn next-btn" style="${showArrows}" onclick="changePhoto('${dealId}', 1)">&#10095;</button>
              <div class="photo-counter" id="counter-${dealId}">1 / ${photos.length}</div>
            </div>
            <div class="deal-details">
              <h2 class="deal-title">${dealData.title}</h2>
              <p class="deal-location">üìç ${dealData.location}</p>
              <p class="deal-price">${dealData.price}</p>
              <div class="deal-notes">${dealData.notes}</div>
              <button class="viewDealBtn" onclick="openChatWithContext('${dealData.title}')">
                I'm Interested
              </button>
            </div>`;
          dealsContainer.appendChild(card);
        });
      });
    });

    window.changePhoto = (dealId, direction) => {
        const data = window.dealPhotos[dealId];
        if(!data) return;
        data.index += direction;
        if (data.index < 0) data.index = data.images.length - 1;
        if (data.index >= data.images.length) data.index = 0;
        const imgEl = document.getElementById(`img-${dealId}`);
        const counterEl = document.getElementById(`counter-${dealId}`);
        if(imgEl) imgEl.src = data.images[data.index];
        if(counterEl) counterEl.innerText = `${data.index + 1} / ${data.images.length}`;
    };

    /* CHAT LOGIC */
    let currentUser = null;
    let chatPath = null;
    const chatBubble = document.getElementById('chatBubble');
    const chatPanel = document.getElementById('chatPanel');
    const chatInput = document.getElementById('chatInput');
    const chatBody = document.getElementById('chatBody');

    chatBubble.onclick = () => {
      chatPanel.classList.toggle('open');
      if(chatPanel.classList.contains('open')) chatBody.scrollTop = chatBody.scrollHeight;
    };

    window.openChatWithContext = (dealTitle) => {
        if (window.self === window.top) {
            chatPanel.classList.add('open');
            chatInput.value = `I'm interested in: ${dealTitle}`;
            chatInput.focus();
        } else {
            alert("Please use the 'Support Chat' button in your dashboard sidebar!");
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            setupChat(user.uid);
            if (window.self === window.top) {
                const presenceRef = ref(db, `presence/global/${user.uid}`);
                onDisconnect(presenceRef).set({state: "offline", last: serverTimestamp()});
                set(presenceRef, {
                    state: "online",
                    name: user.isAnonymous ? "Guest Visitor" : (user.displayName || user.email),
                    email: user.isAnonymous ? "N/A" : user.email,
                    ts: serverTimestamp(),
                    page: "Dispo Portal (Public)"
                });
            }
        } else {
            signInAnonymously(auth).catch(console.error);
        }
    });

    function setupChat(uid) {
        chatPath = `direct_messages/${uid}`;
        const chatRef = ref(db, chatPath);
        onChildAdded(chatRef, (snap) => {
            const msg = snap.val();
            const div = document.createElement('div');
            const isMe = (msg.sender === uid);
            div.className = "msg " + (isMe ? "me" : "them");
            div.innerText = msg.text;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        });
    }

    document.getElementById('chatSend').onclick = sendMessage;
    chatInput.addEventListener('keypress', (e) => { if(e.key === "Enter") sendMessage(); });
    function sendMessage() {
        const text = chatInput.value.trim();
        if (!text || !currentUser) return;
        push(ref(db, chatPath), { text: text, sender: currentUser.uid, ts: serverTimestamp() });
        chatInput.value = "";
    }
  </script>
</body>
</html>
