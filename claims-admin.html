<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Claims Admin • DealBankers</title>
<link rel="icon" href="images/icon (1).jpg">
<style>
  body{margin:0;background:#0f1a22;color:#e6eff5;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:1200px;margin:36px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:#122330;border:1px solid #1f3a4a;border-radius:14px;padding:16px;margin-bottom:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #1a3241;text-align:left;font-size:14px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #2a5063;background:#17384a;color:#d6eaf6;cursor:pointer}
  .btn.primary{background:#1ea060;border-color:#1ea060}
  input,select{background:#0f1f29;border:1px solid #294d61;border-radius:8px;color:#e6eff5;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Claims Admin</h1>
  <div id="gate" class="card">Checking admin role…</div>
  <div id="grid" class="card" style="display:none">
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Title</th><th>Assigned To</th><th>Status</th><th>Docs</th><th>Reassign</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
<script src="scripts/claims-links.js"></script>
<script>
(async function(){
  const app = firebase.initializeApp(window.FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db   = firebase.database();

  auth.onAuthStateChanged(async (user)=>{
    const gate = document.getElementById('gate');
    if(!user){ gate.innerHTML = 'Please <a href="index.html">sign in</a> as admin.'; return; }
    const roleSnap = await db.ref(`roles/${user.uid}`).get();
    if(!(roleSnap.exists() && roleSnap.val()==='admin')){ gate.textContent="Admin role required."; return; }
    gate.style.display = 'none';
    document.getElementById('grid').style.display = 'block';

    await syncClaimsRegistryIfAdmin(app, db, auth);

    const metaSnap = await db.ref('claims/meta').get();
    const filesSnap = await db.ref('claims/files').get();
    const meta = metaSnap.exists()? metaSnap.val(): {};
    const files = filesSnap.exists()? filesSnap.val(): {};

    render(meta, files);
  });

  function render(meta, files){
    const tbody = document.getElementById('rows');
    tbody.innerHTML = '';
    Object.keys(meta).forEach(id=>{
      const m = meta[id], f = files[id]||[];
      const tr = document.createElement('tr');
      const who = m.assignedTo ? (m.assignedTo.email || m.assignedTo.uid) : '(unassigned)';
      tr.innerHTML = `
        <td>${id}</td>
        <td>${m.title||''}</td>
        <td>${who}</td>
        <td>${m.status||'draft'}</td>
        <td>${f.map(d=>`<a href="${d.url}" target="_blank">${d.name}</a>`).join(' · ')||'-'}</td>
        <td>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <input id="who-${id}" placeholder="email or UID" />
            <select id="status-${id}">
              <option ${m.status==='awaiting-client-review'?'selected':''}>awaiting-client-review</option>
              <option ${m.status==='approved-pending-esign'?'selected':''}>approved-pending-esign</option>
              <option ${m.status==='needs-revisions'?'selected':''}>needs-revisions</option>
              <option ${m.status==='unassigned'?'selected':''}>unassigned</option>
            </select>
            <button class="btn primary" onclick="saveMeta('${id}')">Save</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  window.saveMeta = async function(id){
    const val = document.getElementById(`who-${id}`).value.trim();
    const status = document.getElementById(`status-${id}`).value;
    let assignedTo = null;
    if(val){
      if(val.includes('@')) assignedTo = { email: val };
      else assignedTo = { uid: val };
    }
    await firebase.database().ref(`claims/meta/${id}`).update({
      assignedTo, status, updatedAt: Date.now()
    });
    alert('Saved.');
    location.reload();
  }
})();
</script>
</body>
</html>
