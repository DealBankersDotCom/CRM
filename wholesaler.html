<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler ‚Ä¢ Acquisition</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

  <style>
    :root{
      --bg1:#0b131b; --bg2:#142838; --bg3:#173c53;
      --panel:#133045; --line:#2a5a78;
      --text:#f3f8fb; --muted:#c7d7e6; --gold:#ffd36b; --green:#26cf84; --blue:#47b4ff;
      --r:16px; --shadow:0 28px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
      padding:10px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}

    /* header + sticky actions */
    .top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px}
    .crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
    .status{font-size:12px;color:#e8f7ff}

    .sticky{position:sticky;top:0;z-index:8;padding:10px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;
      font-weight:800;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
    .btn:hover{filter:brightness(1.08)}
    .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
    .btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none}
    .btn-ghost{background:#0f2a3a}
    .ico{font-size:20px}

    .lead-wrap{padding:12px}
    .lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(90deg,rgba(255,211,107,.22),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}

    details{background:#0e2130;border:1px solid rgba(255,255,255,.2);border-radius:12px;overflow:hidden;margin:10px 0}
    summary{cursor:pointer;padding:12px 14px;font-weight:800}
    .map,.sv{width:100%;border:0;border-radius:14px;background:#fff}
    .map{height:220px;margin-top:8px}
    .sv{height:250px;margin-top:8px}

    /* settings modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
    .modal.open{display:flex}
    .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
    .sheet{position:relative;width:min(520px,94vw);background:#0f1a24;border:1px solid rgba(255,255,255,.18);
      border-radius:16px;padding:14px}
    .close{position:absolute;right:10px;top:10px;border:0;background:#182632;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
    .opt{display:flex;gap:10px;align-items:center;margin:10px 0}
    label{display:flex;gap:8px;align-items:center}
    .save{margin-top:8px}
    @media (max-width:430px){
      .grid4{grid-template-columns:repeat(4,1fr)}
      .title{font-size:16px}
      .map{height:200px} .sv{height:220px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="crumbs"><span>Wholesaler</span><span class="dot"></span><span>Acquisition</span></div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- sticky actions -->
      <div class="sticky">
        <div class="grid4" style="margin-bottom:8px">
          <a class="btn btn-gold" id="btnCall"  aria-label="Call"><span class="ico">üìû</span></a>
          <a class="btn btn-gold" id="btnSMS"   aria-label="SMS"><span class="ico">üí¨</span></a>
          <a class="btn btn-gold" id="btnNotes" aria-label="Update Notes" target="_blank" rel="noopener"><span class="ico">üìù</span></a>
          <button class="btn btn-ghost" id="btnSettings" aria-label="Settings"><span class="ico">‚öôÔ∏è</span></button>
        </div>
        <div class="grid4">
          <button class="btn btn-ghost" id="btnPrev"   aria-label="Previous"><span class="ico">‚óÄ</span></button>
          <button class="btn btn-ghost" id="btnRandom" aria-label="Random"><span class="ico">üé≤</span></button>
          <button class="btn btn-ghost" id="btnNext"   aria-label="Next"><span class="ico">‚ñ∂</span></button>
          <button class="btn btn-green" id="btnCopy"   aria-label="Copy phone"><span class="ico">üìã</span></button>
        </div>
      </div>

      <!-- lead -->
      <div class="lead-wrap">
        <div id="leadCard" class="lead">
          <div class="body">Initializing‚Ä¶</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Settings modal -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-label="Phone link settings">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <button class="close" data-close>Close</button>
      <h3 style="margin:0 0 6px">Phone Link Preference</h3>
      <div class="opt"><label><input type="radio" name="mode" value="device"> <span>Device Phone (tel:)</span></label></div>
      <div class="opt"><label><input type="radio" name="mode" value="textnow"> <span>TextNow (web)</span></label></div>
      <div class="opt"><label><input type="radio" name="mode" value="gvoice"> <span>Google Voice (web)</span></label></div>
      <button id="saveMode" class="btn btn-gold save">Save</button>
      <p style="color:#9fb3c7;font-size:12px;margin-top:8px">Tip: For TextNow/Voice web, we‚Äôll also copy the number so you can paste fast.</p>
    </div>
  </div>

  <!-- leads.js (cache-busted) -->
  <script>
    (function(){
      const s=document.createElement('script');
      s.src='/leads.js?v='+Date.now();
      s.onload=()=>{window.leads=window.leads||[]; init();};
      s.onerror=()=>document.getElementById('status').textContent='Could not load /leads.js';
      document.head.appendChild(s);
    })();
  </script>

  <script>
    const $=s=>document.querySelector(s);
    const statusEl=$('#status');
    let idx=0;

    const uid=new URL(location.href).searchParams.get('uid')||'anon';

    function setStatus(t){statusEl.textContent=t;}
    const clean=(p)=> (p||'').trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');

    // Phone link mode storage
    const MODE_KEY='db_phone_link_mode';
    function getMode(){ return localStorage.getItem(MODE_KEY) || 'device'; }
    function setMode(m){ localStorage.setItem(MODE_KEY,m); }

    function phoneHref(number, mode){
      const num = number.replace(/[^\d+]/g,'');
      if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){
        // Copy so user can paste in TextNow; open messaging hub
        navigator.clipboard?.writeText(num);
        return 'https://www.textnow.com/messaging';
      }
      if(mode==='gvoice'){
        // Copy then open Voice calls page (web)
        navigator.clipboard?.writeText(num);
        return 'https://voice.google.com/u/0/calls';
      }
      return `tel:${num}`;
    }

    function streetViewSrc(addr){
      // Street View embed via old svembed fallback; works without API key
      return `https://maps.google.com/maps?q=${encodeURIComponent(addr)}&layer=c&output=svembed`;
    }
    function mapSrc(addr){
      return `https://www.google.com/maps?q=${encodeURIComponent(addr)}&output=embed`;
    }

    function render(i){
      if(!Array.isArray(window.leads)||!window.leads.length){
        $('#leadCard').innerHTML='<div class="body">No leads loaded. Ensure <b>/leads.js</b> defines <code>window.leads=[...]</code>.</div>';
        setStatus('No leads found'); return;
      }
      if(i<0) i=window.leads.length-1;
      if(i>=window.leads.length) i=0;
      idx=i;

      const lead=window.leads[idx];
      const name = clean(lead?.contacts?.[0]?.name||'Unknown');
      const phone= phoneOf(lead);
      const addr = clean(lead?.address||'');
      const notes= (lead?.notes||'').replace(/\n/g,'<br>');

      setStatus(`Lead ${idx+1} of ${window.leads.length}`);

      // Update sticky links
      const mode=getMode();
      $('#btnCall').href = phoneHref(phone, mode);
      $('#btnSMS').href  = phone ? `sms:${phone}` : '#';
      $('#btnNotes').href=`https://docs.google.com/forms/d/e/1FAIpQLScIZ7GX_ga5yOx34817gOL8Bb5m3KFXW8r-5I4taw_-ergOxw/viewform?usp=pp_url&entry.849181096=${encodeURIComponent('Wholesaler')}&entry.121126280=${encodeURIComponent(name)}&entry.1828741519=${encodeURIComponent(addr)}`;

      // Lead card
      $('#leadCard').innerHTML = `
        <div class="title">${addr || name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>

          <details open>
            <summary>üìä Deal Details</summary>
            <div style="padding:10px 12px">${notes || 'No deal notes yet.'}</div>
          </details>

          <div class="chips">
            <div class="chip">UID: ${uid.slice(0,8)}</div>
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <div class="chip">Dial: ${mode}</div>
          </div>

          <iframe class="sv" src="${streetViewSrc(addr)}" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          <iframe class="map" src="${mapSrc(addr)}" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
            <a class="btn btn-ghost" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}" target="_blank" rel="noopener">üß≠ Directions</a>
            <a class="btn btn-ghost" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">üåê Open Maps</a>
          </div>
        </div>
      `;
    }

    // actions
    $('#btnPrev').onclick = ()=>render(idx-1);
    $('#btnNext').onclick = ()=>render(idx+1);
    $('#btnRandom').onclick = ()=>render(Math.floor(Math.random()*(window.leads?.length||1)));
    $('#btnCopy').onclick = ()=>{
      const p=phoneOf(window.leads?.[idx]);
      if(!p) return alert('No phone on this lead.');
      navigator.clipboard.writeText(p).then(()=>alert('Copied: '+p));
    };

    // settings modal
    const modal=$('#modal');
    function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); const cur=getMode(); document.querySelectorAll('input[name="mode"]').forEach(r=>{ r.checked = (r.value===cur); }); }
    function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); render(idx); }
    $('#btnSettings').onclick=openModal;
    modal.addEventListener('click',e=>{ if(e.target.hasAttribute('data-close')) closeModal(); });
    $('#saveMode').onclick=()=>{ const m=document.querySelector('input[name="mode"]:checked')?.value||'device'; setMode(m); closeModal(); };

    // keyboard niceties (desktop)
    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft') return $('#btnPrev').click();
      if(e.key==='ArrowRight') return $('#btnNext').click();
      if(e.key.toLowerCase()==='r') return $('#btnRandom').click();
      if(e.key.toLowerCase()==='c') return $('#btnCopy').click();
      if(e.key.toLowerCase()==='s') return $('#btnSettings').click();
    });

    function init(){
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',()=>render(0)); }
      else { render(0); }
    }
  </script>
</body>
</html>
