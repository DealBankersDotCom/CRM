<!-- ================================= DealBankers ‚Ä¢ Wholesaler (Acquisition + Dispo; respects DB filters; mobile-ready) ================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wholesaler Portal</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

<style>
:root{
  --bg1:#0b131b; --bg2:#142838; --bg3:#173c53;
  --line:#2a5a78; --text:#f3f8fb; --muted:#c7d7e6;
  --gold:#ffd36b; --green:#26cf84; --blue:#47b4ff; --panel:#133045;
  --r:16px; --shadow:0 28px 70px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
body{
  margin:0; color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
    linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
  padding:10px;
}
.wrap{max-width:1100px;margin:0 auto}
.card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
.top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px}
.crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
.dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
.status{font-size:12px;color:#e8f7ff}

.sticky{position:sticky;top:0;z-index:8;padding:8px;border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
.actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;
  font-weight:800;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
.btn:hover{filter:brightness(1.08)}
.btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
.btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none}
.btn-ghost{background:#0f2a3a}
.ico{font-size:20px}
.navrow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}

.mode-row{display:flex;gap:8px;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
.mode{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e;cursor:pointer}
.mode.active{background:linear-gradient(180deg,#2a6ebf,#143c6b);border:none}

.lead-wrap{padding:12px}
.lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
.title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
  background:linear-gradient(90deg,rgba(255,211,107,.22),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
.body{padding:12px 14px}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}

.sv,.map{width:100%;border:0;border-radius:14px;background:#fff}
.sv{height:260px;margin-top:6px}
.map{height:220px;margin-top:8px}

.notesBox{display:grid;gap:8px;margin:8px 0 10px}
.textarea{
  width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
  background:#0d2130;color:#eaf6ff;font-size:14px;line-height:1.4
}
.notesRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.savedTag{font-size:12px;color:#bfe9c9;opacity:.9;display:none}

@media (max-width:480px){
  .actions{grid-template-columns:repeat(3,1fr)}
  .navrow{grid-template-columns:repeat(3,1fr)}
  .title{font-size:16px}
  .sv{height:230px} .map{height:200px}
}

#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;
  color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="top">
      <div class="crumbs"><span>Wholesaler</span><span class="dot"></span><span id="crumbMode">Acquisition</span></div>
      <div class="status" id="status">Loading‚Ä¶</div>
    </div>

    <!-- Internal mode switch (no redundant "Wholesaler" tab) -->
    <div class="mode-row">
      <button class="mode active" id="mAcq">Acquisition</button>
      <button class="mode" id="mDispo">Dispo</button>
      <div style="margin-left:auto;font-size:12px;color:#cfe6ff" id="feedInfo"></div>
    </div>

    <!-- action bar -->
    <div class="sticky">
      <div class="actions">
        <a class="btn btn-gold" href="#" id="actCall"  title="Call"><span class="ico">üìû</span></a>
        <a class="btn btn-gold" href="#" id="actSMS"   title="Text"><span class="ico">üí¨</span></a>
        <a class="btn btn-ghost" href="#" id="actDir"   title="Directions"><span class="ico">üöó</span></a>
        <button class="btn btn-ghost" id="actCopy"     title="Copy number"><span class="ico">üìã</span></button>
        <a class="btn btn-ghost" href="https://drive.google.com" target="_blank" rel="noopener" title="Drive"><span class="ico">üìÅ</span></a>
      </div>
      <div class="navrow">
        <button class="btn btn-ghost" id="btnPrev"   title="Prev">‚óÄ</button>
        <button class="btn btn-ghost" id="btnRandom" title="Random">üé≤</button>
        <button class="btn btn-green" id="btnNext"   title="Next">‚ñ∂</button>
      </div>
    </div>

    <!-- acquisition view -->
    <div id="acqView" class="lead-wrap">
      <div id="leadCard" class="lead"><div class="body">Initializing‚Ä¶</div></div>
    </div>

    <!-- dispo view (reuses your lightweight CRM layout) -->
    <div id="dispoView" style="display:none;padding:12px">
      <div id="dispoCard" class="lead" style="margin-bottom:10px"><div class="body">Loading dispo‚Ä¶</div></div>
      <button class="btn btn-green" id="dispoNext" style="width:100%">‚è≠Ô∏è Next Deal</button>
      <div style="margin-top:10px;border-top:1px solid rgba(255,255,255,.18);padding-top:10px">
        <iframe class="map" src="https://www.google.com/maps/d/u/0/embed?mid=1C_OfzvCIlHnx-6nLaZ3Y88izZtflM5g&ehbc=2E312F" allowfullscreen title="Dispo Map"></iframe>
      </div>
    </div>
  </section>
</div>

<!-- in-page settings dialog for phone link -->
<dialog id="settingsDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:520px;width:92%">
  <h3 style="margin:0 0 8px">Phone Link Preference</h3>
  <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
  <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
  <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="saveMode" class="btn" style="flex:1">Save</button>
    <button id="closeMode" class="btn" style="flex:1">Close</button>
  </div>
</dialog>

<div id="toast"></div>

<!-- Firebase (separate app instance for this page) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<script>
const gateApp = firebase.initializeApp(
  {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
  "whGate"
);
const gateDb = gateApp.database();
</script>

<script>
const $=s=>document.querySelector(s);
const statusEl=$('#status'); const toastEl=$('#toast'); const feedInfo=$('#feedInfo');
const dlg=$('#settingsDlg'); const crumbMode=$('#crumbMode');

let idx=0, currentLead=null, rawLeads=[], filteredLeads=[];
let mode='acq'; // 'acq' or 'dispo'

const params = new URL(location.href).searchParams;
const uid = params.get('uid') || 'anon';
if((params.get('mode')||'').toLowerCase()==='dispo'){ mode='dispo'; }

const MODE_KEY='db_phone_link_mode_wh';
const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
const setMode=m=>localStorage.setItem(MODE_KEY,m);

function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1600); }
function setStatus(t){statusEl.textContent=t;}
const clean=s=>(s||'').trim();
const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');
function phoneHref(number, m){
  const num=(number||'').replace(/[^\d+]/g,''); if(!num) return '#';
  if(m==='device') return `tel:${num}`;
  if(m==='textnow'){ navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging'; }
  if(m==='gvoice'){ navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages'; }
  return `tel:${num}`;
}
function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr)}`; }
function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr)}`; }
const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
const saveTimeKey = addr => noteKey(addr)+'_ts';
const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);
function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px'; }

function applyFilters(){
  // pull filters for uid from DB (cached on first call)
}
let userFilters={types:[],strats:[],zips:'',hasPhoneOnly:false};
async function loadFilters(){
  try{
    const snap = await gateDb.ref(`userSettings/${uid}/wholesaler`).get();
    const s = snap.val()||{};
    userFilters = (s.filters||{});
    userFilters.types  = userFilters.types || [];
    userFilters.strats = userFilters.strats|| [];
    userFilters.zips   = (userFilters.zips||'').split(',').map(z=>z.trim()).filter(Boolean);
    window._dialMode  = s.dialMode || 'device';
  }catch(e){ userFilters={types:[],strats:[],zips:[],hasPhoneOnly:false}; window._dialMode='device'; }
}

function passes(l){
  // graceful fallbacks if fields are missing in your /leads.js
  const type = (l.type||'').toLowerCase();
  const strat= (l.strategy||l.strat||'').toString();
  const phone= phoneOf(l);
  const zip  = (l.zip || (l.address||'').match(/\b\d{5}\b/)?.[0] || '').toString();

  if(userFilters.types.length){
    const want = userFilters.types.map(x=>({res:'residential',com:'commercial',land:'land'}[x]||x));
    if(!want.some(w=>type.includes(w))) return false;
  }
  if(userFilters.strats.length){
    if(!userFilters.strats.some(s=>strat.toLowerCase().includes(s.toLowerCase()))) return false;
  }
  if(userFilters.hasPhoneOnly && !phone) return false;
  if(userFilters.zips.length){
    if(!userFilters.zips.includes(zip)) return false;
  }
  return true;
}

function refreshFeedInfo(){
  feedInfo.textContent = `Feed loaded: ${rawLeads.length} ‚Ä¢ After filter: ${filteredLeads.length}`;
}

function render(i){
  if(!filteredLeads.length){
    $('#leadCard').innerHTML='<div class="body">No leads after filters. Adjust Settings ‚Üí Wholesaler.</div>';
    setStatus('No leads found'); refreshFeedInfo(); return;
  }
  if(i<0) i=filteredLeads.length-1;
  if(i>=filteredLeads.length) i=0;
  idx=i;

  const lead=filteredLeads[idx];
  currentLead=lead;

  const name  = clean(lead?.contacts?.[0]?.name||'Unknown');
  const phone = phoneOf(lead);
  const addr  = clean(lead?.address||'');
  const ltype = (lead.type||'').toLowerCase() || 'unknown';

  setStatus(`Lead ${idx+1} of ${filteredLeads.length}`);
  const dial= window._dialMode || getMode();
  $('#actCall').href = phoneHref(phone, dial);
  $('#actSMS').href  = dial==='device' && phone ? `sms:${phone}` : phoneHref(phone, dial);
  $('#actDir').href  = addr ? `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}` : '#';

  const lastSaved = saveTimeGet(addr);
  const lastSavedText = lastSaved ? `Saved ${fmtTime(lastSaved)}` : 'Not saved yet';

  $('#leadCard').innerHTML = `
    <div class="title">${addr || name}</div>
    <div class="body">
      <div style="margin-bottom:6px;font-weight:800">${name}</div>

      <div class="chips">
        <div class="chip">UID: ${uid.slice(0,8)}</div>
        <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
        <div class="chip">Dial: ${dial}</div>
        <div class="chip">Type: ${ltype}</div>
      </div>

      <h3 style="margin:10px 0 6px;font-size:16px">Lead details</h3>
      <div class="notesBox">
        <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶"></textarea>
        <div class="notesRow">
          <button id="inlineSave" class="btn btn-gold"><span class="ico">üíæ</span> Save Notes</button>
          <span id="savedTag" class="savedTag">${lastSavedText}</span>
        </div>
      </div>

      <iframe class="sv"  src="${svSrc(addr)}"   loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Street View"></iframe>
      <iframe class="map" src="${mapSrc(addr)}"  loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Map"></iframe>
    </div>
  `;

  const ta=$('#noteInput');
  ta.value = loadNotes(addr) || (lead?.notes || '');
  autoGrow(ta);
  ta.addEventListener('input',()=>autoGrow(ta));
  $('#inlineSave').onclick = ()=>doSaveNotes();
  refreshFeedInfo();
}

function doSaveNotes(){
  const addr = (currentLead?.address)||'';
  const text = ($('#noteInput')?.value||'').trim();
  saveNotes(addr, text);
  const ts=Date.now(); saveTimeSet(addr, ts);
  const tag=$('#savedTag'); if(tag){ tag.textContent=`Saved ${fmtTime(ts)}`; tag.style.display='inline'; }
  toast('Notes saved');
}

/* Dispo renderer (uses window.leads from /dispo.js) */
let dispoIdx=0;
function renderDispo(){
  if(!Array.isArray(window.leads) || !window.leads.length){
    $('#dispoCard').innerHTML='<div class="body">No dispo deals loaded.</div>'; return;
  }
  if(dispoIdx>=window.leads.length) dispoIdx=0;
  const L = window.leads[dispoIdx];
  const name = L.contacts?.[0]?.name || 'Unknown';
  const phone= L.contacts?.[0]?.phone || '';
  const notes= (L.notes||'').replace(/\n/g,'<br>');
  const url = `https://docs.google.com/forms/d/e/1FAIpQLScIZ7GX_ga5yOx34817gOL8Bb5m3KFXW8r-5I4taw_-ergOxw/viewform?usp=pp_url&entry.849181096=Dispo&entry.121126280=${encodeURIComponent(name)}&entry.1828741519=${encodeURIComponent(L.address||'')}`;

  $('#dispoCard').innerHTML = `
    <div class="title">${L.address||name}</div>
    <div class="body">
      <div class="chips">
        <a class="btn btn-gold" href="${phoneHref(phone,getMode())}" target="_blank">üìû</a>
        <a class="btn btn-ghost" href="https://www.textnow.com/messaging" target="_blank">üí¨</a>
        <a class="btn btn-ghost" href="#" onclick="navigator.clipboard.writeText('${(phone||'').replace(/[^\d+]/g,'')}');return false;">üìã</a>
      </div>
      <div style="margin:4px 0 8px"><b>${name}</b></div>
      <details style="background:#0f2c3e;border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:8px">
        <summary>üìä Deal Details</summary>
        <div style="padding-top:6px">${notes||'No deal notes available.'}</div>
      </details>
      <div style="margin-top:10px"><a class="btn btn-green" href="${url}" target="_blank">üìù Update Notes</a></div>
    </div>
  `;
}

/* actions */
$('#btnPrev').onclick   = ()=>render(idx-1);
$('#btnNext').onclick   = ()=>render(idx+1);
$('#btnRandom').onclick = ()=>render(Math.floor(Math.random()*(filteredLeads.length||1)));

$('#actCopy').onclick = ()=>{
  const p=phoneOf(filteredLeads[idx]||{}); if(!p) return alert('No phone on this lead.');
  navigator.clipboard.writeText(p).then(()=>toast('Phone copied'));
};

document.addEventListener('keydown',e=>{
  if(e.key==='ArrowLeft') return $('#btnPrev').click();
  if(e.key==='ArrowRight') return $('#btnNext').click();
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); return doSaveNotes(); }
});
window.addEventListener('beforeunload',()=>{ if(currentLead){ doSaveNotes(); } });

/* mode switching */
function setModeUI(){
  $('#mAcq').classList.toggle('active',mode==='acq');
  $('#mDispo').classList.toggle('active',mode==='dispo');
  $('#acqView').style.display = (mode==='acq')?'block':'none';
  $('#dispoView').style.display= (mode==='dispo')?'block':'none';
  crumbMode.textContent = (mode==='acq')?'Acquisition':'Dispo';
}
$('#mAcq').onclick = ()=>{ mode='acq'; setModeUI(); boot(); };
$('#mDispo').onclick= ()=>{ mode='dispo'; setModeUI(); boot(); };

/* load scripts only after gate + mode */
async function boot(){
  setModeUI();
  setStatus('Loading‚Ä¶');
  await loadFilters();

  // Owner always allowed
  const owner='aptbhidsonline@gmail.com';
  let allowed=false;
  try{
    const uSnap = await gateDb.ref(`usersByUid/${uid}/email`).get(); // optional mapping if you keep one
    const em = (uSnap.val()||'').toLowerCase();
    if(em===owner) allowed=true;
  }catch(e){}

  if(!allowed){
    try{
      const s=await gateDb.ref(`userSettings/${uid}/wholesaler/leadsEnabled`).get();
      allowed = !!s.val();
    }catch(e){ allowed=false; }
  }

  if(mode==='dispo'){
    // Dispo does not require the gate; but if you want, you can share same setting.
    allowed = true;
  }

  if(!allowed){
    $('#leadCard').innerHTML = '<div class="body">Access to leads is disabled for this account.</div>';
    setStatus('Access denied'); return;
  }

  // load feed based on mode
  if(mode==='acq'){
    rawLeads=[]; filteredLeads=[];
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src='/leads.js?v='+(Date.now());
      s.onload=()=>{ res(); }; s.onerror=()=>{ rej(); };
      document.head.appendChild(s);
    }).catch(()=>{ setStatus('Could not load /leads.js'); });

    rawLeads = Array.isArray(window.leads)? window.leads.slice(): [];
    filteredLeads = rawLeads.filter(passes);
    refreshFeedInfo();
    if(!filteredLeads.length){
      $('#leadCard').innerHTML='<div class="body">No leads after filters. Adjust Settings ‚Üí Wholesaler.</div>';
      setStatus('No leads'); return;
    }
    render(0);
    setStatus(`Loaded ${filteredLeads.length} lead(s)`);
  }else{
    await new Promise((res,rej)=>{
      const s=document.createElement('script'); s.src='/dispo.js?v='+(Date.now());
      s.onload=()=>res(); s.onerror=()=>rej();
      document.head.appendChild(s);
    }).catch(()=>{ $('#dispoCard').innerHTML='<div class="body">Could not load /dispo.js</div>'; });

    renderDispo();
    $('#dispoNext').onclick = ()=>{ dispoIdx++; renderDispo(); };
    setStatus('Dispo ready');
  }
}

/* settings dialog for local override (still respecting Settings ‚Üí dialMode if set) */
$('#actSMS').addEventListener('contextmenu',e=>{ e.preventDefault(); dlg.showModal(); const cur=window._dialMode||getMode(); dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked=(r.value===cur)); });
$('#saveMode').onclick = ()=>{ const m=dlg.querySelector('input[name="mode"]:checked')?.value||'device'; setMode(m); window._dialMode=m; dlg.close(); render(idx); };
$('#closeMode').onclick = ()=>dlg.close();

/* start */
boot();
</script>
</body>
</html>
