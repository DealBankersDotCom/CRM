<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DealBankers ‚Ä¢ Wholesaler</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<style>
:root {
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;--line:#254a63;
  --text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  margin:0;font-family:Inter,system-ui,Arial;
  color:var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  min-height:100vh;
}

/* HEADER / NAV */
.header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;
  border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04));
}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  padding:6px 14px;border-radius:100px;
  border:1px solid rgba(255,255,255,.22);
  background:#0d1823;color:var(--text);
  text-decoration:none;cursor:pointer;font-weight:600;
  transition:background .2s,transform .2s;
}
.chip:hover{background:#14314d;transform:scale(1.03)}
.chip.primary{background:#133e6a}
.chip.danger{background:#6b1111}

/* LAYOUT */
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.15);
  border-radius:20px;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.top{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.2);
}
.seg{display:flex;border:1px solid rgba(255,255,255,.22);border-radius:999px}
.seg button{
  padding:8px 14px;border:0;background:#0e2332;
  color:#cfe6ff;cursor:pointer
}
.seg button.active{
  background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff
}
.status{font-size:12px;color:#9ab9d6}

/* BODY GRID: LEFT = TABLE, RIGHT = DETAIL / STREET VIEW */
.body{
  padding:14px;
  display:grid;
  grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
  gap:16px;
}
@media (max-width:960px){
  .body{grid-template-columns:1fr}
}

.left-col{}
.right-col{
  background:#0b1825;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  padding:12px;
}

/* SEARCH / TABLE */
.search{
  display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap
}
.input{
  flex:1;background:#0d1f2d;border:1px solid #254a63;
  color:#fff;border-radius:12px;padding:8px 10px;
}
.small{padding:4px 10px;font-size:12px}

/* table wrap for mobile */
.table-wrap{
  overflow-x:auto;
  border-radius:12px;
  -webkit-overflow-scrolling:touch;
}
table{width:100%;border-collapse:collapse;font-size:14px;min-width:600px}
th,td{padding:10px;border-top:1px solid rgba(255,255,255,.2)}
thead th{border-top:0;color:#cfe3ff}
tr.lead-row{cursor:pointer}
tr.lead-row:hover{background:rgba(255,255,255,.06)}
tr.lead-row.selected{background:rgba(43,116,255,.25)}

/* RIGHT PANEL: CALL HUB */
.detail-header h3{margin:0;font-size:16px}
.detail-header .sub{font-size:12px;color:#9ab9d6}

.detail-info div{margin-bottom:3px}

.script-box{
  background:#0d2233;
  border-radius:10px;
  padding:10px;
  font-size:13px;
  line-height:1.6;
  margin-top:8px;
}
.map-wrap iframe{
  width:100%;height:220px;border:0
}

/* Floating Chat Bubble */
#chatBubble{
  position:fixed;bottom:24px;right:24px;
  width:54px;height:54px;border-radius:50%;
  background:#133e6a;color:white;border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 0 15px rgba(0,138,255,.6);
  z-index:999;transition:transform .15s
}
#chatBubble:hover{transform:scale(1.08)}
</style>

<!-- Firebase Core -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
</head>

<body data-portal="wholesaler">

<!-- HEADER -->
<header class="header">
  <div>DEALBANKERS ‚Ä¢ Wholesaler Portal</div>
  <nav class="nav">
    <a class="chip" href="profile.html">Dashboard</a>
    <a class="chip" href="dispo.html">Dispo Console</a>
    <a class="chip" href="contractor.html">Contractors</a>
    <button class="chip" id="btnGetLeads">Get Leads</button>
    <button class="chip" id="btnBlue">üåÄ Blue</button>
    <button class="chip danger" id="btnRed">üö® Red</button>
    <a class="chip" id="logoutBtn">Log Out</a>
  </nav>
</header>

<!-- MAIN CONTENT WRAPPER -->
<div class="wrap">
  <section class="card">

    <div class="top">
      <div>
        <div id="crumb">Acquisition</div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>
      <div class="seg">
        <button id="tabAcq" class="active">Acq</button>
        <button id="tabDispo">Dispo</button>
      </div>
    </div>

    <div class="body">

      <!-- LEFT: Lead List -->
      <div class="left-col">
        <div class="search">
          <input id="s_q" class="input" placeholder="Search address / owner"/>
          <button class="chip small" id="s_reload">Search</button>
          <button class="chip small" id="prevLead">‚óÄ Prev</button>
          <button class="chip small" id="nextLead">Next ‚ñ∂</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Address</th><th>Owner</th><th>Phone</th><th>Status</th><th>Notes</th></tr>
            </thead>
            <tbody id="sellerRows"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Detail Panel with Street View -->
      <div class="right-col" id="detailPanel">
        <div class="detail-header">
          <h3 id="detailTitle">No lead selected</h3>
          <div class="sub" id="detailSub">Click a lead to load Street View and scripts.</div>
        </div>

        <div class="detail-info" id="detailInfo" style="display:none;">
          <div><strong>Address:</strong> <span id="detailAddr"></span></div>
          <div><strong>Owner:</strong> <span id="detailOwner"></span></div>
          <div><strong>Phone:</strong> <span id="detailPhone"></span></div>
          <div><strong>Status:</strong> <span id="detailStatus"></span></div>
        </div>

        <div class="detail-actions" id="detailActions" style="display:none;">
          <button class="chip small" id="openMaps">Open in Maps</button>
          <button class="chip small" id="copyScript">Copy Script</button>
        </div>

        <div class="script-box" id="scriptBox">
          Select a lead to load the Belfort-style opener and call flow.
        </div>

        <div class="map-wrap" id="mapWrap" style="display:none;">
          <iframe id="streetFrame" loading="lazy"></iframe>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Floating Chat Bubble -->
<div id="chatBubble">üí¨</div>

<!-- SCRIPTS -->
<script>
let UID=null, IS_ADMIN=false, VIEW_AS=null;
let sellerList=[]; let sellerView=[]; let currentIndex=-1;
let sRef=null, bRef=null;

const esc = s => (''+(s||'')).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const activeUid = () => (IS_ADMIN && VIEW_AS)?VIEW_AS:UID;

/* AUTH */
firebase.auth().onAuthStateChanged(async (u)=>{
  if(!u){ location.href='index.html'; return; }
  UID=u.uid;
  try{
    const roleSnap = await firebase.database().ref('roles/'+UID).get();
    IS_ADMIN = roleSnap.exists() && roleSnap.val()==='admin';
  }catch(e){ console.warn(e); }
  subscribe();
});

document.getElementById('logoutBtn').onclick = ()=>firebase.auth().signOut();
document.getElementById('s_reload').onclick = ()=>renderS();
document.getElementById('prevLead').onclick = ()=>cycleLead(-1);
document.getElementById('nextLead').onclick = ()=>cycleLead(1);

/* SUBSCRIBE TO LEADS */
function subscribe(){
  if(!UID) return;
  if(sRef) sRef.off();
  const a = activeUid();
  sRef = firebase.database().ref('leads/sellers').orderByChild('assignedTo').equalTo(a);
  sRef.on('value', snap=>{
    sellerList = Object.entries(snap.val()||{}).map(([id,v])=>({id,...v}));
    renderS();
  });
}

/* RENDER SELLER LEADS */
function renderS(){
  const q = (s_q.value||'').toLowerCase();
  sellerView = sellerList.filter(v =>
    !q || 
    (v.address||'').toLowerCase().includes(q) ||
    (v.owner||'').toLowerCase().includes(q)
  );

  const tbody = document.getElementById('sellerRows');
  document.getElementById('status').textContent = 'Acq: '+sellerView.length+' items';

  if(!sellerView.length){
    tbody.innerHTML = '<tr><td colspan="5" class="status">No assigned seller leads yet.</td></tr>';
    currentIndex=-1;
    updateDetail(null);
    return;
  }

  tbody.innerHTML = sellerView.map((v,i)=>`
    <tr class="lead-row" data-idx="${i}">
      <td>${esc(v.address)}</td>
      <td>${esc(v.owner)}</td>
      <td>${esc(v.phone)}</td>
      <td>${esc(v.status||'new')}</td>
      <td>${esc(v.notes||'')}</td>
    </tr>`).join('');

  tbody.querySelectorAll('tr.lead-row').forEach(r=>{
    r.addEventListener('click',()=>{
      currentIndex = parseInt(r.dataset.idx,10);
      updateDetail(sellerView[currentIndex]);
      highlightRow();
    });
  });
}

function highlightRow(){
  document.querySelectorAll('#sellerRows tr').forEach(r=>r.classList.remove('selected'));
  if(currentIndex>=0){
    document.querySelector(`#sellerRows tr[data-idx="${currentIndex}"]`)?.classList.add('selected');
  }
}

/* DETAIL PANEL */
function updateDetail(lead){
  const frame=document.getElementById('streetFrame');
  const mapW=document.getElementById('mapWrap');
  const title=document.getElementById('detailTitle');
  const sub=document.getElementById('detailSub');
  const info=document.getElementById('detailInfo');
  const acts=document.getElementById('detailActions');
  const scriptBox=document.getElementById('scriptBox');

  if(!lead){
    title.textContent='No lead selected';
    sub.textContent='Click a lead to load Street View';
    info.style.display='none'; acts.style.display='none';
    mapW.style.display='none'; frame.src='';
    scriptBox.textContent = 'Select a lead for script and street view.';
    return;
  }

  const address = lead.address||'';
  const owner = lead.owner||'';
  const phone = lead.phone||'';
  const status = lead.status||'new';

  title.textContent = owner || 'Unknown Owner';
  sub.textContent = address;
  document.getElementById('detailAddr').textContent = address;
  document.getElementById('detailOwner').textContent = owner;
  document.getElementById('detailPhone').textContent = phone;
  document.getElementById('detailStatus').textContent = status;

  info.style.display='block'; acts.style.display='flex';

  if(address){
    frame.src = 'https://www.google.com/maps?q='+encodeURIComponent(address)+'&output=embed';
    mapW.style.display='block';
  }

  const first = owner.split(' ')[0]||'there';
  scriptBox.innerHTML = `
    <p><strong>Opener:</strong> "Hi ${first}, this is Bill with DealBankers. I‚Äôm calling about ${address}. Did I catch you at a bad time?‚Äù</p>
    <p><strong>Position:</strong> ‚ÄúI work with a small group that solves problem properties ‚Äî
    taxes, liens, or inherited homes. I‚Äôm not here to list it ‚Äî I'm here to solve it.‚Äù</p>
  `;

  document.getElementById('openMaps').onclick = ()=>window.open('https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(address),'_blank');
  document.getElementById('copyScript').onclick = async ()=>{
    await navigator.clipboard.writeText(scriptBox.innerText);
    alert('Script copied!');
  };
}

function cycleLead(d){
  if(!sellerView.length) return;
  currentIndex = (currentIndex + d + sellerView.length) % sellerView.length;
  updateDetail(sellerView[currentIndex]);
  highlightRow();
}

/* CHAT BUBBLE */
document.getElementById('chatBubble').onclick = ()=>{
  window.location.href='townhall.html?from=wholesaler';
};
</script>
</body>
</html>
