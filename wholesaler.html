<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DealBankers â€¢ Wholesaler</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<style>
/* BASE STYLES */
:root {
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;--line:#254a63;
  --text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  margin:0; font-family: Inter, system-ui, Arial;
  color: var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  min-height:100vh;
}

/* HEADER / NAV */
.header {
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 16px;
  border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04));
}
.nav { display:flex; gap:8px; flex-wrap:wrap; }
.chip {
  padding:6px 14px; border-radius:100px;
  border:1px solid rgba(255,255,255,.22);
  background:#0d1823; color:var(--text);
  text-decoration:none; cursor:pointer; font-weight:600;
}
.chip.primary { background:#133e6a; }
.chip.danger { background:#6b1111; }

/* CORE LAYOUT */
.wrap { max-width:1100px; margin:0 auto; padding:16px; }
.card {
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.15);
  border-radius:20px;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.top {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.2);
}
.seg { display:flex; border:1px solid rgba(255,255,255,.22); border-radius:999px; }
.seg button {
  padding:8px 14px; border:0; background:#0e2332;
  color:#cfe6ff; cursor:pointer;
}
.seg button.active {
  background:linear-gradient(180deg,#2b74ff,#0a58ca); color:#fff;
}

.status { font-size:12px; color:#9ab9d6; }
.body { padding:14px; }

.search { display:flex; gap:8px; margin-bottom:8px; }
.input {
  flex:1; background:#0d1f2d; border:1px solid #254a63;
  color:#fff; border-radius:12px; padding:8px 10px;
}
table {
  width:100%; border-collapse: collapse; font-size:14px;
}
th,td { padding:10px; border-top:1px solid rgba(255,255,255,.2); }
thead th { border-top:0; color:#cfe3ff; }

.adminbar {
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  margin-top:8px;
}

/* Floating Chat Bubble */
#chatBubble {
  position:fixed; bottom:24px; right:24px;
  width:54px; height:54px;
  border-radius:50%; background:#133e6a;
  color:white; border:2px solid var(--accent);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; box-shadow:0 0 15px rgba(0,138,255,.6);
  z-index:999;
}

/* MODALS SHARED */
.modal-backdrop {
  position:fixed; inset:0;
  background:rgba(0,0,0,.7);
  display:none; align-items:center; justify-content:center;
  z-index:9999;
}
.modal {
  background:#0f1b27; border:1px solid #254a63;
  border-radius:16px; padding:16px; max-width:520px; width:92%;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
}
.modal.wide { max-width:720px; }

.modal h3 { margin:0 0 8px; }
.row { display:flex; gap:8px; margin:8px 0; flex-wrap:wrap; }
.modal input, .modal select, .modal textarea {
  width:100%; padding:10px; border:1px solid #254a63;
  background:#0d1f2d; color:#fff; border-radius:10px;
}

.actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

/* Lead options */
.lead-grid {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px; margin-top:8px;
}
.lead-card {
  border:1px solid rgba(255,255,255,.2);
  border-radius:14px; padding:12px;
  background:#0e2332; cursor:pointer;
}
.lead-card h4 { margin:0 0 4px; }
.lead-card p { margin:0; font-size:13px; color:#b6c9e0; }

.helper { text-align:right; font-size:12px; color:#9fbed8; margin-top:8px; cursor:pointer; }
</style>

<!-- Firebase Core -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-storage-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
</head>

<body data-portal="wholesaler">

<header class="header">
  <div>DEALBANKERS â€¢ Wholesaler</div>
  <nav class="nav">
    <a class="chip" href="profile.html">Dashboard</a>
    <button class="chip" id="btnGetLeads">Get Leads</button>
    <button class="chip" id="btnBlue">ðŸŒ€ Blue</button>
    <button class="chip danger" id="btnRed">ðŸš¨ Red</button>
    <a class="chip" id="logoutBtn">Log Out</a>
  </nav>
</header>

<!-- Blue/Red Phone Modal -->
<div class="modal-backdrop" id="rbModal">
  <div class="modal">
    <h3 id="rbTitle">Request</h3>
    <div class="row">
      <label>Category</label>
      <select id="rbCategory">
        <option>Acquisition</option><option>Sales</option>
        <option>Contractor</option><option>Realtor</option><option>Website</option>
      </select>
    </div>
    <div class="row"><input id="rbSubject" placeholder="Subject" /></div>
    <div class="row"><textarea id="rbDetails" rows="4" placeholder="Details"></textarea></div>
    <div class="actions">
      <button class="chip" id="rbCancel">Cancel</button>
      <button class="chip primary" id="rbSubmit">Send</button>
    </div>
  </div>
</div>

<!-- Lead Selection Modal -->
<div class="modal-backdrop" id="leadsModal">
  <div class="modal wide">
    <h3>Get Leads</h3>
    <div class="lead-grid">
      <div class="lead-card" data-lead="street"><h4>Street</h4><p>Upload/partner with boots on ground.</p></div>
      <div class="lead-card" data-lead="web"><h4>Web</h4><p>Click campaigns, targeted pipelines.</p></div>
      <div class="lead-card" data-lead="live"><h4>Live</h4><p>Grab inbound, assign, collaborate.</p></div>
    </div>
    <div class="helper" id="closeLeads">Close</div>
  </div>
</div>

<div class="wrap">
  <section class="card">
    <div class="top">
      <div>
        <div id="crumb">Acquisition</div>
        <div class="status" id="status">Loadingâ€¦</div>
      </div>
      <div class="seg">
        <button id="tabAcq" class="active">Acq</button>
        <button id="tabDispo">Dispo</button>
      </div>
    </div>

    <div class="body">
      <div id="adminBar" class="adminbar" style="display:none">
        <span class="status">Admin â€¢ View as UID:</span>
        <input id="impUid" class="input" placeholder="UID (read-only)" />
        <button class="chip" id="applyImp">Apply</button>
        <button class="chip" id="clearImp">Clear</button>
      </div>

      <!-- Acquisition Panel -->
      <section id="panel-acq">
        <div class="search">
          <input id="s_q" class="input" placeholder="Search address / owner" />
          <button class="chip" id="s_reload">Search</button>
        </div>
        <table>
          <thead><tr><th>Address</th><th>Owner</th><th>Phone</th><th>Status</th><th>Notes</th></tr></thead>
          <tbody id="sellerRows"></tbody>
        </table>
      </section>

      <!-- Disposition Panel -->
      <section id="panel-dispo" style="display:none">
        <div class="search">
          <input id="b_q" class="input" placeholder="Search name / criteria" />
          <button class="chip" id="b_reload">Search</button>
        </div>
        <table>
          <thead><tr><th>Name</th><th>Phone</th><th>Criteria</th><th>Status</th><th>Notes</th></tr></thead>
          <tbody id="buyerRows"></tbody>
        </table>
      </section>
    </div>
  </section>
</div>

<!-- Floating Chat -->
<div id="chatBubble">ðŸ’¬</div>

<script>
let UID=null, IS_ADMIN=false, VIEW_AS=null;
let sRef=null, bRef=null;

/* ðŸ” Auth Check */
firebase.auth().onAuthStateChanged(async (u) => {
  if (!u) { location.href = "index.html"; return; }
  UID=u.uid;
  const role=await firebase.database().ref(`roles/${UID}`).get();
  IS_ADMIN=role.exists() && role.val()==='admin';
  document.getElementById('adminBar').style.display = IS_ADMIN ? 'flex' : 'none';
  subscribe();
});

/* NAV & UI Actions */
document.getElementById('logoutBtn').onclick=()=>firebase.auth().signOut();
document.getElementById('tabAcq').onclick=()=>switchMode('acq');
document.getElementById('tabDispo').onclick=()=>switchMode('dispo');
document.getElementById('s_reload').onclick=subscribe;
document.getElementById('b_reload').onclick=subscribe;

document.getElementById('applyImp').onclick=()=>{
  VIEW_AS=document.getElementById('impUid').value.trim()||null;
  subscribe();
};
document.getElementById('clearImp').onclick=()=>{
  VIEW_AS=null; document.getElementById('impUid').value='';
  subscribe();
};

/* SUBSCRIBE TO LEADS */
function switchMode(m){
  document.getElementById('tabAcq').classList.toggle('active',m==='acq');
  document.getElementById('tabDispo').classList.toggle('active',m==='dispo');
  document.getElementById('panel-acq').style.display=m==='acq'?'block':'none';
  document.getElementById('panel-dispo').style.display=m==='dispo'?'block':'none';
  document.getElementById('crumb').textContent=m==='acq'?'Acquisition':'Disposition';
  subscribe();
}
const activeUid=()=> (IS_ADMIN && VIEW_AS) ? VIEW_AS : UID;
const esc=(s)=>(''+(s||'')).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function subscribe(){
  if(!UID) return;
  if(sRef) sRef.off(); if(bRef) bRef.off();
  const a=activeUid();

  sRef=firebase.database().ref('leads/sellers').orderByChild('assignedTo').equalTo(a);
  sRef.on('value',s=>renderS(s.val()||{}));

  bRef=firebase.database().ref('leads/buyers').orderByChild('assignedTo').equalTo(a);
  bRef.on('value',s=>renderB(s.val()||{}));
}

function renderS(o){
  document.getElementById('status').textContent='Acq: '+Object.keys(o).length+' items';
  const q=(document.getElementById('s_q').value||'').toLowerCase();
  document.getElementById('sellerRows').innerHTML=
    Object.entries(o).filter(([_,v])=>
      (v.address||'').toLowerCase().includes(q) ||
      (v.owner||'').toLowerCase().includes(q)
    ).map(([id,v])=>`<tr>
      <td>${esc(v.address)}</td>
      <td>${esc(v.owner)}</td>
      <td>${esc(v.phone)}</td>
      <td>${esc(v.status||'new')}</td>
      <td>${esc(v.notes||'')}</td>
    </tr>`).join('') || `<tr><td colspan="5">No assigned seller leads.</td></tr>`;
}

function renderB(o){
  document.getElementById('status').textContent='Dispo: '+Object.keys(o).length+' items';
  const q=(document.getElementById('b_q').value||'').toLowerCase();
  document.getElementById('buyerRows').innerHTML=
    Object.entries(o).filter(([_,v])=>
      (v.name||'').toLowerCase().includes(q) ||
      (v.criteria||'').toLowerCase().includes(q)
    ).map(([id,v])=>`<tr>
      <td>${esc(v.name)}</td>
      <td>${esc(v.phone)}</td>
      <td>${esc(v.criteria)}</td>
      <td>${esc(v.status||'new')}</td>
      <td>${esc(v.notes||'')}</td>
    </tr>`).join('')
    || `<tr><td colspan="5">No assigned buyer leads.</td></tr>`;
}

/* ðŸ”µ ðŸ”´ BLUE/RED PHONE MODAL */
(function(){
  const m=document.getElementById('rbModal');
  document.getElementById('btnBlue').onclick=()=>show(false);
  document.getElementById('btnRed').onclick=()=>show(true);
  document.getElementById('rbCancel').onclick=()=>m.style.display='none';
  function show(urgent){
    document.getElementById('rbTitle').textContent=urgent?"ðŸš¨ Urgent Request":"Blue Phone Request";
    document.getElementById('rbSubmit').dataset.urgent=urgent?'1':'0';
    m.style.display='flex';
  }
  document.getElementById('rbSubmit').onclick=async()=>{
    try{
      const u=firebase.auth().currentUser||{};
      await firebase.database().ref('requests').push({
        portal:'wholesaler',
        urgent:document.getElementById('rbSubmit').dataset.urgent==='1',
        cat:rbCategory.value, subject:rbSubject.value.trim(),
        details:rbDetails.value.trim(), uid:u.uid||null,
        email:u.email||null, ts:firebase.database.ServerValue.TIMESTAMP
      });
      alert('Request sent.');
      m.style.display='none';
    } catch(e){ alert('Failed to send'); }
  };
})();

/* ðŸŒ GET LEADS MODAL */
(function(){
  const modal=document.getElementById('leadsModal');
  document.getElementById('btnGetLeads').onclick=()=>modal.style.display='flex';
  document.getElementById('closeLeads').onclick=()=>modal.style.display='none';

  modal.addEventListener('click',async e=>{
    if(e.target===modal) return modal.style.display='none';
    const card=e.target.closest('.lead-card');
    if(card){
      try{
        const u=firebase.auth().currentUser||{};
        await firebase.database().ref('lead_requests').push({
          portal:'wholesaler', type:card.dataset.lead,
          uid:u.uid||null, email:u.email||null,
          ts:firebase.database.ServerValue.TIMESTAMP
        });
        alert('Lead request sent.');
        modal.style.display='none';
      } catch(err){ alert('Failed to submit'); }
    }
  });
})();

/* ðŸ’¬ CHAT BUBBLE HOOK */
document.getElementById('chatBubble').onclick = () => {
  window.location.href = "townhall.html";
};
</script>
</body>
</html>
