<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DealBankers ‚Ä¢ Wholesaler</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<style>
:root{
  --bg1:#0b131b;--bg2:#142838;--bg3:#173c53;
  --line:#254a63;--text:#f1f7fb;--muted:#c5d3e1;--accent:#2b74ff;
}
*{box-sizing:border-box;margin:0;padding:0}

body{
  margin:0;font-family:Inter,system-ui,Arial;
  color:var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
  min-height:100vh;
}

/* HEADER */
.header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 16px;
  border-bottom:1px solid rgba(255,255,255,.2);
  background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.04));
}
.nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.chip{
  padding:6px 14px;border-radius:100px;
  border:1px solid rgba(255,255,255,.22);
  background:#0d1823;color:var(--text);
  text-decoration:none;cursor:pointer;font-weight:600;
  transition:background .2s,transform .2s;
}
.chip:hover{background:#14314d;transform:scale(1.03)}
.chip.primary{background:#133e6a}
.chip.danger{background:#6b1111}

/* Settings Gear */
.icon-btn{
  background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.25);
  border-radius:50%;
  width:34px;height:34px;
  font-size:18px;color:white;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.icon-btn:hover{background:rgba(255,255,255,0.25)}

/* LAYOUT */
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{
  background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.15);
  border-radius:20px;
  box-shadow:0 28px 70px rgba(0,0,0,.55);
  overflow:hidden;
}
.top{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.2);
}
.seg{
  display:flex;border:1px solid rgba(255,255,255,.22);border-radius:999px
}
.seg button{
  padding:8px 14px;border:0;background:#0e2332;
  color:#cfe6ff;cursor:pointer
}
.seg button.active{
  background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff
}
.status{font-size:12px;color:#9ab9d6}

/* GRID */
.body{
  padding:14px;
  display:grid;
  grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
  gap:16px;
}
@media(max-width:960px){.body{grid-template-columns:1fr}}

/* LEADS TABLE */
.search{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.input{
  flex:1;background:#0d1f2d;border:1px solid #254a63;
  color:#fff;border-radius:12px;padding:8px 10px;
}
.table-wrap{overflow-x:auto;border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:14px;min-width:600px}
th,td{padding:10px;border-top:1px solid rgba(255,255,255,.2)}
thead th{border-top:0;color:#cfe3ff}
tr.lead-row{cursor:pointer}
tr.lead-row:hover{background:rgba(255,255,255,.06)}
tr.lead-row.selected{background:rgba(43,116,255,.25)}

/* DETAIL PANEL */
.right-col{
  background:#0b1825;border-radius:16px;padding:12px;
  border:1px solid rgba(255,255,255,.14);
}
.detail-header h3{margin:0;font-size:16px}
.detail-header .sub{font-size:12px;color:#9ab9d6;margin-bottom:8px}
.detail-info{font-size:13px;margin-bottom:10px}
.script-box{
  background:#0d2233;border-radius:10px;
  padding:10px;font-size:13px;line-height:1.5;margin-top:8px;
}

/* MAP */
.map-wrap{margin-top:12px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.2)}
.map-wrap iframe{width:100%;height:250px;border:0}

/* --- CHAT BUBBLE & PANEL STYLES --- */
#chatBubble{
  position:fixed;bottom:24px;right:24px;width:60px;height:60px;
  border-radius:50%;background:#133e6a;color:white;
  border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;box-shadow:0 0 20px rgba(43,116,255,0.8);
  z-index:9999;transition:transform .2s, box-shadow 0.2s;
  font-size: 30px;
}
#chatBubble:hover{transform:scale(1.1);box-shadow:0 0 30px rgba(43,116,255,1);}

/* SIDEBAR PANEL */
.sidebar-panel {
  position: fixed; top: 0; right: -360px; width: 340px; height: 100vh;
  background: rgba(11, 24, 37, 0.98); backdrop-filter: blur(12px);
  border-left: 1px solid var(--accent);
  box-shadow: -10px 0 40px rgba(0,0,0,0.8);
  transition: right 0.3s ease-in-out;
  z-index: 10000;
  display: flex; flex-direction: column;
}
.sidebar-panel.open { right: 0; }

.panel-header {
  padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--line);
  display: flex; justify-content: space-between; align-items: center;
}
.panel-title { color: #fff; font-size: 1.1rem; text-shadow: 0 0 10px var(--accent); }
.close-btn { background: none; border: none; color: #ff5555; font-size: 1.2rem; cursor: pointer; }

/* Radar (Admin) */
#radarList { flex: 1; overflow-y: auto; padding: 10px; display: none; }
.radar-user {
  padding: 12px; margin-bottom: 8px; border-radius: 8px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
  cursor: pointer; display: flex; justify-content: space-between; align-items: center;
}
.radar-user:hover { background: rgba(43,116,255,0.2); border-color: var(--accent); }
.status-dot { width: 8px; height: 8px; background: #00ff6a; border-radius: 50%; box-shadow: 0 0 8px #00ff6a; }

/* Chat Area */
#chatArea { flex: 1; display: none; flex-direction: column; background: rgba(0,0,0,0.2); }
#chatMsgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg-bubble { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; word-wrap: break-word; }
.msg-me { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 2px; }
.msg-them { align-self: flex-start; background: #1e2c3a; color: #ddd; border-bottom-left-radius: 2px; }

.chat-input-row { padding: 15px; border-top: 1px solid var(--line); display: flex; gap: 10px; }
.chat-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #080f16; color: white; }
.send-btn { padding: 0 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; }
#backToRadar { font-size: 0.8rem; color: var(--muted); cursor: pointer; margin-right: 10px; display: none; }
</style>
</head>

<body data-portal="wholesaler">

<header class="header">
  <div>DEALBANKERS ‚Ä¢ Wholesaler Portal</div>
  <nav class="nav">
    <a class="chip" href="profile.html">Dashboard</a>
    <button class="chip" id="btnBlue">üåÄ Blue</button>
    <button class="chip danger" id="btnRed">üö® Red</button>
    <button class="icon-btn" id="btnSettings">‚öôÔ∏è</button>
    <a class="chip" id="logoutBtn">Log Out</a>
  </nav>
</header>

<div class="wrap">
  <section class="card">
    <div class="top">
      <div>
        <div id="crumb">Acquisition</div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>
      <div class="seg">
        <button id="tabAcq" class="active">Acq</button>
        <button id="tabDispo">Dispo</button>
      </div>
    </div>

    <div class="body">
      <div id="panel-acq">
        <div class="search">
          <input id="s_q" class="input" placeholder="Search address / owner" />
          <button class="chip small" id="s_reload">Search</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Address</th><th>Owner</th><th>Phone</th><th>Status</th><th>Notes</th></tr>
            </thead>
            <tbody id="sellerRows"></tbody>
          </table>
        </div>
      </div>

      <div id="panel-dispo" style="display:none; height: 80vh;">
        <iframe 
          id="iframeDispo" 
          src="dispo.html" 
          style="width:100%; height:100%; border:none; border-radius:12px; background:#0b1825;">
        </iframe>
      </div>

      <div class="right-col" id="detailPanel">
        <div class="detail-header">
          <h3 id="detailTitle">No lead selected</h3>
          <div class="sub" id="detailSub">Select a lead to load details.</div>
        </div>

        <div class="detail-info" id="detailInfo" style="display:none;">
          <div><strong>Address:</strong> <span id="detailAddr"></span></div>
          <div><strong>Owner:</strong> <span id="detailOwner"></span></div>
          <div><strong>Phone:</strong> <span id="detailPhone"></span></div>
        </div>

        <div class="script-box" id="scriptBox">Select a lead to load script.</div>

        <div class="map-wrap" id="mapWrap" style="display:none;">
          <iframe id="streetFrame" loading="lazy"></iframe>
        </div>
      </div>
    </div>
  </section>
</div>

<div id="chatBubble">üí¨</div>

<div id="sidePanel" class="sidebar-panel">
  <div class="panel-header">
    <div style="display:flex; align-items:center;">
        <span id="backToRadar">‚óÄ Back</span>
        <span id="panelTitle" class="panel-title">Support Chat</span>
    </div>
    <button class="close-btn" id="closePanel">‚úï</button>
  </div>

  <div id="radarList">
    <div style="padding:20px; text-align:center; color:#666;">Scanning for users...</div>
  </div>

  <div id="chatArea">
    <div id="chatMsgs"></div>
    <div class="chat-input-row">
        <input id="chatInput" class="chat-input" type="text" placeholder="Type a message...">
        <button id="chatSend" class="send-btn">‚û§</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
<script src="leads.js"></script>
<script>
let UID = null;
let sellerList = [], sellerView = [], currentIndex = -1;

// Chat Variables
let currentChatPath = null;
let isAdmin = false;
let activeChatRef = null;

// Auth State
firebase.auth().onAuthStateChanged(u => {
  if (!u) return location.href = 'index.html';
  UID = u.uid;
  
  // 1. Start Lead Subscription (Original Logic)
  subscribeLeads();
  
  // 2. Presence Logic (Tracking Online Status)
  trackPresence(u);

  // 3. Check Role & Initialize Chat (God Mode Logic)
  firebase.database().ref(`roles/${UID}`).once('value').then(snap => {
    const role = snap.val();
    if (role === 'admin' || role === 'god' || u.email === "dealbankers@gmail.com") {
        isAdmin = true;
        startRadar();
    } else {
        isAdmin = false;
        currentChatPath = `direct_messages/${UID}`;
        setupChat(currentChatPath); // User listens to their own channel
    }
  });
});

/* --- CHAT LOGIC --- */
const sidePanel = document.getElementById("sidePanel");
const radarList = document.getElementById("radarList");
const chatArea = document.getElementById("chatArea");
const backBtn = document.getElementById("backToRadar");
const panelTitle = document.getElementById("panelTitle");

// Toggle Panel
document.getElementById("chatBubble").onclick = () => {
    sidePanel.classList.toggle("open");
    if(sidePanel.classList.contains("open")) {
        if(isAdmin && !currentChatPath) {
            showRadarView();
        } else {
            // If user or admin already in chat
            if(chatArea.style.display !== 'flex') {
                if(!isAdmin) showChatView(currentChatPath, "Support Chat");
            }
        }
    }
};
document.getElementById("closePanel").onclick = () => sidePanel.classList.remove("open");
backBtn.onclick = () => showRadarView();

function showRadarView() {
    radarList.style.display = "block";
    chatArea.style.display = "none";
    backBtn.style.display = "none";
    panelTitle.innerText = "üì° Live Radar";
    currentChatPath = null;
    if(activeChatRef) { activeChatRef.off(); activeChatRef = null; }
}

function showChatView(path, name) {
    radarList.style.display = "none";
    chatArea.style.display = "flex";
    backBtn.style.display = isAdmin ? "inline" : "none";
    panelTitle.innerText = name;
    currentChatPath = path;
    loadMessages(path);
}

// Setup User Chat (Listen to their own messages)
function setupChat(path) {
    // Just a wrapper to load messages for the user
    loadMessages(path);
}

function startRadar() {
    firebase.database().ref('presence/global').on('value', snap => {
        const data = snap.val() || {};
        radarList.innerHTML = "";
        let count = 0;
        
        Object.keys(data).forEach(uid => {
            if(uid === UID) return;
            const u = data[uid];
            if(u.state === 'online') {
                count++;
                const div = document.createElement("div");
                div.className = "radar-user";
                const loc = u.page ? `<br><small style="color:#88a5bf">On: ${u.page}</small>` : "";
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold; color:#fff">${u.name || 'User'}</div>
                        <small style="color:#666">${u.email}</small>
                        ${loc}
                    </div>
                    <div class="status-dot"></div>
                `;
                div.onclick = () => showChatView(`direct_messages/${uid}`, u.name || 'User');
                radarList.appendChild(div);
            }
        });
        
        if(count === 0) radarList.innerHTML = "<div style='padding:20px;text-align:center;color:#666'>No users online.</div>";
    });
}

function loadMessages(path) {
    const box = document.getElementById("chatMsgs");
    box.innerHTML = "";
    if(activeChatRef) activeChatRef.off();
    
    activeChatRef = firebase.database().ref(path);
    activeChatRef.on('child_added', snap => {
        const msg = snap.val();
        const div = document.createElement("div");
        const isMe = (msg.sender === UID);
        div.className = "msg-bubble " + (isMe ? "msg-me" : "msg-them");
        div.innerText = msg.text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });
}

// Send Message
document.getElementById("chatSend").onclick = sendMsg;
document.getElementById("chatInput").addEventListener("keypress", (e) => { if(e.key==="Enter") sendMsg(); });

function sendMsg() {
    const input = document.getElementById("chatInput");
    const txt = input.value.trim();
    if(!txt || !currentChatPath) return;
    
    firebase.database().ref(currentChatPath).push({
        sender: UID,
        text: txt,
        ts: firebase.database.ServerValue.TIMESTAMP
    });
    input.value = "";
}

/* --- PRESENCE TRACKING --- */
function trackPresence(u) {
    const globalRef = firebase.database().ref(`presence/global/${u.uid}`);
    const statusRef = firebase.database().ref(`presence/${u.uid}`);
    const connRef = firebase.database().ref('.info/connected');

    connRef.on('value', snap => {
        if (snap.val() === false) return;
        globalRef.onDisconnect().set({state: "offline", last: firebase.database.ServerValue.TIMESTAMP});
        statusRef.onDisconnect().set({state: "offline", ts: firebase.database.ServerValue.TIMESTAMP});

        globalRef.set({
            state: "online",
            name: u.displayName || u.email,
            email: u.email,
            ts: firebase.database.ServerValue.TIMESTAMP,
            page: "Wholesaler Portal"
        });
        statusRef.set({state: "online", ts: firebase.database.ServerValue.TIMESTAMP});
    });
}

/* --- ORIGINAL LEAD LOGIC (PRESERVED) --- */
function subscribeLeads() {
  // Manual mode: load leads from leads.js (window.leads)
  sellerList = Array.isArray(window.leads) ? window.leads.map((v, i) => ({ id: v.docnum || String(i), ...v })) : [];
  renderLeads();
}


function renderLeads() {
  const q = (document.getElementById('s_q').value || '').toLowerCase();
  sellerView = sellerList.filter(v =>
    !q || (v.address || '').toLowerCase().includes(q) ||
    (v.owner || '').toLowerCase().includes(q)
  );

  document.getElementById('status').textContent = 'Acq: ' + sellerView.length + ' items';
  const tbody = document.getElementById('sellerRows');

  if (!sellerView.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="status">No leads found.</td></tr>';
    updateDetail(null);
    return;
  }

  tbody.innerHTML = sellerView.map((v, i) => `
    <tr class="lead-row" data-idx="${i}">
      <td>${v.address || ''}</td>
      <td>${v.owner || ''}</td>
<td>${(v.phone || (v.contacts && v.contacts[0] && v.contacts[0].phone) || '')}</td>
      <td>${v.status || 'new'}</td>
      <td>${v.notes || ''}</td>
    </tr>`).join('');

  tbody.querySelectorAll('tr.lead-row').forEach(r => {
    r.onclick = () => {
      currentIndex = parseInt(r.dataset.idx);
      updateDetail(sellerView[currentIndex]);
    };
  });
}

function updateDetail(lead) {
  const detailTitle = document.getElementById('detailTitle');
  const detailSub = document.getElementById('detailSub');
  const detailInfo = document.getElementById('detailInfo');
  const detailAddr = document.getElementById('detailAddr');
  const detailOwner = document.getElementById('detailOwner');
  const detailPhone = document.getElementById('detailPhone');
  const scriptBox = document.getElementById('scriptBox');
  const mapWrap = document.getElementById('mapWrap');
  const streetFrame = document.getElementById('streetFrame');

  if (!lead) {
    detailTitle.textContent = 'No lead selected';
    detailSub.textContent = 'Select a lead to view information.';
    detailInfo.style.display = 'none';
    scriptBox.textContent = 'Select a lead to load script.';
    mapWrap.style.display = 'none';
    return;
  }

  detailTitle.textContent = lead.owner || 'Lead Details';
  detailSub.textContent = lead.status || 'new';
  detailInfo.style.display = 'block';

  detailAddr.textContent = lead.address || '';
  detailOwner.textContent = lead.owner || '';
  detailPhone.textContent = lead.phone || '';
  scriptBox.textContent = `Hi ${lead.owner || 'there'}, this is Bill regarding ${lead.address || 'your property'}. Are you the owner?`;

  if (lead.address) {
    streetFrame.src = 'https://www.google.com/maps/embed/v1/place?key=AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs&q=' + encodeURIComponent(lead.address);
    mapWrap.style.display = 'block';
  }
}

/* UI Listeners */
document.getElementById('s_reload').onclick = () => renderLeads();
document.getElementById('btnSettings').onclick = () => location.href = 'settings.html';
document.getElementById('logoutBtn').onclick = () => firebase.auth().signOut();

document.addEventListener('DOMContentLoaded', () => {
  const tabAcq = document.getElementById('tabAcq');
  const tabDispo = document.getElementById('tabDispo');
  const panelAcq = document.getElementById('panel-acq');
  const panelDispo = document.getElementById('panel-dispo');
  const crumb = document.getElementById('crumb');

  tabAcq.onclick = () => {
    tabAcq.classList.add('active');
    tabDispo.classList.remove('active');
    panelAcq.style.display = 'block';
    panelDispo.style.display = 'none';
    crumb.textContent = 'Acquisition';
  };

  tabDispo.onclick = () => {
    tabDispo.classList.add('active');
    tabAcq.classList.remove('active');
    panelAcq.style.display = 'none';
    panelDispo.style.display = 'block';
    crumb.textContent = 'Dispo';
  };
});
</script>

</body>
</html>
