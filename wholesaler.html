<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Acquisition ‚Ä¢ DealBankers</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
  :root{
    --bg:#0e1721; --panel:#0f1c28; --line:#1e3343;
    --text:#edf5fb; --muted:#9fb4c6; --cta:#1ecf7a; --gold:#ffd36b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,#0b1218,#0e1a24 50%,#102534);color:var(--text);
       font-family:system-ui,Segoe UI,Arial,sans-serif;padding:8px}
  .wrap{max-width:1200px;margin:0 auto}
  .card{border:1px solid var(--line);border-radius:16px;background:var(--panel);overflow:hidden}

  .top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .crumbs{font-size:12px;color:var(--muted)} .dot{display:inline-block;width:6px;height:6px;border-radius:99px;background:#5de0ff;margin:0 6px}
  .status{font-size:12px;color:#dff1ff}

  /* Layout: content + notes (desktop) */
  .shell{display:grid;grid-template-columns:1fr 340px;gap:12px;padding:12px}
  @media (max-width: 900px){ .shell{grid-template-columns:1fr} }

  /* Minimal toolbar */
  .bar{position:sticky;top:0;z-index:6;background:linear-gradient(180deg,rgba(255,255,255,.06),transparent);border-bottom:1px solid var(--line)}
  .bar-inner{display:flex;align-items:center;gap:10px;padding:10px}
  .cta{
    flex:1 1 auto;text-align:center;padding:12px 14px;border-radius:12px;background:linear-gradient(180deg,var(--cta),#19a963);
    color:#08140d;font-weight:900;letter-spacing:.02em;border:0;cursor:pointer
  }
  .icons{display:flex;gap:8px;flex-wrap:wrap}
  .ico{width:40px;height:40px;border-radius:10px;border:1px solid var(--line);background:#0e2332;display:grid;place-items:center;color:#e9f4ff;text-decoration:none}
  .ico:hover{background:#143142}
  .ico span{font-size:18px;line-height:1}

  /* Lead card */
  .lead{border:1px solid var(--line);border-radius:12px;background:#0d1f2c;overflow:hidden}
  .ttl{padding:12px 14px;border-bottom:1px solid var(--line);font-weight:900}
  .body{padding:10px 12px}
  .name{font-weight:900;font-size:18px;margin:2px 0 10px}
  details{background:#0c1b27;border:1px solid var(--line);border-radius:10px;margin:8px 0;overflow:hidden}
  summary{padding:10px 12px;cursor:pointer;font-weight:800}
  .map{width:100%;height:220px;border:0;border-radius:10px;background:#fff;margin-top:8px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px;background:#0e2332;border:1px solid var(--line);color:#cfe1f1}

  /* Notes panel */
  .notes{border:1px solid var(--line);border-radius:12px;background:#0d1f2c;display:flex;flex-direction:column;min-height:420px;position:sticky;top:66px}
  .notes .hd{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .notes .status{font-size:12px;color:var(--muted)}
  .notes .pad{padding:10px 12px;display:flex;flex-direction:column;gap:8px}
  .notes textarea{width:100%;min-height:240px;border-radius:10px;border:1px solid #25465b;background:#0b1a24;color:#eaf6ff;padding:10px 12px;resize:vertical}
  .btnRow{display:flex;gap:8px;flex-wrap:wrap}
  .btnSmall{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0e2332;color:#eaf6ff;text-decoration:none;cursor:pointer}
  .btnSmall.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#1b1506;border:0}
  .hint{font-size:12px;color:var(--muted)}

  /* Mobile: keep notes collapsed to save space */
  @media (max-width:900px){
    .notes{position:static}
  }
  @media (max-width:480px){
    .bar-inner{gap:8px;padding:8px}
    .cta{padding:10px}
    .ico{width:36px;height:36px;border-radius:9px}
    .map{height:190px}
    .notes textarea{min-height:160px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="crumbs">Wholesaler <span class="dot"></span> Acquisition</div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- Minimal toolbar -->
      <div class="bar">
        <div class="bar-inner">
          <div class="icons">
            <a id="prev" class="ico" title="Previous"><span>‚óÄÔ∏è</span></a>
            <a id="rand" class="ico" title="Random"><span>üé≤</span></a>
            <a id="leadMap" class="ico" title="Lead Map" target="_blank" rel="noopener"><span>üó∫Ô∏è</span></a>
            <a id="reload" class="ico" title="Reload"><span>‚ü≥</span></a>
          </div>
          <button id="next" class="cta">Next Deal</button>
          <div class="icons">
            <a id="call"  class="ico" title="Call"><span>üìû</span></a>
            <a id="sms"   class="ico" title="SMS"><span>üí¨</span></a>
            <a id="email" class="ico" title="Email"><span>‚úâÔ∏è</span></a>
            <a id="copy"  class="ico" title="Copy Phone"><span>üìã</span></a>
          </div>
        </div>
      </div>

      <div class="shell">
        <!-- Lead -->
        <div>
          <div id="leadCard" class="lead"><div class="body">Initializing‚Ä¶</div></div>
        </div>

        <!-- Notes (desktop sticky) -->
        <aside class="notes" id="notesBox">
          <div class="hd">
            <div><strong>Notes</strong></div>
            <div class="status" id="saveState">Idle</div>
          </div>
          <div class="pad">
            <textarea id="notesText" placeholder="Call outcomes, asks, timeline, objections, offer terms‚Ä¶"></textarea>
            <div class="btnRow">
              <button class="btnSmall gold" id="openForm">Open Form</button>
              <button class="btnSmall" id="insertStamp">Insert Timestamp</button>
              <button class="btnSmall" id="clearNotes">Clear</button>
            </div>
            <div class="hint">Autosaves to Firebase. Per-lead, per-user.</div>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <!-- Cache-busted leads.js -->
  <script>
    (function(){
      const s=document.createElement('script');
      s.src='/leads.js?v='+Date.now();
      s.onload=()=>{ window.leads=window.leads||[]; init(); };
      s.onerror=()=>{ document.getElementById('status').textContent='Could not load /leads.js'; };
      document.head.appendChild(s);
    })();
  </script>

  <!-- Firebase (for notes autosave) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
      authDomain: "deal-bankers.firebaseapp.com",
      databaseURL: "https://deal-bankers-default-rtdb.firebaseio.com",
      projectId: "deal-bankers",
      storageBucket: "deal-bankers.firebasestorage.app",
      messagingSenderId: "485110155601",
      appId: "1:485110155601:web:b4c38350ac58c1a2ecab70",
      measurementId: "G-KTNXZM14F7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    // ------- helpers
    const $=q=>document.querySelector(q);
    let i=0, uidParam=new URL(location.href).searchParams.get('uid')||'anon';
    const setStatus=t=>{const el=$('#status'); if(el) el.textContent=t;};
    const phoneOf=l=>(l?.contacts?.[0]?.phone||'').trim();
    const nameOf =l=>(l?.contacts?.[0]?.name || 'Unknown').trim();
    const addrOf =l=>(l?.address||'').trim();
    const hashLead = (l)=> btoa(unescape(encodeURIComponent(addrOf(l)||nameOf(l)))).replace(/=+$/,''); // simple stable key

    // ------- render lead
    function render(n){
      if(!Array.isArray(window.leads)||!window.leads.length){
        setStatus('No leads found.');
        $('#leadCard').innerHTML='<div class="body">No leads loaded.</div>'; return;
      }
      if(n<0) n=window.leads.length-1; if(n>=window.leads.length) n=0; i=n;

      const lead  = window.leads[i];
      const name  = nameOf(lead);
      const phone = phoneOf(lead);
      const addr  = addrOf(lead);
      const notesHTML = (lead?.notes||'').replace(/\n/g,'<br>');

      setStatus(`Lead ${i+1} of ${window.leads.length}`);

      // toolbar links
      $('#call').href  = phone?`tel:${phone}`:'#';
      $('#sms').href   = phone?`sms:${phone}`:'#';
      $('#email').href = `mailto:?subject=${encodeURIComponent(name)} ‚Äî Lead`;
      $('#copy').onclick = ()=>{ if(!phone) return alert('No phone on this lead.'); navigator.clipboard.writeText(phone).then(()=>alert('Copied: '+phone)); };
      $('#leadMap').href='https://www.google.com/maps/d/u/0/viewer?mid=1C_OfzvCIlHnx-6nLaZ3Y88izZtflM5g&hl=en';
      $('#reload').onclick=()=>location.reload();

      // card
      $('#leadCard').innerHTML=`
        <div class="ttl">${addr || name}</div>
        <div class="body">
          <div class="name">${name}</div>
          <details open>
            <summary>üìä Deal Details</summary>
            <div style="padding:8px 12px">${notesHTML || 'No deal notes available.'}</div>
          </details>
          <iframe class="map" src="https://www.google.com/maps?q=${encodeURIComponent(addr)}&output=embed" loading="lazy"></iframe>
          <div class="chips">
            <div class="chip">UID: ${uidParam.slice(0,8)}</div>
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <a class="chip" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}" target="_blank" rel="noopener">Directions</a>
            <a class="chip" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">Open in Google Maps</a>
          </div>
        </div>`;

      // load notes for this lead & user
      loadNotes(hashLead(lead));
      // form button points to your Google Form prefilled
      $('#openForm').onclick=()=>{
        const url = `https://docs.google.com/forms/d/e/1FAIpQLScIZ7GX_ga5yOx34817gOL8Bb5m3KFXW8r-5I4taw_-ergOxw/viewform?usp=pp_url&entry.849181096=${encodeURIComponent('Wholesaler')}&entry.121126280=${encodeURIComponent(name)}&entry.1828741519=${encodeURIComponent(addr)}`;
        window.open(url,'_blank','noopener');
      };
    }

    // ------- minimal controls
    $('#next').onclick = ()=>render(i+1);
    $('#prev').onclick = ()=>render(i-1);
    $('#rand').onclick = ()=>render(Math.floor(Math.random()*(window.leads?.length||1)));
    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft') return $('#prev').click();
      if(e.key==='ArrowRight')return $('#next').click();
      if(e.key.toLowerCase()==='r') return $('#rand').click();
    });

    // ------- NOTES: autosave to Firebase
    let saveTimer=null, currentKey=null, unsub=null;
    function loadNotes(key){
      currentKey = key;
      const ref = db.ref(`leadNotes/${key}/${uidParam}`);
      // detach previous listener
      if(typeof unsub==='function'){ unsub(); }
      const cb = ref.on('value', snap=>{
        // avoid clobbering user‚Äôs active typing: only set if different and not dirty
        const ta = $('#notesText');
        const val = (snap.val()?.text)||'';
        if(ta && ta.dataset.dirty!=='1'){ ta.value = val; setSaveState(snap.val()?.updatedAt); }
      });
      unsub = ()=> ref.off('value', cb);

      // set handlers
      const ta = $('#notesText');
      ta.dataset.dirty='0';
      ta.oninput = ()=>{
        ta.dataset.dirty='1';
        setSaveState(null,true);
        clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> doSave(ref, ta.value), 1500);
      };
      $('#insertStamp').onclick=()=>{
        const d=new Date(); ta.value += `\n[${d.toLocaleString()}] `; ta.dispatchEvent(new Event('input'));
      };
      $('#clearNotes').onclick=()=>{ if(confirm('Clear notes for this lead?')){ ta.value=''; ta.dispatchEvent(new Event('input')); } };
    }

    function doSave(ref, text){
      ref.set({ text, updatedAt: Date.now(), uid: uidParam })
        .then(()=>{ $('#notesText').dataset.dirty='0'; setSaveState(Date.now()); })
        .catch(()=> setSaveState(null,false,true));
    }
    function setSaveState(ts, typing=false, error=false){
      const el=$('#saveState');
      if(error){ el.textContent='Error saving'; el.style.color='#ff9b9b'; return; }
      if(typing){ el.textContent='Saving‚Ä¶'; el.style.color='#ffd36b'; return; }
      if(ts){ el.textContent='Saved ‚Ä¢ '+ new Date(ts).toLocaleTimeString(); el.style.color='#9fb4c6'; }
      else { el.textContent='Idle'; el.style.color='#9fb4c6'; }
    }

    function init(){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>render(0));} else {render(0);} }
  </script>
</body>
</html>
