<!-- ===================== wholesaler.html (Acq + Dispo + Realtor tab; Claims Exchange btn; working Red/Blue phone forms) ===================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler ‚Ä¢ Portal</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --bg1:#0b131b; --bg2:#142838; --bg3:#173c53;
      --panel:#0f1f2b; --line:#254a63;
      --text:#f1f7fb; --muted:#c5d3e1;
      --blue:#47b4ff; --green:#26cf84; --gold:#ffd36b; --red:#ff5a5a;
      --shadow:0 28px 70px rgba(0,0,0,.55);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
      padding:10px
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
    .top{
      display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px
    }
    .crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
    .status{font-size:12px;color:#e8f7ff}

    /* Sticky head */
    .sticky{
      position:sticky;top:0;z-index:8;padding:10px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06));
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    .segWrap{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .seg{display:inline-flex;border:1px solid rgba(255,255,255,.22);border-radius:999px;overflow:hidden}
    .seg button{padding:8px 12px;background:#0e2332;border:0;color:#cfe6ff;cursor:pointer}
    .seg button.active{background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff}
    .hint{font-size:12px;color:#b8cbe0}
    .hint.hidden{display:none}

    .actionsRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(255,255,255,.22);border-radius:999px;background:#0f2231;color:#e8f6ff;text-decoration:none;font-weight:800;cursor:pointer}
    .pill.red{background:linear-gradient(180deg,#ff8080,#c54c4c);color:#220000;border:none}
    .pill.blue{background:linear-gradient(180deg,#78b9ff,#3d6fd6);color:#061326;border:none}
    .pill.gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}

    /* Toolbars & buttons */
    .bar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;
      font-weight:800;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
    .btn:hover{filter:brightness(1.08)}
    .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
    .btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none}
    .btn-ghost{background:#0f2a3a}
    .ico{font-size:20px}
    .small{min-height:34px;padding:6px 10px;font-weight:700}
    .navrow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:8px 0}
    .hidden{display:none !important}

    /* Lead & sections */
    .lead-wrap{padding:12px}
    .lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(90deg,rgba(255,211,107,.18),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}
    .section{border:1px solid rgba(255,255,255,.18);border-radius:14px;background:#0f1f2b;padding:10px;margin-top:10px}

    .sv,.map{width:100%;border:0;border-radius:14px;background:#fff}
    .sv{height:260px;margin-top:6px}
    .map{height:220px;margin-top:8px}
    .textarea{
      width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:#0d2130;color:#eaf6ff;font-size:14px;line-height:1.4
    }
    .notesRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .savedTag{font-size:12px;color:#bfe9c9;opacity:.9;display:none}

    /* Capital console (within Dispo) */
    .capWrap{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:10px 0}
    .capCard{border:1px solid rgba(255,255,255,.18);border-radius:14px;background:#0e2231;padding:10px}
    .capLabel{font-size:12px;color:#bcd3e7}
    .capValue{font-weight:900;font-size:18px}

    /* Dispo lists */
    .dispoHead{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between}
    .dispoCTA{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .dealgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .group{margin-top:14px}
    .group h4{margin:0 0 8px;color:#d9e9f8}
    .dealcard{border:1px solid rgba(255,255,255,.18);border-radius:12px;background:#0e2231;padding:10px;cursor:pointer}
    .dealhdr{display:flex;justify-content:space-between;align-items:center;font-weight:800;margin-bottom:6px}
    .dealtype{font-size:11px;padding:3px 8px;border-radius:999px;background:#103043;border:1px solid rgba(255,255,255,.18)}
    .dealmeta{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .dealmeta .chip{background:#0d2a3c}
    .actrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    @media (max-width:760px){ .dealgrid{grid-template-columns:1fr} }

    /* Desktop-only preview col */
    .desktopOnly{display:inline-flex}
    @media (max-width:980px){ .desktopOnly{display:none !important} }
    .dispoLayout{display:grid;grid-template-columns:1.1fr .9fr;gap:10px}
    @media (max-width:980px){ .dispoLayout{display:block} }
    .preview{border:1px solid rgba(255,255,255,.18);border-radius:12px;background:#0e2231;padding:10px;min-height:420px}
    .pvHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .pvTitle{font-weight:900}
    .carousel{position:relative;width:100%;height:340px;border-radius:12px;overflow:hidden;background:#08121a}
    .carousel img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .35s ease}
    .carousel img.active{opacity:1}
    .carBtns{position:absolute;inset:auto 0 8px 0;display:flex;justify-content:center;gap:8px}
    .carBtn{border:1px solid rgba(255,255,255,.22);background:#0b1a24;border-radius:999px;padding:6px 10px;color:#eaf6ff}

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;
      color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}

    /* Hide directions button on desktop; show only on mobile/tablet */
    @media (min-width:981px){ #actDir{display:none !important} }
    @media (max-width:980px){ #actDir{display:inline-flex} }

    @media (max-width:560px){
      .bar{grid-template-columns:repeat(3,1fr)}
      .navrow{grid-template-columns:repeat(3,1fr)}
      .sv{height:230px}
      .map{height:200px}
    }

    /* Dialog base */
    dialog{border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px}
    .dlgRow{display:grid;gap:8px}
    .input, select{width:100%;height:38px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0d2130;color:#eaf6ff;padding:8px}
    .textarea.input{min-height:100px}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <!-- Header -->
      <div class="top">
        <div class="crumbs">
          <span>DealBankers</span><span class="dot"></span><span id="crumbMode">Acquisition</span>
        </div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- Sticky controls -->
      <div class="sticky">
        <div class="segWrap">
          <div class="seg" role="tablist" aria-label="Mode">
            <button id="tabAcq"  class="active" role="tab" aria-selected="true">Acq</button>
            <button id="tabDispo" role="tab" aria-selected="false">Dispo</button>
            <button id="tabRealtor" role="tab" aria-selected="false">Realtor</button>
          </div>
          <div id="leadHint" class="hint">Lead filters live in <b>Profile ‚Üí Settings ‚Üí Wholesaler</b>.</div>
        </div>
        <div class="actionsRight">
          <a id="btnRedPhone"  class="pill red"  href="#">üî¥ Immediate Support</a>
          <a id="btnBluePhone" class="pill blue" href="#">üîµ Standard Support</a>
          <a id="btnClaims"    class="pill gold" href="claims.html">‚öñÔ∏è Claims Exchange</a>
          <button id="newItemTop" class="pill gold">Ôºã New Deal / Offer</button>
        </div>
      </div>

      <!-- Acq toolbars -->
      <div class="lead-wrap">
        <div id="acqBar" class="bar" aria-label="Actions">
          <a class="btn btn-gold" href="#" id="actCall"  title="Call"><span class="ico">üìû</span></a>
          <a class="btn btn-gold" href="#" id="actSMS"   title="Text"><span class="ico">üí¨</span></a>
          <a class="btn btn-ghost" href="#" id="actDir"  title="Directions"><span class="ico">üöó</span></a>
          <button class="btn btn-ghost" id="actCopy"     title="Copy number"><span class="ico">üìã</span></button>
          <a class="btn btn-ghost" href="https://drive.google.com" target="_blank" rel="noopener" title="Drive"><span class="ico">üìÅ</span></a>
          <button class="btn btn-ghost" id="actSettings" title="Dial preference"><span class="ico">‚öôÔ∏è</span></button>
        </div>
        <div id="acqNav" class="navrow">
          <button class="btn btn-ghost" id="btnPrev"   title="Prev">‚óÄ</button>
          <button class="btn btn-ghost" id="btnRandom" title="Random">üé≤</button>
          <button class="btn btn-green" id="btnNext"   title="Next">‚ñ∂</button>
        </div>

        <!-- Acquisition panel -->
        <div id="leadCard" class="lead">
          <div class="body">Initializing‚Ä¶</div>
        </div>

        <!-- Disposition panel -->
        <div id="dispoPane" class="section hidden" aria-live="polite">
          <div class="dispoHead">
            <h3 style="margin:2px 0">üì¶ Disposition</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a class="btn" href="https://www.craigslist.org/" target="_blank" rel="noopener">Post to Craigslist</a>
              <a class="btn" href="https://www.facebook.com/marketplace/create/item" target="_blank" rel="noopener">Post to FB Marketplace</a>
              <a class="btn" id="linkShareAll" href="#" title="Copy a shareable link">Link Share</a>
              <a class="btn btn-green" href="dispo.html" target="_blank" rel="noopener">üìû Buyers List Queue</a>
            </div>
          </div>

          <!-- Capital Console -->
          <div id="capConsole" class="capWrap">
            <div class="capCard"><div class="capLabel">Capital Open</div><div id="capOpen" class="capValue">$‚Äî</div></div>
            <div class="capCard"><div class="capLabel">Turn</div><div id="capTurn" class="capValue">‚Äî</div></div>
            <div class="capCard"><div class="capLabel">Commodity</div><div id="capComm" class="capValue">‚Äî</div></div>
          </div>

          <!-- Dispo lists -->
          <div class="dispoLayout">
            <div id="dispoLeft">
              <div class="group" id="dealsGroup">
                <h4>Deals</h4>
                <div id="dealsGrid" class="dealgrid"></div>
              </div>
              <div class="group" id="offeringsGroup">
                <h4>Offerings</h4>
                <div id="offeringsGrid" class="dealgrid"></div>
              </div>
            </div>

            <div id="dispoPreview" class="preview desktopOnly">
              <div class="pvHead">
                <div class="pvTitle" id="pvTitle">Photo / Memo Preview</div>
                <div style="display:flex;gap:6px">
                  <button id="pvAdd"  class="btn small">Ôºã Add Photo</button>
                  <button id="pvEdit" class="btn small">‚úé Edit Photos</button>
                </div>
              </div>
              <div class="carousel" id="pvCarousel"></div>
            </div>
          </div>
        </div>

        <!-- Realtor panel -->
        <div id="realtorPane" class="section hidden" aria-live="polite">
          <div class="dispoHead">
            <h3 style="margin:2px 0">üè† Realtor Portal</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a class="btn btn-green" href="realtor.html" target="_blank" rel="noopener">Open Realtor Workspace</a>
            </div>
          </div>
          <div class="section">
            <div style="font-weight:800;margin-bottom:6px">Notes</div>
            <div style="color:#cfe3f7">Use the dedicated realtor workspace for MLS research, comps, and outbound marketing tasks.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Dial preference dialog -->
  <dialog id="settingsDlg" style="max-width:520px;width:92%">
    <h3 style="margin:0 0 8px">Phone Link Preference</h3>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMode" class="btn" style="flex:1">Save</button>
      <button id="closeMode" class="btn" style="flex:1">Close</button>
    </div>
  </dialog>

  <!-- Photo manager dialog (desktop-only) -->
  <dialog id="photoDlg" style="max-width:720px;width:92%">
    <h3 style="margin:0 0 8px">Manage Photos</h3>
    <div class="dlgRow">
      <label>Photo URLs (comma separated)
        <textarea id="phUrls" rows="3" class="textarea input" placeholder="https://...jpg, https://...png"></textarea>
      </label>
      <label>Upload Photos
        <input id="phFiles" type="file" accept="image/*" multiple style="display:block;margin-top:6px"/>
      </label>
    </div>
    <div id="phThumbs" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="phClear" class="btn">Clear All</button>
      <button id="phSave"  class="btn btn-green">Save</button>
      <button id="phClose" class="btn">Close</button>
    </div>
  </dialog>

  <!-- New Deal/Offer dialog -->
  <dialog id="newItemDlg" style="max-width:680px;width:92%">
    <h3 id="newItemTitle" style="margin:0 0 8px">New Deal / Offer</h3>
    <div class="dlgRow">
      <label>Type
        <select id="niKind" class="input">
          <option value="deal">Deal</option>
          <option value="offering">Offer</option>
        </select>
      </label>

      <!-- Urgency/profile (brought back) -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label>Urgency
          <select id="niUrgency" class="input">
            <option value="urgent">Urgent (Immediate)</option>
            <option value="normal" selected>Not Urgent</option>
          </select>
        </label>
        <label>Profile
          <select id="niProfile" class="input">
            <option value="wholesaler">Wholesaler</option>
            <option value="contractor">Contractor</option>
            <option value="investor">Investor</option>
            <option value="realtor">Realtor</option>
          </select>
        </label>
      </div>

      <label>Title <input id="niTitle" class="input" placeholder="123 Main St ‚Ä¢ or short title"/></label>
      <label>Address / Location (optional for Offer) <input id="niAddr" class="input" placeholder="Full address or city"/></label>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label>Price <input id="niPrice" class="input" placeholder="$"/></label>
        <label>Terms <input id="niTerms" class="input" placeholder="e.g., Assignment $12k ‚Ä¢ As-is"/></label>
      </div>

      <label id="memoRow">Memo URL (PDF/HTML; Offers)
        <input id="niMemo" class="input" placeholder="https://...pdf or /offering-memo.html"/>
      </label>
      <label id="photoRow">Photo URLs (comma separated for Deals)
        <textarea id="niPhotos" rows="2" class="textarea input" placeholder="https://...jpg, https://...png"></textarea>
      </label>

      <label>Notes
        <textarea id="niNotes" rows="3" class="textarea input" placeholder="What makes this compelling?"></textarea>
      </label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="niSave"  class="btn btn-green">Save</button>
      <button id="niClose" class="btn">Close</button>
    </div>
  </dialog>

  <!-- Immediate / Standard Support dialogs (restored working forms) -->
  <dialog id="supportDlg" style="max-width:620px;width:92%">
    <h3 id="supportTitle" style="margin:0 0 8px">Support Request</h3>
    <div class="dlgRow">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label>Name <input id="supName" class="input" placeholder="Your name"/></label>
        <label>Best Contact <input id="supContact" class="input" placeholder="Phone or email"/></label>
      </div>
      <label>Portal Area
        <select id="supArea" class="input">
          <option>Wholesaler</option>
          <option>Contractor</option>
          <option>Investor</option>
          <option>Realtor</option>
          <option>Claims Exchange</option>
          <option>Other</option>
        </select>
      </label>
      <label>Urgency
        <select id="supUrgency" class="input">
          <option value="immediate">Immediate</option>
          <option value="soon" selected>Soon</option>
          <option value="later">Later</option>
        </select>
      </label>
      <label>Describe the issue / request
        <textarea id="supMsg" rows="4" class="textarea input" placeholder="What's going on?"></textarea>
      </label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="supSend" class="btn btn-green">Send</button>
      <button id="supClose" class="btn">Close</button>
    </div>
  </dialog>

  <div id="toast"></div>

  <!-- Firebase (gate + db) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="config.js"></script>

  <script>
    // ----- Firebase app(s)
    if(!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.database();

    // Separate app for gate (optional, keeps schema tidy)
    const gateApp = !firebase.apps.find(a=>a.name==="whGate")
      ? firebase.initializeApp(
          {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
          "whGate"
        )
      : firebase.app("whGate");
    const gateDb   = gateApp.database();

    // ----- DOM helpers
    const $=s=>document.querySelector(s);
    const statusEl=$('#status'), toastEl=$('#toast'), modeCrumb=$('#crumbMode');
    function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1600); }
    function setStatus(t){ if(statusEl) statusEl.textContent=t; }
    const clean=s=>(s||'').trim();
    const slugify = s => (s||'item').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const esc = (s)=>String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    // ----- Global state
    let idx=0, currentLead=null, mode='acq';
    const params = new URL(location.href).searchParams;
    const uidParam = params.get('uid') || 'anon';
    const uidLocal = uidParam; // used when saving dispo items
    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);

    // Gate flags for permissions
    window.whGate = { acqEnabled:false, dispoEnabled:false };

    // Leads loader
    function loadLeadsJS(){
      const s=document.createElement('script');
      s.src='leads.js?v='+Date.now();
      s.onload=()=>{ window.leads = window.leads || []; init(); };
      s.onerror=()=>setStatus('Could not load leads.js');
      document.head.appendChild(s);
    }

    // Fetch gate + capital console
    gateDb.ref(`userSettings/${uidParam}/wholesaler`).once('value').then(snap=>{
      const g = snap.val() || {};
      window.whGate.acqEnabled   = (g.acqEnabled   !== undefined) ? !!g.acqEnabled   : !!g.leadsEnabled;
      window.whGate.dispoEnabled = (g.dispoEnabled !== undefined) ? !!g.dispoEnabled : !!g.leadsEnabledDispo;

      if(!window.whGate.acqEnabled){
        $('#leadCard').innerHTML =
          '<div class="body">Access to <b>acquisition</b> leads is disabled for this account. Ask admin to enable in Settings ‚Üí Wholesaler.</div>';
        setStatus('Acq access denied');
      } else {
        loadLeadsJS();
      }

      gateDb.ref('capital/summary').once('value').then(s=>{
        const v=s.val()||{};
        $('#capOpen').textContent = v.open || '$300k';
        $('#capTurn').textContent = v.turn || '7‚Äì10 days';
        $('#capComm').textContent = v.commodity || '‚Äî';
      }).catch(()=>{
        $('#capOpen').textContent='$300k';
        $('#capTurn').textContent='7‚Äì10 days';
        $('#capComm').textContent='‚Äî';
      });
    }).catch(()=>{
      $('#leadCard').innerHTML =
        '<div class="body">Could not verify access right now. Try again shortly.</div>';
      setStatus('Gate check failed');
    });

    // ----- Dial helpers
    function phoneOf(l){ return clean(l?.contacts?.[0]?.phone||''); }
    function phoneHref(number, dialMode){
      const num=(number||'').replace(/[^\d+]/g,'');
      if(!num) return '#';
      if(dialMode==='device') return `tel:${num}`;
      if(dialMode==='textnow'){ navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging'; }
      if(dialMode==='gvoice'){ navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages'; }
      return `tel:${num}`;
    }
    function dirHref(addr){ return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr||'')}`; }
    function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr)}`; }
    function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr)}`; }

    // Notes localStorage
    const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
    const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
    const saveTimeKey = addr => noteKey(addr)+'_ts';
    const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
    const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);
    function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px'; }

    // ----- Dispo data (merge local script + DB + fallback)
    let dispoItems=null, dispoLoaded=false;
    const fallbackDispo = [
      { kind:'deal', id:'4319-san-luis-st', title:'4319 San Luis St, San Antonio, TX 78237', address:'4319 San Luis St, San Antonio, TX 78237', price:'$65,000 ask', terms:'Wholesale assignment ‚Ä¢ As-is', memo:'offering-memo3.html',
        notes:'RM-4 zoning ‚Ä¢ 9,975 sqft lot ‚Ä¢ small structure built 2003 ‚Ä¢ water on site; electric setup not completed',
        photos:[
          'images/deals/san-luis-st/532285905_1525203368622964_6419601791457539095_n.jpg',
          'images/deals/san-luis-st/533401545_1232983395178499_3448834856308498546_n.jpg'
        ]},
      { kind:'deal', id:'3014-el-paso-st', title:'3014 El Paso St, San Antonio, TX 78207', address:'3014 El Paso St, San Antonio, TX 78207',
        price:'$155,000 ask', terms:'Assignment $12k ‚Ä¢ As-is', memo:'offering-memo2.html',
        notes:'2/1 ‚Ä¢ 948 sqft ‚Ä¢ 1945 build ‚Ä¢ pier foundation ‚Ä¢ recent remodel 2024' },
      { kind:'offering', id:'virgin-d6-lift', title:'Virgin D6 Lift ‚Äî FOB Houston', address:'‚Äî', price:'Capital Need $300k', terms:'Repay 7‚Äì10 days ‚Ä¢ 100M gal',
        memo:'offering-memo1.html', notes:'Private money / fuel trade offering. Use Submit Interest for soft commits.' }
    ];

    async function fetchDbDispo(uidX){
      try{
        const snap = await gateDb.ref(`deals/${uidX}`).once('value');
        const obj = snap.val() || {};
        return Object.entries(obj).map(([id,d])=>{
          const safeId = d.id || id || slugify((d.title||d.address||'item'));
          return {
            id: safeId,
            kind:    d.kind || 'deal',
            title:   d.title || safeId,
            address: d.location || d.address || '',
            price:   d.price || '',
            terms:   d.terms || '',
            memo:    d.memo || '',
            notes:   d.notes || '',
            photos:  Array.isArray(d.photos)? d.photos : [],
            createdBy: d.createdBy || uidX
          };
        });
      }catch{ return []; }
    }

    async function mergeDispoData(){
      const dbItems = await fetchDbDispo(uidParam);
      const base = dispoItems || fallbackDispo;
      const byId = new Map();
      [...base, ...dbItems].forEach(raw=>{
        const id = raw.id || slugify(raw.title||raw.address||'item');
        byId.set(id, {...raw, id}); // DB wins when later merged if same id
      });
      return Array.from(byId.values());
    }

    function ensureDispoData(cb){
      if(dispoLoaded){ mergeDispoData().then(list=>cb(list)); return; }
      const s=document.createElement('script'); s.src='dispo-data.js?v='+Date.now();
      s.onload = async ()=>{ dispoLoaded=true; dispoItems=window.dispoItems||fallbackDispo; cb(await mergeDispoData()); };
      s.onerror = async ()=>{ dispoLoaded=true; dispoItems=fallbackDispo; cb(await mergeDispoData()); };
      document.head.appendChild(s);
    }

    // ----- Preview (desktop)
    const pvTitle=$('#pvTitle'), pvCar=$('#pvCarousel'), photoDlg=$('#photoDlg'),
          phUrls=$('#phUrls'), phFiles=$('#phFiles'), phThumbs=$('#phThumbs'),
          pvAdd=$('#pvAdd'), pvEdit=$('#pvEdit');
    let previewItem=null, carIdx=0, carTimer=null, carRun=true;

    function slugFor(it){ const base=(it?.memo||'') || (it?.title||'') || (it?.address||'item'); return String(base).toLowerCase().replace(/[^a-z0-9]+/g,'-'); }
    const PHKEY = it => `db_dispo_photos_${slugFor(it)}`;
    function getPhotos(it){
      try{ const x=JSON.parse(localStorage.getItem(PHKEY(it))||'[]'); if(Array.isArray(x)&&x.length) return x; }catch{}
      return Array.isArray(it?.photos)?it.photos:[];
    }
    function savePhotos(it,arr){ localStorage.setItem(PHKEY(it), JSON.stringify(arr||[])); }
    function isPdf(url){ try{ return /\.pdf($|\?)/i.test(new URL(url, location.href).pathname); }catch{return /\.pdf($|\?)/i.test(url||'');} }
    function memoViewer(url){ if(isPdf(url)) return `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`; return url; }

    function renderPreview(it){
      carIdx = 0; carRun = true; previewItem=it;
      pvTitle.textContent = it?.title || it?.address || 'Photo / Memo Preview';
      const photos=getPhotos(it); pvCar.innerHTML='';

      if(!photos.length && it?.memo){
        const src = memoViewer(it.memo);
        pvCar.innerHTML = `<iframe src="${src}" style="width:100%;height:100%;border:0"></iframe>`;
        return;
      }
      if(!photos.length){
        pvCar.innerHTML = `<div style="color:#b8cbe0;padding:12px">No photos yet. Use <b>Ôºã Add Photo</b> to upload or paste URLs${it?.memo? ' ‚Äî memo available via Open Memo button.' : '.'}</div>`;
        return;
      }
      photos.forEach((src,i)=>{ const img=new Image(); img.src=src; img.alt='photo'; if(i===0) img.className='active'; pvCar.appendChild(img); });
      const ctr=document.createElement('div'); ctr.className='carBtns';
      const prev=document.createElement('button'); prev.className='carBtn'; prev.textContent='‚óÄ';
      const pause=document.createElement('button'); pause.className='carBtn'; pause.textContent='‚èØ';
      const next=document.createElement('button'); next.className='carBtn'; next.textContent='‚ñ∂';
      ctr.append(prev,pause,next); pvCar.appendChild(ctr);
      prev.onclick=()=>{ carRun=false; setSlide(-1); };
      next.onclick=()=>{ carRun=false; setSlide(+1); };
      pause.onclick=()=>{ carRun=!carRun; if(carRun) startCar(); else stopCar(); };
      startCar();
    }
    function setSlide(d){
      const imgs=[...pvCar.querySelectorAll('img')]; if(!imgs.length) return;
      imgs[carIdx]?.classList.remove('active');
      carIdx=(carIdx+d+imgs.length)%imgs.length;
      imgs[carIdx]?.classList.add('active');
    }
    function startCar(){ stopCar(); carTimer=setInterval(()=>{ if(carRun) setSlide(+1); },2800); }
    function stopCar(){ if(carTimer){ clearInterval(carTimer); carTimer=null; } }

    function openPhotoMgr(){
      const it=previewItem; if(!it) return;
      const arr=getPhotos(it);
      phUrls.value = arr.filter(u=>!/^data:/.test(u)).join(', ');
      drawThumbs(arr);
      photoDlg.showModal();
    }
    function drawThumbs(arr){
      phThumbs.innerHTML='';
      arr.forEach((src,i)=>{
        const d=document.createElement('div');
        d.innerHTML=`<img src="${src}" style="width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:8px"/><button class="btn small" data-i="${i}" style="margin-top:4px">Remove</button>`;
        phThumbs.appendChild(d);
      });
      phThumbs.querySelectorAll('button[data-i]').forEach(b=>{
        b.onclick=()=>{ const i=+b.dataset.i; const cur=getPhotos(previewItem); cur.splice(i,1); savePhotos(previewItem,cur); drawThumbs(cur); renderPreview(previewItem); };
      });
    }
    $('#phSave').onclick = async ()=>{
      if(!previewItem) return;
      const urls=phUrls.value.split(',').map(s=>s.trim()).filter(Boolean);
      const ups = await (async files=>{
        const out=[]; for(const f of files){ const data=await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); }); out.push(data); } return out;
      })(phFiles.files||[]);
      const final=[...urls,...ups];
      savePhotos(previewItem,final); renderPreview(previewItem); photoDlg.close(); phFiles.value=''; phUrls.value='';
    };
    $('#phClear').onclick = ()=>{ if(!previewItem) return; savePhotos(previewItem,[]); drawThumbs([]); renderPreview(previewItem); };
    $('#phClose').onclick = ()=>photoDlg.close();
    pvAdd.onclick = openPhotoMgr; pvEdit.onclick = openPhotoMgr;

    // ----- Dispo render
    function renderDispo(){
      ensureDispoData(items=>{
        const deals = items.filter(i=>i.kind!=='offering');
        const offs  = items.filter(i=>i.kind==='offering');

        const fill = (list, gridId) => {
          const grid=$(gridId); grid.innerHTML='';
          const byId = Object.fromEntries(list.map(i=>[(i.id || slugify(i.title||i.address||'item')), i]));
          list.forEach(it=>{
            const kindTag = it.kind==='offering' ? 'Offer' : 'Deal';
            const idSafe = it.id || slugify(it.title||it.address||'item');
            const editable = !!(it.createdBy && it.createdBy === uidLocal);
            const absMemo = (()=>{ try{ return it.memo ? (it.memo.startsWith('http') ? it.memo : new URL(it.memo, location.href).href) : ''; } catch(_){ return it.memo||''; } })();

            const el=document.createElement('div'); el.className='dealcard';
            el.innerHTML=`
              <div class="dealhdr">
                <div>${esc(it.title)}</div>
                <div class="dealtype">${esc(kindTag)}</div>
              </div>
              <div class="dealmeta">
                ${it.price?`<div class="chip">${esc(it.price)}</div>`:''}
                ${it.terms?`<div class="chip">${esc(it.terms)}</div>`:''}
                ${it.address?`<div class="chip">${esc(it.address)}</div>`:''}
              </div>
              ${it.notes?`<div style="font-size:13px;color:#cfe3f7">${esc(it.notes)}</div>`:''}
              <div class="actrow">
                ${it.memo?`<a class="btn" href="${esc(it.memo)}" target="_blank" rel="noopener">Open Memo</a>`:''}
                <a class="btn" href="${esc(it.share||'https://www.facebook.com/marketplace/create/item')}" target="_blank" rel="noopener">Post / Share</a>
                ${it.memo?`<button class="btn" data-copy="${esc(absMemo)}">Copy Link</button>`:''}
                <a class="btn" href="https://www.craigslist.org/" target="_blank" rel="noopener">Craigslist</a>
                <button class="btn desktopOnly" data-preview="1">üì∑ Preview</button>
                <button class="btn desktopOnly" data-manage="1">Ôºã Photos</button>
                ${editable ? `<button class="btn small" data-edit="${esc(idSafe)}">Edit</button><button class="btn small" data-del="${esc(idSafe)}">Delete</button>` : ``}
              </div>`;
            el.addEventListener('click',e=>{
              if(window.matchMedia('(max-width: 980px)').matches) return;
              if(e.target.closest('.actrow')){
                if(e.target.matches('button[data-preview]')) { renderPreview(it); }
                if(e.target.matches('button[data-manage]'))  { renderPreview(it); openPhotoMgr(); }
                return;
              }
              renderPreview(it);
            });
            grid.appendChild(el);
          });
          grid.querySelectorAll('button[data-copy]').forEach(b=>{
            b.addEventListener('click',e=>{ e.stopPropagation(); navigator.clipboard.writeText(b.getAttribute('data-copy')).then(()=>toast('Link copied')); });
          });
          grid.querySelectorAll('button[data-edit]').forEach(b=>{
            b.addEventListener('click',e=>{
              e.stopPropagation();
              const it = byId[b.getAttribute('data-edit')];
              if(it) openEditor(it);
            });
          });
          grid.querySelectorAll('button[data-del]').forEach(b=>{
            b.addEventListener('click',async e=>{
              e.stopPropagation();
              const id=b.getAttribute('data-del');
              if(!confirm('Delete this item?')) return;
              try{
                await gateDb.ref(`deals/${uidLocal}/${id}`).remove();
                toast('Deleted'); renderDispo();
              }catch{ alert('Could not delete right now.'); }
            });
          });
        };

        fill(deals, '#dealsGrid');
        fill(offs,  '#offeringsGrid');

        if(!window.matchMedia('(max-width: 980px)').matches){
          renderPreview(items[0]||null);
        }
      });
    }

    // ----- Acquisition render + improved embeds
    async function geocode(addr){
      if(!addr) return null;
      try{
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}&email=support%40dealbankers.com`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const arr = await res.json();
        if(Array.isArray(arr) && arr[0] && arr[0].lat && arr[0].lon){
          return {lat:+arr[0].lat, lon:+arr[0].lon};
        }
      }catch{}
      return null;
    }
    async function improveStreetViewAndMap(addr, svIframe, mapIframe){
      const hit = await geocode(addr);
      if(!hit) return;
      svIframe.src = `https://www.google.com/maps?layer=c&cbll=${hit.lat},${hit.lon}&cbp=12,0,,0,0&hl=en&z=18&output=svembed`;
      if(mapIframe){
        mapIframe.src = `https://www.google.com/maps?output=embed&q=${encodeURIComponent(hit.lat+','+hit.lon)}&z=17`;
      }
    }

    function render(i){
      if(!Array.isArray(window.leads)||!window.leads.length){
        $('#leadCard').innerHTML='<div class="body">No leads loaded. Ensure <b>leads.js</b> defines <code>window.leads=[...]</code>.</div>';
        setStatus('No leads found'); return;
      }
      if(i<0) i=window.leads.length-1;
      if(i>=window.leads.length) i=0;
      idx=i;

      const lead=window.leads[idx];
      currentLead=lead;

      const name  = clean(lead?.contacts?.[0]?.name||'Unknown');
      const phone = phoneOf(lead);
      const addr  = clean(lead?.address||'');

      modeCrumb.textContent = (mode==='acq'?'Acquisition':'Disposition');
      setStatus(`${mode==='acq'?'Acq':'Dispo'} ‚Ä¢ Lead ${idx+1} of ${window.leads.length}`);

      const dialMode=getMode();
      $('#actCall').href = phoneHref(phone, dialMode);
      $('#actSMS').href  = dialMode==='device' && phone ? `sms:${phone}` : phoneHref(phone, dialMode);
      $('#actDir').href  = dirHref(addr);

      const lastSaved = saveTimeGet(addr);
      const lastSavedText = lastSaved ? `Saved ${fmtTime(lastSaved)}` : 'Not saved yet';

      $('#leadCard').innerHTML = `
        <div class="title">${esc(addr || name)}</div>
        <div class="body">
          <div class="chips">
            <div class="chip">UID: ${esc(uidLocal.slice(0,8))}</div>
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <div class="chip">Dial: ${esc(dialMode)}</div>
            <div class="chip">Mode: Acquisition</div>
          </div>

          <h3 style="margin:4px 0 6px;font-size:16px">${esc(name)}</h3>

          <div class="section">
            <div style="font-weight:800;margin-bottom:6px">Lead details</div>
            <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶"></textarea>
            <div class="notesRow">
              <button id="inlineSave" class="btn btn-gold"><span class="ico">üíæ</span> Save Notes</button>
              <span id="savedTag" class="savedTag">${esc(lastSavedText)}</span>
            </div>
          </div>

          <div class="section">
            <iframe class="sv"  src="${svSrc(addr)}"   loading="lazy" allowfullscreen referrerpolicy="no-referrer-when-downgrade" title="Street View"></iframe>
            <iframe class="map" src="${mapSrc(addr)}"  loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Map"></iframe>
          </div>
        </div>
      `;

      const ta=$('#noteInput');
      ta.value = loadNotes(addr) || (lead?.notes || '');
      autoGrow(ta);
      ta.addEventListener('input',()=>autoGrow(ta));
      $('#inlineSave').onclick = ()=>doSaveNotes();

      const svIframe = $('#leadCard .sv');
      const mapIframe= $('#leadCard .map');
      improveStreetViewAndMap(addr, svIframe, mapIframe);
    }

    function doSaveNotes(){
      const addr = (currentLead?.address)||'';
      const text = ($('#noteInput')?.value||'').trim();
      saveNotes(addr, text);
      const ts=Date.now(); saveTimeSet(addr, ts);
      const tag=$('#savedTag'); if(tag){ tag.textContent=`Saved ${fmtTime(ts)}`; tag.style.display='inline'; }
      toast('Notes saved');
    }

    // ----- Actions
    $('#btnPrev').onclick   = ()=>render(idx-1);
    $('#btnNext').onclick   = ()=>render(idx+1);
    $('#btnRandom').onclick = ()=>render(Math.floor(Math.random()*(window.leads?.length||1)));

    $('#actCopy').onclick = ()=>{
      const p=phoneOf(window.leads?.[idx]);
      if(!p) return alert('No phone on this lead.');
      navigator.clipboard.writeText(p).then(()=>toast('Phone copied'));
    };

    // dial settings
    const dlg=$('#settingsDlg');
    $('#actSettings').onclick = ()=>{
      dlg.showModal();
      const cur=getMode();
      dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked=(r.value===cur));
    };
    $('#saveMode').onclick = ()=>{ const m=dlg.querySelector('input[name="mode"]:checked')?.value||'device'; setMode(m); dlg.close(); render(idx); };
    $('#closeMode').onclick = ()=>dlg.close();

    // Tabs
    function switchTo(modeName){
      mode = modeName;
      $('#tabAcq').classList.toggle('active',mode==='acq');
      $('#tabDispo').classList.toggle('active',mode==='dispo');
      $('#tabRealtor').classList.toggle('active',mode==='realtor');

      // show/hide panels
      $('#acqBar').classList.toggle('hidden',mode!=='acq');
      $('#acqNav').classList.toggle('hidden',mode!=='acq');
      $('#leadCard').classList.toggle('hidden',mode!=='acq');
      $('#leadHint').classList.toggle('hidden',mode!=='acq');

      $('#dispoPane').classList.toggle('hidden',mode!=='dispo');
      $('#realtorPane').classList.toggle('hidden',mode!=='realtor');

      modeCrumb.textContent = (mode==='acq'?'Acquisition': mode==='dispo'?'Disposition':'Realtor');
      setStatus(mode==='acq' ? 'Acq ‚Ä¢ Ready' : mode==='dispo' ? 'Dispo ‚Ä¢ Ready' : 'Realtor ‚Ä¢ Ready');

      if(mode==='acq'){
        if(window.whGate?.acqEnabled){ render(idx); }
        else{
          $('#leadCard').classList.remove('hidden');
          $('#leadCard').innerHTML = '<div class="body">Access to <b>acquisition</b> leads is disabled for this account.</div>';
          setStatus('Acq access denied');
        }
      } else if(mode==='dispo'){
        if(window.whGate?.dispoEnabled){ renderDispo(); }
        else{
          const pane = $('#dispoPane');
          pane.classList.remove('hidden');
          pane.innerHTML = `
            <div class="section">
              <div style="font-weight:800;margin-bottom:6px">Dispo access disabled</div>
              <div style="color:#cfe3f7">Your account does not currently have access to <b>Dispo</b> leads.</div>
            </div>`;
          setStatus('Dispo access denied');
        }
      } else {
        // realtor: nothing dynamic for now
      }
    }
    $('#tabAcq').onclick    = ()=>switchTo('acq');
    $('#tabDispo').onclick  = ()=>switchTo('dispo');
    $('#tabRealtor').onclick= ()=>switchTo('realtor');

    // Share all
    $('#linkShareAll')?.addEventListener('click',e=>{
      e.preventDefault();
      const root = location.origin + location.pathname.replace(/\/[^/]*$/,'/');
      navigator.clipboard.writeText(root).then(()=>toast('Site link copied'));
    });

    // Keyboard
    document.addEventListener('keydown',e=>{
      if(mode==='acq'){
        if(e.key==='ArrowLeft') return $('#btnPrev').click();
        if(e.key==='ArrowRight') return $('#btnNext').click();
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); return doSaveNotes(); }
      }
    });
    window.addEventListener('beforeunload',()=>{ if(mode==='acq' && currentLead){ doSaveNotes(); } });

    function init(){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',()=>render(0)); } else { render(0); } }

    // ----- New Item dialog wiring
    const newDlg = $('#newItemDlg');
    function updateKindRows(){
      const k=$('#niKind').value;
      $('#memoRow').style.display  = (k==='offering')?'block':'none';
      $('#photoRow').style.display = (k==='deal')?'block':'none';
    }
    function openEditor(it){
      $('#newItemTitle').textContent = it?.id ? (it.kind==='offering' ? 'Edit Offer' : 'Edit Deal') : 'New Deal / Offer';
      $('#niKind').value   = it?.kind || 'deal';
      $('#niUrgency').value= it?.urgency || 'normal';
      $('#niProfile').value= it?.profile || 'wholesaler';
      $('#niTitle').value  = it?.title || '';
      $('#niAddr').value   = it?.address || '';
      $('#niPrice').value  = it?.price || '';
      $('#niTerms').value  = it?.terms || '';
      $('#niMemo').value   = it?.memo  || '';
      $('#niNotes').value  = it?.notes || '';
      $('#niPhotos').value = (Array.isArray(it?.photos)?it.photos:[]).filter(u=>!/^data:/.test(u)).join(', ');
      newDlg.dataset.editing = it?.id || '';
      updateKindRows();
      newDlg.showModal();
    }
    $('#niKind').addEventListener('change', updateKindRows);
    $('#newItemTop').onclick = ()=>openEditor(null);
    $('#niClose').onclick    = ()=>{ newDlg.dataset.editing=''; newDlg.close(); };

    $('#niSave').onclick  = async ()=>{
      const kind  = $('#niKind').value;
      const title = $('#niTitle').value.trim();
      if(!title) return alert('Title is required');
      const addr  = $('#niAddr').value.trim();
      const price = $('#niPrice').value.trim();
      const terms = $('#niTerms').value.trim();
      const memo  = $('#niMemo').value.trim();
      const photos= $('#niPhotos').value.split(',').map(s=>s.trim()).filter(Boolean);
      const notes = $('#niNotes').value.trim();
      const urgency = $('#niUrgency').value;
      const profile = $('#niProfile').value;

      const editingId = newDlg.dataset.editing || null;
      const id = editingId || slugify(title || addr || (kind+'-'+Date.now()));
      const payload = { id, kind, title, address: addr, location: addr, price, terms, memo, photos, notes, urgency, profile, status:'active', createdBy: uidLocal, updatedAt: Date.now() };
      try{
        await gateDb.ref(`deals/${uidLocal}/${id}`).set(payload);
        newDlg.dataset.editing=''; toast(editingId ? 'Updated' : 'Saved'); newDlg.close();
        if(mode==='dispo') renderDispo();
      }catch{ alert('Could not save right now.'); }
    };

    // ----- Support dialogs (red/blue)
    const supportDlg = $('#supportDlg');
    const supTitle = $('#supportTitle');
    const supUrg = $('#supUrgency');
    $('#btnRedPhone').onclick = (e)=>{ e.preventDefault(); supTitle.textContent='Immediate Support'; supUrg.value='immediate'; supportDlg.showModal(); };
    $('#btnBluePhone').onclick= (e)=>{ e.preventDefault(); supTitle.textContent='Standard Support';  supUrg.value='soon';      supportDlg.showModal(); };
    $('#supClose').onclick=()=>supportDlg.close();
    $('#supSend').onclick = async ()=>{
      const user = auth.currentUser;
      const payload = {
        uid: user?.uid||uidLocal,
        email: user?.email||'',
        name: $('#supName').value.trim(),
        contact: $('#supContact').value.trim(),
        area: $('#supArea').value,
        urgency: $('#supUrgency').value,
        message: $('#supMsg').value.trim(),
        ts: Date.now()
      };
      try{
        await db.ref('supportRequests').push(payload);
        toast('Request sent'); supportDlg.close();
        $('#supName').value=''; $('#supContact').value=''; $('#supMsg').value='';
      }catch{ alert('Could not send right now.'); }
    };
  </script>
</body>
</html>
