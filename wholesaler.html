<!-- ===================== wholesaler.html (Acq + Dispo; with Live share + Live Leads toggle) ===================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler ‚Ä¢ Portal</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

  <style>
    :root{
      --bg1:#0b131b; --bg2:#142838; --bg3:#173c53;
      --panel:#0f1f2b; --line:#254a63;
      --text:#f1f7fb; --muted:#c5d3e1;
      --blue:#47b4ff; --green:#26cf84; --gold:#ffd36b;
      --shadow:0 28px 70px rgba(0,0,0,.55);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
      padding:10px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}

    .top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px}
    .crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
    .status{font-size:12px;color:#e8f7ff}

    .sticky{position:sticky;top:0;z-index:8;padding:10px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
    .seg{display:inline-flex;border:1px solid rgba(255,255,255,.22);border-radius:999px;overflow:hidden}
    .seg button{padding:8px 12px;background:#0e2332;border:0;color:#cfe6ff;cursor:pointer}
    .seg button.active{background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff}

    .hint{margin-top:8px;font-size:12px;color:#b8cbe0}
    .hint.hidden{display:none}

    .bar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;
      font-weight:800;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
    .btn:hover{filter:brightness(1.08)}
    .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
    .btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none}
    .btn-ghost{background:#0f2a3a}
    .ico{font-size:20px}
    .small{min-height:34px;padding:6px 10px;font-weight:700}

    .navrow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:8px 0}
    .hidden{display:none !important}

    .lead-wrap{padding:12px}
    .lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(90deg,rgba(255,211,107,.18),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}
    .section{border:1px solid rgba(255,255,255,.18);border-radius:14px;background:#0f1f2b;padding:10px;margin-top:10px}
    .sv,.map{width:100%;border:0;border-radius:14px;background:#fff}
    .sv{height:260px;margin-top:6px}
    .map{height:220px;margin-top:8px}
    .textarea{
      width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:#0d2130;color:#eaf6ff;font-size:14px;line-height:1.4
    }
    .notesRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .savedTag{font-size:12px;color:#bfe9c9;opacity:.9;display:none}

    /* ---------- Dispo-only UI ---------- */
    .dispoHead{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between}
    .dispoCTA{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .dealgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .group{margin-top:14px}
    .group h4{margin:0 0 8px;color:#d9e9f8}
    .dealcard{border:1px solid rgba(255,255,255,.18);border-radius:12px;background:#0e2231;padding:10px;cursor:pointer}
    .dealhdr{display:flex;justify-content:space-between;align-items:center;font-weight:800;margin-bottom:6px}
    .dealtype{font-size:11px;padding:3px 8px;border-radius:999px;background:#103043;border:1px solid rgba(255,255,255,.18)}
    .dealmeta{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .dealmeta .chip{background:#0d2a3c}
    .actrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    @media (max-width:760px){ .dealgrid{grid-template-columns:1fr} }

    /* Desktop-only preview column */
    .desktopOnly{display:inline-flex}
    @media (max-width:980px){ .desktopOnly{display:none !important} }
    .dispoLayout{display:grid;grid-template-columns:1.1fr .9fr;gap:10px}
    @media (max-width:980px){ .dispoLayout{display:block} }
    .preview{border:1px solid rgba(255,255,255,.18);border-radius:12px;background:#0e2231;padding:10px;min-height:420px}
    .pvHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .pvTitle{font-weight:900}
    .carousel{position:relative;width:100%;height:340px;border-radius:12px;overflow:hidden;background:#08121a}
    .carousel img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .35s ease}
    .carousel img.active{opacity:1}
    .carBtns{position:absolute;inset:auto 0 8px 0;display:flex;justify-content:center;gap:8px}
    .carBtn{border:1px solid rgba(255,255,255,.22);background:#0b1a24;border-radius:999px;padding:6px 10px;color:#eaf6ff}

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;
      color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}

    @media (max-width:560px){ .bar{grid-template-columns:repeat(3,1fr)} .navrow{grid-template-columns:repeat(3,1fr)} .sv{height:230px} .map{height:200px} }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <!-- Header -->
      <div class="top">
        <div class="crumbs">
          <span>Wholesaler</span><span class="dot"></span><span id="crumbMode">Acquisition</span>
        </div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- Sticky controls -->
      <div class="sticky">
        <div class="seg" role="tablist" aria-label="Mode">
          <button id="tabAcq"  class="active" role="tab" aria-selected="true">Acq</button>
          <button id="tabDispo" role="tab" aria-selected="false">Dispo</button>
        </div>
        <div id="leadHint" class="hint">Lead filters live in <b>Profile ‚Üí Settings ‚Üí Wholesaler</b>. No self-enable switch here.</div>

        <!-- Acq-only toolbars -->
        <div id="acqBar" class="bar" aria-label="Actions">
          <a class="btn btn-gold" href="#" id="actCall"  title="Call"><span class="ico">üìû</span></a>
          <a class="btn btn-gold" href="#" id="actSMS"   title="Text"><span class="ico">üí¨</span></a>
          <a class="btn btn-ghost" href="#" id="actDir"  title="Directions"><span class="ico">üöó</span></a>
          <button class="btn btn-ghost" id="actCopy"     title="Copy number"><span class="ico">üìã</span></button>
          <a class="btn btn-ghost" href="https://drive.google.com" target="_blank" rel="noopener" title="Drive"><span class="ico">üìÅ</span></a>
          <button class="btn btn-ghost" id="actSettings" title="Dial preference"><span class="ico">‚öôÔ∏è</span></button>
          <!-- NEW: Live Leads toggle (same style as your buttons) -->
          <button class="btn btn-green" id="btnLiveToggle" title="Show Live Leads">üü¢ Live Leads</button>
        </div>

        <div id="acqNav" class="navrow">
          <button class="btn btn-ghost" id="btnPrev"   title="Prev">‚óÄ</button>
          <button class="btn btn-ghost" id="btnRandom" title="Random">üé≤</button>
          <button class="btn btn-green" id="btnNext"   title="Next">‚ñ∂</button>
        </div>
      </div>

      <div class="lead-wrap">
        <!-- Acquisition panel -->
        <div id="leadCard" class="lead">
          <div class="body">Initializing‚Ä¶</div>
        </div>

        <!-- Simple Live Leads panel (hidden until toggled) -->
        <div id="livePane" class="section hidden" aria-live="polite">
          <div class="dispoHead">
            <h3 style="margin:2px 0">üü¢ Live Leads</h3>
            <div class="small" id="liveCount" style="opacity:.8">Loading‚Ä¶</div>
          </div>
          <div id="liveList" class="dealgrid"></div>
        </div>

        <!-- Disposition panel -->
        <div id="dispoPane" class="section hidden" aria-live="polite">
          <div class="dispoHead">
            <h3 style="margin:2px 0">üì¶ Disposition</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <a class="btn small" id="newDealBtn"      href="#">Ôºã New Deal</a>
              <a class="btn small" id="newOfferingBtn"  href="#">Ôºã New Offering</a>
              <a class="btn btn-green" href="dispo.html" target="_blank" rel="noopener">üìû Buyers List Queue</a>
            </div>
          </div>

          <div class="dispoCTA">
            <a class="btn" href="https://www.craigslist.org/" target="_blank" rel="noopener">Post to Craigslist</a>
            <a class="btn" href="https://www.facebook.com/marketplace/create/item" target="_blank" rel="noopener">Post to FB Marketplace</a>
            <a class="btn" id="linkShareAll" href="#" title="Copy a shareable link">Link Share</a>
          </div>

          <!-- Desktop-only 2-col layout: left cards, right preview -->
          <div class="dispoLayout">
            <div id="dispoLeft">
              <div class="group" id="dealsGroup">
                <h4>Deals</h4>
                <div id="dealsGrid" class="dealgrid"></div>
              </div>
              <div class="group" id="offeringsGroup">
                <h4>Offerings</h4>
                <div id="offeringsGrid" class="dealgrid"></div>
              </div>
            </div>

            <div id="dispoPreview" class="preview desktopOnly">
              <div class="pvHead">
                <div class="pvTitle" id="pvTitle">Photo / Memo Preview</div>
                <div style="display:flex;gap:6px">
                  <button id="pvAdd"  class="btn small">Ôºã Add Photo</button>
                  <button id="pvEdit" class="btn small">‚úé Edit Photos</button>
                </div>
              </div>
              <div class="carousel" id="pvCarousel"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Dial preference dialog -->
  <dialog id="settingsDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:520px;width:92%">
    <h3 style="margin:0 0 8px">Phone Link Preference</h3>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMode" class="btn" style="flex:1">Save</button>
      <button id="closeMode" class="btn" style="flex:1">Close</button>
    </div>
  </dialog>

  <!-- Photo manager dialog (desktop-only) -->
  <dialog id="photoDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:720px;width:92%">
    <h3 style="margin:0 0 8px">Manage Photos</h3>
    <div style="display:grid;gap:8px">
      <label>Photo URLs (comma separated)
        <textarea id="phUrls" rows="3" class="textarea" placeholder="https://...jpg, https://...png"></textarea>
      </label>
      <label>Upload Photos
        <input id="phFiles" type="file" accept="image/*" multiple style="display:block;margin-top:6px"/>
      </label>
    </div>
    <div id="phThumbs" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="phClear" class="btn">Clear All</button>
      <button id="phSave"  class="btn btn-green">Save</button>
      <button id="phClose" class="btn">Close</button>
    </div>
  </dialog>

  <!-- New item dialog (Deals / Offerings) -->
  <dialog id="newItemDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:640px;width:92%">
    <h3 id="newItemTitle" style="margin:0 0 8px">New Item</h3>
    <div style="display:grid;gap:8px">
      <label>Kind
        <select id="niKind" class="textarea" style="min-height:auto;height:38px">
          <option value="deal">Deal</option>
          <option value="offering">Offering</option>
        </select>
      </label>
      <label>Title <input id="niTitle" class="textarea" style="min-height:auto;height:38px"/></label>
      <label>Address / Location (optional for Offering) <input id="niAddr" class="textarea" style="min-height:auto;height:38px"/></label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label>Price <input id="niPrice" class="textarea" style="min-height:auto;height:38px"/></label>
        <label>Terms <input id="niTerms" class="textarea" style="min-height:auto;height:38px"/></label>
      </div>
      <label>Memo URL (PDF or HTML; Offerings only, optional)
        <input id="niMemo" class="textarea" style="min-height:auto;height:38px" placeholder="https://...pdf or /offering-memoX.html"/>
      </label>
      <label>Notes <textarea id="niNotes" rows="3" class="textarea"></textarea></label>
      <label>Photo URLs (comma separated) <textarea id="niPhotos" rows="2" class="textarea" placeholder="https://...jpg, https://...png"></textarea></label>
      <!-- NEW: Share as Live (keeps your styling) -->
      <label style="display:flex;gap:8px;align-items:center">
        <input id="niLive" type="checkbox"/> Share this as <b>Live</b> (visible to other users)
      </label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="niSave"  class="btn btn-green">Save</button>
      <button id="niClose" class="btn">Close</button>
    </div>
  </dialog>

  <div id="toast"></div>

  <!-- Firebase (gate for leads) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    /* same gated app you already use; reused for Live reads/writes */
    const gateApp = firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const gateDb   = gateApp.database();
    const params   = new URL(location.href).searchParams;
    const uidParam = params.get('uid') || 'anon';

    // Permission flags available to the rest of the page
    window.whGate = { acqEnabled:false, dispoEnabled:false };

    function loadLeadsJS(){
      const s=document.createElement('script');
      s.src='leads.js?v='+Date.now();
      s.onload=()=>{ window.leads = window.leads || []; init(); };
      s.onerror=()=>document.getElementById('status').textContent='Could not load leads.js';
      document.head.appendChild(s);
    }

    gateDb.ref(`userSettings/${uidParam}/wholesaler`).once('value').then(snap=>{
      const g = snap.val() || {};
      // Back-compat: support old single switches if present
      window.whGate.acqEnabled   = (g.acqEnabled   !== undefined) ? !!g.acqEnabled   : !!g.leadsEnabled;
      window.whGate.dispoEnabled = (g.dispoEnabled !== undefined) ? !!g.dispoEnabled : !!g.leadsEnabledDispo;

      if(!window.whGate.acqEnabled){
        document.getElementById('leadCard').innerHTML =
          '<div class="body">Access to <b>acquisition</b> leads is disabled for this account. Ask admin to enable in Settings ‚Üí Wholesaler.</div>';
        document.getElementById('status').textContent = 'Acq access denied';
      } else {
        loadLeadsJS();
      }
    }).catch(()=>{
      document.getElementById('leadCard').innerHTML =
        '<div class="body">Could not verify access right now. Try again shortly.</div>';
      document.getElementById('status').textContent = 'Gate check failed';
    });
  </script>

  <script>
    const $=s=>document.querySelector(s);
    const statusEl=$('#status'); const toastEl=$('#toast'); const modeCrumb=$('#crumbMode');
    const dlg=$('#settingsDlg');
    let idx=0, currentLead=null, mode='acq';
    let liveMode=false; // NEW: Acq <-> Live toggle

    const uid=new URL(location.href).searchParams.get('uid')||'anon';
    const MODE_KEY='db_phone_link_mode_wh';

    function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1600); }
    function setStatus(t){statusEl.textContent=t;}
    const clean=s=>(s||'').trim();
    const slugify = s => (s||'item').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const esc = (s)=>String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);

    /* ======= LIVE LEADS (simple viewer) ======= */
    function renderLiveCard(key, d){
      const price = d.price ? `<div class="chip">${esc(d.price)}</div>` : '';
      const terms = d.terms ? `<div class="chip">${esc(d.terms)}</div>` : '';
      const addr  = d.address ? `<div class="chip">${esc(d.address)}</div>` : '';
      const memo  = d.memo ? `<a class="btn" href="${esc(d.memo)}" target="_blank" rel="noopener">Open Memo</a>` : '';
      const title = esc(d.title || d.address || '(Untitled)');
      return `
        <div class="dealcard" data-key="${esc(key)}">
          <div class="dealhdr">
            <div>${title}</div>
            <div class="dealtype">${d.kind==='offering'?'Offering':'Deal'}</div>
          </div>
          <div class="dealmeta">${price}${terms}${addr}</div>
          ${d.notes?`<div style="font-size:13px;color:#cfe3f7">${esc(d.notes)}</div>`:''}
          <div class="actrow">
            ${memo || ''}
          </div>
        </div>`;
    }
    function showAcq(){ liveMode=false; $('#livePane').classList.add('hidden'); $('#leadCard').classList.remove('hidden'); $('#btnLiveToggle').textContent='üü¢ Live Leads'; modeCrumb.textContent='Acquisition'; }
    function showLive(){ liveMode=true; $('#leadCard').classList.add('hidden'); $('#livePane').classList.remove('hidden'); $('#btnLiveToggle').textContent='‚Ü© Back to Acq'; modeCrumb.textContent='Live Leads'; }

    async function loadLiveOnce(){
      try{
        const snap = await gateDb.ref('leads').orderByChild('live').equalTo(true).get();
        const list = Object.entries(snap.val()||{}).map(([k,v])=>({id:k, ...v}));
        $('#liveList').innerHTML = list.map(it=>renderLiveCard(it.id, it)).join('') || '<div class="small" style="opacity:.8">No live leads yet.</div>';
        $('#liveCount').textContent = `${list.length} live`;
      }catch(e){
        $('#liveList').innerHTML = '<div class="small" style="opacity:.8">Error loading live leads.</div>';
      }
    }

    /* ===== existing acq utilities (unchanged behavior) ===== */
    function phoneOf(l){ return clean(l?.contacts?.[0]?.phone||''); }
    function phoneHref(number, dialMode){
      const num=(number||'').replace(/[^\d+]/g,'');
      if(!num) return '#';
      if(dialMode==='device') return `tel:${num}`;
      if(dialMode==='textnow'){ navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging'; }
      if(dialMode==='gvoice'){ navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages'; }
      return `tel:${num}`;
    }
    function dirHref(addr){ return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr||'')}`; }
    function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr)}`; }
    function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr)}`; }

    const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
    const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
    const saveTimeKey = addr => noteKey(addr)+'_ts';
    const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
    const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);

    function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px'; }

    /* ---------- Dispo items: unchanged visuals, add live flag on save ---------- */
    let previewItem=null; // used by photo manager
    function getPhotos(it){ return Array.isArray(it?.photos)? it.photos : []; }
    function savePhotos(it, arr){ it.photos = Array.isArray(arr)? arr : []; }
    function renderPreview(it){
      const car = $('#pvCarousel'); if(!car) return;
      const pics = getPhotos(it);
      car.innerHTML = pics.map((src,i)=>`<img src="${src}" class="${i===0?'active':''}" alt="Photo ${i+1}">`).join('');
    }

    // Ensure Dispo data exists; this keeps your existing merging/fallback approach
    let _dispoCache=null;
    function ensureDispoData(cb){
      if(_dispoCache){ cb(_dispoCache); return; }
      gateDb.ref('leads').once('value').then(s=>{
        const cloud = Object.values(s.val()||{}).filter(x=>x && (x.kind==='deal' || x.kind==='offering'));
        _dispoCache = cloud;
        cb(_dispoCache);
      }).catch(()=>cb(_dispoCache||[]));
    }

    function renderDispo(){
      ensureDispoData(items=>{
        const deals = items.filter(i=>i.kind!=='offering');
        const offs  = items.filter(i=>i.kind==='offering');

        const fill = (list, gridId) => {
          const grid=$(gridId); grid.innerHTML='';
          list.forEach(it=>{
            const kindTag = it.kind==='offering' ? 'Offering' : 'Deal';
            const absMemo = (()=>{ try{ return it.memo ? (it.memo.startsWith('http') ? it.memo : new URL(it.memo, location.href).href) : ''; } catch(_){ return it.memo||''; } })();

            const el=document.createElement('div'); el.className='dealcard';
            el.innerHTML=`
              <div class="dealhdr">
                <div>${esc(it.title||it.address||'(Untitled)')}</div>
                <div class="dealtype">${esc(kindTag)}</div>
              </div>
              <div class="dealmeta">
                ${it.price?`<div class="chip">${esc(it.price)}</div>`:''}
                ${it.terms?`<div class="chip">${esc(it.terms)}</div>`:''}
                ${it.address?`<div class="chip">${esc(it.address)}</div>`:''}
                ${it.live===true?`<div class="chip">üü¢ Live</div>`:''}
              </div>
              ${it.notes?`<div style="font-size:13px;color:#cfe3f7">${esc(it.notes)}</div>`:''}
              <div class="actrow">
                ${it.memo?`<a class="btn" href="${esc(it.memo)}" target="_blank" rel="noopener">Open Memo</a>`:''}
                <a class="btn" href="${esc(it.share||'https://www.facebook.com/marketplace/create/item')}" target="_blank" rel="noopener">Post / Share</a>
                ${it.memo?`<button class="btn" data-copy="${esc(absMemo)}">Copy Link</button>`:''}
                <a class="btn" href="https://www.craigslist.org/" target="_blank" rel="noopener">Craigslist</a>
                <button class="btn desktopOnly" data-preview="1">üì∑ Preview</button>
                <button class="btn desktopOnly" data-manage="1">Ôºã Photos</button>
              </div>`;
            grid.appendChild(el);
          });
        };

        fill(deals, '#dealsGrid');
        fill(offs,  '#offeringsGrid');
      });
    }

    /* ===================== Minimal events wiring ===================== */
    document.addEventListener('DOMContentLoaded',()=>{
      // Tabs
      const acqBtn=$('#tabAcq'), dispoBtn=$('#tabDispo');
      acqBtn.onclick=()=>{ $('#leadCard').classList.remove('hidden'); $('#dispoPane').classList.add('hidden'); $('#livePane').classList.add('hidden'); modeCrumb.textContent='Acquisition'; };
      dispoBtn.onclick=()=>{ $('#dispoPane').classList.remove('hidden'); $('#leadCard').classList.add('hidden'); $('#livePane').classList.add('hidden'); renderDispo(); modeCrumb.textContent='Disposition'; };

      // Live toggle
      $('#btnLiveToggle').onclick=async()=>{
        if(liveMode){ showAcq(); return; }
        await loadLiveOnce();
        showLive();
      };

      // New item buttons
      $('#newDealBtn').onclick = e=>{ e.preventDefault(); openNewItem('deal'); };
      $('#newOfferingBtn').onclick = e=>{ e.preventDefault(); openNewItem('offering'); };

      // Photo dlg buttons handled below when previewItem is set
    });

    function openNewItem(kind){
      $('#niKind').value = kind || 'deal';
      $('#niTitle').value = '';
      $('#niAddr').value  = '';
      $('#niPrice').value = '';
      $('#niTerms').value = '';
      $('#niMemo').value  = '';
      $('#niNotes').value = '';
      $('#niPhotos').value = '';
      $('#niLive').checked = false; // default off
      document.getElementById('newItemDlg').showModal();
    }

    $('#niClose').onclick = ()=> document.getElementById('newItemDlg').close();

    // Save New Item (adds live flag)
    $('#niSave').onclick = async ()=>{
      const kind  = $('#niKind').value || 'deal';
      const title = ($('#niTitle').value||'').trim();
      const addr  = ($('#niAddr').value||'').trim();
      const price = ($('#niPrice').value||'').trim();
      const terms = ($('#niTerms').value||'').trim();
      const memo  = ($('#niMemo').value||'').trim();
      const notes = ($('#niNotes').value||'').trim();
      const photos= ($('#niPhotos').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const live  = $('#niLive').checked === true;

      const item = {
        kind, title, address:addr, price, terms, memo, notes, photos,
        live, createdBy: uid, createdAt: Date.now(), updatedAt: Date.now()
      };

      try{
        const ref = gateDb.ref('leads').push();
        await ref.set(item);
        toast(live ? 'Saved as Live' : 'Saved (private)');
        document.getElementById('newItemDlg').close();
        _dispoCache=null; // bust cache; next render pulls fresh
        if(liveMode) loadLiveOnce();
        else renderDispo();
      }catch(e){
        console.error(e);
        toast('Error saving item');
      }
    };

    /* ===== status helpers & phone pref (unchanged visuals) ===== */
    const MODE_KEY2='db_phone_link_mode_wh';
    function setDialLabel(m){ const btn=$('#actSettings'); if(btn) btn.dataset.mode=m; }

    $('#actSettings').onclick=()=>{ const dlg=$('#settingsDlg'); if(!dlg) return; const m=localStorage.getItem(MODE_KEY2)||'device'; dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked = (r.value===m)); dlg.showModal(); };
    $('#saveMode').onclick=()=>{ const m=[...document.querySelectorAll('#settingsDlg input[name="mode"]')].find(x=>x.checked)?.value||'device'; localStorage.setItem(MODE_KEY2,m); setDialLabel(m); toast('Saved'); $('#settingsDlg').close(); };
    $('#closeMode').onclick=()=>$('#settingsDlg').close();

    // basic actions remain intact
    $('#actCopy').onclick = ()=>{ const n=''+(window.currentLeadPhone||''); if(!n){ toast('No number'); return; } navigator.clipboard.writeText(n.replace(/[^\d+]/g,'')).then(()=>toast('Number copied')); };
  </script>
</body>
</html>
