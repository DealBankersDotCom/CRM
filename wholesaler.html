<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DealBankers ‚Ä¢ Wholesaler</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

<style>
  :root{
    --bg:#0d1822; --panel:#0f1a24; --card:#12202d; --line:#203241;
    --text:#eaf1f6; --muted:#9fb3c7; --accent:#0d6efd; --gold:#c7a86a;
    --green:#28a745; --danger:#d9534f; --shadow:0 22px 60px rgba(0,0,0,.5);
    --r:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
    background:
      radial-gradient(900px 500px at 85% -10%, #133243 0%, transparent 60%),
      linear-gradient(135deg,#0b1218,#0e1a24 50%,#102434);
    color:var(--text); min-height:100vh;
  }

  /* Shell */
  .shell{max-width:1200px; margin:0 auto; padding:16px}
  .bar{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:12px 14px; border:1px solid #1a2a36; border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    box-shadow:var(--shadow); backdrop-filter:blur(10px);
  }
  .brand{display:flex; align-items:center; gap:12px}
  .brand img{width:40px;height:40px;border-radius:9px;object-fit:cover}
  .title{display:flex; flex-direction:column}
  .title b{letter-spacing:.06em}
  .title small{color:var(--muted)}
  .bar .btn{padding:9px 12px; border-radius:10px; border:1px solid #1d3142; background:#0f1a24; color:#cfe2f3; cursor:pointer}
  .btn:hover{filter:brightness(1.06)}
  .btn-green{background:linear-gradient(180deg,#2fb557,#199a3f); border:none; color:#fff}
  .btn-red{background:linear-gradient(180deg,#dd6060,#bb3e3e); border:none; color:#fff}

  /* Tabs (Acq/Dispo) */
  .tabs{display:flex; gap:8px; padding:14px 2px 0}
  .tab{padding:8px 12px; border-radius:999px; border:1px solid #1d3142; background:#0f1a24; color:#cfe2f3; cursor:pointer; font-size:13px}
  .tab.active{background:linear-gradient(180deg,var(--gold),#9d7d49); color:#111; border:none}

  /* Workspace */
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:12px}
  .card{background:#10202c; border:1px solid #1a2a36; border-radius:var(--r); overflow:hidden}
  .card h3{margin:0; padding:12px 14px; background:#0c151d; border-bottom:1px solid #122432; font-size:15px}
  .card .body{padding:12px}

  .stack{display:flex; flex-direction:column; gap:10px}
  .row{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:8px 10px; border-radius:999px; border:1px solid #1d3142; background:#0f1a24; color:#cfe2f3; font-size:13px}

  /* Lead card */
  .lead{
    background:#0f1a24; border:1px solid #1d3142; border-radius:12px; padding:12px;
  }
  .lead b{font-size:16px}
  .lead a{color:#6fb3ff; text-decoration:none}
  .lead .btn{padding:8px 10px}
  .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:#0e2030; border:1px solid #1d3142; color:#9fb3c7; font-size:12px}

  /* Map / iframe */
  iframe.map{width:100%; height:320px; border:0; border-radius:10px; background:#fff}

  /* Gate / empty */
  .gate{padding:14px; border:1px dashed #2a4256; border-radius:12px; background:#0f1a24; color:var(--muted)}

  /* Modal */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:50}
  .modal .box{width:90%; max-width:900px; height:80vh; background:#fff; border-radius:12px; overflow:hidden; position:relative}
  .modal iframe{width:100%; height:100%; border:0}
  .close{position:absolute; top:10px; right:12px; width:32px; height:32px; border-radius:50%; border:0; background:#333; color:#fff; cursor:pointer}

  /* Responsive */
  @media (max-width: 960px){ .grid{grid-template-columns: 1fr} iframe.map{height:260px} }
</style>
</head>
<body>
  <div class="shell">
    <!-- Top Bar -->
    <div class="bar">
      <div class="brand">
        <img src="icon (1).jpg" alt="">
        <div class="title">
          <b>Wholesaler ‚Ä¢ Acquisition</b>
          <small>Calls ‚Ä¢ Notes ‚Ä¢ Map ‚Ä¢ Fast nav</small>
        </div>
      </div>
      <div class="row">
        <button id="btnFullscreen" class="btn btn-green">Open Fullscreen</button>
        <button id="btnLogout" class="btn btn-red">Log Out</button>
      </div>
    </div>

    <!-- Sub Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="acq">Acquisition</button>
      <button class="tab" data-tab="dispo">Dispo</button>
    </div>

    <!-- Acquisition Workspace -->
    <section data-panel="acq" class="grid">
      <!-- Lead pane -->
      <div class="card">
        <h3>Lead Panel</h3>
        <div class="body">
          <div id="feedGate" class="gate">No feed configured. Ask an admin to export leads and pass the <span class="badge">?feed=PUBLIC_SCRIPT_URL</span> into this page, or set it inside the file.</div>

          <div id="leadWrap" class="stack" style="display:none">
            <div class="row">
              <button id="btnPrev" class="btn">‚èÆ Prev</button>
              <button id="btnNext" class="btn">‚è≠ Next</button>
              <span class="pill" id="idxBadge">0 / 0</span>
            </div>

            <div id="leadCard" class="lead">
              <!-- populated -->
            </div>
          </div>
        </div>
      </div>

      <!-- Map pane -->
      <div class="card">
        <h3>Map</h3>
        <div class="body">
          <iframe id="mapFrame" class="map" src="about:blank" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
    </section>

    <!-- Dispo Panel (simple links / launchers) -->
    <section data-panel="dispo" class="card" style="display:none; margin-top:12px">
      <h3>Dispositions Tools</h3>
      <div class="body row">
        <button class="btn" onclick="window.open('dispo.html?uid='+encodeURIComponent(state.uid),'_blank','noopener')">Open Dispo in New Tab</button>
        <button class="btn" onclick="window.open('offer_packet.html','_blank','noopener')">Offering Memorandum</button>
        <button class="btn" onclick="window.open('investor_signup.html','_blank','noopener')">Investor Signup</button>
        <button class="btn" onclick="window.open('market_listing.html','_blank','noopener')">Public Listing</button>
      </div>
    </section>
  </div>

  <!-- Notes Google Form modal -->
  <div id="modal" class="modal">
    <div class="box">
      <button class="close" onclick="closeModal()">√ó</button>
      <iframe id="formFrame"></iframe>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
      authDomain: "deal-bankers.firebaseapp.com",
      databaseURL: "https://deal-bankers-default-rtdb.firebaseio.com",
      projectId: "deal-bankers",
      storageBucket: "deal-bankers.firebasestorage.app",
      messagingSenderId: "485110155601",
      appId: "1:485110155601:web:b4c38350ac58c1a2ecab70",
      measurementId: "G-KTNXZM14F7"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    /* --------- Config / State ---------- */
    // Optional: hardcode your latest public feed here, or pass ?feed=<url>
    const DEFAULT_FEED = ""; // e.g. "https://drive.google.com/uc?export=download&id=XXXXXXXX"

    const state = {
      uid: "",
      leads: [],   // array from Drive script: window.leads
      i: 0,
      feedURL: ""
    };

    /* --------- Helpers ---------- */
    const $ = s => document.querySelector(s);
    const panels = [...document.querySelectorAll('[data-panel]')];
    const tabs   = [...document.querySelectorAll('.tab')];

    function showPanel(name){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===name));
      panels.forEach(p => p.style.display = (p.dataset.panel===name) ? '' : 'none');
    }
    document.querySelector('.tabs').addEventListener('click', e=>{
      const b = e.target.closest('.tab'); if(!b) return;
      showPanel(b.dataset.tab);
    });

    function qs(name){ return new URL(location.href).searchParams.get(name) || ""; }

    function setMap(address){
      const q = encodeURIComponent(address);
      const src = `https://www.google.com/maps?q=${q}&output=embed`;
      $('#mapFrame').src = src;
    }

    function openModal(url){
      $('#formFrame').src = url;
      $('#modal').style.display = 'flex';
    }
    function closeModal(){
      $('#modal').style.display = 'none';
      $('#formFrame').src = 'about:blank';
    }
    window.closeModal = closeModal; // for button

    function renderLead(){
      if (!state.leads.length){ return; }
      const lead = state.leads[state.i];
      const contact = lead.contacts && lead.contacts[0] ? lead.contacts[0] : { name:"(no name)", phone:"" };
      const addr = lead.address || "(no address)";
      const tn  = "https://www.textnow.com/messaging";
      const formBase = "https://docs.google.com/forms/d/e/1FAIpQLScIZ7GX_ga5yOx34817gOL8Bb5m3KFXW8r-5I4taw_-ergOxw/viewform";
      const formUrl = `${formBase}?usp=pp_url&entry.849181096=${encodeURIComponent('Wholesaler')}&entry.121126280=${encodeURIComponent(contact.name)}&entry.1828741519=${encodeURIComponent(addr)}&entry.204=${encodeURIComponent(state.uid)}`;

      $('#idxBadge').textContent = `${state.i+1} / ${state.leads.length}`;

      $('#leadCard').innerHTML = `
        <div class="row">
          <button class="btn" onclick="navigator.clipboard.writeText('${(contact.phone||'').replace(/'/g,'')}').then(()=>alert('Number copied'))">üìû Copy</button>
          <a class="btn" href="${tn}" target="_blank" rel="noopener">üí¨ TextNow</a>
          <button class="btn" onclick="openModal('${formUrl}')">üìù Update Notes</button>
        </div>
        <div style="margin-top:8px">
          <b>${contact.name}</b><br>
          <span class="badge">${contact.phone || 'no phone'}</span>
        </div>
        <div style="margin-top:8px">${addr}</div>
        ${lead.notes ? `<div style="margin-top:10px" class="badge">notes</div><div style="margin-top:6px">${String(lead.notes).replace(/\n/g,'<br>')}</div>` : ''}
      `;
      setMap(addr);
    }

    function next(n){
      if (!state.leads.length) return;
      state.i = (state.i + n + state.leads.length) % state.leads.length;
      renderLead();
    }

    /* --------- Feed loader ---------- */
    function injectFeed(src){
      if (!src) return false;
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => {
        // Expect global "leads" array from feed
        if (Array.isArray(window.leads) && window.leads.length){
          state.leads = window.leads;
          $('#feedGate').style.display = 'none';
          $('#leadWrap').style.display = 'flex';
          state.i = 0;
          renderLead();
        } else {
          $('#feedGate').innerHTML = 'Feed loaded but no leads found.';
        }
      };
      s.onerror = () => $('#feedGate').innerHTML = 'Failed to load feed script.';
      document.head.appendChild(s);
      return true;
    }

    /* --------- Auth + Boot ---------- */
    auth.onAuthStateChanged(u=>{
      if (!u){ location.href='index.html'; return; }
      state.uid = u.uid;

      // ensure URL uid param for consistency (useful when opened directly)
      const cur = qs('uid');
      if (cur !== state.uid){
        const url = new URL(location.href);
        url.searchParams.set('uid', state.uid);
        history.replaceState(null,'',url.toString());
      }

      // feed via ?feed=... or fallback to DEFAULT_FEED
      state.feedURL = qs('feed') || DEFAULT_FEED;
      if (!injectFeed(state.feedURL)){
        // keep gate visible, user will see instructions
      }
    });

    /* --------- Wire UI ---------- */
    $('#btnPrev').onclick = ()=> next(-1);
    $('#btnNext').onclick = ()=> next(+1);
    $('#btnFullscreen').onclick = ()=>{
      const url = new URL(location.href);
      window.open(url.toString(), '_blank','noopener');
    };
    $('#btnLogout').onclick = async ()=>{
      try{ await auth.signOut(); location.href='index.html'; }catch(e){ alert(e.message); }
    };
  </script>
</body>
</html>
