<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Acquisition ‚Ä¢ DealBankers</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
  <style>
    :root{
      --bg1:#0b1218;--bg2:#0e1a24;--bg3:#133247;
      --panel:#0d1f2e;--card:#112a3d;--line:#224055;
      --text:#f2f7fb;--muted:#bcd0e3;--accent:#57e3ff;--accent2:#ffd36a;
      --green:#2fd07a;--bluebtn:#1a7fff;--shadow:0 24px 60px rgba(0,0,0,.55);--r:18px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:radial-gradient(1200px 480px at 92% -10%,#1c4561 0,transparent 60%),
                 linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));
      padding:12px
    }
    .wrap{max-width:1100px;margin:0 auto;filter:saturate(1.06)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06));
          border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
    .top{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;
         border-bottom:1px solid var(--line);
         background:radial-gradient(700px 220px at 4% 0%,rgba(255,255,255,.16),transparent 70%),
                    linear-gradient(90deg,rgba(87,227,255,.18),rgba(255,211,106,.16))}
    .crumbs{display:flex;gap:10px;align-items:center;font-size:13px;color:#e6f4ff}
    .crumbs .dot{width:7px;height:7px;border-radius:999px;background:var(--accent);box-shadow:0 0 14px rgba(87,227,255,.9)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:12px;border-bottom:1px solid var(--line);background:#0e2536}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #21445b;cursor:pointer;background:#0f3247;color:#eef7ff;font-weight:700;letter-spacing:.02em;transition:filter .15s ease,transform .02s ease}
    .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
    .btn-blue{background:linear-gradient(180deg,var(--bluebtn),#165fbe);border:none}
    .quickbar{position:sticky;top:0;z-index:5;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:12px;background:linear-gradient(180deg,#133247,#102a3e);border-bottom:1px solid var(--line)}
    .qbtn{min-width:160px;display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid #21445b;color:#0a1a22;font-weight:900;box-shadow:0 10px 18px rgba(0,0,0,.25)}
    .qbtn.call{background:linear-gradient(180deg,#2fe18a,#1bb76d)}
    .qbtn.sms{background:linear-gradient(180deg,#4eb6ff,#1a7fff);color:#fff}
    .qbtn.mail{background:linear-gradient(180deg,#ffd36a,#c89a2a)}
    .qbtn.note,.qbtn.copy{background:linear-gradient(180deg,#ffffff,#dfe7ee)}
    .hide-mobile{display:none}
    @media (min-width:820px){ .hide-mobile{display:inline-flex} }

    .center{max-width:900px;margin:0 auto;padding:14px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);overflow:hidden}
    .panel .hd{padding:12px 14px;font-weight:800;font-size:14px;letter-spacing:.02em;border-bottom:1px solid var(--line);
      background:linear-gradient(90deg,rgba(255,211,106,.22),transparent 40%),
                 linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .pad{padding:12px 14px}
    .lead{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:linear-gradient(180deg,var(--card),#0e2739)}
    .lead .title{padding:14px;font-weight:900;letter-spacing:.02em;
      background:radial-gradient(600px 260px at 6% -20%,rgba(255,255,255,.25),transparent 70%),
                 linear-gradient(90deg,rgba(255,211,106,.26),transparent 40%),
                 linear-gradient(180deg,rgba(0,0,0,.25),transparent);
      border-bottom:1px solid var(--line)}
    .lead .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;justify-content:center}
    .chip{font-size:12px;padding:7px 12px;border-radius:999px;border:1px solid #28506a;background:#123a53}
    .sv{width:100%;height:340px;border:0;border-radius:12px;background:#000;object-fit:cover}
    .map{width:100%;height:340px;border:0;border-radius:12px;background:#fff}
    @media (max-width:480px){.sv,.map{height:280px}}

    .note-card{background:#0f334a;border:1px solid #224b63;border-radius:12px;padding:12px 14px;margin:14px auto;max-width:840px}
    .note-card h3{margin:0 0 8px;font-size:14px;letter-spacing:.03em}
    .textarea{width:100%;min-height:120px;resize:vertical;border-radius:10px;border:1px solid #2a5572;background:#0d2535;color:#eaf6ff;padding:10px 12px;line-height:1.45}
    .note-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .btn-ghost{background:#0f3247;color:#eaf6ff}

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b1218;color:#fff;padding:10px 14px;border-radius:12px;border:1px solid #1a2a36;box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="crumbs"><span>Wholesaler</span><span class="dot"></span><span>Acquisition</span></div>
        <div class="crumbs" id="status">Loading‚Ä¶</div>
      </div>

      <div class="toolbar">
        <button class="btn btn-blue" id="btnLeadMap">üó∫Ô∏è Lead Map</button>
        <button class="btn" id="btnOpenFs">‚§¢ Fullscreen</button>
        <button class="btn" id="btnReload">‚ü≥ Reload</button>
      </div>

      <div class="quickbar">
        <button class="qbtn call" id="qbCall">üìû Call</button>
        <button class="qbtn sms"  id="qbSMS">üí¨ SMS</button>
        <button class="qbtn mail" id="qbEmail">‚úâÔ∏è Email</button>
        <button class="qbtn copy hide-mobile" id="qbCopy">üìã Copy Phone</button>
        <button class="qbtn note" id="qbNotes">üìù Update Notes</button>
      </div>

      <div class="center">
        <div class="panel">
          <div class="hd">Lead</div>
          <div class="pad">
            <div id="leadCard" class="lead"><div class="body">Initializing‚Ä¶</div></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig={
      apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
      authDomain:"deal-bankers.firebaseapp.com",
      databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
      projectId:"deal-bankers",
      storageBucket:"deal-bankers.firebasestorage.app",
      messagingSenderId:"485110155601",
      appId:"1:485110155601:web:b4c38350ac58c1a2ecab70",
      measurementId:"G-KTNXZM14F7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(), db=firebase.database();
  </script>

  <!-- Load leads with cache-bust -->
  <script>
    (function(){
      const s=document.createElement('script');
      s.src='/leads.js?v='+Date.now();
      s.onload=()=>{ window.leads=window.leads||[]; };
      s.onerror=()=>{ document.getElementById('status').textContent='Could not load /leads.js'; };
      document.head.appendChild(s);
    })();
  </script>

  <script>
    /************* CONFIG ‚Äì PUT YOUR GOOGLE MAPS KEY HERE *************/
    const GOOGLE_MAPS_KEY = 'YOUR_GOOGLE_MAPS_API_KEY'; // <-- paste your "Browser key" (AIza...)
    /******************************************************************/

    const $=s=>document.querySelector(s);
    let idx=0, currentUser=null;
    const statusEl=$('#status');
    const uidParam=new URL(location.href).searchParams.get('uid')||'anon';
    const setStatus=t=>statusEl.textContent=t;
    const phoneOf=l=>(l?.contacts?.[0]?.phone||'').trim();
    const svCache=new Map(); // address|size -> url

    function toast(msg){const el=$('#toast');el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',1800)}

    const leadKey = addr => encodeURIComponent(String(addr||'').trim());

    async function fetchSavedNotes(key){
      try{
        const snap = await db.ref(`leadNotes/acq/${key}/latest`).get();
        return snap.exists() ? (snap.val().text||'') : '';
      }catch(e){ return ''; }
    }
    async function saveNotes(key, text){
      if(!currentUser){ toast('Sign in again.'); return; }
      const payload = { text, uid: currentUser.uid, email: currentUser.email||'', ts: Date.now() };
      const base = db.ref(`leadNotes/acq/${key}`);
      await base.child('latest').set(payload);
      await base.child('history').push(payload);
      toast('Notes saved');
    }

    function streetViewUrl(addr, w=900, h=340){
      if(!GOOGLE_MAPS_KEY) return null;
      const k=`${addr}|${w}x${h}`;
      if(svCache.has(k)) return svCache.get(k);
      const params=new URLSearchParams({
        size:`${w}x${h}`,
        location:addr,
        fov:'85',
        pitch:'0',
        key:GOOGLE_MAPS_KEY
      });
      const url=`https://maps.googleapis.com/maps/api/streetview?${params.toString()}`;
      svCache.set(k,url);
      return url;
    }
    const mapEmbed = addr => `https://www.google.com/maps?q=${encodeURIComponent(addr)}&output=embed`;

    function render(i){
      if(!Array.isArray(window.leads)||!window.leads.length){
        setStatus('No leads found.');
        $('#leadCard').innerHTML='<div class="body">No leads loaded. Ensure <b>/leads.js</b> defines <code>window.leads=[...]</code>.</div>';
        return;
      }
      if(i<0)i=window.leads.length-1; if(i>=window.leads.length)i=0; idx=i;

      const lead=window.leads[idx];
      const name = lead?.contacts?.[0]?.name || 'Unknown';
      const addr = lead?.address || '';
      const phone= phoneOf(lead);

      setStatus(`Lead ${idx+1} of ${window.leads.length}`);

      const fileNotes = (lead?.notes||'').trim();
      const isMobile = window.matchMedia('(max-width: 820px)').matches;

      // Build media section: SV on desktop, map on mobile. SV falls back to map if image fails.
      let mediaHtml='';
      if(isMobile || !GOOGLE_MAPS_KEY){
        mediaHtml = `<iframe class="map" src="${mapEmbed(addr)}" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
      }else{
        const sv = streetViewUrl(addr, 1200, 340);
        const map = mapEmbed(addr);
        mediaHtml = `
          <img id="svImg" class="sv" src="${sv}" alt="Street View" onerror="this.replaceWith(Object.assign(document.createElement('iframe'),{className:'map',src:'${map}',loading:'lazy'}))">
        `;
      }

      $('#leadCard').innerHTML=`
        <div class="title">${addr || name}</div>
        <div class="body">
          <div class="chips">
            <div class="chip">UID: ${uidParam.slice(0,8)}</div>
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <div class="chip">${name}</div>
          </div>

          <div class="note-card">
            <h3>üìä Deal Details</h3>
            <textarea id="noteArea" class="textarea" placeholder="Type notes‚Ä¶"></textarea>
            <div class="note-actions">
              <button id="btnResetNote" class="btn btn-ghost">Reset</button>
              <button id="btnSaveNote"  class="btn" style="background:linear-gradient(180deg,#3b9eff,#0c63d6);border:none">Save Notes</button>
            </div>
            <div id="noteHint" class="muted" style="margin-top:6px"></div>
          </div>

          ${mediaHtml}

          <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0">
            <a class="btn" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}" target="_blank" rel="noopener">Directions</a>
            <a class="btn" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener">Open in Google Maps</a>
          </div>
        </div>
      `;

      // Quickbar actions
      const callHref  = phone ? `tel:${phone}` : '#';
      const smsHref   = phone ? `sms:${phone}` : '#';
      const mailHref  = `mailto:?subject=${encodeURIComponent(name)} ‚Äî Lead&body=${encodeURIComponent(addr)}`;
      const notesForm = `https://docs.google.com/forms/d/e/1FAIpQLScIZ7GX_ga5yOx34817gOL8Bb5m3KFXW8r-5I4taw_-ergOxw/viewform?usp=pp_url&entry.849181096=${encodeURIComponent('Wholesaler')}&entry.121126280=${encodeURIComponent(name)}&entry.1828741519=${encodeURIComponent(addr)}`;

      $('#qbCall').onclick = ()=> phone ? window.open(callHref,'_self') : toast('No phone on file');
      $('#qbSMS').onclick  = ()=> phone ? window.open(smsHref,'_self') : toast('No phone on file');
      $('#qbEmail').onclick= ()=> window.open(mailHref,'_self');
      $('#qbNotes').onclick= ()=> window.open(notesForm,'_blank','noopener');
      const copyBtn = $('#qbCopy');
      if(copyBtn){
        copyBtn.onclick = async ()=> {
          if (!phone) { toast('No phone on file'); return; }
          try { await navigator.clipboard.writeText(phone); toast('Phone copied'); }
          catch { toast('Could not copy'); }
        };
      }

      // Notes load/save
      (async ()=>{
        const key = leadKey(addr);
        const saved = (await fetchSavedNotes(key)) || '';
        const area  = $('#noteArea');
        const hint  = $('#noteHint');

        const setText = t => {
          area.value = t;
          const d = new Date();
          hint.textContent = t ? `Loaded ‚Ä¢ ${d.toLocaleString()}` : 'No saved notes yet (showing editor with current text).';
        };

        setText(saved || fileNotes);

        $('#btnResetNote').onclick = ()=> setText(fileNotes);
        $('#btnSaveNote').onclick  = async ()=>{
          const text = area.value.trim();
          await saveNotes(key, text);
          setText(text);
        };
      })();
    }

    // Header controls
    $('#btnOpenFs').onclick = ()=> window.open(location.href,'_blank','noopener');
    $('#btnReload').onclick = ()=> location.reload();
    $('#btnLeadMap').onclick= ()=> window.open('https://www.google.com/maps/d/u/0/viewer?mid=1C_OfzvCIlHnx-6nLaZ3Y88izZtflM5g&hl=en','_blank','noopener');

    // Keyboard nav
    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft')  return render(idx-1);
      if(e.key==='ArrowRight') return render(idx+1);
      if(e.key.toLowerCase()==='r') return render(Math.floor(Math.random()*(window.leads?.length||1)));
    });

    // Render when auth is ready
    firebase.auth().onAuthStateChanged(u=>{
      currentUser = u || null;
      if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', ()=> render(0));
      } else {
        render(0);
      }
    });

    // Re-render only when crossing mobile/desktop breakpoint (saves Street View quota)
    (function(){
      let isMobile = window.matchMedia('(max-width: 820px)').matches;
      const mq = window.matchMedia('(max-width: 820px)');
      mq.addEventListener('change', (e) => {
        const nowMobile = e.matches;
        if (nowMobile !== isMobile) {
          isMobile = nowMobile;
          render(idx);
        }
      });
    })();
  </script>
</body>
</html>
