<!-- =============== Wholesaler Portal (Offerings=PDF, Deals=Carousel; ACQ fixed + file download; role-scoped Settings with Contractor 16 divisions) =============== -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wholesaler Portal</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
  /* ====== Theme: ‚ÄúRetro Bond Workstation‚Äù ====== */
  :root{
    --bg1:#0a0f16;--bg2:#102131;--bg3:#14354c;
    --text:#e9f3ff;--muted:#a6c2d7;--gold:#ffd36b;--green:#25d18f;--line:#2a5a78;
    --accent:#52c8ff;--accent2:#9ae6ff;--panel:#0e2433;--glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 520px at 92% -12%, rgba(86,214,255,.22) 0%, transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
    padding:10px;
  }
  @media (min-width:1000px){
    body::before{
      content:"";position:fixed;inset:0;pointer-events:none;
      background:
        linear-gradient(transparent 31px, rgba(82,200,255,.06) 32px),
        linear-gradient(90deg, transparent 31px, rgba(82,200,255,.06) 32px);
      background-size:32px 32px;
      mask-image:radial-gradient(1200px 520px at 85% -10%, black 35%, transparent 70%);
    }
  }

  .wrap{max-width:1180px;margin:0 auto}
  .card{
    border:1px solid rgba(255,255,255,.18);
    border-radius:20px;
    background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
    overflow:hidden;position:relative;
  }
  .card::after{content:"";position:absolute;inset:-1px;border-radius:20px;border:1px solid rgba(146,233,255,.2);pointer-events:none;}

  .top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,rgba(0,0,0,.18),rgba(255,255,255,.05))}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0c1f2d;color:#cfe7ff;cursor:pointer}
  .pill.active{background:linear-gradient(180deg,#1a6c92,#0e435d);color:#eaffff;border-color:transparent}
  .crumbs{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:600}
  .status{font-size:12px;color:#e8f7ff;opacity:.9}

  .subtabs{display:flex;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
  .sub{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.22);background:#0d2332;color:#cfe7ff;cursor:pointer}
  .sub.active{background:#114463;color:#fff;border-color:transparent}

  .sticky{position:sticky;top:0;z-index:5}
  .actions{display:grid;grid-template-columns:repeat(12,1fr);gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.22);background:var(--panel);color:#eaf6ff;cursor:pointer;text-decoration:none;transition:transform .05s ease, box-shadow .15s ease}
  .btn:active{transform:translateY(1px)}
  .btn:hover{box-shadow:0 0 0 1px rgba(154,230,255,.18) inset,0 0 18px rgba(82,200,255,.18)}
  .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
  .btn-green{background:linear-gradient(180deg,#26cf84,#1a9b61);color:#fff;border:none}
  .btn-ghost{background:var(--glass)}
  .btn-small{padding:8px 10px;font-size:12px}
  .muted{color:var(--muted);font-size:13px}

  /* Lead */
  .lead{margin:12px;border:1px solid rgba(255,255,255,.22);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));overflow:hidden}
  .title{padding:12px 14px;font-weight:900;border-bottom:1px solid rgba(255,255,255,.18)}
  .body{padding:12px 14px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}
  .sv,.map{width:100%;border:0;border-radius:14px;background:#fff}.sv{height:260px;margin-top:6px}.map{height:220px;margin:8px 0}
  .textarea{width:100%;min-height:120px;resize:vertical;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#0d2130;color:#eaf6ff}

  /* Chooser */
  .chooser{padding:16px;display:grid;gap:10px}
  .grid4{display:grid;grid-template-columns:repeat(2,minmax(200px,1fr));gap:10px}
  @media (min-width:860px){.grid4{grid-template-columns:repeat(4,1fr)}}
  .choice{border:1px solid rgba(255,255,255,.22);border-radius:14px;padding:12px;background:#0e2233}
  .choice h4{margin:0 0 6px}.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0d2130;color:#eaf6ff}

  /* Dispo */
  .offerCard,.dealCard{display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.18);background:#0f2a3a;border-radius:12px;padding:10px}
  .offerCard{cursor:pointer}
  .badge{font-size:11px;padding:4px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:#0c1f2d;color:#cfe7ff}
  .postPanel{margin-bottom:12px;border:1px dashed rgba(154,230,255,.4);border-radius:14px;padding:12px;background:rgba(12,31,45,.4)}
  .postGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  @media (min-width:860px){.postGrid{grid-template-columns:repeat(4,1fr)}}
  .sectionBox{border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px}
  .previewTitle{font-weight:800;margin:0 0 6px;color:var(--accent2)}

  /* Right preview: PDF or Carousel */
  .viewer{border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px}
  .viewer iframe{width:100%;height:520px;border:0;border-radius:12px;background:#fff}
  .carouselInline{position:relative;border-radius:12px;background:#06141f;min-height:260px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .carouselInline img{max-height:65vh;max-width:100%}
  .thumbsInline{display:flex;gap:6px;overflow:auto;padding:6px;margin-top:8px}
  .thumbsInline img{height:56px;width:84px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.2);cursor:pointer;opacity:.9}
  .thumbsInline img.active{outline:2px solid var(--accent)}
  .arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:6px 10px;cursor:pointer}
  .arrow.left{left:8px}.arrow.right{right:8px}

  /* Settings */
  .settingsWrap{padding:12px}
  .roleTabs{display:flex;gap:8px;margin-bottom:8px}
  .roleTab{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.22);background:#0e2233;color:#cfe7ff;cursor:pointer}
  .roleTab.active{background:#14577b;color:#fff;border-color:transparent}
  .field{display:grid;gap:6px;margin:8px 0}
  .chkGrid{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:8px}
  @media (min-width:860px){.chkGrid{grid-template-columns:repeat(4,1fr)}}

  /* Footer + Toast */
  footer{max-width:1180px;margin:14px auto 6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:8px}
  footer a{color:var(--accent2);text-decoration:none}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);display:none}
</style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="tabs" id="roleTabsTop">
          <span class="pill active" data-role="wh">Wholesaler</span>
          <span class="pill" data-role="ct">Contractor</span>
          <span class="pill" data-role="re">Realtor</span>
          <span class="pill" data-role="in">Investor</span>
          <span class="pill" data-role="settings">Settings</span>
        </div>
        <div class="crumbs"><span id="crumb">Wholesaler ‚Ä¢ Acquisition</span></div>
        <div id="status" class="status">Loading‚Ä¶</div>
      </div>

      <!-- Wholesaler subtabs -->
      <div class="subtabs sticky" id="whSubtabs">
        <span class="sub active" data-sub="acq">Acquisition</span>
        <span class="sub" data-sub="dispo">Dispo</span>
        <span class="sub" id="exportLeads">‚¨áÔ∏è Export Leads (.csv)</span>
        <span class="sub" id="seedLeads">üå± Load Sample Leads</span>
      </div>

      <!-- Toolbar (Acq) -->
      <div class="sticky" id="acqBar">
        <div class="actions">
          <a class="btn btn-gold" id="actCall">üìû Call</a>
          <a class="btn btn-gold" id="actSMS">üí¨ Text</a>
          <a class="btn" id="actDirections" target="_blank" rel="noopener">üß≠ Directions</a>
          <button class="btn" id="actCopy">üìã Copy</button>
          <button class="btn" id="actSettings">‚öôÔ∏è Dial Pref</button>
          <button class="btn" id="leadPhotos">üì∑ Photos</button>
          <button class="btn btn-green" id="addLead">‚ûï Lead</button>
          <button class="btn btn-ghost btn-small" id="reloadLeads">üîÑ Reload</button>
          <button class="btn btn-ghost btn-small" id="resetFilters">‚ôªÔ∏è Reset Filters</button>
          <button class="btn btn-ghost" id="prevLead">‚¨ÖÔ∏è Prev</button>
          <button class="btn btn-green" id="nextLead">‚û°Ô∏è Next</button>
        </div>
        <div id="telemetry" class="muted" style="margin:6px 10px 12px"></div>
      </div>

      <!-- ACQ lead card -->
      <div id="acqWrap">
        <div id="leadCard" class="lead"><div class="body">Initializing‚Ä¶</div></div>
      </div>

      <!-- Lead Source Chooser -->
      <div id="chooser" class="chooser" style="display:none">
        <h3 style="margin:0">Pick how you want to work leads</h3>
        <div class="muted">We‚Äôll notify admin and turn on the right feed. You can also upload a CSV to start immediately.</div>
        <div class="grid4">
          <div class="choice"><h4>Street Leads</h4><div class="muted">Door-knock, driving for dollars. Curated by ZIP.</div><button class="btn btn-green" data-req="Street Leads">Request Street Leads</button></div>
          <div class="choice"><h4>Web Leads</h4><div class="muted">Inbound web form / PPC / site capture.</div><button class="btn btn-green" data-req="Web Leads">Request Web Leads</button></div>
          <div class="choice"><h4>Live Leads</h4><div class="muted">Live transfer / warm handoff.</div><button class="btn btn-green" data-req="Live Leads">Request Live Leads</button></div>
          <div class="choice"><h4>Use Your CRM</h4><div class="muted">Give us API/CSV; we‚Äôll sync.</div><button class="btn btn-green" data-req="Use Own CRM">Connect My CRM</button></div>
        </div>

        <div class="choice" style="margin-top:10px">
          <h4>Upload your own leads (CSV)</h4>
          <div class="muted" style="margin-bottom:6px">Columns accepted: <b>address</b>, name, phone, notes</div>
          <input id="csv" type="file" accept=".csv" class="input"/>
          <div class="muted" id="csvMsg" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- DISPO: Posting Console + lists + viewer -->
      <div id="dispoWrap" style="display:none;padding:12px">
        <div style="display:grid;grid-template-columns:1.1fr .9fr;gap:12px">
          <!-- Left Column -->
          <div>
            <!-- Posting Console -->
            <div class="postPanel">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:800">Posting Console</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn btn-green" id="addOffering">‚ûï Offering</button>
                  <button class="btn" id="offeringPhotos">üì∑ Offering Photos</button>
                  <button class="btn btn-green" id="addDeal">‚ûï Deal</button>
                  <button class="btn" id="dealPhotos">üì∑ Deal Photos</button>
                </div>
              </div>
              <div class="postGrid">
                <a class="btn" id="postCraigslist" target="_blank" rel="noopener">üÖí Craigslist</a>
                <a class="btn" id="postFBM" target="_blank" rel="noopener">üì¶ FB Marketplace</a>
                <a class="btn" id="emailBlast" target="_blank" rel="noopener">‚úâÔ∏è Email Blast</a>
                <a class="btn" id="buyersActive" target="_blank" rel="noopener">üóÇÔ∏è Active Buyers</a>
                <a class="btn" id="buyersAll" target="_blank" rel="noopener">üìö All Buyers</a>
                <a class="btn" id="townHall" target="_blank" rel="noopener">üèõÔ∏è Town Hall</a>
              </div>
            </div>

            <!-- Offerings -->
            <div class="sectionBox">
              <h3 style="margin:0 0 8px">Offerings ‚Äî Private Capital</h3>
              <input id="offerSearch" class="input" placeholder="Search instrument, amount, term, jurisdiction, keywords‚Ä¶" style="margin-bottom:8px"/>
              <div id="offerCards" style="display:grid;gap:10px"></div>
            </div>

            <!-- Deals -->
            <div class="sectionBox" style="margin-top:12px">
              <h3 style="margin:0 0 8px">Deals ‚Äî Wholesale & End-Buyer</h3>
              <input id="dealSearch" class="input" placeholder="Search address, price, tags, summary‚Ä¶" style="margin-bottom:8px"/>
              <div id="dealCards" style="display:grid;gap:10px"></div>
            </div>
          </div>

          <!-- Right Column: Viewer -->
          <div class="viewer">
            <h3 class="previewTitle" id="previewTitle">Preview</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <a id="btnOpenFull" class="btn btn-gold" target="_blank" rel="noopener">Open Full</a>
              <button id="btnOpenGallery" class="btn" style="display:none">Open Gallery</button>
              <a id="btnInterest" class="btn" target="_blank" rel="noopener">Submit Interest</a>
            </div>
            <!-- PDF for offerings -->
            <iframe id="sofPreview" title="SOF preview"></iframe>
            <!-- Carousel for deals -->
            <div id="dealPreview" style="display:none">
              <div class="carouselInline" id="dealCarousel">
                <button class="arrow left" id="dcPrev">‚ü®</button>
                <img id="dcHero" alt="deal photo"/>
                <button class="arrow right" id="dcNext">‚ü©</button>
              </div>
              <div class="thumbsInline" id="dcThumbs"></div>
              <div class="muted" id="dealMeta" style="margin-top:6px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS (role-scoped) -->
      <div id="settingsWrap" class="settingsWrap" style="display:none">
        <div class="roleTabs" id="settingsRoleTabs">
          <span class="roleTab active" data-srole="wh">Wholesaler</span>
          <span class="roleTab" data-srole="ct">Contractor</span>
          <span class="roleTab" data-srole="re">Realtor</span>
          <span class="roleTab" data-srole="in">Investor</span>
        </div>

        <!-- Wholesaler settings -->
        <div class="rolePane" data-pane="wh">
          <div class="field">
            <label>ZIP Filters (comma separated)</label>
            <input id="whZips" class="input" placeholder="e.g., 77003, 77004"/>
          </div>
          <div class="field">
            <label>Type Filters</label>
            <div class="chkGrid">
              <label><input type="checkbox" name="whType" value="residential"/> Residential</label>
              <label><input type="checkbox" name="whType" value="commercial"/> Commercial</label>
              <label><input type="checkbox" name="whType" value="land"/> Land</label>
            </div>
          </div>
          <button class="btn btn-green" id="saveWh">üíæ Save Wholesaler Settings</button>
        </div>

        <!-- Contractor settings -->
        <div class="rolePane" data-pane="ct" style="display:none">
          <div class="field">
            <label>Service Divisions (check all that apply)</label>
            <div id="ctDivisions" class="chkGrid"></div>
          </div>
          <div class="field">
            <label>Service Area ZIPs (comma separated)</label>
            <input id="ctZips" class="input" placeholder="e.g., 77003, 77004"/>
          </div>
          <div class="field">
            <label>Notes</label>
            <textarea id="ctNotes" class="textarea" placeholder="Crew size, licenses, preference, insurance‚Ä¶"></textarea>
          </div>
          <button class="btn btn-green" id="saveCt">üíæ Save Contractor Settings</button>
        </div>

        <!-- Realtor settings -->
        <div class="rolePane" data-pane="re" style="display:none">
          <div class="field">
            <label>MLS / Board</label>
            <input id="reMls" class="input" placeholder="e.g., HAR, NTREIS"/>
          </div>
          <div class="field">
            <label>Farm ZIPs</label>
            <input id="reZips" class="input" placeholder="e.g., 77003, 77004"/>
          </div>
          <button class="btn btn-green" id="saveRe">üíæ Save Realtor Settings</button>
        </div>

        <!-- Investor settings -->
        <div class="rolePane" data-pane="in" style="display:none">
          <div class="field">
            <label>Buy Box</label>
            <textarea id="inBuyBox" class="textarea" placeholder="Asset types, price range, markets, yields‚Ä¶"></textarea>
          </div>
          <button class="btn btn-green" id="saveIn">üíæ Save Investor Settings</button>
        </div>
      </div>
    </section>
  </div>

  <footer>
    <div>¬© 2025 DealBankers.com ‚Äî All rights reserved.</div>
    <div>v2.1 ‚ÄúBond Workstation‚Äù</div>
  </footer>

  <div id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script>
    // Firebase (isolated app for this page)
    const app=firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const db=app.database();
    const storage=firebase.storage(app);

    // URL params
    const p=new URL(location.href).searchParams;
    const topRole=(p.get('role')||'wh').toLowerCase(); // wh | ct | re | in | settings
    const sub=(p.get('sub')||'acq').toLowerCase();       // acq | dispo
    const uid=p.get('uid')||'anon';

    // Helpers
    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    function setStatus(t){$('#status').textContent=t}
    function toast(t){const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1600)}
    const slug = s => String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    // ===== Top role tabs =====
    function setRole(role){
      $$('#roleTabsTop .pill').forEach(el=>el.classList.toggle('active', el.dataset.role===role));
      const isWh = role==='wh';
      const isSettings = role==='settings';
      $('#whSubtabs').style.display = isWh? 'flex' : 'none';
      $('#acqBar').style.display     = isWh && subState==='acq'? 'block' : 'none';
      $('#acqWrap').style.display    = isWh && subState==='acq'? 'block' : 'none';
      $('#chooser').style.display    = 'none';
      $('#dispoWrap').style.display  = isWh && subState==='dispo'? 'block' : 'none';
      $('#settingsWrap').style.display = isSettings? 'block' : 'none';
      $('#crumb').textContent = isWh ? ('Wholesaler ‚Ä¢ ' + (subState==='acq'?'Acquisition':'Dispo')) :
                             role==='ct' ? 'Contractor' :
                             role==='re' ? 'Realtor' :
                             role==='in' ? 'Investor' : 'Settings';
      if(isWh){
        if(subState==='acq'){ initAcqGate(); }
        if(subState==='dispo'){ loadDispo(); }
      }
      if(isSettings){ loadSettingsUI(); }
    }

    $$('#roleTabsTop .pill').forEach(el=>{
      el.addEventListener('click', ()=>{ setRole(el.dataset.role); });
    });

    // ===== Wholesaler subtabs =====
    let subState = (sub==='dispo'?'dispo':'acq');
    function setSub(newSub){
      subState=newSub;
      $$('#whSubtabs .sub').forEach(el=>el.classList.toggle('active', el.dataset.sub===newSub));
      setRole('wh');
    }
    $$('#whSubtabs .sub[data-sub]').forEach(el=>el.addEventListener('click',()=>setSub(el.dataset.sub)));

    // ===== Live settings (for ACQ filters) =====
    let settingsFilters={types:[], zips:[], version:0};
    db.ref(`userSettings/${uid}/wholesaler`).on('value', snap=>{
      const v=snap.val()||{};
      settingsFilters.types = Array.isArray(v.types)? v.types.map(s=>String(s).toLowerCase()) : [];
      settingsFilters.zips  = Array.isArray(v.zips)? v.zips.map(String) : [];
      settingsFilters.version = v.settingsVersion||0;
      if(window.leads && window.leads.length){ recomputeFiltersAndRender(); }
    });

    function activeFilters(){
      return {
        types: settingsFilters.types,
        zips: settingsFilters.zips,
        hasType: (settingsFilters.types||[]).length>0,
        hasZips: (settingsFilters.zips||[]).length>0,
        typeSet:new Set(settingsFilters.types||[]),
        zipSet:new Set(settingsFilters.zips||[])
      };
    }

    // ===== Acquisition =====
    let idx=0, current=null; const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);
    const clean=s=>(s||'').toString().trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');

    function phoneHref(number,mode){
      const num=(number||'').replace(/[^\d+]/g,''); if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging';}
      if(mode==='gvoice'){navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages';}
      return `tel:${num}`;
    }
    const extractZip=addr=>{const m=String(addr||'').match(/\b\d{5}\b/); return m?m[0]:'';}
    function classifyLead(lead){
      const bag=[lead?.type,lead?.category,lead?.tags,lead?.notes,lead?.details,lead?.description,lead?.zoning,lead?.use].map(clean).join(' ').toLowerCase();
      const isLand=/\b(vacant|raw|unimproved)\s+(lot|land)\b/.test(bag)||/\blot\b/.test(bag)||/\bacre(s)?\b/.test(bag);
      const isComm=!isLand && (/\b(commercial|retail|industrial|warehouse|office|restaurant|hotel|motel|c[- ]?store|gas|shopping|mall|strip|mixed[- ]use|cap ?rate|triple ?net|nnn|flex|medical office|clinic|self[ -]?storage|automotive|dealership|multifamily(?!\s*residential))\b/.test(bag)||/\bzoned\s*[cbi]\b/.test(bag));
      const isResi=!isLand && /\b(residential|single[- ]family|sfh|house|duplex|triplex|quadplex|apartment|condo|townhome|mobile home|mh)\b/.test(bag);
      if(isComm) return 'commercial'; if(isResi) return 'residential'; if(isLand) return 'land'; return '';
    }

    function computeFiltered(all){
      const {typeSet, zipSet, hasType, hasZips} = activeFilters();
      let arr = all.slice();
      if(hasType){
        arr=arr.filter(l=>{
          const t=classifyLead(l);
          if(t==='') return false;
          if(t==='land') return typeSet.has('land');
          return typeSet.has(t);
        });
      }
      if(hasZips){arr=arr.filter(l=>{const z=extractZip(l?.address||''); return z && zipSet.has(z);});}
      return arr;
    }

    function telemetry(allCount, filteredCount){
      const f=activeFilters();
      $('#telemetry').textContent =
        `Feed loaded: ${allCount} ‚Ä¢ After filter: ${filteredCount}` +
        (f.hasType?` ‚Ä¢ types: ${[...f.typeSet].join(',')}`:'') +
        (f.hasZips?` ‚Ä¢ zips: ${[...f.zipSet].join(',')}`:'') +
        (settingsFilters.version?` ‚Ä¢ settings v${settingsFilters.version}`:'');
    }

    function recomputeFiltersAndRender(){
      if(!Array.isArray(window.leads) || !window.leads.length) return;
      const filtered = computeFiltered(window.leads);
      window.__filteredLeads = filtered;
      setStatus(`Loaded ${filtered.length} lead(s)`);
      telemetry(window.leads.length, filtered.length);
      if(!filtered.length){
        $('#leadCard').innerHTML='<div class="body"><b>No leads match your filters.</b></div>';
        return;
      }
      if(idx>=filtered.length) idx=0;
      renderLead(idx);
    }

    function initAcqGate(){
      setStatus('Checking access‚Ä¶');
      db.ref(`userSettings/${uid}/wholesaler`).once('value').then(s=>{
        const v=s.val()||{}; const allowed=!!v.leadsEnabled;
        if(!allowed){ renderChooser('Access to leads is not enabled yet.'); return; }
        loadLeadsScript(true);
      }).catch(()=>renderChooser('Could not verify access right now.'));
    }

    function renderChooser(reason){
      $('#chooser').style.display='block';
      $('#acqWrap').style.display='none';
      setStatus(reason||'Pick a lead source');
      $('#chooser').addEventListener('click',async e=>{
        const btn=e.target.closest('[data-req]'); if(!btn) return;
        const type=btn.getAttribute('data-req');
        const payload={uid, email:'', name:'', type:`Lead Access: ${type}`, contact:'', subject:'', message:`User requested: ${type}`, status:'new', ts:Date.now()};
        try{await db.ref('requests').push(payload); toast('Request sent'); setStatus('Request sent ‚Äî we‚Äôll enable your feed.');}
        catch{toast('Could not send request');}
      });
      $('#csv').addEventListener('change', handleCSV);
    }

    // Robust /leads.js loader (no stray parens)
    function loadLeadsScript(bust){
      const finish=()=>{
        if(Array.isArray(window.leads) && window.leads.length){
          $('#chooser').style.display='none'; $('#acqWrap').style.display='block';
          initAcq();
        }else{
          // seed a tiny demo so ACQ always works
          window.leads=[{id:'demo-1',address:'123 Demo Ave, Houston, TX 77003',contacts:[{name:'John Seller',phone:'(555) 123-4567'}],notes:'Demo lead',type:'residential'}];
          $('#chooser').style.display='none'; $('#acqWrap').style.display='block';
          initAcq();
          toast('Using demo leads (leads.js not found)');
        }
      };
      const head=document.head;
      const s=document.createElement('script');
      s.src = (bust?('/leads.js?v='+Date.now()):'/leads.js');
      s.onload=finish;
      s.onerror=finish;
      head.appendChild(s);
    }

    function initAcq(){
      if(!Array.isArray(window.leads)||!window.leads.length){
        $('#leadCard').innerHTML='<div class="body"><b>No leads loaded.</b></div>'; return;
      }
      recomputeFiltersAndRender();
    }

    function svSrc(a){return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(a||'')}`;}
    function mapSrc(a){return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(a||'')}`;}

    function renderLead(i){
      const arr=window.__filteredLeads||[];
      if(!arr.length){$('#leadCard').innerHTML='<div class="body">No leads.</div>'; return;}
      if(i<0) i=arr.length-1; if(i>=arr.length) i=0; idx=i; current=arr[idx];

      const name=clean(current?.contacts?.[0]?.name||'Unknown');
      const phone=phoneOf(current);
      const addr=clean(current?.address||'');
      const mode=getMode();

      $('#actCall').href=phoneHref(phone,mode);
      $('#actSMS').href=mode==='device'&&phone?`sms:${phone}`:phoneHref(phone,mode);
      $('#actDirections').href=addr?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`:'#';

      $('#leadCard').innerHTML=`
        <div class="title">${addr||name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>
          <div class="chips">
            <div class="chip">UID: ${(uid||'anon').slice(0,8)}</div>
            <div class="chip">${phone?'Phone on file':'Phone missing'}</div>
            <div class="chip">Dial: ${mode}</div>
            ${activeFilters().hasType?`<div class="chip">Type: ${classifyLead(current)||'n/a'}</div>`:''}
            ${activeFilters().hasZips?`<div class="chip">ZIP: ${addr.match(/\b\d{5}\b/)?.[0]||'n/a'}</div>`:''}
          </div>
          <h3 style="margin:10px 0 6px;font-size:16px">Lead details</h3>
          <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶"></textarea>
          <div style="margin-top:8px"><button id="saveNotes" class="btn btn-gold">üíæ Save Notes</button></div>
          <iframe class="sv" src="${svSrc(addr)}" loading="lazy"></iframe>
          <iframe class="map" src="${mapSrc(addr)}" loading="lazy"></iframe>
        </div>`;

      const key='db_notes_'+(addr||name).toLowerCase().replace(/[^a-z0-9]+/g,'-');
      const ta=$('#noteInput'); ta.value=localStorage.getItem(key)||current?.notes||'';
      $('#saveNotes').onclick=()=>{localStorage.setItem(key,ta.value.trim()); toast('Notes saved');};

      $('#prevLead').onclick=()=>renderLead(idx-1);
      $('#nextLead').onclick=()=>renderLead(idx+1);
      document.onkeydown=(e)=>{ if(e.key==='ArrowLeft') renderLead(idx-1); if(e.key==='ArrowRight') renderLead(idx+1);};

      $('#actCopy').onclick=()=>{ if(!phone) return alert('No phone on this lead.'); navigator.clipboard.writeText(phone).then(()=>toast('Phone copied')); };

      $('#actSettings').onclick=()=>{ const cur=getMode(); const next=cur==='device'?'textnow':cur==='textnow'?'gvoice':'device'; setMode(next); toast(`Dial mode: ${next}`); renderLead(idx); };

      $('#leadPhotos').onclick=()=>openPhotos('lead', current.id || slug(addr));
    }

    // CSV uploader
    function handleCSV(ev){
      const f=ev.target.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        const txt=String(r.result||''); const rows=txt.split(/\r?\n/).filter(Boolean);
        const hdr=(rows.shift()||'').split(',').map(s=>s.trim().toLowerCase());
        const ix=n=>hdr.findIndex(h=>h===n);
        const iAddr=ix('address'), iName=ix('name'), iPhone=ix('phone'), iNotes=ix('notes');
        const arr=rows.map(line=>{
          const cols=line.split(',');
          return {id: slug(cols[iAddr]||('lead-'+Date.now()+Math.random().toString(16).slice(2))),
                  address:cols[iAddr]||'', contacts:[{name:cols[iName]||'', phone:cols[iPhone]||''}], notes:cols[iNotes]||''};
        });
        window.leads = (window.leads||[]).concat(arr);
        $('#csvMsg').textContent=`Loaded ${arr.length} lead(s) from CSV.`;
        $('#chooser').style.display='none'; $('#acqWrap').style.display='block';
        recomputeFiltersAndRender();
      };
      r.readAsText(f);
    }

    // Add Lead
    $('#addLead').onclick=()=>{
      const d = buildLeadForm();
      d.showModal();
    };

    function buildLeadForm(){
      const d=document.createElement('dialog');
      d.innerHTML=`
        <div class="modal-head"><strong>New Lead</strong><button class="btn btn-ghost btn-small" id="x">‚úñ</button></div>
        <div class="modal-body">
          <div style="display:grid;gap:8px">
            <input id="fAddr" class="input" placeholder="Address"/>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <input id="fName" class="input" placeholder="Contact name"/>
              <input id="fPhone" class="input" placeholder="Phone"/>
            </div>
            <select id="fType" class="input">
              <option value="">Type (optional)</option>
              <option>residential</option><option>land</option><option>commercial</option>
            </select>
            <textarea id="fNotes" class="textarea" placeholder="Notes"></textarea>
            <input id="fPhotos" type="file" accept="image/*" multiple capture="environment"/>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-ghost" id="cancel">Cancel</button>
              <button class="btn btn-green" id="save">Save Lead</button>
            </div>
          </div>
          <div class="progressRow" id="upProgress" style="display:none"></div>
        </div>`;
      document.body.appendChild(d);
      d.querySelector('#x').onclick=()=>d.close();
      d.querySelector('#cancel').onclick=()=>d.close();
      d.addEventListener('close', ()=>d.remove());
      d.querySelector('#save').onclick=async ()=>{
        const address=d.querySelector('#fAddr').value.trim();
        if(!address){ alert('Address required'); return; }
        const leadId = slug(address) || ('lead-'+Date.now());
        const lead = {
          id:leadId, address,
          contacts:[{name:d.querySelector('#fName').value.trim(), phone:d.querySelector('#fPhone').value.trim()}],
          type:d.querySelector('#fType').value.trim(), notes:d.querySelector('#fNotes').value.trim(),
          createdAt:Date.now(), createdBy:uid, status:'acq'
        };
        try{
          await db.ref(`leads/${uid}/${leadId}`).set(lead);
          window.leads = (window.leads||[]); window.leads.unshift(lead);
          recomputeFiltersAndRender();
          const files = d.querySelector('#fPhotos').files;
          if(files && files.length) await uploadFilesWithBar(files, 'lead', leadId, d.querySelector('#upProgress'));
          toast('Lead added'); d.close();
        }catch(e){ console.error(e); alert('Could not save lead'); }
      };
      return d;
    }

    // -------------------- Photos (Storage + Carousel) --------------------
    async function uploadFilesWithBar(fileList, context, entityId, progressEl){
      progressEl.style.display='grid'; progressEl.innerHTML='';
      const tasks=[...fileList].map(async (file, ix)=>{
        const compressed = await compressImage(file, 1600);
        const key = Date.now()+'-'+ix+'-'+Math.random().toString(16).slice(2);
        const path = `photos/${uid}/${context}/${entityId}/${key}`;
        const ref = storage.ref().child(path);
        const row=document.createElement('div'); row.className='progressItem';
        row.innerHTML=`${file.name}<div class="bar"><i style="width:0%"></i></div>`;
        progressEl.appendChild(row);
        await ref.put(compressed);
        const url = await ref.getDownloadURL();
        const meta = {url, storagePath:path, bytes:compressed.size, createdAt:Date.now(), order:ix};
        await db.ref(`photosIndex/${uid}/${context}/${entityId}/${key}`).set(meta);
        row.querySelector('i').style.width='100%';
      });
      await Promise.all(tasks);
    }

    function compressImage(file, maxSide){
      return new Promise((resolve)=>{
        if(!/^image\//.test(file.type)) return resolve(file);
        const img=new Image();
        img.onload=()=>{
          const c=document.createElement('canvas'); const ctx=c.getContext('2d');
          let w=img.width, h=img.height; const scale = Math.min(1, maxSide/Math.max(w,h));
          c.width=w*scale; c.height=h*scale; ctx.drawImage(img,0,0,c.width,c.height);
          c.toBlob(b=>b?resolve(new File([b], file.name, {type:'image/jpeg'})):resolve(file),'image/jpeg',0.85);
        };
        img.onerror=()=>resolve(file);
        const fr=new FileReader(); fr.onload=()=>{ img.src=fr.result; }; fr.readAsDataURL(file);
      });
    }

    async function openPhotos(context, entityId){
      const d=document.createElement('dialog');
      d.innerHTML=`
        <div class="modal-head"><strong>Photos</strong><button class="btn btn-ghost btn-small" id="x">‚úñ</button></div>
        <div class="modal-body">
          <div class="carousel" id="car"></div>
          <div class="thumbs" id="thumbs"></div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="up" type="file" accept="image/*" multiple capture="environment"/>
            <button class="btn" id="refresh">‚Üª Refresh</button>
          </div>
          <div class="progressRow" id="bar" style="display:none"></div>
        </div>`;
      document.body.appendChild(d);
      const car=d.querySelector('#car'), thumbs=d.querySelector('#thumbs'), bar=d.querySelector('#bar');
      let list=[];
      const setActive=i=>{
        if(!list.length) { car.innerHTML='<div style="opacity:.7;padding:12px">No photos yet</div>'; return;}
        i=(i+list.length)%list.length; car.innerHTML=`<img src="${list[i].url}" alt="photo ${i+1}"/>`;
      };
      async function load(){
        const snap = await db.ref(`photosIndex/${uid}/${context}/${entityId}`).get();
        const obj = snap.val()||{}; list=Object.values(obj).sort((a,b)=>(a.order||0)-(b.order||0));
        thumbs.innerHTML=list.map((m,i)=>`<img data-i="${i}" src="${m.url}"/>`).join('');
        thumbs.onclick=e=>{ const t=e.target.closest('img'); if(!t) return; setActive(+t.dataset.i); };
        setActive(0);
      }
      await load();
      d.querySelector('#x').onclick=()=>d.close();
      d.addEventListener('close', ()=>d.remove());
      d.querySelector('#refresh').onclick=load;
      d.querySelector('#up').onchange=async (ev)=>{
        const files=ev.target.files; if(!files||!files.length) return;
        await uploadFilesWithBar(files, context, entityId, bar);
        await load();
      };
      d.showModal();
    }

    // Reload + Reset buttons
    $('#reloadLeads').onclick=()=>{ window.leads=[]; window.__filteredLeads=[]; loadLeadsScript(true); toast('Reloading leads‚Ä¶'); };
    $('#resetFilters').onclick=()=>{ settingsFilters.types=[]; settingsFilters.zips=[]; recomputeFiltersAndRender(); toast('Filters reset'); };

    // ===== DISPO: Offerings (PDF) + Deals (Carousel) =====
    function memoUrl(page, sof){
      const p = page || 'offering-memo2.html';
      return p + (sof ? ('?sof=' + encodeURIComponent(sof)) : '');
    }

    let currentOffer=null, currentDeal=null, dealPhotosCache={};

    function setPreviewOffering(offer){
      $('#dealPreview').style.display='none';
      $('#sofPreview').style.display='block';
      const url = offer.sof || offer.sofUrl || 'https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview';
      $('#sofPreview').src = url;
      $('#previewTitle').textContent = offer.title ? `Viewing: ${offer.title}` : 'Statement of Facts';
      $('#btnOpenFull').style.display='inline-flex';
      $('#btnOpenFull').href=memoUrl(offer.page, offer.sof);
      $('#btnOpenGallery').style.display='none';
      $('#btnInterest').href=memoUrl(offer.page, offer.sof)+'#interest';
      currentOffer = offer; currentDeal=null;
    }

    async function setPreviewDeal(deal){
      $('#sofPreview').style.display='none';
      $('#dealPreview').style.display='block';
      $('#previewTitle').textContent = deal.title ? `Viewing: ${deal.title}` : 'Deal Photos';
      $('#btnOpenFull').style.display='none';
      $('#btnOpenGallery').style.display='inline-flex';
      $('#btnOpenGallery').onclick=()=>openPhotos('deal', deal.id);
      $('#dealMeta').textContent = [deal.location, deal.price?`Price: ${deal.price}`:'', deal.terms?`Terms: ${deal.terms}`:''].filter(Boolean).join(' ‚Ä¢ ');

      const list = await getDealPhotos(deal.id);
      renderDealCarousel(list);
      currentDeal = deal; currentOffer=null;
    }

    async function getDealPhotos(id){
      if(dealPhotosCache[id]) return dealPhotosCache[id];
      const snap = await db.ref(`photosIndex/${uid}/deal/${id}`).get();
      const obj = snap.val()||{};
      const list = Object.values(obj).sort((a,b)=>(a.order||0)-(b.order||0));
      dealPhotosCache[id]=list; return list;
    }

    function renderDealCarousel(list){
      const hero=$('#dcHero'), thumbs=$('#dcThumbs');
      let i=0; if(!list.length){ hero.removeAttribute('src'); hero.alt='No photos yet'; thumbs.innerHTML=''; return; }
      function paint(){
        hero.src=list[i].url; hero.alt=`Photo ${i+1}`;
        thumbs.innerHTML=list.map((m,ix)=>`<img ${ix===i?'class="active"':''} data-i="${ix}" src="${m.url}"/>`).join('');
      }
      paint();
      $('#dcPrev').onclick=()=>{ i=(i-1+list.length)%list.length; paint(); };
      $('#dcNext').onclick=()=>{ i=(i+1)%list.length; paint(); };
      thumbs.onclick=e=>{ const t=e.target.closest('img'); if(!t) return; i=+t.dataset.i; paint(); };
    }

    async function loadDispo(){
      setStatus('Loading dispo‚Ä¶');
      // ---- Offerings
      const [gSnap, uSnap] = await Promise.all([
        db.ref('offerings/global').get().catch(()=>({val:()=>null})),
        db.ref(`offerings/${uid}`).get().catch(()=>({val:()=>null}))
      ]);
      const toArr = o => o ? Object.values(o) : [];
      let offerings = [...toArr(gSnap.val()), ...toArr(uSnap.val())];

      if(!offerings.length){
        offerings = [
          { id:'booth', title:'Booth St. ‚Äî Offering Memorandum',
            page:'offering-memo1.html',
            sof:'https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview',
            badges:['Instrument: Note','Amt: $30k','Term: 3‚Äì6 mo','Juris: TX'],
            icon:'üè†'},
          { id:'d6', title:'Virgin D6 Lift ‚Äî FOB Houston',
            page:'offering-memo2.html',
            sof:'https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview',
            badges:['Instrument: Inventory Prepay','Amt: $300k','Term: 7‚Äì10 days','Juris: TX'],
            icon:'üõ¢Ô∏è'}
        ];
      }

      const offerWrap = $('#offerCards'); offerWrap.innerHTML='';
      offerings.forEach((o,i)=>{
        o.id = o.id || slug(o.title||('off-'+i));
        const card = document.createElement('div'); card.className='offerCard';
        card.innerHTML = `
          <div style="font-size:24px">${o.icon||'üìÑ'}</div>
          <div style="flex:1">
            <div style="font-weight:900;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span>${o.title||'Untitled Offering'}</span>
              ${(o.badges||[]).slice(0,4).map(b=>`<span class="badge">${b}</span>`).join('')}
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a class="btn" target="_blank" rel="noopener" href="${memoUrl(o.page,o.sof)}">Open</a>
            <a class="btn" target="_blank" rel="noopener" href="${memoUrl(o.page,o.sof)}#interest">Interest</a>
          </div>`;
        card.addEventListener('click', ()=>setPreviewOffering(o));
        offerWrap.appendChild(card);
        if(i===0) setPreviewOffering(o);
      });

      // ---- Deals
      const [gdSnap, udSnap] = await Promise.all([
        db.ref('deals/global').get().catch(()=>({val:()=>null})),
        db.ref(`deals/${uid}`).get().catch(()=>({val:()=>null}))
      ]);
      let deals = [...toArr(gdSnap.val()), ...toArr(udSnap.val())];

      if(!deals.length){
        deals = [
          { id:'booth-wholesale', title:'Booth St. ‚Äî Wholesale', location:'Booth St, TX', price:'$145,000', terms:'Assignment', tags:['SFH','Light rehab'] },
          { id:'st-luis-seller-finance', title:'St. Luis ‚Äî Seller Finance', location:'St. Luis, TX', price:'$210,000', terms:'10% down, 7.5% APR', tags:['Seller Finance','Turnkey'] }
        ];
      }

      const dealWrap = $('#dealCards'); dealWrap.innerHTML='';
      deals.forEach((d,i)=>{
        d.id=d.id||slug(d.title||('deal-'+i));
        const card=document.createElement('div'); card.className='dealCard';
        card.innerHTML=`
          <div style="font-size:24px">üßæ</div>
          <div style="flex:1">
            <div style="font-weight:900">${d.title||'Untitled Deal'}</div>
            <div class="muted" style="margin-top:4px">${[d.location, d.price?`Price: ${d.price}`:'', d.terms?`Terms: ${d.terms}`:''].filter(Boolean).join(' ‚Ä¢ ')}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
              ${(d.tags||[]).slice(0,4).map(t=>`<span class="badge">${t}</span>`).join('')}
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-ghost btn-small" data-edit="${d.id}">‚úèÔ∏è Edit</button>
            <button class="btn btn-ghost btn-small" data-photos="${d.id}">üì∑</button>
          </div>`;
        card.addEventListener('click', (e)=>{ if(e.target.closest('button')) return; setPreviewDeal(d); });
        dealWrap.appendChild(card);
      });

      dealWrap.addEventListener('click',e=>{
        const edit=e.target.closest('[data-edit]'); const photos=e.target.closest('[data-photos]');
        if(edit){ openDealForm(deals.find(x=>x.id===edit.dataset.edit)); }
        if(photos){ openPhotos('deal', photos.dataset.photos); }
      });

      // search
      $('#offerSearch').oninput=e=>{
        const q=(e.target.value||'').toLowerCase();
        [...offerWrap.children].forEach(c=>{ c.style.display=(c.textContent.toLowerCase().includes(q)?'flex':'none'); });
      };
      $('#dealSearch').oninput=e=>{
        const q=(e.target.value||'').toLowerCase();
        [...dealWrap.children].forEach(c=>{ c.style.display=(c.textContent.toLowerCase().includes(q)?'flex':'none'); });
      };

      // quick actions
      $('#offeringPhotos').onclick=()=>{ if(!currentOffer){ toast('Select an offering first'); return; } openPhotos('offering', currentOffer.id||slug(currentOffer.title)); };
      $('#dealPhotos').onclick=()=>{ if(!currentDeal){ toast('Select a deal first'); return; } openPhotos('deal', currentDeal.id); };

      setStatus('Dispo ready');
    }

    // Add Offering
    $('#addOffering').onclick=()=>{
      const d=document.createElement('dialog');
      d.innerHTML=`
        <div class="modal-head"><strong>New Offering</strong><button class="btn btn-ghost btn-small" id="x">‚úñ</button></div>
        <div class="modal-body">
          <div style="display:grid;gap:8px">
            <input id="t" class="input" placeholder="Title (e.g., Booth St. ‚Äî Offering Memorandum)"/>
            <input id="sof" class="input" placeholder="SOF preview URL (Google Drive, etc.)"/>
            <textarea id="notes" class="textarea" placeholder="Notes / Terms (optional)"></textarea>
            <input id="photos" type="file" accept="image/*" multiple capture="environment"/>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-ghost" id="cancel">Cancel</button>
              <button class="btn btn-green" id="save">Save Offering</button>
            </div>
          </div>
          <div class="progressRow" id="bar" style="display:none"></div>
        </div>`;
      document.body.appendChild(d);
      d.querySelector('#x').onclick=()=>d.close();
      d.querySelector('#cancel').onclick=()=>d.close();
      d.addEventListener('close', ()=>d.remove());
      d.querySelector('#save').onclick=async ()=>{
        const title=d.querySelector('#t').value.trim(); if(!title){ alert('Title required'); return; }
        const id=slug(title); const sof=d.querySelector('#sof').value.trim();
        const off={id,title,sof,icon:'üìÑ',badges:[],createdAt:Date.now(),createdBy:uid,status:'active'};
        try{
          await db.ref(`offerings/${uid}/${id}`).set(off);
          const files=d.querySelector('#photos').files;
          if(files && files.length) await uploadFilesWithBar(files,'offering',id,d.querySelector('#bar'));
          toast('Offering added'); d.close(); loadDispo();
        }catch(e){ console.error(e); alert('Could not save offering'); }
      };
      d.showModal();
    };

    // Add/Edit Deal
    function openDealForm(existing){
      const d=document.createElement('dialog');
      const isEdit=!!existing;
      d.innerHTML=`
        <div class="modal-head"><strong>${isEdit?'Edit Deal':'New Deal'}</strong><button class="btn btn-ghost btn-small" id="x">‚úñ</button></div>
        <div class="modal-body">
          <div style="display:grid;gap:8px">
            <input id="t" class="input" placeholder="Title" value="${existing?.title||''}"/>
            <input id="loc" class="input" placeholder="Location (City, ST)" value="${existing?.location||''}"/>
            <input id="price" class="input" placeholder="Price (e.g., $145,000)" value="${existing?.price||''}"/>
            <input id="terms" class="input" placeholder="Terms (e.g., Assignment / 10% down...)" value="${existing?.terms||''}"/>
            <input id="tags" class="input" placeholder="Tags (comma separated)" value="${(existing?.tags||[]).join(', ')}"/>
            <textarea id="notes" class="textarea" placeholder="Short description (optional)">${existing?.notes||''}</textarea>
            <input id="photos" type="file" accept="image/*" multiple capture="environment"/>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-ghost" id="cancel">Cancel</button>
              <button class="btn btn-green" id="save">${isEdit?'Save Changes':'Save Deal'}</button>
            </div>
          </div>
          <div class="progressRow" id="bar" style="display:none"></div>
        </div>`;
      document.body.appendChild(d);
      d.querySelector('#x').onclick=()=>d.close();
      d.querySelector('#cancel').onclick=()=>d.close();
      d.addEventListener('close', ()=>d.remove());
      d.querySelector('#save').onclick=async ()=>{
        const title=d.querySelector('#t').value.trim(); if(!title){ alert('Title required'); return; }
        const id=isEdit?(existing.id):(slug(title)||('deal-'+Date.now()));
        const v={
          id,title,
          location:d.querySelector('#loc').value.trim(),
          price:d.querySelector('#price').value.trim(),
          terms:d.querySelector('#terms').value.trim(),
          tags:(d.querySelector('#tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
          notes:d.querySelector('#notes').value.trim(),
          updatedAt:Date.now(), createdBy:uid, status:'active'
        };
        if(!isEdit) v.createdAt=Date.now();
        try{
          await db.ref(`deals/${uid}/${id}`).set(v);
          const files=d.querySelector('#photos').files;
          if(files && files.length) await uploadFilesWithBar(files,'deal',id,d.querySelector('#bar'));
          dealPhotosCache[id]=null;
          toast(isEdit?'Deal updated':'Deal added'); d.close(); loadDispo();
        }catch(e){ console.error(e); alert('Could not save deal'); }
      };
      d.showModal();
    }
    $('#addDeal').onclick=()=>openDealForm();

    // Posting console links
    const setHref=(id,url)=>{ const el=$(id); if(el) el.href=url; };
    setHref('#postCraigslist','https://accounts.craigslist.org/login');
    setHref('#postFBM','https://www.facebook.com/marketplace/create/item');
    setHref('#emailBlast','mailto:?subject=DealBankers%20Offering&body=Reply%20to%20be%20added%20to%20buyers%20list');
    setHref('#buyersActive','#buyers-active');
    setHref('#buyersAll','#buyers-all');
    setHref('#townHall','chat.html?tab=townhall');

    // ===== Export/Seed buttons =====
    $('#exportLeads').onclick=()=>{
      const arr = window.__filteredLeads||window.leads||[];
      if(!arr.length){ toast('No leads to export'); return; }
      const hdr=['address','name','phone','notes'];
      const rows = [hdr.join(',')].concat(arr.map(l=>{
        const name = l?.contacts?.[0]?.name||'';
        const phone = l?.contacts?.[0]?.phone||'';
        return [`"${(l.address||'').replace(/"/g,'""')}"`,
                `"${(name).replace(/"/g,'""')}"`,
                `"${(phone).replace(/"/g,'""')}"`,
                `"${(l.notes||'').replace(/"/g,'""')}"`].join(',');
      }));
      const blob = new Blob([rows.join('\n')],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='leads_export.csv'; a.click();
      URL.revokeObjectURL(a.href);
    };

    $('#seedLeads').onclick=()=>{
      window.leads = [
        {id:'demo-1',address:'123 Demo Ave, Houston, TX 77003',contacts:[{name:'John Seller',phone:'(555) 123-4567'}],notes:'Vacant. Neighbor says owner moved.',type:'residential'},
        {id:'demo-2',address:'55 Rail Yard, Houston, TX 77004',contacts:[{name:'ACME LLC',phone:'(555) 555-2222'}],notes:'Warehouse ‚Äî commercial',type:'commercial'},
        {id:'demo-3',address:'0 County Rd, TX 78901',contacts:[{name:'Ranch Co',phone:'(555) 222-9999'}],notes:'5 acres raw land',type:'land'}
      ];
      $('#chooser').style.display='none'; $('#acqWrap').style.display='block';
      recomputeFiltersAndRender();
      toast('Sample leads loaded');
    };

    // ===== Settings UI =====
    function loadSettingsUI(){
      // Toggle panes
      $$('#settingsRoleTabs .roleTab').forEach(el=>{
        el.onclick=()=>{
          $$('#settingsRoleTabs .roleTab').forEach(x=>x.classList.toggle('active', x===el));
          const role=el.dataset.srole;
          $$('.rolePane').forEach(pane=>pane.style.display=(pane.dataset.pane===role?'block':'none'));
        };
      });

      // Fill Wholesaler
      $('#whZips').value = (settingsFilters.zips||[]).join(', ');
      $$('#settingsWrap input[name="whType"]').forEach(cb=>{
        cb.checked = settingsFilters.types.includes(cb.value);
      });
      $('#saveWh').onclick=async ()=>{
        const z=($('#whZips').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const t=$$('#settingsWrap input[name="whType"]').filter(cb=>cb.checked).map(cb=>cb.value);
        const payload={zips:z, types:t, settingsVersion:(settingsFilters.version||0)+1, leadsEnabled:true};
        await db.ref(`userSettings/${uid}/wholesaler`).set(payload);
        toast('Wholesaler settings saved');
      };

      // Build Contractor 16 divisions
      const DIVS=[
        'Demolition','Sitework / Grading','Concrete / Foundation','Masonry',
        'Framing / Carpentry','Roofing','Siding / Exterior','Windows & Doors',
        'Plumbing','Electrical','HVAC','Insulation',
        'Drywall & Texture','Painting','Flooring / Tile','Finish Trim & Cabinets'
      ];
      const ctDivWrap=$('#ctDivisions');
      ctDivWrap.innerHTML = DIVS.map((d,i)=>`<label><input type="checkbox" name="ctDiv" value="${d}"/> ${d}</label>`).join('');
      // load contractor values
      db.ref(`userSettings/${uid}/contractor`).once('value').then(s=>{
        const v=s.val()||{};
        const selected = v.divisions||{};
        $$('#ctDivisions input[name="ctDiv"]').forEach(cb=>{ cb.checked=!!selected[cb.value]; });
        $('#ctZips').value=(v.zips||[]).join(', ');
        $('#ctNotes').value=v.notes||'';
      });
      $('#saveCt').onclick=async ()=>{
        const divs={}; $$('#ctDivisions input[name="ctDiv"]').forEach(cb=>{ if(cb.checked) divs[cb.value]=true; });
        const payload={divisions:divs, zips:($('#ctZips').value||'').split(',').map(s=>s.trim()).filter(Boolean), notes:$('#ctNotes').value||''};
        await db.ref(`userSettings/${uid}/contractor`).set(payload);
        toast('Contractor settings saved');
      };

      // Realtor
      db.ref(`userSettings/${uid}/realtor`).once('value').then(s=>{
        const v=s.val()||{};
        $('#reMls').value=v.mls||'';
        $('#reZips').value=(v.zips||[]).join(', ');
      });
      $('#saveRe').onclick=async ()=>{
        const payload={mls:$('#reMls').value||'', zips:($('#reZips').value||'').split(',').map(s=>s.trim()).filter(Boolean)};
        await db.ref(`userSettings/${uid}/realtor`).set(payload);
        toast('Realtor settings saved');
      };

      // Investor
      db.ref(`userSettings/${uid}/investor`).once('value').then(s=>{
        const v=s.val()||{}; $('#inBuyBox').value=v.buyBox||'';
      });
      $('#saveIn').onclick=async ()=>{
        await db.ref(`userSettings/${uid}/investor`).set({buyBox:$('#inBuyBox').value||''});
        toast('Investor settings saved');
      };
    }

    // ===== Initialize =====
    setSub(subState);      // paints subtabs
    setRole(topRole==='settings'?'settings':topRole); // paints role view
  </script>
</body>
</html>
