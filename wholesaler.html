<!-- ======================= wholesaler.html (Acq + Dispo subtabs, filters, desktop-friendly buttons) ======================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler ‚Ä¢ Portal</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

  <style>
    :root{
      --bg1:#f6f9fc; --bg2:#eef3f8;
      --ink:#0f1720; --muted:#5b6b7c; --line:#dbe4ee;
      --accent:#0d6efd; --accent-2:#0a58ca; --gold:#c89b3a; --green:#1a9b61;
      --card:#ffffff; --soft:#f2f6fb; --shadow:0 16px 40px rgba(0,0,0,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:14px;
    }

    .wrap{max-width:1100px; margin:0 auto}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px; box-shadow:var(--shadow); overflow:hidden;
    }

    /* Top bar */
    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px; border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#ffffff,#fafcff);
    }
    .crumbs{display:flex; gap:10px; align-items:center; color:var(--muted); font-weight:700}
    .crumbs .dot{width:7px;height:7px;border-radius:999px;background:var(--accent); box-shadow:0 0 12px rgba(13,110,253,.65)}
    .status{font-size:12px; color:var(--muted)}

    /* Sub tabs */
    .subtabs{display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid var(--line); background:#fff}
    .subtab{padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#fff; color:#1a2a3a; cursor:pointer; font-weight:700}
    .subtab.active{background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; border:none}

    /* Filter bar (Acq) */
    .filterbar{display:grid; gap:10px; padding:12px; background:var(--soft); border-bottom:1px solid var(--line)}
    .filtergrid{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px}
    .filtergroup{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px}
    .label{font-size:12px; color:var(--muted); margin-bottom:6px}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{padding:7px 10px; border-radius:999px; background:#f4f7fb; border:1px solid var(--line); cursor:pointer; font-size:13px}
    .chip.active{background:#e8f1ff; border-color:#cfe0ff; color:#0a58ca; font-weight:700}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .input{flex:1; min-width:160px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    .btn{padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:800}
    .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; border:none}
    .btn-soft{background:#fff}
    .help{font-size:12px; color:var(--muted)}

    /* Actions (Acq) */
    .sticky{position:sticky; top:0; z-index:5; border-bottom:1px solid var(--line); background:#fff}
    .actions{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; padding:12px; background:#fff}
    .action-btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; min-height:44px;
      padding:10px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:800;
      color:#0f2233; text-decoration:none; text-align:center;
    }
    .action-gold{background:linear-gradient(180deg,#ffd36b,var(--gold)); color:#211a05; border:none}
    .action-green{background:linear-gradient(180deg,#26cf84,var(--green)); color:#fff; border:none}

    /* Desktop = text labels. Mobile = icons only */
    .ico{font-size:18px}
    .label-text{display:inline}
    .icon-only{display:none}
    @media (max-width:560px){
      .label-text{display:none}
      .icon-only{display:inline}
      .filtergrid{grid-template-columns:1fr}
      .actions{grid-template-columns:repeat(3,1fr)}
    }

    /* Lead card */
    .lead-wrap{padding:12px}
    .lead{
      border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#fff;
    }
    .title{padding:12px 14px; font-weight:900; letter-spacing:.02em; font-size:18px; border-bottom:1px solid var(--line);
      background:linear-gradient(90deg,#fff6d8,transparent 45%),linear-gradient(180deg,#fff, #f9fbff)}
    .body{padding:12px 14px}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
    .pill{font-size:12px; font-weight:700; padding:7px 11px; border-radius:999px; background:#f4f7fb; border:1px solid var(--line)}

    .sv,.map{width:100%; border:0; border-radius:14px; background:#fff}
    .sv{height:260px; margin-top:6px}
    .map{height:220px; margin-top:8px}

    .notesBox{display:grid; gap:8px; margin:10px 0}
    .textarea{width:100%; min-height:120px; resize:vertical; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff}

    /* Dispo frame */
    .dispo-wrap{padding:12px; background:#fff}
    .frame{border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#fff; height:78vh; min-height:560px}
    .frame iframe{width:100%; height:100%; border:0}

    #toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:16px;
      background:#0b1218; color:#fff; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,.2); box-shadow:0 12px 28px rgba(0,0,0,.25);
      font-size:14px; display:none; z-index:70
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <!-- Top bar -->
      <div class="top">
        <div class="crumbs"><span>Wholesaler</span><span class="dot"></span><span>Portal</span></div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- Sub tabs -->
      <div class="subtabs" id="subtabs">
        <button class="subtab active" data-sub="acq">Acquisition</button>
        <button class="subtab" data-sub="dispo">Dispo</button>
      </div>

      <!-- ACQUISITION: Filter bar + actions + lead viewer -->
      <div id="acqPanel">
        <!-- Filter bar -->
        <div class="filterbar">
          <div class="filtergrid">
            <div class="filtergroup" id="fg-asset">
              <div class="label">Asset Type</div>
              <div class="chips">
                <button class="chip active" data-asset="any">Any</button>
                <button class="chip" data-asset="residential">Residential</button>
                <button class="chip" data-asset="commercial">Commercial</button>
              </div>
            </div>

            <div class="filtergroup">
              <div class="label">ZIP include (comma-sep)</div>
              <div class="row">
                <input id="zipInclude" class="input" placeholder="e.g. 90001, 90002"/>
              </div>
            </div>

            <div class="filtergroup">
              <div class="label">ZIP exclude (comma-sep)</div>
              <div class="row">
                <input id="zipExclude" class="input" placeholder="e.g. 90003, 90004"/>
              </div>
            </div>

            <div class="filtergroup">
              <div class="label">Lead Source</div>
              <div class="chips">
                <button class="chip active" data-src="street">Street</button>
                <button class="chip active" data-src="web">Web</button>
                <button class="chip active" data-src="live">Live</button>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="filtergroup" style="flex:1">
              <div class="label">Role</div>
              <div class="chips">
                <button class="chip active" data-role="acqmgr">Acquisition Manager</button>
                <button class="chip" data-role="processor">Lead Processor</button>
              </div>
            </div>

            <div class="row" style="align-items:end">
              <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
              <button id="clearFilters" class="btn btn-soft">Clear</button>
              <a class="btn btn-soft" target="_blank" rel="noopener"
                 href="https://www.google.com/maps/d/u/0/viewer?mid=1C_OfzvCIlHnx-6nLaZ3Y88izZtflM5g&hl=en&ll=0,0&z=3">
                 All Leads & Lead Map
              </a>
            </div>
          </div>
          <div class="help">TIP: If a lead doesn‚Äôt include a ZIP, we‚Äôll try to extract it from the address.</div>
        </div>

        <!-- Desktop-friendly action buttons -->
        <div class="sticky">
          <div class="actions">
            <a class="action-btn action-gold" href="#" id="actCall"><span class="icon-only">üìû</span><span class="label-text">Call</span></a>
            <a class="action-btn action-gold" href="#" id="actSMS"><span class="icon-only">üí¨</span><span class="label-text">Text</span></a>
            <button class="action-btn" id="actCopy"><span class="icon-only">üìã</span><span class="label-text">Copy #</span></button>
            <a class="action-btn" href="https://drive.google.com" target="_blank" rel="noopener"><span class="icon-only">üìÅ</span><span class="label-text">Drive</span></a>
            <button class="action-btn" id="actSettings"><span class="icon-only">‚öôÔ∏è</span><span class="label-text">Dial Settings</span></button>
          </div>
        </div>

        <!-- Lead viewer -->
        <div class="lead-wrap">
          <div id="leadCard" class="lead">
            <div class="body">Initializing‚Ä¶</div>
          </div>
          <div class="row" style="padding:12px 0">
            <button class="btn" id="btnPrev">‚óÄ Previous</button>
            <button class="btn" id="btnRandom">üé≤ Random</button>
            <button class="btn btn-primary" id="btnNext">Next ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- DISPO: simple full-frame embed -->
      <div id="dispoPanel" style="display:none">
        <div class="dispo-wrap">
          <div class="row" style="padding:0 0 8px 0">
            <a id="openDispoTab" class="btn btn-soft" target="_blank" rel="noopener">Open Dispo in New Tab</a>
          </div>
          <div class="frame">
            <iframe id="dispoFrame" src="about:blank" title="Dispositions"></iframe>
          </div>
        </div>
      </div>

    </section>
  </div>

  <!-- Settings dialog -->
  <dialog id="settingsDlg" style="border:none;border-radius:16px;background:#fff;color:#0f2233;padding:14px;max-width:520px;width:92%">
    <h3 style="margin:0 0 8px">Phone Link Preference</h3>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMode" class="btn" style="flex:1">Save</button>
      <button id="closeMode" class="btn" style="flex:1">Close</button>
    </div>
  </dialog>

  <div id="toast"></div>

  <!-- Firebase (gate before loading leads.js) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    // Dedicated app instance for this page (avoid clashes if embedded)
    const gateApp = firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const gateDb = gateApp.database();

    const params = new URL(location.href).searchParams;
    const uidParam = params.get('uid') || 'anon';

    // Check gate before loading leads.js
    gateDb.ref(`userSettings/${uidParam}/wholesaler/leadsEnabled`).once('value').then(snap=>{
      const allowed = !!snap.val();
      if(!allowed){
        document.getElementById('leadCard').innerHTML =
          '<div class="body">Access to leads is disabled for this account.</div>';
        document.getElementById('status').textContent = 'Access denied';
      }else{
        const s=document.createElement('script');
        s.src='/leads.js?v='+Date.now();
        s.onload=()=>{ window.leads = window.leads || []; init(); };
        s.onerror=()=>document.getElementById('status').textContent='Could not load /leads.js';
        document.head.appendChild(s);
      }
    }).catch(()=>{
      document.getElementById('leadCard').innerHTML =
        '<div class="body">Could not verify access right now. Try again shortly.</div>';
      document.getElementById('status').textContent = 'Gate check failed';
    });
  </script>

  <script>
    const $=s=>document.querySelector(s);
    const statusEl=$('#status'); const toastEl=$('#toast'); const dlg=$('#settingsDlg');

    /* ---------- Subtabs ---------- */
    const subtabs = document.getElementById('subtabs');
    const acqPanel = document.getElementById('acqPanel');
    const dispoPanel = document.getElementById('dispoPanel');
    const dispoFrame = document.getElementById('dispoFrame');
    const openDispoTab = document.getElementById('openDispoTab');

    function showSub(name){
      [...subtabs.querySelectorAll('.subtab')].forEach(b=>b.classList.toggle('active', b.dataset.sub===name));
      acqPanel.style.display = (name==='acq') ? '' : 'none';
      dispoPanel.style.display = (name==='dispo') ? '' : 'none';
      if(name==='dispo' && !dispoFrame.src) {
        const uid = encodeURIComponent(new URL(location.href).searchParams.get('uid')||'anon');
        const url = `dispo.html?uid=${uid}`;
        dispoFrame.src = url; openDispoTab.href = url;
      }
      const u = new URL(location.href); u.searchParams.set('wh', name); history.replaceState(null,'',u);
    }
    subtabs.addEventListener('click', (e)=>{
      const b = e.target.closest('.subtab'); if(!b) return;
      showSub(b.dataset.sub);
    });

    /* ---------- Filters ---------- */
    const filterState = {
      asset: 'any',
      zipsInclude: new Set(),
      zipsExclude: new Set(),
      sources: new Set(['street','web','live']),
      role: 'acqmgr'
    };

    function parseZips(val){
      return new Set((val||'').split(',').map(s=>s.trim()).filter(Boolean));
    }
    function zipFromAddress(addr){
      const m = (addr||'').match(/\b(\d{5})(?:-\d{4})?\b/);
      return m ? m[1] : '';
    }
    function leadZip(lead){
      return lead?.zip || zipFromAddress(lead?.address||'');
    }
    function leadAssetType(lead){
      const t = (lead?.assetType || '').toString().toLowerCase();
      if(t) return t; // 'residential' or 'commercial' if provided
      // Heuristic by keywords (fallback)
      const blob = `${lead?.notes||''} ${lead?.address||''}`.toLowerCase();
      if(/suite|unit|retail|office|warehouse|industrial|commercial|shop/.test(blob)) return 'commercial';
      return 'residential';
    }
    function leadSource(lead){
      return (lead?.source || 'street').toString().toLowerCase(); // default 'street'
    }

    function applyFilterArray(arr){
      return arr.filter(ld=>{
        // Source filter
        if(filterState.sources.size && !filterState.sources.has(leadSource(ld))) return false;

        // Asset filter
        if(filterState.asset !== 'any'){
          if(leadAssetType(ld) !== filterState.asset) return false;
        }

        // Zip filters
        const z = leadZip(ld);
        if(filterState.zipsInclude.size && !filterState.zipsInclude.has(z)) return false;
        if(filterState.zipsExclude.size && filterState.zipsExclude.has(z)) return false;

        return true;
      });
    }

    function wireChips(scope, key, valuesAreDirect=true){
      scope.addEventListener('click',(e)=>{
        const chip = e.target.closest('.chip'); if(!chip) return;
        const ds = chip.dataset;
        if(key==='asset'){
          scope.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          filterState.asset = ds.asset;
        } else if(key==='role'){
          scope.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          filterState.role = ds.role;
        } else if(key==='source'){
          chip.classList.toggle('active');
          const val = ds.src;
          if(chip.classList.contains('active')) filterState.sources.add(val);
          else filterState.sources.delete(val);
          if(filterState.sources.size===0){
            // Prevent empty set -> keep at least one selected
            filterState.sources.add(val);
            chip.classList.add('active');
          }
        }
      });
    }

    wireChips(document.getElementById('fg-asset'), 'asset');
    wireChips(document.querySelector('[data-src]')?.parentElement || document.body, 'source');
    document.querySelectorAll('[data-src]').forEach(()=>{}); // no-op, ensures DOM is ready
    document.querySelectorAll('[data-role]').forEach(()=>{}); // no-op

    // manual handlers for role/source groups
    document.querySelectorAll('[data-role]').forEach(el=>{
      el.addEventListener('click',()=>{
        el.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        filterState.role = el.dataset.role;
      });
    });
    document.querySelectorAll('[data-src]').forEach(el=>{
      el.addEventListener('click',()=>{
        el.classList.toggle('active');
        const v = el.dataset.src;
        if(el.classList.contains('active')) filterState.sources.add(v); else filterState.sources.delete(v);
        if(filterState.sources.size===0){ filterState.sources.add(v); el.classList.add('active'); }
      });
    });

    document.getElementById('applyFilters').addEventListener('click',()=>{
      filterState.zipsInclude = parseZips(document.getElementById('zipInclude').value);
      filterState.zipsExclude = parseZips(document.getElementById('zipExclude').value);
      // Re-render current index within filtered set
      render(idx, true);
    });
    document.getElementById('clearFilters').addEventListener('click',()=>{
      filterState.asset='any';
      filterState.zipsInclude.clear();
      filterState.zipsExclude.clear();
      filterState.sources=new Set(['street','web','live']);
      filterState.role='acqmgr';
      document.getElementById('zipInclude').value='';
      document.getElementById('zipExclude').value='';
      // reset chips
      document.querySelectorAll('.chip').forEach(ch=>ch.classList.remove('active'));
      document.querySelector('[data-asset="any"]').classList.add('active');
      document.querySelector('[data-role="acqmgr"]').classList.add('active');
      document.querySelectorAll('[data-src]').forEach(el=>el.classList.add('active'));
      render(idx, true);
    });

    /* ---------- Actions / lead viewer ---------- */
    let idx=0, currentLead=null;

    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);

    function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1600); }
    function setStatus(t){ statusEl.textContent=t; }
    const clean=s=>(s||'').trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');

    function phoneHref(number, mode){
      const num=(number||'').replace(/[^\d+]/g,'');
      if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){ navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging'; }
      if(mode==='gvoice'){ navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages'; }
      return `tel:${num}`;
    }

    function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr||'')}`; }
    function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr||'')}`; }

    const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
    const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
    const saveTimeKey = addr => noteKey(addr)+'_ts';
    const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
    const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);
    function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

    function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px'; }

    function filteredLeads(){
      return applyFilterArray(Array.isArray(window.leads)? window.leads : []);
    }

    function render(i, fromFilter=false){
      const list = filteredLeads();
      if(!list.length){
        $('#leadCard').innerHTML='<div class="body">No leads match your filters (or none loaded). Check <b>/leads.js</b>.</div>';
        setStatus('0 leads'); return;
      }
      if(fromFilter) i=0;
      if(i<0) i=list.length-1;
      if(i>=list.length) i=0;
      idx=i;

      const lead=list[idx];
      currentLead=lead;

      const name  = clean(lead?.contacts?.[0]?.name||'Unknown');
      const phone = phoneOf(lead);
      const addr  = clean(lead?.address||'');
      const src   = leadSource(lead);
      const z     = leadZip(lead);
      const atype = leadAssetType(lead);

      setStatus(`Lead ${idx+1} of ${list.length}`);

      const mode=getMode();
      $('#actCall').href = phoneHref(phone, mode);
      $('#actSMS').href  = mode==='device' && phone ? `sms:${phone}` : phoneHref(phone, mode);

      const lastSaved = saveTimeGet(addr);
      const lastSavedText = lastSaved ? `Saved ${fmtTime(lastSaved)}` : 'Not saved yet';

      $('#leadCard').innerHTML = `
        <div class="title">${addr || name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>

          <div class="pillrow">
            <div class="pill">Source: ${src}</div>
            <div class="pill">Asset: ${atype}</div>
            <div class="pill">ZIP: ${z || '‚Äî'}</div>
            <div class="pill">Dial: ${mode}</div>
          </div>

          <h3 style="margin:10px 0 6px;font-size:16px">Lead notes</h3>
          <div class="notesBox">
            <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶"></textarea>
            <div class="row">
              <button id="inlineSave" class="btn"><span class="icon-only">üíæ</span><span class="label-text">Save Notes</span></button>
              <span id="savedTag" class="help">${lastSavedText}</span>
            </div>
          </div>

          <iframe class="sv"  src="${svSrc(addr)}"   loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Street View"></iframe>
          <iframe class="map" src="${mapSrc(addr)}"  loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Map"></iframe>
        </div>
      `;

      const ta=$('#noteInput');
      ta.value = loadNotes(addr) || (lead?.notes || '');
      autoGrow(ta);
      ta.addEventListener('input',()=>autoGrow(ta));

      $('#inlineSave').onclick = ()=>doSaveNotes();
    }

    function doSaveNotes(){
      const addr = (currentLead?.address)||'';
      const text = ($('#noteInput')?.value||'').trim();
      saveNotes(addr, text);
      const ts=Date.now(); saveTimeSet(addr, ts);
      const tag=$('#savedTag'); if(tag){ tag.textContent=`Saved ${fmtTime(ts)}`; }
      toast('Notes saved');
    }

    // actions
    $('#btnPrev').onclick   = ()=>render(idx-1);
    $('#btnNext').onclick   = ()=>render(idx+1);
    $('#btnRandom').onclick = ()=>render(Math.floor(Math.random()*(filteredLeads().length||1)));

    $('#actCopy').onclick = ()=>{
      const p=phoneOf(currentLead||{});
      if(!p) return alert('No phone on this lead.');
      navigator.clipboard.writeText(p).then(()=>toast('Phone copied'));
    };

    $('#actSettings').onclick = ()=>{
      dlg.showModal();
      const cur=getMode();
      dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked=(r.value===cur));
    };
    $('#saveMode').onclick = ()=>{
      const m=dlg.querySelector('input[name="mode"]:checked')?.value||'device';
      setMode(m); dlg.close(); render(idx);
    };
    $('#closeMode').onclick = ()=>dlg.close();

    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft') return $('#btnPrev').click();
      if(e.key==='ArrowRight') return $('#btnNext').click();
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); return doSaveNotes(); }
    });

    window.addEventListener('beforeunload',()=>{ if(currentLead){ doSaveNotes(); } });

    function init(){
      // default subtab
      const wh = new URL(location.href).searchParams.get('wh') || 'acq';
      showSub(wh);
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',()=>render(0,true)); }
      else { render(0,true); }
    }
  </script>
</body>
</html>
