<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wholesaler Portal</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
  :root{--text:#e9f3ff;--muted:#a6c2d7;--gold:#ffd36b;--green:#25d18f}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
  background:linear-gradient(135deg,#0a0f16,#102131 55%,#14354c)}
  .wrap{max-width:1180px;margin:0 auto}
  .card{border:1px solid rgba(255,255,255,.18);border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));overflow:hidden}
  .top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.2)}
  .tabs{display:flex;gap:8px}.pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0c1f2d;color:#cfe7ff;cursor:pointer}
  .pill.active{background:linear-gradient(180deg,#1a6c92,#0e435d);color:#eaffff;border-color:transparent}
  .subtabs{display:flex;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.2)}
  .sub{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.22);background:#0d2332;color:#cfe7ff;cursor:pointer}
  .sub.active{background:#114463;color:#fff;border-color:transparent}
  .actions{display:grid;grid-template-columns:repeat(12,1fr);gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.2)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;text-decoration:none}
  .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
  .btn-green{background:linear-gradient(180deg,#26cf84,#1a9b61);color:#fff;border:none}
  .muted{color:var(--muted);font-size:13px}
  .lead{margin:12px;border:1px solid rgba(255,255,255,.22);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
  .title{padding:12px 14px;font-weight:900;border-bottom:1px solid rgba(255,255,255,.18)}
  .body{padding:12px 14px}
  .qf{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,rgba(0,0,0,.12),rgba(255,255,255,.05))}
  .qf .tag{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0d2332;color:#cfe7ff}
  body.embedded #whSubtabs{display:none !important}
  /* hide ONLY quick-filters row when embedded ‚Äì actions remain */
  body.embedded #quickFilters{display:none !important}
</style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="tabs" id="roleTabsTop">
          <span class="pill active" data-role="wh">Wholesaler</span>
          <span class="pill" data-role="ct">Contractor</span>
          <span class="pill" data-role="re">Realtor</span>
          <span class="pill" data-role="in">Investor</span>
          <span class="pill" data-role="settings">Settings</span>
        </div>
        <div id="crumb" class="muted">Wholesaler ‚Ä¢ Acquisition</div>
        <div id="status" class="muted">Loading‚Ä¶</div>
      </div>

      <div class="subtabs" id="whSubtabs">
        <span class="sub active" data-sub="acq">Acquisition</span>
        <span class="sub" data-sub="dispo">Dispo</span>
      </div>

      <div class="actions" id="acqBar">
        <a class="btn btn-gold" id="actCall">üìû Call</a>
        <a class="btn btn-gold" id="actSMS">üí¨ Text</a>
        <a class="btn" id="actDirections" target="_blank" rel="noopener">üß≠ Directions</a>
        <button class="btn" id="actCopy">üìã Copy</button>
        <button class="btn" id="actSettings">‚öôÔ∏è Dial Mode</button>
        <button class="btn" id="leadPhotos">üì∑ Photos</button>
        <button class="btn btn-green" id="addLead">‚ûï Lead</button>
        <button class="btn" id="reloadLeads">üîÑ Reload</button>
        <button class="btn" id="resetFilters">‚ôªÔ∏è Reset</button>
        <button class="btn btn-green" id="nextLead">‚û°Ô∏è Next</button>
        <div id="telemetry" class="muted" style="grid-column:1/-1;text-align:right"></div>
      </div>

      <!-- Quick filters live here for stand-alone mode only (hidden when embedded) -->
      <div id="quickFilters" class="qf">
        <span class="muted" style="align-self:center">Type:</span>
        <button class="tag" data-q="type" data-val="residential">Residential</button>
        <button class="tag" data-q="type" data-val="commercial">Commercial</button>
        <button class="tag" data-q="type" data-val="land">Land</button>
        <span class="muted" style="align-self:center;margin-left:8px">Strategy:</span>
        <button class="tag" data-q="strategy" data-val="flip">Flip</button>
        <button class="tag" data-q="strategy" data-val="brrrr">BRRRR</button>
        <button class="tag" data-q="strategy" data-val="buyhold">Buy & Hold</button>
        <button class="tag" data-q="strategy" data-val="wholesale">Wholesale</button>
        <button class="tag" data-q="strategy" data-val="sellerfinance">Seller Finance</button>
        <button class="tag" id="qHasPhone" data-q="hasphone" data-val="1" style="margin-left:8px">Has phone</button>
        <input id="qZips" class="tag" style="border-radius:10px" placeholder="ZIPs e.g. 77003,77004"/>
      </div>

      <div id="acqWrap"><div id="leadCard" class="lead"><div class="body">Initializing‚Ä¶</div></div></div>
      <div id="dispoWrap" style="display:none;padding:12px"><div class="muted">Dispo viewer</div></div>
    </section>
  </div>
  <footer style="max-width:1180px;margin:14px auto 6px;color:#a6c2d7;font-size:12px;display:flex;justify-content:space-between"><div>¬© 2025 DealBankers.com</div><div>v2.3</div></footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script>
    // Embedded detection: param or iframe -> hide sub/quick filters when embedded
    (function(){
      const p=new URL(location.href).searchParams;
      const force=p.get('embed')==='1'||p.get('ui')==='embed'||p.get('min')==='1';
      const inIframe=(function(){ try{return window.self!==window.top;}catch(e){return true;} })();
      if(force||inIframe){ document.body.classList.add('embedded'); }
    })();

    // Firebase (scoped)
    const app=firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const db=app.database();

    // Params
    const prs=new URL(location.href).searchParams;
    const uid=prs.get('uid')||'anon';
    const email=prs.get('email')||'';
    const subParam=(prs.get('sub')||'acq').toLowerCase();
    const forceLeads=prs.get('leads')==='1';

    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    function setStatus(t){$('#status').textContent=t}
    const slug=s=>String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    // Role/Sub tabs
    let subState=subParam==='dispo'?'dispo':'acq';
    function setSub(s){ subState=s; $('#acqWrap').style.display=(s==='acq')?'block':'none'; $('#dispoWrap').style.display=(s==='dispo')?'block':'none';
      $$('#whSubtabs .sub').forEach(el=>el.classList.toggle('active',el.dataset.sub===s)); $('#crumb').textContent='Wholesaler ‚Ä¢ '+(s==='acq'?'Acquisition':'Dispo'); if(s==='acq') initAcqGate(); }
    $$('#whSubtabs .sub').forEach(el=>el.addEventListener('click',()=>setSub(el.dataset.sub)));

    // Persistent settings (only used in stand-alone mode)
    let settingsFilters={types:[], zips:[], leadsEnabled:false};
    db.ref(`userSettings/${uid}/wholesaler`).on('value',s=>{ const v=s.val()||{}; settingsFilters.types=v.types||[]; settingsFilters.zips=v.zips||[]; settingsFilters.leadsEnabled=!!v.leadsEnabled; });

    // ===== Global/session filters (can be driven by parent) =====
    const qf={types:new Set(), strategies:new Set(), hasPhone:false, zips:[]};

    function parseList(s){return (s||'').split(',').map(x=>x.trim().toLowerCase()).filter(Boolean)}
    // seed from query (parent passes these initially)
    parseList(prs.get('qfTypes')).forEach(v=>qf.types.add(v));
    parseList(prs.get('qfStrategies')).forEach(v=>qf.strategies.add(v));
    qf.hasPhone = prs.get('qfHasPhone')==='1';
    qf.zips = parseList(prs.get('qfZips'));

    // accept live updates from parent without reloading iframe
    window.addEventListener('message',e=>{
      const d=e?.data||{}; if(d.type!=='whFilters') return;
      const p=d.payload||{};
      qf.types=new Set((p.types||[]).map(String));
      qf.strategies=new Set((p.strategies||[]).map(String));
      qf.hasPhone=!!p.hasPhone; qf.zips=(p.zips||[]).map(String);
      recomputeFiltersAndRender();
    });

    // Quick filters UI (only usable when not embedded, but still powers filtering)
    $('#quickFilters').addEventListener('click',e=>{
      const t=e.target.closest('.tag'); if(!t) return;
      const q=t.dataset.q, val=(t.dataset.val||'').toLowerCase();
      if(q==='type'){ if(qf.types.has(val)) qf.types.delete(val); else qf.types.add(val); t.classList.toggle('on'); }
      else if(q==='strategy'){ if(qf.strategies.has(val)) qf.strategies.delete(val); else qf.strategies.add(val); t.classList.toggle('on'); }
      else if(q==='hasphone'){ qf.hasPhone=!qf.hasPhone; t.classList.toggle('on', qf.hasPhone); }
      recomputeFiltersAndRender();
    });
    $('#qZips').addEventListener('change',()=>{ qf.zips=($('#qZips').value||'').split(',').map(s=>s.trim()).filter(Boolean); recomputeFiltersAndRender(); });

    // ===== Leads pipeline (robust) =====
    let idx=0, current=null; window.leads=[]; window.__filteredLeads=[];

    function clean(s){return (s||'').toString().trim()}
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');
    const extractZip=a=>{const m=String(a||'').match(/\b\d{5}\b/); return m?m[0]:'';}
    function classifyLead(lead){
      const bag=[lead?.type,lead?.category,lead?.tags,lead?.notes,lead?.details,lead?.description,lead?.zoning,lead?.use].map(clean).join(' ').toLowerCase();
      const isLand=/\b(vacant|raw|unimproved)\s+(lot|land)\b/.test(bag)||/\blot\b/.test(bag)||/\bacre(s)?\b/.test(bag);
      const isComm=!isLand && /\b(commercial|retail|industrial|warehouse|office|restaurant|hotel|motel|c[- ]?store|gas|shopping|mall|strip|mixed[- ]use|nnn|self[ -]?storage|multifamily(?!\s*residential))\b/.test(bag);
      const isResi=!isLand && /\b(residential|single[- ]family|sfh|house|duplex|triplex|quadplex|apartment|condo|townhome|mobile home|mh)\b/.test(bag);
      if(isComm) return 'commercial'; if(isResi) return 'residential'; if(isLand) return 'land'; return '';
    }
    function matchesStrategies(lead){
      if(!qf.strategies.size) return true;
      const bag=`${lead?.notes||''} ${lead?.details||''} ${lead?.tags||''} ${lead?.description||''}`.toLowerCase();
      const map={flip:/\bflip|rehab|fix[ -]?and[ -]?flip|arv\b/, brrrr:/\bbrrrr\b/, buyhold:/\bbuy\s*&?\s*hold|cash\s*flow|rental\b/, wholesale:/\bwholesale|assignment\b/, sellerfinance:/\bseller[- ]?finance|owner[- ]?finance\b/};
      for(const key of qf.strategies){ if(map[key] && map[key].test(bag)) return true; } return false;
    }
    function computeFiltered(all){
      let arr=all.slice();
      if(qf.types.size){ arr=arr.filter(l=>qf.types.has(classifyLead(l))); }
      if(qf.zips.length){ const zset=new Set(qf.zips); arr=arr.filter(l=>{const z=extractZip(l?.address||''); return z && zset.has(z);}); }
      if(qf.hasPhone){ arr=arr.filter(l=>phoneOf(l)); }
      if(qf.strategies.size){ arr=arr.filter(l=>matchesStrategies(l)); }
      return arr;
    }
    function telemetry(allCount, filteredCount){
      $('#telemetry').textContent=`Feed loaded: ${allCount} ‚Ä¢ After filter: ${filteredCount}`;
    }
    function recomputeFiltersAndRender(){
      if(!window.leads.length){ $('#leadCard').innerHTML='<div class="body"><b>No leads loaded.</b></div>'; return; }
      const filtered=computeFiltered(window.leads); window.__filteredLeads=filtered;
      setStatus(`Loaded ${filtered.length} lead(s)`); telemetry(window.leads.length, filtered.length);
      if(!filtered.length){ $('#leadCard').innerHTML='<div class="body"><b>No leads match your filters.</b></div>'; return; }
      if(idx>=filtered.length) idx=0; renderLead(idx);
    }

    async function tryLoadScript(src){ return new Promise((resolve)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>resolve(true); s.onerror=()=>resolve(false); document.head.appendChild(s); }); }
    function normalize(o){
      const arr=Array.isArray(o)?o:Object.values(o||{});
      return arr.map((r,i)=>({
        id:r.id||slug(r.address||('lead-'+i+'-'+Date.now())),
        address:r.address||r.addr||'',
        contacts:r.contacts||[{name:r.name||r.owner||'', phone:r.phone||r.phone1||r.tel||''}],
        notes:r.notes||r.note||r.comment||'',
        type:r.type||r.category||''
      })).filter(x=>x.address||phoneOf(x));
    }
    async function readDB(path){ try{ const s=await db.ref(path).get(); const v=normalize(s.val()); if(v.length) return v; }catch{} return []; }

    async function loadLeads(){
      setStatus('Loading leads‚Ä¶');
      window.leads=[];
      // 1) scripts
      const emailSlug=slug(email.replace(/@/g,' at ').replace(/\./g,' dot '));
      const candidates=[ '/leads.js', `/leads-${uid}.js`, `/leads-${emailSlug}.js` ];
      for(const url of candidates){ const ok=await tryLoadScript(url); if(ok && Array.isArray(window.leads) && window.leads.length){ break; } }
      // 2) DB fallbacks
      if(!window.leads.length){
        const pools=[
          `leads/${uid}`, `leadsFeed/${uid}`, `leadsFeedByEmail/${emailSlug}`
        ];
        for(const p of pools){ const v=await readDB(p); if(v.length){ window.leads=v; break; } }
      }
      if(!window.leads.length){
        setStatus('No external feed found ‚Äî you can add or import leads.'); // still allow ACQ UI
      }
      recomputeFiltersAndRender();
    }

    function initAcqGate(){ // with forceLeads, open ACQ even if DB flag is false
      if(forceLeads || settingsFilters.leadsEnabled){ loadLeads(); } else { loadLeads(); } // always proceed now
    }

    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);
    function phoneHref(number,mode){ const num=(number||'').replace(/[^\d+]/g,''); if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging';}
      if(mode==='gvoice'){navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages';}
      return `tel:${num}`; }
    const svSrc=a=>`https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(a||'')}`;
    const mapSrc=a=>`https://www.google.com/maps?output=embed&q=${encodeURIComponent(a||'')}`;

    function renderLead(i){
      const arr=window.__filteredLeads||[]; if(!arr.length){$('#leadCard').innerHTML='<div class="body">No leads.</div>'; return;}
      if(i<0) i=arr.length-1; if(i>=arr.length) i=0; idx=i; current=arr[idx];
      const name=clean(current?.contacts?.[0]?.name||'Unknown'); const phone=phoneOf(current); const addr=clean(current?.address||''); const mode=getMode();
      $('#actCall').href=phoneHref(phone,mode); $('#actSMS').href=mode==='device'&&phone?`sms:${phone}`:phoneHref(phone,mode);
      $('#actDirections').href=addr?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`:'#';
      $('#leadCard').innerHTML=`
        <div class="title">${addr||name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>
          <textarea id="noteInput" style="width:100%;min-height:120px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#0d2130;color:#eaf6ff" placeholder="Type notes here‚Ä¶"></textarea>
          <div style="margin-top:8px"><button id="saveNotes" class="btn btn-gold">üíæ Save Notes</button></div>
          <iframe class="sv" src="${svSrc(addr)}" loading="lazy" style="width:100%;height:260px;border:0;border-radius:12px;margin-top:6px"></iframe>
          <iframe class="map" src="${mapSrc(addr)}" loading="lazy" style="width:100%;height:220px;border:0;border-radius:12px;margin-top:8px"></iframe>
        </div>`;
      const key='db_notes_'+(addr||name).toLowerCase().replace(/[^a-z0-9]+/g,'-');
      const ta=$('#noteInput'); ta.value=localStorage.getItem(key)||current?.notes||''; $('#saveNotes').onclick=()=>{localStorage.setItem(key,ta.value.trim()); setStatus('Notes saved');};
      $('#actCopy').onclick=()=>{ if(!phone) return alert('No phone on this lead.'); navigator.clipboard.writeText(phone).then(()=>setStatus('Phone copied')); };
      $('#actSettings').onclick=()=>{ const cur=getMode(); const next=cur==='device'?'textnow':cur==='textnow'?'gvoice':'device'; setMode(next); setStatus(`Dial mode: ${next}`); renderLead(idx); };
      $('#nextLead').onclick=()=>renderLead(idx+1);
      document.onkeydown=(e)=>{ if(e.key==='ArrowRight') renderLead(idx+1); };
    }

    $('#reloadLeads').onclick=()=>{ window.leads=[]; window.__filteredLeads=[]; loadLeads(); }
    $('#resetFilters').onclick=()=>{ qf.types.clear(); qf.strategies.clear(); qf.zips=[]; qf.hasPhone=false; recomputeFiltersAndRender(); }

    // Boot
    setSub(subState);
    initAcqGate();
  </script>
</body>
</html>
