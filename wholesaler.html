<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler ‚Ä¢ Acquisition</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

  <style>
    :root{
      --bg1:#0b131b; --bg2:#142838; --bg3:#173c53;
      --line:#2a5a78; --text:#f3f8fb; --muted:#c7d7e6;
      --gold:#ffd36b; --green:#26cf84; --blue:#47b4ff; --panel:#133045;
      --shadow:0 28px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
      padding:10px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{
      background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden
    }

    /* Header */
    .top{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px
    }
    .crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
    .status{font-size:12px;color:#e8f7ff}

    /* Sub-nav (Acq/Dispo only ‚Äì no inner Wholesaler/Settings) */
    .subnav{
      display:flex;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))
    }
    .pill{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#cfe7ff;text-decoration:none}
    .pill.active{background:linear-gradient(180deg,#2b74ff,#0a58ca);border:none;color:#fff}

    .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.08)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;
      font-weight:800;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
    .btn:hover{filter:brightness(1.08)}
    .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
    .btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none}
    .btn-ghost{background:#0f2a3a}
    .ico{font-size:20px}
    .navrow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 10px 10px}

    .lead-wrap{padding:12px}
    .lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(90deg,rgba(255,211,107,.22),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}

    .sv,.map{width:100%;border:0;border-radius:14px;background:#fff}
    .sv{height:260px;margin-top:6px}
    .map{height:220px;margin-top:8px}

    .notesBox{display:grid;gap:8px;margin:8px 0 10px}
    .textarea{width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:#0d2130;color:#eaf6ff;font-size:14px;line-height:1.4}

    @media (max-width:480px){
      .actions{grid-template-columns:repeat(3,1fr)}
      .title{font-size:16px}
      .sv{height:230px} .map{height:200px}
    }

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;
      color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="crumbs"><span>Wholesaler</span><span class="dot"></span><span>Acquisition</span></div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- Only Acquisition/Dispo here. (No inner "Wholesaler" or "Settings" tab.) -->
      <div class="subnav">
        <span class="pill active">Acquisition</span>
        <a class="pill" href="dispo.html">Dispo</a>
        <span style="margin-left:auto;color:#9fc9ec;font-size:12px">Lead filters live in <b>Profile ‚Üí Settings ‚Üí Wholesaler</b>.</span>
      </div>

      <div class="actions">
        <a class="btn btn-gold" href="#" id="actCall"  title="Call"><span class="ico">üìû</span></a>
        <a class="btn btn-gold" href="#" id="actSMS"   title="Text"><span class="ico">üí¨</span></a>
        <a class="btn btn-ghost" id="actDirections"   title="Directions" href="#" target="_blank" rel="noopener"><span class="ico">üß≠</span></a>
        <button class="btn btn-ghost" id="actCopy"     title="Copy number"><span class="ico">üìã</span></button>
        <button class="btn btn-ghost" id="actSettings" title="Dial mode"><span class="ico">‚öôÔ∏è</span></button>
      </div>

      <div class="navrow">
        <button class="btn btn-ghost" id="btnPrev"   title="Prev">‚óÄ</button>
        <button class="btn btn-ghost" id="btnRandom" title="Random">üé≤</button>
        <button class="btn btn-green" id="btnNext"   title="Next">‚ñ∂</button>
      </div>

      <div class="lead-wrap">
        <div id="leadCard" class="lead">
          <div class="body">Initializing‚Ä¶</div>
        </div>
      </div>
    </section>
  </div>

  <!-- simple dial-mode dialog -->
  <dialog id="settingsDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:520px;width:92%">
    <h3 style="margin:0 0 8px">Phone Link Preference</h3>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMode" class="btn" style="flex:1">Save</button>
      <button id="closeMode" class="btn" style="flex:1">Close</button>
    </div>
  </dialog>

  <div id="toast"></div>

  <script>
    /* ---------- helpers ---------- */
    const $=s=>document.querySelector(s);
    const statusEl=$('#status'); const toastEl=$('#toast');
    const dlg=$('#settingsDlg');
    let idx=0, currentLead=null;

    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);
    const clean=s=>(s||'').trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');

    function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1600); }
    function setStatus(t){statusEl.textContent=t;}

    function phoneHref(number, mode){
      const num=(number||'').replace(/[^\d+]/g,'');
      if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){ navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging'; }
      if(mode==='gvoice'){ navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages'; }
      return `tel:${num}`;
    }

    function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr)}`; }
    function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr)}`; }
    function dirHref(addr){ return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`; }

    const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
    const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
    const saveTimeKey = addr => noteKey(addr)+'_ts';
    const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
    const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);

    const pad=n=>String(n).padStart(2,'0');
    const fmtTime=ts=>{ const d=new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; };

    /* ---------- gate + filters (driven by Profile via postMessage, optional) ---------- */
    const state = {
      uid: null,
      gate: null, // null=unknown, true=enabled, false=disabled
      filters: {zips:[],types:[],strategies:[],hasPhone:false},
    };

    function zipOf(a){ const m=String(a||'').match(/\b\d{5}\b/); return m?m[0]:''; }
    function classifyLead(lead){
      const bag=[lead?.type,lead?.category,lead?.tags,lead?.notes,lead?.details,lead?.description,lead?.zoning,lead?.use].map(clean).join(' ').toLowerCase();
      const isLand=/\b(vacant|raw|unimproved)\s+(lot|land)\b/.test(bag)||/\blot\b/.test(bag)||/\bacre(s)?\b/.test(bag);
      const isComm=!isLand && (/\b(commercial|retail|industrial|warehouse|office|restaurant|hotel|motel|shopping|strip|mixed[- ]use|cap ?rate|nnn|self[ -]?storage|flex|medical|clinic|multifamily(?!\s*residential))\b/.test(bag));
      const isResi=!isLand && /\b(residential|single[- ]family|sfh|house|duplex|triplex|quad(plex)?|apartment|condo|townhome|mobile)\b/.test(bag);
      if(isComm) return 'commercial'; if(isResi) return 'residential'; if(isLand) return 'land'; return '';
    }
    function matchesStrategies(lead){
      const wanted=state.filters.strategies||[];
      if(!wanted.length) return true;
      const bag=`${lead?.notes||''} ${lead?.details||''} ${lead?.tags||''} ${lead?.description||''}`.toLowerCase();
      const map={flip:/\bflip|rehab|fix[ -]?and[ -]?flip|arv\b/, brrrr:/\bbrrrr\b/, buyhold:/\bbuy\s*&?\s*hold|cash\s*flow|rental\b/, wholesale:/\bwholesale|assignment\b/, sellerfinance:/\bseller[- ]?finance|owner[- ]?finance|carry\s*back\b/};
      return wanted.some(k=>map[k]?.test(bag));
    }
    function applyFilters(all){
      let arr=all.slice();
      const f=state.filters||{};
      if(f.types?.length){
        const set=new Set(f.types);
        arr=arr.filter(l=>set.has(classifyLead(l)));
      }
      if(f.zips?.length){
        const zset=new Set(f.zips);
        arr=arr.filter(l=>{const z=zipOf(l?.address||''); return z && zset.has(z);});
      }
      if(f.hasPhone){ arr=arr.filter(l=>phoneOf(l)); }
      if(f.strategies?.length){ arr=arr.filter(l=>matchesStrategies(l)); }
      return arr;
    }

    /* ---------- render ---------- */
    let idxFiltered=0, filtered=[];
    function telemetry(allCount, filteredCount){
      const g = (state.gate===false)? ' ‚Ä¢ access disabled' : (state.gate===true? '' : ' ‚Ä¢ gate unknown');
      setStatus(`Loaded ${filteredCount} lead(s) ‚Ä¢ Feed: ${allCount}${g}`);
    }

    function render(i){
      const all = Array.isArray(window.leads)? window.leads : [];

      if(state.gate===false){
        $('#leadCard').innerHTML='<div class="body">Access to leads is not enabled yet.</div>';
        telemetry(all.length, 0);
        return;
      }

      filtered = applyFilters(all);
      if(!filtered.length){
        $('#leadCard').innerHTML='<div class="body">No leads match your current settings.</div>';
        telemetry(all.length, 0);
        return;
      }

      if(i<0) i=filtered.length-1;
      if(i>=filtered.length) i=0;
      idxFiltered=i;

      const lead=filtered[idxFiltered];
      currentLead=lead;

      const name  = clean(lead?.contacts?.[0]?.name||'Unknown');
      const phone = phoneOf(lead);
      const addr  = clean(lead?.address||'');

      const mode=getMode();
      $('#actCall').href = phoneHref(phone, mode);
      $('#actSMS').href  = mode==='device' && phone ? `sms:${phone}` : phoneHref(phone, mode);
      $('#actDirections').href = dirHref(addr);

      const lastSaved = saveTimeGet(addr);
      const lastSavedText = lastSaved ? `Saved ${fmtTime(lastSaved)}` : 'Not saved yet';

      $('#leadCard').innerHTML = `
        <div class="title">${addr || name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>

          <div class="chips">
            <div class="chip">UID: ${(state.uid||'anon').slice(0,8)}</div>
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <div class="chip">Dial: ${mode}</div>
            <div class="chip">Type: ${classifyLead(lead) || 'n/a'}</div>
          </div>

          <h3 style="margin:10px 0 6px;font-size:16px">Lead details</h3>
          <div class="notesBox">
            <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶">${lead?.notes?clean(lead.notes):loadNotes(addr)}</textarea>
            <div class="chips" style="margin:6px 0 0">
              <button id="inlineSave" class="btn btn-gold"><span class="ico">üíæ</span> Save Notes</button>
              <span id="savedTag" class="chip" style="background:#103b2a;border-color:#1f6a49">${lastSavedText}</span>
            </div>
          </div>

          <iframe class="sv"  src="${svSrc(addr)}"   loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Street View"></iframe>
          <iframe class="map" src="${mapSrc(addr)}"  loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Map"></iframe>
        </div>
      `;

      $('#inlineSave').onclick = ()=>{
        const text = ($('#noteInput')?.value||'').trim();
        saveNotes(addr, text);
        const ts=Date.now(); saveTimeSet(addr, ts);
        const tag=$('#savedTag'); if(tag){ tag.textContent=`Saved ${fmtTime(ts)}`; }
        toast('Notes saved');
      };

      telemetry(all.length, filtered.length);
    }

    /* ---------- controls ---------- */
    $('#btnPrev').onclick   = ()=>render(idxFiltered-1);
    $('#btnNext').onclick   = ()=>render(idxFiltered+1);
    $('#btnRandom').onclick = ()=>render(Math.floor(Math.random()*(filtered?.length||1)));

    $('#actCopy').onclick = ()=>{
      const p=phoneOf(filtered?.[idxFiltered]);
      if(!p) return alert('No phone on this lead.');
      navigator.clipboard.writeText(p).then(()=>toast('Phone copied'));
    };

    $('#actSettings').onclick = ()=>{
      dlg.showModal();
      const cur=getMode();
      dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked=(r.value===cur));
    };
    $('#saveMode').onclick = ()=>{
      const m=dlg.querySelector('input[name="mode"]:checked')?.value||'device';
      setMode(m); dlg.close(); render(idxFiltered);
    };
    $('#closeMode').onclick = ()=>dlg.close();

    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft') return $('#btnPrev').click();
      if(e.key==='ArrowRight') return $('#btnNext').click();
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); const b=document.getElementById('inlineSave'); if(b) b.click(); }
    });

    /* ---------- parent handshake ---------- */
    window.addEventListener('message', (ev)=>{
      const d=ev.data||{};
      if(d && d.type==='db-auth'){
        state.uid = d.uid || state.uid;
        if(typeof d.leadsEnabled==='boolean') state.gate = d.leadsEnabled;
        state.filters = d.filters || state.filters;
        render(idxFiltered);
      }
    });

    /* ---------- boot: load /leads.js immediately so phones see leads ---------- */
    (function boot(){
      const s=document.createElement('script');
      s.src='/leads.js?v='+Date.now();
      s.onload=()=>{ window.leads = window.leads || []; render(0); };
      s.onerror=()=>setStatus('Could not load /leads.js');
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
