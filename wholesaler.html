<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DealBankers â€¢ Wholesaler</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
<style>
:root{--bg1:#0b131b;--bg2:#142838;--bg3:#173c53;--line:#254a63;--text:#f1f7fb;--muted:#c5d3e1}
*{box-sizing:border-box}body{margin:0;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
background:radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3))}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.2);
background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.06))}
.nav{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;height:34px;padding:0 12px;border-radius:999px;border:1px solid rgba(255,255,255,.22);
background:linear-gradient(180deg,#111f2c,#0d1823);color:#eaf6ff;text-decoration:none;font-weight:700;cursor:pointer}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.18);border-radius:20px;box-shadow:0 28px 70px rgba(0,0,0,.55);overflow:hidden}
.top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06))}
.seg{display:inline-flex;border:1px solid rgba(255,255,255,.22);border-radius:999px;overflow:hidden}
.seg button{padding:8px 12px;background:#0e2332;border:0;color:#cfe6ff;cursor:pointer}.seg button.active{background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff}
.body{padding:12px}.search{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.input{background:#0d1f2d;border:1px solid #254a63;border-radius:12px;color:#eaf6ff;padding:8px 10px;outline:none}
table{width:100%;border-collapse:collapse;font-size:14px}th,td{border-top:1px solid rgba(255,255,255,.2);padding:10px;text-align:left}thead th{border-top:0;color:#cfe3ff}
.status{font-size:12px;color:#8fb3d1}.adminbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.chip.danger{background:linear-gradient(180deg,#6b1111,#3a0a0a);}
.chip.primary{background:linear-gradient(180deg,#0f2945,#0a1d31);}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{background:#0f1b27;border:1px solid #254a63;border-radius:16px;max-width:520px;width:92%;box-shadow:0 28px 70px rgba(0,0,0,.55);padding:16px}
.modal h3{margin:0 0 8px}.row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
.modal label{font-size:14px;color:#cfe3ff}.modal input,.modal select,.modal textarea{width:100%;padding:10px;border:1px solid #254a63;border-radius:10px;background:#0d1f2d;color:#eaf6ff}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.modal.wide{max-width:720px}
.lead-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:8px}
.lead-card{border:1px solid rgba(255,255,255,.22);border-radius:14px;padding:12px;background:#0e2332;cursor:pointer}
.lead-card h4{margin:0 0 6px;font-size:16px}
.lead-card p{margin:0;font-size:12px;color:#a8c3db}
.helper{font-size:12px;color:#9fbed8;margin-top:8px;text-align:right}
.helper a{color:#bfe3ff;text-decoration:underline;cursor:pointer}

/* Command Hub Modal */
#commandHub .row button{flex:1;background:#0e2332;border:1px solid #254a63;border-radius:8px;padding:10px;color:#eaf6ff;cursor:pointer}
#commandHub .row button:hover{background:#173c53}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
<script src="config.js"></script>
<script src="app-auth.js"></script>
<script src="leads.js"></script>
</head>
<body data-portal="wholesaler">

<header class="header">
  <div>DEALBANKERS â€¢ Portal</div>
  <nav class="nav">
    <a class="chip" href="profile.html">Profile</a>
    <a class="chip primary" href="claims-exchange.html">Claims Exchange</a>
    <button class="chip" id="btnGetLeads">Get Leads</button>
    <button class="chip" id="btnBlue">ðŸŒ€ Blue Phone</button>
    <button class="chip danger" id="btnRed">ðŸš¨ Red Phone</button>
    <a class="chip" id="logoutBtn">Log Out</a>
  </nav>
</header>

<div class="wrap">
<section class="card">
  <div class="top">
    <div><div id="crumb">Acquisition</div><div class="status" id="status">Loadingâ€¦</div></div>
    <div class="seg"><button id="tabAcq" class="active">Acq</button><button id="tabDispo">Dispo</button></div>
  </div>
  
  <div class="body">
    <div id="adminBar" class="adminbar" style="display:none">
      <span class="status">Admin â€¢ View as UID:</span>
      <input id="impUid" class="input" placeholder="paste UID"/><button class="chip" id="applyImp">Apply</button>
      <button class="chip" id="clearImp">Clear</button>
    </div>

    <section id="panel-acq">
      <div class="search"><input id="s_q" class="input" placeholder="Search address/owner"/><button class="chip" id="s_reload">Search</button></div>
      <table><thead><tr><th>Address</th><th>Owner</th><th>Phone</th><th>Status</th><th>Notes</th></tr></thead><tbody id="sellerRows"></tbody></table>
    </section>

    <section id="panel-dispo" style="display:none">
      <div class="search"><input id="b_q" class="input" placeholder="Search name/criteria"/><button class="chip" id="b_reload">Search</button></div>
      <table><thead><tr><th>Name</th><th>Phone</th><th>Criteria</th><th>Status</th><th>Notes</th></tr></thead><tbody id="buyerRows"></tbody></table>
    </section>
  </div>
</section>
</div>
<!-- Command Hub Modal -->
<div class="modal-backdrop" id="commandHub" style="display:none;">
  <div class="modal wide">
    <h3>Lead Command Hub</h3>
    <p id="cmdAddress"></p>
    <div class="row">
      <button id="cmdCall">ðŸ“ž Call</button>
      <button id="cmdMap">ðŸ—º Street View</button>
      <button id="cmdMsg">ðŸ’¬ Script</button>
      <button id="cmdCopy">ðŸ“‹ Copy Number</button>
    </div>
    <div class="row">
      <textarea id="cmdNotes" rows="4" placeholder="Add/update notes..."></textarea>
    </div>
    <div class="actions">
      <button class="chip" id="cmdCancel">Close</button>
      <button class="chip primary" id="cmdSave">Save Notes</button>
    </div>
  </div>
</div>
<script>
let UID=null, IS_ADMIN=false, VIEW_AS=null, sRef=null, currentLead=null;

firebase.auth().onAuthStateChanged(async u=>{
  if(!u) return;
  UID=u.uid;
  const r=await firebase.database().ref('roles/'+UID).get();
  IS_ADMIN=r.exists() && r.val()==='admin';
  document.getElementById('adminBar').style.display=IS_ADMIN?'flex':'none';
  subscribe();
});

function activeUid(){ return (IS_ADMIN && VIEW_AS)?VIEW_AS:UID; }
function esc(s){return(''+(s||'')).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

function subscribe(){
  if(!UID) return;
  if(sRef) sRef.off();
  const a=activeUid();
  sRef=firebase.database().ref('leads/sellers').orderByChild('assignedTo').equalTo(a);
  sRef.on('value',s=>renderLeads(s.val()||{}));
}

function renderLeads(o){
  const q=(document.getElementById('s_q').value||'').toLowerCase();
  const rows=Object.entries(o).map(([id,v])=>({id,...v}))
    .filter(v=>!q||(v.address||'').toLowerCase().includes(q)||(v.owner||'').toLowerCase().includes(q))
    .map(v=>`<tr data-id="${v.id}"><td>${esc(v.address)}</td><td>${esc(v.owner)}</td>
      <td>${esc(v.phone)}</td><td>${esc(v.status||'new')}</td><td>${esc(v.notes||'')}</td></tr>`).join('');
  
  document.getElementById('sellerRows').innerHTML = rows;
  
  // Attach click handler for modal
  document.querySelectorAll('#sellerRows tr').forEach(tr=>{
    tr.onclick=()=>openCommandHub(o[tr.dataset.id], tr.dataset.id);
  });
}

/* Command Hub Functions */
function openCommandHub(v,id){
  currentLead={...v,id};
  document.getElementById('cmdAddress').textContent=v.address;
  document.getElementById('cmdNotes').value=v.notes||'';
  document.getElementById('commandHub').style.display='flex';
}

document.getElementById('cmdCancel').onclick=()=>document.getElementById('commandHub').style.display='none';

document.getElementById('cmdSave').onclick=async ()=>{
  try{
    await firebase.database().ref(`leads/sellers/${currentLead.id}`).update({notes:document.getElementById('cmdNotes').value});
    alert('Notes saved.');
    document.getElementById('commandHub').style.display='none';
  }catch(e){ alert('Failed to save.'); }
};

document.getElementById('cmdCall').onclick=()=>window.location=`tel:${currentLead.phone}`;
document.getElementById('cmdCopy').onclick=()=>navigator.clipboard.writeText(currentLead.phone);
document.getElementById('cmdMap').onclick=()=>window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${encodeURIComponent(currentLead.address)}`,'_blank');
document.getElementById('cmdMsg').onclick=()=>alert("Script: Hi, is this the property owner?");
</script>
</body>
</html>
