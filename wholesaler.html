<!-- =============== DealBankers • Wholesaler Portal (embed-aware, no ACQ chips; retro-noir) =============== -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wholesaler Portal</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
  :root{
    --bg1:#0a0f16;--bg2:#102131;--bg3:#14354c;
    --text:#e9f3ff;--muted:#a6c2d7;--gold:#ffd36b;--green:#25d18f;--line:#2a5a78;
    --accent:#52c8ff;--accent2:#9ae6ff;--panel:#0e2433;--glass:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 520px at 92% -12%, rgba(86,214,255,.22) 0%, transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
    padding:10px;
  }
  .wrap{max-width:1180px;margin:0 auto}
  .card{border:1px solid rgba(146,233,255,.22);border-radius:20px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));overflow:hidden}
  .top{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,rgba(0,0,0,.16),rgba(255,255,255,.05))}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0c1f2d;color:#cfe7ff;cursor:pointer}
  .pill.active{background:linear-gradient(180deg,#1a6c92,#0e435d);color:#eaffff;border-color:transparent}
  .crumbs{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:600}
  .status{font-size:12px;color:#e8f7ff;opacity:.9}
  .sticky{position:sticky;top:0;z-index:5}

  .actions{display:grid;grid-template-columns:repeat(12,1fr);gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.22);background:var(--panel);color:#eaf6ff;cursor:pointer;text-decoration:none}
  .btn:hover{box-shadow:0 0 0 1px rgba(154,230,255,.18) inset,0 0 18px rgba(82,200,255,.18)}
  .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
  .btn-green{background:linear-gradient(180deg,#26cf84,#1a9b61);color:#fff;border:none}
  .btn-ghost{background:var(--glass)}
  .btn-small{padding:8px 10px;font-size:12px}
  .muted{color:var(--muted);font-size:13px}

  .lead{margin:12px;border:1px solid rgba(255,255,255,.22);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));overflow:hidden}
  .title{padding:12px 14px;font-weight:900;border-bottom:1px solid rgba(255,255,255,.18)}
  .body{padding:12px 14px}
  .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e;display:inline-block;margin:0 6px 6px 0}
  .sv,.map{width:100%;border:0;border-radius:14px;background:#fff}.sv{height:260px;margin-top:6px}.map{height:220px;margin:8px 0}

  /* DISPO */
  .postPanel{margin-bottom:12px;border:1px dashed rgba(154,230,255,.4);border-radius:14px;padding:12px;background:rgba(12,31,45,.4)}
  .postGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .sectionBox{border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px}
  .viewer{border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px}
  .viewer iframe{width:100%;height:520px;border:0;border-radius:12px;background:#fff}
  .dealCard,.offerCard{display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.18);background:#0f2a3a;border-radius:12px;padding:10px}
  .badge{font-size:11px;padding:4px 8px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:#0c1f2d;color:#cfe7ff}

  dialog{border:1px solid rgba(154,230,255,.25);border-radius:16px;background:#0c1f2d;color:var(--text);max-width:720px;width:96%}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:8px 6px 0}
  .modal-body{padding:8px 6px 12px}
  .input,.textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0d2130;color:#eaf6ff}
  .textarea{min-height:120px;resize:vertical}
  .progressRow{display:grid;gap:6px;margin-top:8px}
  .bar{height:6px;background:#0b2130;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#56ddff,#1fb880)}

  /* Embedded mode: hide top nav/subtabs/settings to avoid redundancy */
  body.embedded .top .tabs,
  body.embedded #whSubtabs,
  body.embedded #settingsWrap{display:none !important}
</style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="tabs" id="roleTabsTop">
          <span class="pill active" data-role="wh">Wholesaler</span>
          <span class="pill" data-role="settings">Settings</span>
        </div>
        <div class="crumbs"><span id="crumb">Wholesaler • Acquisition</span></div>
        <div id="status" class="status">Loading…</div>
      </div>

      <!-- Wholesaler subtabs (only visible when not embedded) -->
      <div class="sticky" id="whSubtabs" style="display:flex;gap:8px;padding:10px;border-bottom:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))">
        <span class="pill active" data-sub="acq">Acquisition</span>
        <span class="pill" data-sub="dispo">Dispo</span>
      </div>

      <!-- ACQ -->
      <div class="sticky" id="acqBar" style="display:none">
        <div class="actions">
          <a class="btn btn-gold" id="actCall">📞 Call</a>
          <a class="btn btn-gold" id="actSMS">💬 Text</a>
          <a class="btn" id="actDirections" target="_blank" rel="noopener">🧭 Directions</a>
          <button class="btn" id="actCopy">📋 Copy</button>
          <button class="btn" id="actSettings">⚙️ Dial Mode</button>
          <button class="btn" id="leadPhotos">📷 Photos</button>
          <button class="btn btn-green" id="addLead">➕ Lead</button>
          <button class="btn btn-ghost btn-small" id="reloadLeads">🔄 Reload</button>
          <button class="btn btn-ghost btn-small" id="prevLead">⬅️ Prev</button>
          <button class="btn btn-green btn-small" id="nextLead">➡️ Next</button>
          <div id="telemetry" class="muted" style="grid-column:1/-1;text-align:right;padding-right:6px"></div>
        </div>
      </div>

      <div id="acqWrap"><div id="leadCard" class="lead"><div class="body">Initializing…</div></div></div>

      <!-- Chooser (when feed not enabled) -->
      <div id="chooser" style="display:none;padding:14px">
        <h3 style="margin:0">Pick how you want to work leads</h3>
        <div class="muted">We’ll notify admin and turn on the right feed. Or upload a CSV to start immediately.</div>
        <div class="postGrid" style="margin-top:8px">
          <button class="btn btn-green" data-req="Street Leads">Request Street Leads</button>
          <button class="btn btn-green" data-req="Web Leads">Request Web Leads</button>
          <button class="btn btn-green" data-req="Live Leads">Request Live Leads</button>
          <button class="btn btn-green" data-req="Use Own CRM">Connect My CRM</button>
        </div>
        <div class="sectionBox" style="margin-top:10px">
          <b>Upload your own leads (CSV)</b>
          <div class="muted" style="margin:4px 0 8px">Columns: address, name, phone, notes</div>
          <input id="csv" type="file" accept=".csv" class="input"/>
          <div class="muted" id="csvMsg" style="margin-top:6px"></div>
        </div>
      </div>

      <!-- DISPO -->
      <div id="dispoWrap" style="display:none;padding:12px">
        <div style="display:grid;grid-template-columns:1.1fr .9fr;gap:12px">
          <div>
            <div class="postPanel">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div style="font-weight:800">Posting Console</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn btn-green" id="addOffering">➕ Offering</button>
                  <button class="btn btn-green" id="addDeal">➕ Deal</button>
                  <button class="btn" id="dealPhotosBtn">📷 Selected Deal Photos</button>
                </div>
              </div>
              <div class="postGrid">
                <a class="btn" href="https://accounts.craigslist.org/login" target="_blank" rel="noopener">🅒 Craigslist</a>
                <a class="btn" href="https://www.facebook.com/marketplace/create/item" target="_blank" rel="noopener">📦 FB Marketplace</a>
                <a class="btn" href="mailto:?subject=DealBankers%20Offering&body=Reply%20to%20be%20added%20to%20buyers%20list">✉️ Email Blast</a>
                <a class="btn" href="chat.html?tab=townhall" target="_blank" rel="noopener">🏛️ Town Hall</a>
              </div>
            </div>

            <div class="sectionBox">
              <h3 style="margin:0 0 6px">Offerings — Private Capital</h3>
              <input id="offerSearch" class="input" placeholder="Search…" style="margin-bottom:8px"/>
              <div id="offerCards" style="display:grid;gap:10px"></div>
            </div>

            <div class="sectionBox" style="margin-top:12px">
              <h3 style="margin:0 0 6px">Deals — Wholesale & End-Buyer</h3>
              <input id="dealSearch" class="input" placeholder="Search…" style="margin-bottom:8px"/>
              <div id="dealCards" style="display:grid;gap:10px"></div>
            </div>
          </div>

          <div class="viewer">
            <h3 id="previewTitle" style="margin:0 0 8px">Preview</h3>
            <iframe id="sofPreview" title="SOF preview"></iframe>
            <div id="dealPreview" style="display:none">
              <div style="text-align:center;opacity:.8;margin:10px 0">Open gallery to view photos.</div>
              <button id="openDealGallery" class="btn">Open Gallery</button>
              <div class="muted" id="dealMeta" style="margin-top:6px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS (only when not embedded; mirrors Profile) -->
      <div id="settingsWrap" style="display:none;padding:12px">
        <h3 style="margin:0 0 8px">Wholesaler Settings</h3>
        <div class="sectionBox">
          <label>ZIPs <input id="sZips" class="input" placeholder="77003, 77004"/></label>
          <div style="margin-top:8px">Type</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
            <label class="badge"><input type="checkbox" value="residential" style="margin-right:6px">Residential</label>
            <label class="badge"><input type="checkbox" value="commercial"  style="margin-right:6px">Commercial</label>
            <label class="badge"><input type="checkbox" value="land"        style="margin-right:6px">Land</label>
          </div>
          <div style="margin-top:8px">Strategy</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
            <label class="badge"><input type="checkbox" value="flip"          style="margin-right:6px">Flip</label>
            <label class="badge"><input type="checkbox" value="brrrr"        style="margin-right:6px">BRRRR</label>
            <label class="badge"><input type="checkbox" value="buyhold"      style="margin-right:6px">Buy & Hold</label>
            <label class="badge"><input type="checkbox" value="wholesale"    style="margin-right:6px">Wholesale</label>
            <label class="badge"><input type="checkbox" value="sellerfinance"style="margin-right:6px">Seller Finance</label>
          </div>
          <div style="margin-top:8px">
            <label>Require phone?
              <select id="sHasPhone" class="input" style="margin-top:6px">
                <option value="">No preference</option><option value="1">Yes</option>
              </select>
            </label>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="sSave" class="btn btn-green">Save</button>
            <span id="sSaved" class="muted" style="display:none">Saved ✓</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer style="max-width:1180px;margin:12px auto 6px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between">
    <div>© 2025 DealBankers.com — All rights reserved.</div>
    <div>Wholesaler v2.3</div>
  </footer>

  <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);display:none"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script>
    // Detect embed
    (function(){
      const p=new URL(location.href).searchParams;
      if(p.get('embed')==='1'||p.get('ui')==='embed') document.body.classList.add('embedded');
    })();

    // Firebase (isolated app)
    const app=firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const db=app.database(), storage=firebase.storage(app);

    const prs=new URL(location.href).searchParams;
    const uid=prs.get('uid')||'anon';
    let subState=(prs.get('sub')||'acq').toLowerCase()==='dispo'?'dispo':'acq';

    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    function setStatus(t){$('#status').textContent=t}
    function toast(t){const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1600)}

    // UI Switching
    function setRole(role){
      const isWh = role==='wh';
      const isSettings = role==='settings';
      $$('#roleTabsTop .pill').forEach(el=>el.classList.toggle('active', el.dataset.role===role));
      $('#whSubtabs').style.display = (document.body.classList.contains('embedded')? 'none' : (isWh?'flex':'none'));
      $('#acqBar').style.display    = (isWh && subState==='acq')? 'block' : 'none';
      $('#acqWrap').style.display   = (isWh && subState==='acq')? 'block' : 'none';
      $('#chooser').style.display   = 'none';
      $('#dispoWrap').style.display = (isWh && subState==='dispo')? 'block' : 'none';
      $('#settingsWrap').style.display = isSettings? 'block' : 'none';
      $('#crumb').textContent = isWh ? ('Wholesaler • ' + (subState==='acq'?'Acquisition':'Dispo')) : 'Settings';
      if(isWh){ subState==='acq' ? initAcqGate() : loadDispo(); }
      if(isSettings){ fillSettingsUI(); }
    }
    $$('#roleTabsTop .pill').forEach(el=>el.onclick=()=>setRole(el.dataset.role));

    $$('#whSubtabs .pill').forEach(el=>el.onclick=()=>{ subState=el.dataset.sub; $$('#whSubtabs .pill').forEach(x=>x.classList.toggle('active',x===el)); setRole('wh'); });

    // ===== Settings (shared with Profile) =====
    let settingsFilters={types:[], strategies:[], zips:[], hasPhone:false, leadsEnabled:false, version:0};
    db.ref(`userSettings/${uid}/wholesaler`).on('value', snap=>{
      const v=snap.val()||{};
      settingsFilters.types = Array.isArray(v.types)? v.types.map(s=>String(s).toLowerCase()) : [];
      settingsFilters.strategies = Array.isArray(v.strategies)? v.strategies.map(s=>String(s).toLowerCase()) : [];
      settingsFilters.zips  = Array.isArray(v.zips)? v.zips.map(String) : [];
      settingsFilters.hasPhone = !!v.hasPhone;
      settingsFilters.leadsEnabled = !!v.leadsEnabled;
      settingsFilters.version = v.settingsVersion||v.version||0;
      if(window.leads && window.leads.length) recomputeAndRender();
    });

    function fillSettingsUI(){
      $('#sZips').value=(settingsFilters.zips||[]).join(', ');
      const set=new Set(settingsFilters.types||[]);
      $$(`#settingsWrap input[type="checkbox"][value="residential"]`)[0].checked=set.has('residential');
      $$(`#settingsWrap input[type="checkbox"][value="commercial"]`)[0].checked=set.has('commercial');
      $$(`#settingsWrap input[type="checkbox"][value="land"]`)[0].checked=set.has('land');

      const sset=new Set(settingsFilters.strategies||[]);
      ['flip','brrrr','buyhold','wholesale','sellerfinance'].forEach(v=>{
        $$(`#settingsWrap input[type="checkbox"][value="${v}"]`)[0].checked=sset.has(v);
      });
      $('#sHasPhone').value=settingsFilters.hasPhone?'1':'';
      $('#sSave').onclick=async ()=>{
        const z=($('#sZips').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        const types=['residential','commercial','land'].filter(v=>$$(`#settingsWrap input[value="${v}"]`)[0].checked);
        const strategies=['flip','brrrr','buyhold','wholesale','sellerfinance'].filter(v=>$$(`#settingsWrap input[value="${v}"]`)[0].checked);
        await db.ref(`userSettings/${uid}/wholesaler`).set({zips:z, types, strategies, hasPhone:($('#sHasPhone').value==='1'), leadsEnabled:true, settingsVersion:Date.now()});
        $('#sSaved').style.display='inline'; setTimeout(()=>$('#sSaved').style.display='none',1200);
        setRole('wh');
      };
    }

    // ===== ACQ =====
    let idx=0, current=null;
    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);
    const clean=s=>(s||'').toString().trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');
    const zipOf=a=>{const m=String(a||'').match(/\b\d{5}\b/); return m?m[0]:'';}

    function phoneHref(number,mode){
      const num=(number||'').replace(/[^\d+]/g,''); if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging';}
      if(mode==='gvoice'){navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages';}
      return `tel:${num}`;
    }
    function classifyLead(lead){
      const bag=[lead?.type,lead?.category,lead?.tags,lead?.notes,lead?.details,lead?.description,lead?.zoning,lead?.use].map(clean).join(' ').toLowerCase();
      const isLand=/\b(vacant|raw|unimproved)\s+(lot|land)\b/.test(bag)||/\blot\b/.test(bag)||/\bacre(s)?\b/.test(bag);
      const isComm=!isLand && (/\b(commercial|retail|industrial|warehouse|office|restaurant|hotel|motel|shopping|strip|mixed[- ]use|cap ?rate|nnn|self[ -]?storage|flex|medical|clinic|multifamily(?!\s*residential))\b/.test(bag));
      const isResi=!isLand && /\b(residential|single[- ]family|sfh|house|duplex|triplex|quad(plex)?|apartment|condo|townhome|mobile)\b/.test(bag);
      if(isComm) return 'commercial'; if(isResi) return 'residential'; if(isLand) return 'land'; return '';
    }
    function matchesStrategies(lead){
      const bag=`${lead?.notes||''} ${lead?.details||''} ${lead?.tags||''} ${lead?.description||''}`.toLowerCase();
      const map={flip:/\bflip|rehab|fix[ -]?and[ -]?flip|arv\b/, brrrr:/\bbrrrr\b/, buyhold:/\bbuy\s*&?\s*hold|cash\s*flow|rental\b/, wholesale:/\bwholesale|assignment\b/, sellerfinance:/\bseller[- ]?finance|owner[- ]?finance|carry\s*back\b/};
      if(!settingsFilters.strategies?.length) return true;
      return settingsFilters.strategies.some(k=>map[k]?.test(bag));
    }
    function computeFiltered(all){
      let arr=all.slice();
      if(settingsFilters.types?.length){
        const set=new Set(settingsFilters.types);
        arr=arr.filter(l=>set.has(classifyLead(l)));
      }
      if(settingsFilters.zips?.length){
        const zset=new Set(settingsFilters.zips);
        arr=arr.filter(l=>{const z=zipOf(l?.address||''); return z && zset.has(z);});
      }
      if(settingsFilters.hasPhone){ arr=arr.filter(l=>phoneOf(l)); }
      if(settingsFilters.strategies?.length){ arr=arr.filter(l=>matchesStrategies(l)); }
      return arr;
    }
    function telemetry(allCount, filteredCount){
      $('#telemetry').textContent =
        `Feed loaded: ${allCount} • After filter: ${filteredCount}` +
        (settingsFilters.version?` • settings v${settingsFilters.version}`:'');
    }

    function svSrc(a){return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(a||'')}`;}
    function mapSrc(a){return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(a||'')}`;}

    function renderLead(i){
      const arr=window.__filteredLeads||[];
      if(!arr.length){ $('#leadCard').innerHTML='<div class="body"><b>No leads match your settings.</b></div>'; return; }
      if(i<0) i=arr.length-1; if(i>=arr.length) i=0; idx=i; current=arr[idx];
      const name=clean(current?.contacts?.[0]?.name||'Unknown');
      const phone=phoneOf(current);
      const addr=clean(current?.address||'');
      const mode=getMode();
      $('#actCall').href=phoneHref(phone,mode);
      $('#actSMS').href=mode==='device'&&phone?`sms:${phone}`:phoneHref(phone,mode);
      $('#actDirections').href=addr?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addr)}`:'#';

      $('#leadCard').innerHTML=`
        <div class="title">${addr||name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>
          <div>
            <span class="chip">Dial: ${mode}</span>
            <span class="chip">${phone?'Phone on file':'Phone missing'}</span>
            ${settingsFilters.types?.length?`<span class="chip">Type: ${classifyLead(current)||'n/a'}</span>`:''}
            ${settingsFilters.zips?.length?`<span class="chip">ZIP: ${addr.match(/\b\d{5}\b/)?.[0]||'n/a'}</span>`:''}
          </div>
          <h3 style="margin:10px 0 6px;font-size:16px">Lead details</h3>
          <textarea id="noteInput" class="textarea" placeholder="Type notes here…"></textarea>
          <div style="margin-top:8px"><button id="saveNotes" class="btn btn-gold">💾 Save Notes</button></div>
          <iframe class="sv" src="${svSrc(addr)}" loading="lazy"></iframe>
          <iframe class="map" src="${mapSrc(addr)}" loading="lazy"></iframe>
        </div>`;

      const key='db_notes_'+(addr||name).toLowerCase().replace(/[^a-z0-9]+/g,'-');
      const ta=$('#noteInput'); ta.value=localStorage.getItem(key)||current?.notes||'';
      $('#saveNotes').onclick=()=>{localStorage.setItem(key,ta.value.trim()); toast('Notes saved');};
      $('#prevLead').onclick=()=>renderLead(idx-1);
      $('#nextLead').onclick=()=>renderLead(idx+1);
      $('#actCopy').onclick=()=>{ if(!phone) return alert('No phone on this lead.'); navigator.clipboard.writeText(phone).then(()=>toast('Phone copied')); };
      $('#actSettings').onclick=()=>{ const cur=getMode(); const next=cur==='device'?'textnow':cur==='textnow'?'gvoice':'device'; setMode(next); toast(`Dial mode: ${next}`); renderLead(idx); };
      $('#leadPhotos').onclick=()=>openPhotos('lead', current.id || (addr||name));
    }

    function recomputeAndRender(){
      const filtered=computeFiltered(window.leads||[]);
      window.__filteredLeads=filtered;
      setStatus(`Loaded ${filtered.length} lead(s)`);
      telemetry((window.leads||[]).length, filtered.length);
      renderLead(idx);
    }

    function loadLeadsScript(bust){
      const finish=()=>{
        if(Array.isArray(window.leads) && window.leads.length){
          $('#chooser').style.display='none'; $('#acqBar').style.display='block';
          recomputeAndRender();
        }else{
          window.leads=[{id:'demo-1',address:'3014 El Paso St, San Antonio, TX 78207',contacts:[{name:'Kevin Holdsworth',phone:'(210) 555-1212'}],notes:'2/1, 948 sqft, 1945 build — retail remodel in 2024',type:'residential'}];
          $('#chooser').style.display='none'; $('#acqBar').style.display='block';
          recomputeAndRender(); toast('Using demo leads (leads.js not found)');
        }
      };
      const s=document.createElement('script');
      s.src=(bust?('/leads.js?v='+Date.now()):'/leads.js');
      s.onload=finish; s.onerror=finish;
      document.head.appendChild(s);
    }

    function initAcqGate(){
      if(!settingsFilters.leadsEnabled){
        $('#acqBar').style.display='none';
        $('#acqWrap').style.display='none';
        $('#chooser').style.display='block';
        wireChooser();
        $('#csv').onchange=handleCSV;
        setStatus('Access to leads is not enabled yet.');
        return;
      }
      $('#acqWrap').style.display='block';
      $('#acqBar').style.display='block';
      loadLeadsScript(true);
    }

    function wireChooser(){
      $('#chooser').addEventListener('click',async e=>{
        const btn=e.target.closest('[data-req]'); if(!btn) return;
        const type=btn.getAttribute('data-req');
        const payload={uid, type:`Lead Access: ${type}`, ts:Date.now(), status:'new'};
        try{await db.ref('requests').push(payload); toast('Request sent');}
        catch{toast('Could not send request');}
      });
    }

    // CSV -> leads
    function handleCSV(ev){
      const f=ev.target.files?.[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{
        const txt=String(r.result||''); const rows=txt.split(/\r?\n/).filter(Boolean);
        const hdr=(rows.shift()||'').split(',').map(s=>s.trim().toLowerCase());
        const ix=n=>hdr.findIndex(h=>h===n);
        const iAddr=ix('address'), iName=ix('name'), iPhone=ix('phone'), iNotes=ix('notes');
        const slug=s=>String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^[-]|[-]$/g,'');
        const arr=rows.map(line=>{
          const cols=line.split(',');
          return {id: slug(cols[iAddr]||('lead-'+Date.now()+Math.random().toString(16).slice(2))),
                  address:cols[iAddr]||'', contacts:[{name:cols[iName]||'', phone:cols[iPhone]||''}], notes:cols[iNotes]||''};
        });
        window.leads=(window.leads||[]).concat(arr);
        $('#csvMsg').textContent=`Loaded ${arr.length} lead(s) from CSV.`;
        $('#acqWrap').style.display='block'; $('#acqBar').style.display='block';
        recomputeAndRender();
      };
      r.readAsText(f);
    }

    // Photos (Storage + progress)
    async function compressImage(file, maxSide){
      return new Promise((resolve)=>{
        if(!/^image\//.test(file.type)) return resolve(file);
        const img=new Image(); const fr=new FileReader();
        img.onload=()=>{ const c=document.createElement('canvas'), ctx=c.getContext('2d'); let w=img.width,h=img.height;
          const s=Math.min(1,maxSide/Math.max(w,h)); c.width=w*s; c.height=h*s; ctx.drawImage(img,0,0,c.width,c.height);
          c.toBlob(b=>b?resolve(new File([b],file.name,{type:'image/jpeg'})):resolve(file),'image/jpeg',0.85); };
        img.onerror=()=>resolve(file); fr.onload=()=>img.src=fr.result; fr.readAsDataURL(file);
      });
    }
    async function uploadFilesWithBar(files, ctx, id, progressEl){
      progressEl.style.display='grid'; progressEl.innerHTML='';
      const tasks=[...files].map(async (file, ix)=>{
        const comp=await compressImage(file,1600);
        const key=Date.now()+'-'+ix+'-'+Math.random().toString(16).slice(2);
        const ref=storage.ref().child(`photos/${uid}/${ctx}/${id}/${key}`);
        const row=document.createElement('div'); row.className='muted'; row.innerHTML=`${file.name}<div class="bar"><i style="width:0%"></i></div>`;
        progressEl.appendChild(row);
        try{ await ref.put(comp); const url=await ref.getDownloadURL();
             await db.ref(`photosIndex/${uid}/${ctx}/${id}/${key}`).set({url, bytes:comp.size, order:ix, createdAt:Date.now()});
             row.querySelector('i').style.width='100%';
        }catch(e){ row.querySelector('i').style.width='0%'; row.innerHTML += ' <span style="color:#ff9f9f">failed</span>'; }
      });
      await Promise.all(tasks);
    }
    async function openPhotos(ctx, id){
      const d=document.createElement('dialog');
      d.innerHTML=`<div class="modal-head"><strong>Photos</strong><button id="x" class="btn btn-ghost btn-small">✖</button></div>
      <div class="modal-body">
        <div id="list" class="muted" style="margin-bottom:8px">Loading…</div>
        <div style="display:flex;gap:8px;align-items:center"><input id="up" type="file" accept="image/*" multiple capture="environment"/><button id="refresh" class="btn">↻ Refresh</button></div>
        <div id="bar" class="progressRow" style="display:none"></div>
      </div>`;
      document.body.appendChild(d);
      const listEl=d.querySelector('#list'), bar=d.querySelector('#bar');
      async function load(){
        const snap=await db.ref(`photosIndex/${uid}/${ctx}/${id}`).get();
        const arr=Object.values(snap.val()||{}).sort((a,b)=>(a.order||0)-(b.order||0));
        listEl.innerHTML = arr.length? arr.map((m,i)=>`<a href="${m.url}" target="_blank" rel="noopener">Photo ${i+1}</a>`).join(' · ') : 'No photos yet';
      }
      await load();
      d.querySelector('#x').onclick=()=>d.close(); d.addEventListener('close',()=>d.remove());
      d.querySelector('#refresh').onclick=load;
      d.querySelector('#up').onchange=async e=>{ const files=e.target.files; if(!files?.length) return; await uploadFilesWithBar(files,ctx,id,bar); await load(); };
      d.showModal();
    }

    // Add Lead (minimal)
    $('#addLead').onclick=()=>{
      const d=document.createElement('dialog');
      d.innerHTML=`<div class="modal-head"><strong>New Lead</strong><button id="x" class="btn btn-ghost btn-small">✖</button></div>
      <div class="modal-body">
        <div style="display:grid;gap:8px">
          <input id="a" class="input" placeholder="Address"/>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><input id="n" class="input" placeholder="Contact name"/><input id="p" class="input" placeholder="Phone"/></div>
          <textarea id="notes" class="textarea" placeholder="Notes"></textarea>
          <input id="photos" type="file" accept="image/*" multiple capture="environment"/>
          <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancel" class="btn btn-ghost">Cancel</button><button id="save" class="btn btn-green">Save</button></div>
        </div>
        <div id="bar" class="progressRow" style="display:none"></div>
      </div>`;
      document.body.appendChild(d);
      const slug=s=>String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^[-]|[-]$/g,'');
      d.querySelector('#x').onclick=()=>d.close(); d.querySelector('#cancel').onclick=()=>d.close();
      d.addEventListener('close',()=>d.remove());
      d.querySelector('#save').onclick=async ()=>{
        const address=d.querySelector('#a').value.trim(); if(!address){ alert('Address required'); return; }
        const id=slug(address)||('lead-'+Date.now());
        const lead={id,address,contacts:[{name:d.querySelector('#n').value.trim(),phone:d.querySelector('#p').value.trim()}],notes:d.querySelector('#notes').value.trim(),createdAt:Date.now(),createdBy:uid,status:'acq'};
        try{ await db.ref(`leads/${uid}/${id}`).set(lead); window.leads=(window.leads||[]); window.leads.unshift(lead); }
        catch(e){ try{ const key='localLeads_'+uid; const bag=JSON.parse(localStorage.getItem(key)||'[]'); bag.unshift(lead); localStorage.setItem(key,JSON.stringify(bag)); window.leads=(window.leads||[]); window.leads.unshift(lead); toast('Lead saved locally'); }catch{} }
        const files=d.querySelector('#photos').files; if(files?.length) await uploadFilesWithBar(files,'lead',id,d.querySelector('#bar'));
        recomputeAndRender(); d.close();
      };
      d.showModal();
    };

    // Reload
    $('#reloadLeads').onclick=()=>{ window.leads=[]; window.__filteredLeads=[]; loadLeadsScript(true); toast('Reloading leads…'); };

    // ===== DISPO =====
    let currentDeal=null;
    function toArr(o){return o?Object.values(o):[];}

    function setPreviewOffering(o){
      $('#dealPreview').style.display='none';
      $('#sofPreview').style.display='block';
      $('#previewTitle').textContent=o.title||'Statement of Facts';
      $('#sofPreview').src = o.sof || o.sofUrl || 'https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview';
    }
    function setPreviewDeal(d){
      currentDeal=d; $('#sofPreview').style.display='none'; $('#dealPreview').style.display='block';
      $('#previewTitle').textContent=d.title||'Deal Photos';
      $('#dealMeta').textContent=[d.location, d.price?`Price: ${d.price}`:'', d.terms?`Terms: ${d.terms}`:''].filter(Boolean).join(' • ');
      $('#openDealGallery').onclick=()=>openPhotos('deal', d.id);
    }

    async function loadDispo(){
      setStatus('Loading dispo…');
      const [g1,u1,g2,u2]=await Promise.all([
        db.ref('offerings/global').get().catch(()=>({val:()=>null})),
        db.ref(`offerings/${uid}`).get().catch(()=>({val:()=>null})),
        db.ref('deals/global').get().catch(()=>({val:()=>null})),
        db.ref(`deals/${uid}`).get().catch(()=>({val:()=>null}))
      ]);
      let offerings=[...toArr(g1.val()),...toArr(u1.val())];
      if(!offerings.length){
        offerings=[{id:'booth',title:'Booth St. — Offering Memorandum',sof:'https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview',badges:['Instrument: Note','Amt: $30k','Term: 3–6 mo','Juris: TX']}];
      }
      const offerWrap=$('#offerCards'); offerWrap.innerHTML='';
      offerings.forEach((o,i)=>{
        const card=document.createElement('div'); card.className='offerCard';
        card.innerHTML=`<div style="font-size:24px">📄</div><div style="flex:1"><div style="font-weight:900">${o.title||'Offering'}</div></div><div><button class="btn">Open</button></div>`;
        card.onclick=()=>setPreviewOffering(o); offerWrap.appendChild(card);
        if(i===0) setPreviewOffering(o);
      });

      // Deals (+ local fallback)
      const key='localDeals_'+uid;
      let deals=[...toArr(g2.val()),...toArr(u2.val())];
      try{ deals=[...deals, ...Object.values(JSON.parse(localStorage.getItem(key)||'{}'))]; }catch{}
      if(!deals.length){
        deals=[{id:'booth-wholesale',title:'Booth St. — Wholesale',location:'Booth St, TX',price:'$145,000',terms:'Assignment',tags:['SFH','Light rehab']}];
      }
      const dealWrap=$('#dealCards'); dealWrap.innerHTML='';
      deals.forEach((d,i)=>{
        const card=document.createElement('div'); card.className='dealCard';
        card.innerHTML=`<div style="font-size:24px">🧾</div>
          <div style="flex:1"><div style="font-weight:900">${d.title||'Deal'}</div>
          <div class="muted" style="margin-top:4px">${[d.location, d.price?`Price: ${d.price}`:'', d.terms?`Terms: ${d.terms}`:''].filter(Boolean).join(' • ')}</div></div>
          <div><button class="btn btn-ghost btn-small" data-edit="${d.id}">✏️ Edit</button>
          <button class="btn btn-ghost btn-small" data-photos="${d.id}">📷</button></div>`;
        card.addEventListener('click',e=>{ if(e.target.closest('button')) return; setPreviewDeal(d); });
        dealWrap.appendChild(card);
        if(i===0) setPreviewDeal(d);
      });
      dealWrap.onclick=e=>{
        const ed=e.target.closest('[data-edit]'); const ph=e.target.closest('[data-photos]');
        if(ed){ openDealForm(deals.find(x=>x.id===ed.dataset.edit)); }
        if(ph){ openPhotos('deal', ph.dataset.photos); }
      };

      $('#offerSearch').oninput=e=>{const q=(e.target.value||'').toLowerCase(); [...offerWrap.children].forEach(c=>c.style.display=c.textContent.toLowerCase().includes(q)?'flex':'none');};
      $('#dealSearch').oninput=e=>{const q=(e.target.value||'').toLowerCase(); [...dealWrap.children].forEach(c=>c.style.display=c.textContent.toLowerCase().includes(q)?'flex':'none');};

      $('#dealPhotosBtn').onclick=()=>{ if(!currentDeal) return toast('Select a deal first'); openPhotos('deal', currentDeal.id); };
      setStatus('Dispo ready');
    }

    // Add/Edit Deal with fallback
    function openDealForm(existing){
      const d=document.createElement('dialog');
      const isEdit=!!existing;
      d.innerHTML=`<div class="modal-head"><strong>${isEdit?'Edit Deal':'New Deal'}</strong><button id="x" class="btn btn-ghost btn-small">✖</button></div>
      <div class="modal-body">
        <div style="display:grid;gap:8px">
          <input id="t" class="input" placeholder="Title" value="${existing?.title||''}"/>
          <input id="loc" class="input" placeholder="Location (City, ST)" value="${existing?.location||''}"/>
          <input id="price" class="input" placeholder="Price" value="${existing?.price||''}"/>
          <input id="terms" class="input" placeholder="Terms" value="${existing?.terms||''}"/>
          <input id="tags" class="input" placeholder="Tags (comma separated)" value="${(existing?.tags||[]).join(', ')}"/>
          <textarea id="notes" class="textarea" placeholder="Short description">${existing?.notes||''}</textarea>
          <input id="photos" type="file" accept="image/*" multiple/>
          <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancel" class="btn btn-ghost">Cancel</button><button id="save" class="btn btn-green">${isEdit?'Save Changes':'Save Deal'}</button></div>
        </div>
        <div id="bar" class="progressRow" style="display:none"></div>
      </div>`;
      document.body.appendChild(d);
      d.querySelector('#x').onclick=()=>d.close();
      d.querySelector('#cancel').onclick=()=>d.close();
      d.addEventListener('close',()=>d.remove());
      d.querySelector('#save').onclick=async ()=>{
        const title=d.querySelector('#t').value.trim(); if(!title){ alert('Title required'); return; }
        const slug=s=>String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^[-]|[-]$/g,'');
        const id=isEdit?(existing.id):(slug(title)||('deal-'+Date.now()));
        const v={id,title,location:d.querySelector('#loc').value.trim(),price:d.querySelector('#price').value.trim(),terms:d.querySelector('#terms').value.trim(),
                 tags:(d.querySelector('#tags').value||'').split(',').map(s=>s.trim()).filter(Boolean), notes:d.querySelector('#notes').value.trim(),
                 updatedAt:Date.now(), createdBy:uid, status:'active'};
        if(!isEdit) v.createdAt=Date.now();
        let ok=false;
        try{ await db.ref(`deals/${uid}/${id}`).set(v); ok=true; }
        catch(e){ try{ const key='localDeals_'+uid; const bag=JSON.parse(localStorage.getItem(key)||'{}'); bag[id]=v; localStorage.setItem(key,JSON.stringify(bag)); ok=true; toast('Deal saved locally'); }catch{} }
        if(ok){
          const files=d.querySelector('#photos').files; if(files?.length) await uploadFilesWithBar(files,'deal',id,d.querySelector('#bar'));
          d.close(); loadDispo();
        }else alert('Could not save deal');
      };
      d.showModal();
    }
    $('#addOffering').onclick=()=>{
      const d=document.createElement('dialog');
      d.innerHTML=`<div class="modal-head"><strong>New Offering</strong><button id="x" class="btn btn-ghost btn-small">✖</button></div>
      <div class="modal-body">
        <div style="display:grid;gap:8px">
          <input id="t" class="input" placeholder="Title"/>
          <input id="sof" class="input" placeholder="SOF preview URL (Google Drive etc.)"/>
          <input id="photos" type="file" accept="image/*" multiple/>
          <div style="display:flex;gap:8px;justify-content:flex-end"><button id="cancel" class="btn btn-ghost">Cancel</button><button id="save" class="btn btn-green">Save Offering</button></div>
        </div>
        <div id="bar" class="progressRow" style="display:none"></div>
      </div>`;
      document.body.appendChild(d);
      d.querySelector('#x').onclick=()=>d.close(); d.querySelector('#cancel').onclick=()=>d.close();
      d.addEventListener('close',()=>d.remove());
      d.querySelector('#save').onclick=async ()=>{
        const title=d.querySelector('#t').value.trim(); if(!title){ alert('Title required'); return; }
        const id=title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^[-]|[-]$/g,'');
        const off={id,title,sof:d.querySelector('#sof').value.trim(),createdAt:Date.now(),createdBy:uid,status:'active'};
        try{ await db.ref(`offerings/${uid}/${id}`).set(off); const files=d.querySelector('#photos').files; if(files?.length) await uploadFilesWithBar(files,'offering',id,d.querySelector('#bar')); d.close(); loadDispo(); }
        catch(e){ alert('Could not save offering'); }
      };
      d.showModal();
    };

    // Init
    setRole('wh');
  </script>
</body>
</html>
