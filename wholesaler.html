<!-- =============================== Wholesaler Portal (auth-ready; source chooser; gated Acq; Dispo intact) =============================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler Portal</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

  <style>
    :root{ --bg1:#0b131b; --bg2:#142838; --bg3:#173c53; --line:#2a5a78; --text:#f3f8fb; --muted:#c7d7e6;
           --gold:#ffd36b; --green:#26cf84; --blue:#47b4ff; --r:16px; --shadow:0 28px 70px rgba(0,0,0,.55); }
    *{box-sizing:border-box}
    body{ margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
                  linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3)); padding:10px; }
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
    .top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px}
    .crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
    .status{font-size:12px;color:#e8f7ff}
    .sticky{position:sticky;top:0;z-index:8;padding:10px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}
    .actions{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;font-weight:800;
      border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
    .btn:hover{filter:brightness(1.08)} .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
    .btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none} .btn-ghost{background:#0f2a3a}
    .ico{font-size:18px} .label{font-weight:800}
    .navrow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}

    .lead-wrap{padding:12px}
    .lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(90deg,rgba(255,211,107,.22),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}
    .sv,.map{width:100%;border:0;border-radius:14px;background:#fff} .sv{height:260px;margin-top:6px} .map{height:220px;margin-top:8px}
    .notesBox{display:grid;gap:8px;margin:8px 0 10px}
    .textarea{width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:#0d2130;color:#eaf6ff;font-size:14px;line-height:1.4}
    .notesRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .savedTag{font-size:12px;color:#bfe9c9;opacity:.9;display:none}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card2{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px}
    .offer-card{display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,.18);background:#0f2a3a;border-radius:12px;padding:10px}
    .offer-title{font-weight:900} .offer-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;background:#112f45;border:1px solid rgba(255,255,255,.18);padding:4px 8px;border-radius:999px}

    @media (max-width:680px){ .actions{grid-template-columns:repeat(3,1fr)} .navrow{grid-template-columns:repeat(3,1fr)}
      .sv{height:230px} .map{height:200px} .grid{grid-template-columns:1fr} }

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;color:#fff;padding:10px 14px;border-radius:12px;
      border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}

    /* Onboarding */
    .onboard{padding:16px}
    .src-grid{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:12px}
    @media (max-width:640px){ .src-grid{grid-template-columns:1fr} }
    .src{border:1px solid rgba(255,255,255,.18);border-radius:14px;background:#0f2233;padding:12px}
    .src h4{margin:0 0 6px}
    .muted{color:#c7d7e6} .hidden{display:none} .small{font-size:12px;opacity:.85}
    .drop{border:1px dashed rgba(255,255,255,.25);border-radius:12px;padding:10px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="crumbs"><span>Wholesaler</span><span class="dot"></span><span id="modeCrumb">Acquisition</span></div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- STICKY ACTIONS (Acq only) -->
      <div class="sticky" id="acqBar" style="display:none">
        <div class="actions">
          <a class="btn btn-gold" href="#" id="actCall"><span class="ico">üìû</span><span class="label">Call</span></a>
          <a class="btn btn-gold" href="#" id="actSMS"><span class="ico">üí¨</span><span class="label">Text</span></a>
          <button class="btn btn-ghost" id="actCopy"><span class="ico">üìã</span><span class="label">Copy</span></button>
          <a class="btn btn-ghost" href="https://drive.google.com" target="_blank" rel="noopener"><span class="ico">üìÅ</span><span class="label">Drive</span></a>
          <button class="btn btn-ghost" id="actSettings"><span class="ico">‚öôÔ∏è</span><span class="label">Dial Pref</span></button>
        </div>
        <div class="navrow">
          <button class="btn btn-ghost" id="btnPrev">‚óÄ <span class="label">Prev</span></button>
          <button class="btn btn-ghost" id="btnRandom">üé≤ <span class="label">Random</span></button>
          <button class="btn btn-green" id="btnNext">‚ñ∂ <span class="label">Next</span></button>
        </div>
      </div>

      <!-- ACQ: Lead viewer -->
      <div class="lead-wrap" id="acqWrap" style="display:none">
        <div id="leadCard" class="lead"><div class="body">Initializing‚Ä¶</div></div>
      </div>

      <!-- ACQ: Onboarding -->
      <div id="onboardWrap" class="onboard hidden">
        <h3 style="margin:4px 0 8px">Choose how you want to work leads</h3>
        <p class="muted small" style="margin:0 0 10px">You won‚Äôt see any leads until you pick a source.</p>
        <div class="src-grid">
          <div class="src">
            <h4>üöó Street Leads</h4>
            <p class="muted small">We assign routes / zip filters after approval.</p>
            <button id="reqStreet" class="btn btn-gold">Request Street Leads</button>
          </div>
          <div class="src">
            <h4>üåê Web Leads</h4>
            <p class="muted small">Online lead lists & skip tracing, after approval.</p>
            <button id="reqWeb" class="btn btn-gold">Request Web Leads</button>
          </div>
          <div class="src">
            <h4>üìû Live Leads</h4>
            <p class="muted small">Warm, real-time handoffs when available.</p>
            <button id="reqLive" class="btn btn-gold">Request Live Leads</button>
          </div>
          <div class="src">
            <h4>üì• Use My Own CRM / List</h4>
            <p class="muted small">Upload CSV or paste JSON to use your own leads now.</p>
            <div class="drop" id="csvDrop">
              <input id="csvInput" type="file" accept=".csv" class="hidden"/>
              <button id="pickCsv" class="btn">Upload CSV</button>
              <div class="small" style="margin-top:6px">Columns: address, name, phone, notes</div>
            </div>
            <div style="margin-top:8px">
              <textarea id="jsonBox" class="textarea" placeholder='‚Ä¶or paste JSON: [{"address":"123 Main‚Ä¶","contacts":[{"name":"‚Ä¶","phone":"‚Ä¶"}]}]'></textarea>
              <button id="useJson" class="btn" style="margin-top:6px">Use This List</button>
            </div>
          </div>
        </div>
      </div>

      <!-- DISPO -->
      <div id="dispoWrap" style="display:none; padding:12px">
        <div class="grid">
          <div class="card2">
            <h3 style="margin:0 0 8px">Active Offerings</h3>
            <div class="offer-card" style="margin-bottom:10px">
              <div style="font-size:28px">üõ¢Ô∏è</div>
              <div style="flex:1">
                <div class="offer-title">Virgin D6 Lift ‚Äî FOB Houston</div>
                <div class="offer-badges">
                  <span class="badge">Capital Need: $300k</span>
                  <span class="badge">Repay: 7‚Äì10 days</span>
                  <span class="badge">100M gallons</span>
                </div>
                <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                  <a class="btn btn-gold" href="offering-memo2.html?sof=https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview" target="_blank" rel="noopener">Open Offering Memo</a>
                  <a class="btn btn-ghost" href="offering-memo2.html?sof=https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview#interest" target="_blank" rel="noopener">Submit Interest</a>
                </div>
              </div>
            </div>
            <div class="offer-card" style="opacity:.85">
              <div style="font-size:26px">üèóÔ∏è</div>
              <div style="flex:1">
                <div class="offer-title">Add your first Dispo offering</div>
                <div class="offer-badges"><span class="badge">Bring your deal</span><span class="badge">Upload docs</span></div>
                <div style="margin-top:8px"><a class="btn btn-ghost" href="#" onclick="alert('Coming soon: create-offering.html');return false;">Create Offering</a></div>
              </div>
            </div>
          </div>
          <div class="card2">
            <h3 style="margin:0 0 8px">Statement of Facts (Inline Preview)</h3>
            <iframe id="dispoSOF" title="SOF" style="width:100%;height:520px;border:0;border-radius:12px;background:#fff"
              src="https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview" allow="autoplay"></iframe>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Dial preference dialog -->
  <dialog id="settingsDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:520px;width:92%">
    <h3 style="margin:0 0 8px">Phone Link Preference</h3>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMode" class="btn" style="flex:1">Save</button>
      <button id="closeMode" class="btn" style="flex:1">Close</button>
    </div>
  </dialog>

  <div id="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    // Initialize (same project as parent; includes Auth so DB reads are authenticated)
    const app = firebase.initializeApp({
      apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
      authDomain:"deal-bankers.firebaseapp.com",
      databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",
      projectId:"deal-bankers"
    }, "wh-portal");
    const auth = firebase.auth(app);
    const db   = firebase.database(app);

    // URL params
    const urlp   = new URL(location.href).searchParams;
    const sub    = (urlp.get('sub')||urlp.get('mode')||'acq').toLowerCase();
    const uidQP  = urlp.get('uid') || '';
    const whTypes = (urlp.get('whTypes')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    const whZips  = (urlp.get('whZips')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const zipSet = new Set(whZips);
    const hasTypeFilter = whTypes.length>0;

    // UI helpers
    const $=s=>document.querySelector(s);
    function toast(t){ const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1600); }
    function setStatus(t){ $('#status').textContent=t; }
    function showAcq(){ $('#modeCrumb').textContent='Acquisition'; $('#acqBar').style.display='block'; $('#acqWrap').style.display='block'; $('#dispoWrap').style.display='none'; }
    function showDispo(){ $('#modeCrumb').textContent='Dispo'; $('#acqBar').style.display='none'; $('#acqWrap').style.display='none'; $('#dispoWrap').style.display='block'; setStatus('Offerings'); }
    if(sub==='dispo'){ showDispo(); } else { showAcq(); }

    // Auth handshake: wait for sign-in so DB rules with auth work inside the iframe
    auth.onAuthStateChanged(async (u)=>{
      try{
        const uid = (u && u.uid) ? u.uid : (uidQP || 'anon');

        if(sub==='acq'){
          await runAcq(uid, u);   // whole acquisition flow
        }else{
          setStatus('Offerings');
        }
      }catch(err){
        console.error(err);
        setStatus('Could not load. Try again.');
        // If something fails, at least show onboarding so users can request access
        showOnboarding(true);
        wireOnboarding({uid:(auth.currentUser?.uid||uidQP||'anon'), email:(auth.currentUser?.email||''), name:(auth.currentUser?.displayName||'')});
      }
    });

    // Acquisition flow
    async function runAcq(uid, user){
      setStatus('Checking access‚Ä¶');
      const choiceSnap = await db.ref(`userSettings/${uid}/wholesaler/source`).get();
      const gateSnap   = await db.ref(`userSettings/${uid}/wholesaler/leadsEnabled`).get();
      const choice = choiceSnap.val() || '';
      const allowed = !!gateSnap.val();

      if(!choice){
        setStatus('Pick a lead source to continue');
        showOnboarding(true);
        wireOnboarding({uid, email:user?.email||'', name:user?.displayName||''});
        return;
      }
      if(choice!=='mine' && !allowed){
        setStatus('Awaiting approval');
        showOnboarding(true);
        $('#onboardWrap').insertAdjacentHTML('afterbegin','<div class="muted" style="margin:0 0 8px">Request submitted. We‚Äôll unlock your routes/filters when approved.</div>');
        wireOnboarding({uid, email:user?.email||'', name:user?.displayName||''});
        return;
      }

      // Ready to show the dialer
      showOnboarding(false);
      if(choice==='mine'){
        // Their own list was saved previously (CSV/JSON). If not present yet, prompt again.
        setStatus('Ready');
        if(!window.leads){ showOnboarding(true); wireOnboarding({uid, email:user?.email||'', name:user?.displayName||''}); return; }
        initAcq(); return;
      }

      // House-provided: load /leads.js
      setStatus('Loading leads‚Ä¶');
      const s=document.createElement('script');
      s.src='/leads.js?v='+Date.now();
      s.onload=()=>{ window.leads = window.leads || []; initAcq(); };
      s.onerror=()=>{ setStatus('Could not load /leads.js'); $('#leadCard').innerHTML='<div class="body">No leads loaded.</div>'; };
      document.head.appendChild(s);
    }

    // Show/hide onboarding
    function showOnboarding(show=true){
      $('#onboardWrap').classList.toggle('hidden', !show);
      $('#acqWrap').style.display = show ? 'none' : 'block';
      $('#acqBar').style.display  = show ? 'none' : 'block';
    }

    // Onboarding event wiring
    function wireOnboarding({uid,email,name}){
      async function writeChoice(val){ await db.ref(`userSettings/${uid}/wholesaler/source`).set(val); }
      async function sendReq(type){
        await db.ref('requests').push({uid, email:email||'', name:name||'', type, status:'new', ts:Date.now()});
      }
      $('#reqStreet').onclick = async()=>{ await writeChoice('street'); await sendReq('Street Leads Access'); toast('Request sent'); setStatus('Requested Street Leads'); };
      $('#reqWeb').onclick    = async()=>{ await writeChoice('web');    await sendReq('Web Leads Access');    toast('Request sent'); setStatus('Requested Web Leads'); };
      $('#reqLive').onclick   = async()=>{ await writeChoice('live');   await sendReq('Live Leads Access');   toast('Request sent'); setStatus('Requested Live Leads'); };

      // Own list: CSV/JSON (renders immediately without approval)
      $('#pickCsv').onclick = ()=>$('#csvInput').click();
      $('#csvInput').addEventListener('change', async (e)=>{
        const f=e.target.files?.[0]; if(!f) return;
        const text=await f.text(); const rows=csvToObjects(text);
        if(!rows.length) return alert('No rows found. Expected columns: address, name, phone, notes');
        await writeChoice('mine');
        window.leads = mapRowsToLeads(rows);
        showOnboarding(false); setStatus('Ready'); initAcq();
      });
      $('#useJson').onclick = async ()=>{
        try{
          const arr = JSON.parse($('#jsonBox').value||'[]');
          if(!Array.isArray(arr)||!arr.length) return alert('Invalid JSON array.');
          await writeChoice('mine');
          window.leads = arr; showOnboarding(false); setStatus('Ready'); initAcq();
        }catch{ alert('JSON parse error.'); }
      };
    }

    // CSV helpers
    function csvToObjects(text){
      const lines=text.replace(/\r/g,'').split('\n').filter(Boolean);
      if(!lines.length) return [];
      const headers=splitCSV(lines[0]).map(h=>h.trim().toLowerCase());
      const idx={address:headers.indexOf('address'),name:headers.indexOf('name'),phone:headers.indexOf('phone'),notes:headers.indexOf('notes')};
      const out=[];
      for(let i=1;i<lines.length;i++){
        const parts=splitCSV(lines[i]);
        const get=j=>(j>=0&&j<parts.length)?parts[j].trim():'';
        out.push({address:get(idx.address),name:get(idx.name),phone:get(idx.phone),notes:get(idx.notes)});
      }
      return out.filter(o=>o.address||o.phone||o.name);
    }
    function splitCSV(line){
      const out=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c==='\"'){ if(q && line[i+1]==='\"'){ cur+='\"'; i++; } else { q=!q; } }
        else if(c===',' && !q){ out.push(cur); cur=''; }
        else cur+=c;
      }
      out.push(cur); return out;
    }
    function mapRowsToLeads(rows){ return rows.map(r=>({address:r.address||'',notes:r.notes||'',contacts:[{name:r.name||'',phone:r.phone||''}]})); }

    // ---- ACQ (viewer) ----
    let idx=0, currentLead=null;
    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);
    const clean=s=>(s||'').trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');
    const extractZip = (addr='') => (String(addr).match(/\b\d{5}\b/)||[''])[0];
    const leadType = (lead) => {
      const t=(lead?.type||lead?.category||lead?.tags||'').toString().toLowerCase();
      if(t.includes('comm')) return 'commercial';
      if(t.includes('resi')||t.includes('sfr')||t.includes('home')||t.includes('house')) return 'residential';
      return '';
    };
    function phoneHref(num,mode){ const n=(num||'').replace(/[^\d+]/g,''); if(!n) return '#';
      if(mode==='device') return `tel:${n}`; if(mode==='textnow'){ navigator.clipboard?.writeText(n); return 'https://www.textnow.com/messaging'; }
      if(mode==='gvoice'){ navigator.clipboard?.writeText(n); return 'https://voice.google.com/u/0/messages'; } return `tel:${n}`; }
    function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr)}`; }
    function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr)}`; }
    const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
    const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
    const saveTimeKey = addr => noteKey(addr)+'_ts';
    const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
    const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);
    function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px'; }

    function applyFilters(all){
      let arr=all;
      if(hasTypeFilter){ arr=arr.filter(l=>{ const lt=leadType(l); return lt?whTypes.includes(lt):true; }); }
      if(zipSet.size){ arr=arr.filter(l=>{ const z=extractZip(l?.address||''); return z && zipSet.has(z); }); }
      return arr;
    }

    function initAcq(){
      const all=Array.isArray(window.leads)?window.leads.slice():[];
      const filtered=applyFilters(all);
      if(!filtered.length){
        $('#leadCard').innerHTML=`<div class="body"><b>No leads match your filters.</b>
          <div style="margin-top:6px;font-size:13px;opacity:.85">Types: ${hasTypeFilter?whTypes.join(', '):'any'} ‚Ä¢ Zips: ${whZips.length?whZips.join(', '):'any'}</div></div>`;
        setStatus('0 leads after filters'); return;
      }
      window.__filteredLeads=filtered; showAcq(); setStatus(`Loaded ${filtered.length} lead(s)`); render(0);
    }

    function render(i){
      const arr=window.__filteredLeads||[]; if(!arr.length){ $('#leadCard').innerHTML='<div class="body">No leads loaded.</div>'; setStatus('No leads found'); return; }
      if(i<0) i=arr.length-1; if(i>=arr.length) i=0; idx=i;
      const lead=arr[idx]; currentLead=lead;
      const name=clean(lead?.contacts?.[0]?.name||'Unknown'); const phone=phoneOf(lead); const addr=clean(lead?.address||'');
      setStatus(`Lead ${idx+1} of ${arr.length}`);
      const mode=getMode(); $('#actCall').href=phoneHref(phone,mode); $('#actSMS').href = mode==='device' && phone ? `sms:${phone}` : phoneHref(phone,mode);
      const lastSaved=saveTimeGet(addr); const lastSavedText=lastSaved?`Saved ${fmtTime(lastSaved)}`:'Not saved yet';
      $('#leadCard').innerHTML=`<div class="title">${addr||name}</div><div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>
          <div class="chips">
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <div class="chip">Dial: ${mode}</div>
            ${hasTypeFilter?`<div class="chip">Type: ${leadType(lead)||'n/a'}</div>`:''}
            ${zipSet.size?`<div class="chip">ZIP: ${extractZip(addr)||'n/a'}</div>`:''}
          </div>
          <h3 style="margin:10px 0 6px;font-size:16px">Lead details</h3>
          <div class="notesBox">
            <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶"></textarea>
            <div class="notesRow">
              <button id="inlineSave" class="btn btn-gold"><span class="ico">üíæ</span><span class="label">Save Notes</span></button>
              <span id="savedTag" class="savedTag">${lastSavedText}</span>
            </div>
          </div>
          <iframe class="sv" src="${svSrc(addr)}" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Street View"></iframe>
          <iframe class="map" src="${mapSrc(addr)}" loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Map"></iframe>
        </div>`;
      const ta=$('#noteInput'); ta.value=loadNotes(addr) || (lead?.notes||''); autoGrow(ta); ta.addEventListener('input',()=>autoGrow(ta));
      $('#inlineSave').onclick=()=>{ const text=(ta.value||'').trim(); saveNotes(addr,text); const ts=Date.now(); saveTimeSet(addr,ts);
        const tag=$('#savedTag'); if(tag){ tag.textContent=`Saved ${fmtTime(ts)}`; tag.style.display='inline'; } toast('Notes saved'); };
    }

    // Small actions
    document.addEventListener('click',e=>{ if(e.target.id==='btnPrev') render(idx-1); if(e.target.id==='btnNext') render(idx+1);
      if(e.target.id==='btnRandom') render(Math.floor(Math.random()*((window.__filteredLeads||[]).length||1))); });
    $('#actCopy')?.addEventListener('click',()=>{ const arr=window.__filteredLeads||[]; const p=phoneOf(arr[idx]||{}); if(!p) return alert('No phone on this lead.');
      navigator.clipboard.writeText(p).then(()=>toast('Phone copied')); });
    const dlg=$('#settingsDlg'); $('#actSettings')?.addEventListener('click',()=>{ dlg.showModal(); const cur=(localStorage.getItem(MODE_KEY)||'device');
      dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked=(r.value===cur)); });
    $('#saveMode')?.addEventListener('click',()=>{ const m=dlg.querySelector('input[name="mode"]:checked')?.value||'device'; localStorage.setItem(MODE_KEY,m); dlg.close(); render(idx); });
    $('#closeMode')?.addEventListener('click',()=>dlg.close());
    document.addEventListener('keydown',e=>{ if(sub!=='acq') return; if(e.key==='ArrowLeft') return render(idx-1); if(e.key==='ArrowRight') return render(idx+1);
      if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); const ta=$('#noteInput'); if(ta){ ta.blur(); $('#inlineSave')?.click(); } } });
    window.addEventListener('beforeunload',()=>{ if(sub==='acq' && currentLead){ const ta=$('#noteInput'); if(ta){ const addr=currentLead.address||''; saveNotes(addr,(ta.value||'').trim()); } } });
  </script>
</body>
</html>
