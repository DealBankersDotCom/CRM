<!-- ================================= wholesaler.html (Acq+Dispo; request-gated; improved type filter) ================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wholesaler Portal</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
<style>
/* (same styles as you already have) */
</style>
</head>
<body>
  <!-- header + acq/dispo UI identical to your last version; omitted styles for brevity -->

  <!-- Dispo offering uses offering-memo2.html -->
  <!-- ... inside your Dispo block, ensure links use memo2: -->
  <!--
     <a class="btn btn-gold" href="offering-memo2.html?sof=GDRIVE_PREVIEW_URL" ...>Open Offering Memo</a>
  -->

  <!-- Firebase + Logic -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    const gateApp=firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const gateDb=gateApp.database();

    const urlp=new URL(location.href).searchParams;
    const sub=(urlp.get('sub')||urlp.get('mode')||'acq').toLowerCase();
    const uidParam=urlp.get('uid')||'anon';
    const whTypes=(urlp.get('whTypes')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    const whZips=(urlp.get('whZips')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const hasTypeFilter=whTypes.length>0; const zipSet=new Set(whZips);

    const $=s=>document.querySelector(s);
    function setStatus(t){ const s=document.getElementById('status'); if(s) s.textContent=t; }

    // gate
    if(sub==='acq'){
      gateDb.ref(`userSettings/${uidParam}/wholesaler/leadsEnabled`).once('value').then(snap=>{
        if(!snap.val()){
          const c=document.getElementById('leadCard');
          if(c) c.innerHTML='<div class="body">Leads are disabled. Open Wholesaler tab to request Street/Web/Live Leads or connect your CRM.</div>';
          setStatus('Access denied');
          return;
        }
        const s=document.createElement('script'); s.src='/leads.js?v='+Date.now();
        s.onload=()=>{ window.leads=window.leads||[]; initAcq(); }; s.onerror=()=>setStatus('Could not load /leads.js'); document.head.appendChild(s);
      });
    }

    // ---------- filtering helpers (UPDATED) ----------
    const clean = s => (s||'').toString().trim();
    const extractZip = (addr='') => { const m=String(addr).match(/\b\d{5}\b/); return m?m[0]:''; };

    // Stronger classification: only count as "commercial" if explicit commercial cues.
    function classifyLead(lead){
      const bag = [
        lead?.type, lead?.category, lead?.tags,
        lead?.notes, lead?.details, lead?.description,
        lead?.zoning, lead?.use
      ].map(clean).join(' ').toLowerCase();

      const isComm = /\b(commercial|retail|industrial|warehouse|office|restaurant|hotel|motel|c-store|gas|shopping|mall|strip|mixed[- ]use|cap ?rate|triple ?net|nnn|flex|medical office|clinic|self[ -]?storage|automotive|dealership|multifamily(?!\s*residential))\b/.test(bag)
                    || /\bzoned\s*[c|b|i]\b/.test(bag);

      const isResi = /\b(residential|single[- ]family|sfh|house|duplex|triplex|quadplex|apartment|condo|townhome|mh|mobile home)\b/.test(bag);

      const isVacantLand = /\b(vacant|raw|unimproved)\s+(lot|land)\b/.test(bag) || /\blot\b/.test(bag);

      if(isComm) return 'commercial';
      if(isResi) return 'residential';
      if(isVacantLand) return 'land';
      return ''; // unknown
    }

    function applyFilters(all){
      let arr = all;
      if(hasTypeFilter){
        arr = arr.filter(l=>{
          const t = classifyLead(l);
          if(t==='') return false;           // if user set any type filter, drop unknowns
          if(t==='land') return whTypes.includes('land'); // optional "land" bucket if you add it later
          return whTypes.includes(t);
        });
      }
      if(zipSet.size){
        arr = arr.filter(l=>{ const z=extractZip(l?.address||''); return z && zipSet.has(z); });
      }
      return arr;
    }

    // ...rest of your ACQ renderer from your last good build ...
  </script>
</body>
</html>
