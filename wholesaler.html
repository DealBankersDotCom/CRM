<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wholesaler ‚Ä¢ Acquisition</title>
<link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

<!--
USAGE
- Preferred: wholesaler.html?uid=<FIREBASE_UID>&feed=<GOOGLE_DRIVE_PUBLIC_SCRIPT_URL>
  (the feed is the ‚ÄúPUBLIC latest‚Äù script URL your Sheet export shows)
- Fallback: include a local leads.js that defines window.leads = [...]
-->

<style>
  :root{
    --ink:#0f1620; --muted:#6b7280; --line:#e7e7e7; --bg:#f2f4f7; --panel:#ffffff;
    --accent:#0d6efd; --ok:#28a745; --shadow:0 14px 34px rgba(0,0,0,.08);
    --r:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Arial, sans-serif; background:var(--bg); color:var(--ink)}

  header{
    background:#111; color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center;
    position:sticky; top:0; z-index:5;
  }
  .menu{cursor:pointer; font-size:22px; user-select:none}
  .menu-content{
    display:none; position:absolute; top:56px; right:16px; background:#fff; border:1px solid var(--line);
    border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.2); z-index:1000; overflow:hidden; min-width:220px;
  }
  .menu-content a{display:block; padding:12px 16px; text-decoration:none; color:#111; font-weight:600}
  .menu-content a:hover{background:#f5f7fb}

  .container{display:flex; flex-direction:column; height:calc(100vh - 56px)}
  @media (min-width:900px){ .container{flex-direction:row} }
  .lead-section,.map-section{padding:14px}
  .lead-section{flex:1; overflow:auto}
  .map-section{flex:1; display:flex}

  .lead-buttons{
    display:flex; justify-content:center; gap:10px; margin-bottom:12px; flex-wrap:wrap;
  }
  .lead-buttons a,.lead-buttons button{
    font-size:20px; border:none; border-radius:10px; text-decoration:none; cursor:pointer; padding:10px 12px; color:#fff;
  }
  .call{background:var(--accent)} .drive{background:#6c757d} .settings{background:#343a40} .chat{background:#17a2b8}

  .lead-card{
    background:var(--panel); padding:16px; border-radius:12px; box-shadow:var(--shadow);
    margin:0 auto 15px; max-width:640px; border:1px solid var(--line);
  }
  .lead-card a{color:var(--accent); font-weight:700; text-decoration:none}
  .lead-card button{background:var(--ok); color:#fff; padding:8px 12px; border:none; border-radius:8px; font-size:14px; margin-top:10px; cursor:pointer}

  .next-btn{display:block; margin:16px auto; padding:12px 20px; font-size:18px; background:#111; color:#fff; border:none; border-radius:10px; cursor:pointer}

  iframe.map{width:100%; border:none; border-radius:12px; box-shadow:var(--shadow); border:1px solid var(--line)}
  .map-section iframe.map{height:100%}
  @media (max-width:899px){ iframe.map{height:340px} }

  /* Permission gate / notices */
  .gate{margin:18px; padding:16px; border:1px solid var(--line); background:#fff; border-radius:12px}
  .gate h3{margin:0 0 6px} .gate p{margin:0 0 10px; color:var(--muted)}
  .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; font-size:12px}

  /* Modal */
  .modal{display:none; position:fixed; z-index:999; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; padding:16px}
  .modal-content{width:100%; max-width:1100px; height:80%; background:#fff; border-radius:14px; overflow:hidden; position:relative; box-shadow:0 20px 50px rgba(0,0,0,.35)}
  .modal iframe{width:100%; height:100%; border:none}
  .close-btn{position:absolute; top:10px; right:12px; font-size:20px; background:#333; color:#fff; border:none; border-radius:50%; width:34px; height:34px; cursor:pointer}

  .highlight{background:yellow; padding:0 2px}
</style>
</head>
<body>
<header>
  Wholesaler ‚Ä¢ Acquisition
  <div style="position:relative">
    <div class="menu" onclick="toggleMenu()">‚ò∞</div>
    <div class="menu-content" id="menuContent">
      <a href="dispo.html" target="_blank" rel="noopener">Open Dispo Page</a>
      <a href="profile.html?tab=wholesaler&wh=acq" rel="noopener">Back to Profile</a>
    </div>
  </div>
</header>

<!-- Notices -->
<div id="feedNotice" class="gate" style="display:none">
  <h3>No feed configured</h3>
  <p>Ask an admin to export leads and pass the <span class="badge">?feed=PUBLIC_SCRIPT_URL</span> into this page, or set it inside the file.</p>
</div>
<div id="gate" class="gate" style="display:none">
  <h3>Checking your access‚Ä¶</h3>
  <p>Please wait a moment while we verify your wholesaler permissions.</p>
</div>

<!-- Main workspace -->
<div id="portal" class="container" style="display:none">
  <section class="lead-section">
    <div class="lead-buttons">
      <button id="btnPrev" class="drive">‚èÆ</button>
      <button id="btnNext" class="drive">‚è≠</button>
      <a class="chat" href="https://www.textnow.com/messaging" target="_blank" rel="noopener">TextNow</a>
      <button id="btnNotes" class="settings">üìù Notes</button>
      <button id="btnCopy" class="call">üìû Copy</button>
    </div>

    <div id="leadCard" class="lead-card">Loading‚Ä¶</div>
    <button class="next-btn" onclick="next(1)">‚è≠Ô∏è Next Lead</button>
  </section>

  <section class="map-section">
    <iframe id="map" class="map" src="about:blank" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
  </section>
</div>

<!-- Notes modal -->
<div id="formModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">√ó</button>
    <iframe id="formIframe"></iframe>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
  // Optional hardcoded feed (leave "" to force passing ?feed=...)
  const DEFAULT_FEED = ""; // e.g. "https://drive.google.com/uc?export=download&id=XXXXXXXX"

  const firebaseConfig = {
    apiKey: "AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",
    authDomain: "deal-bankers.firebaseapp.com",
    databaseURL: "https://deal-bankers-default-rtdb.firebaseio.com",
    projectId: "deal-bankers",
    storageBucket: "deal-bankers.firebasestorage.app",
    messagingSenderId: "485110155601",
    appId: "1:485110155601:web:b4c38350ac58c1a2ecab70",
    measurementId: "G-KTNXZM14F7"
  };
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  /* ---------- State / helpers ---------- */
  const qs = name => new URL(location.href).searchParams.get(name) || "";
  const $  = s => document.querySelector(s);
  const state = { uid:"", leads:[], i:0 };

  function toggleMenu(){
    const m = $('#menuContent'); m.style.display = (m.style.display==='block') ? 'none' : 'block';
  }
  function setMap(address){
    const q = encodeURIComponent(address || '');
    $('#map').src = q ? `https://www.google.com/maps?q=${q}&output=embed` : 'about:blank';
  }
  function openModal(url){ $('#formIframe').src = url; $('#formModal').style.display='flex'; }
  function closeModal(){ $('#formModal').style.display='none'; $('#formIframe').src='about:blank'; }
  window.closeModal = closeModal;

  function highlightKeywords(text=''){
    const keywords = ["asbestos","vacant","fha","foreclosure","build","loan","occupied","equity","taxes","motivated","carryback"];
    const regex = new RegExp(`\\b(${keywords.join('|')})\\b`,'gi');
    return text.replace(regex,'<span class="highlight">$1</span>');
  }

  function render(){
    if(!state.leads.length){ $('#leadCard').textContent = 'No leads loaded.'; return; }
    const L = state.leads[state.i];
    const contact = (L.contacts && L.contacts[0]) || {name:'(no name)', phone:''};
    const addr = L.address || '';

    const formBase = "https://docs.google.com/forms/d/e/1FAIpQLScIZ7GX_ga5yOx34817gOL8Bb5m3KFXW8r-5I4taw_-ergOxw/viewform";
    const formUrl  = `${formBase}?usp=pp_url&entry.849181096=${encodeURIComponent('Wholesaler')}&entry.121126280=${encodeURIComponent(contact.name)}&entry.1828741519=${encodeURIComponent(addr)}&entry.204=${encodeURIComponent(state.uid)}`;

    $('#leadCard').innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px">
        <span class="badge">${state.i+1} / ${state.leads.length}</span>
        ${addr ? `<span class="badge">Address</span>`:''}
      </div>
      <div style="font-weight:700; font-size:18px">${contact.name}</div>
      <div style="margin-top:4px">${addr || '(no address)'}</div>
      <div style="margin-top:6px"><span class="badge">${contact.phone || 'no phone'}</span></div>
      ${L.notes ? `<details style="margin-top:10px" open>
          <summary style="cursor:pointer; font-weight:700">üìä Deal Details</summary>
          <div style="margin-top:6px">${highlightKeywords(String(L.notes)).replace(/\n/g,'<br>')}</div>
        </details>` : '' }
      <div style="margin-top:10px">
        <a href="https://www.textnow.com/messaging" target="_blank" rel="noopener">TextNow Link</a>
        <button style="margin-left:10px" onclick="openModal('${formUrl}')">üìù Update Lead Notes</button>
      </div>
    `;
    setMap(addr);
    // bind quick buttons
    $('#btnCopy').onclick = ()=> navigator.clipboard.writeText(contact.phone||'').then(()=>alert('Copied: '+(contact.phone||'')));
    $('#btnNotes').onclick = ()=> openModal(formUrl);
  }

  function next(delta){
    if(!state.leads.length) return;
    state.i = (state.i + delta + state.leads.length) % state.leads.length;
    render();
  }
  window.next = next;

  function injectScript(src){
    return new Promise((resolve,reject)=>{
      if(!src){ resolve(false); return; }
      const s = document.createElement('script');
      s.src = src;
      s.onload = ()=>resolve(true);
      s.onerror = ()=>reject(new Error('Feed load failed'));
      document.head.appendChild(s);
    });
  }

  /* ---------- Auth + Role + Feed ---------- */
  (function boot(){
    $('#gate').style.display = 'block';
    auth.onAuthStateChanged(async (u)=>{
      if(!u){ $('#gate').innerHTML = `<h3>Not signed in</h3><p>Please <a href="index.html">sign in</a>.</p>`; return; }
      state.uid = u.uid;

      try{
        const snap = await db.ref(`users/${state.uid}/roles/wholesaler`).get();
        const ok = snap.val() === true || snap.val() === 'true';
        if(!ok){
          $('#gate').innerHTML = `<h3>Access denied</h3><p>Your account doesn‚Äôt have wholesaler permissions.</p>`;
          return;
        }
      }catch(e){
        console.error(e);
        $('#gate').innerHTML = `<h3>Error</h3><p>Couldn‚Äôt verify access. Refresh and try again.</p>`;
        return;
      }

      // Try query feed, then DEFAULT_FEED, then local leads.js fallback
      const feedURL = qs('feed') || DEFAULT_FEED;
      let loaded = false;
      try{
        if(feedURL){ await injectScript(feedURL); loaded = Array.isArray(window.leads) && window.leads.length>0; }
      }catch(e){ console.warn('Feed error', e); }

      if(!loaded){
        // try local leads.js (optional file in your repo)
        try{
          await injectScript('leads.js');
          loaded = Array.isArray(window.leads) && window.leads.length>0;
        }catch(e){ /* ignore */ }
      }

      if(!loaded){
        $('#feedNotice').style.display = 'block';
      }

      $('#gate').style.display = 'none';
      $('#portal').style.display = 'flex';

      if(loaded){
        state.leads = window.leads;
        state.i = 0;
        render();
      }else{
        $('#leadCard').innerHTML = `<div class="lead-card">No leads loaded. Provide a feed (?feed=) or add <code>leads.js</code>.</div>`;
      }
    });
  })();

  /* ---------- UI wiring ---------- */
  document.addEventListener('click', e=>{
    if(!e.target.closest('.menu') && !e.target.closest('.menu-content')){
      const m = $('#menuContent'); if(m) m.style.display='none';
    }
  });
  $('#btnPrev').onclick = ()=> next(-1);
  $('#btnNext').onclick = ()=> next(1);
</script>
</body>
</html>
