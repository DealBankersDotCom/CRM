<!-- ================= Wholesaler Portal (Acq + Dispo ‚Ä¢ house leads + user uploads ‚Ä¢ filters ‚Ä¢ offerings) ================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wholesaler Portal</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>

  <style>
    :root{
      --bg1:#0b131b; --bg2:#142838; --bg3:#173c53;
      --line:#2a5a78; --text:#f3f8fb; --muted:#c7d7e6;
      --gold:#ffd36b; --green:#26cf84; --blue:#47b4ff; --panel:#133045;
      --r:16px; --shadow:0 28px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 520px at 92% -12%, rgba(93,224,255,.22) 0%, transparent 60%),
        linear-gradient(135deg,var(--bg1),var(--bg2) 55%,var(--bg3));
      padding:10px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}

    .top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); font-size:14px}
    .crumbs{display:flex;gap:10px;align-items:center;color:var(--muted)}
    .dot{width:7px;height:7px;border-radius:999px;background:var(--blue);box-shadow:0 0 14px rgba(93,224,255,.9)}
    .status{font-size:12px;color:#e8f7ff}

    .sticky{position:sticky;top:0;z-index:8;padding:10px;border-bottom:1px solid rgba(255,255,255,.2);
      background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(255,255,255,.06))}

    /* Actions */
    .actions{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px;border-radius:12px;
      font-weight:800;border:1px solid rgba(255,255,255,.22);background:#0e2433;color:#eaf6ff;cursor:pointer;min-height:44px;text-decoration:none}
    .btn:hover{filter:brightness(1.08)}
    .btn-gold{background:linear-gradient(180deg,var(--gold),#c89b3a);color:#211a05;border:none}
    .btn-green{background:linear-gradient(180deg,var(--green),#1a9b61);color:#fff;border:none}
    .btn-ghost{background:#0f2a3a}
    .ico{font-size:18px}
    .label{font-weight:800}

    .navrow{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}

    .lead-wrap{padding:12px}
    .lead{border:1px solid rgba(255,255,255,.22);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03))}
    .title{padding:12px 14px;font-weight:900;letter-spacing:.02em;font-size:18px;border-bottom:1px solid rgba(255,255,255,.18);
      background:linear-gradient(90deg,rgba(255,211,107,.22),transparent 45%),linear-gradient(180deg,rgba(0,0,0,.15),transparent)}
    .body{padding:12px 14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{font-size:12px;font-weight:700;padding:7px 11px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:#0f2c3e}

    .sv,.map{width:100%;border:0;border-radius:14px;background:#fff}
    .sv{height:260px;margin-top:6px}
    .map{height:220px;margin-top:8px}

    .notesBox{display:grid;gap:8px;margin:8px 0 10px}
    .textarea{
      width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:#0d2130;color:#eaf6ff;font-size:14px;line-height:1.4
    }
    .notesRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .savedTag{font-size:12px;color:#bfe9c9;opacity:.9;display:none}

    /* Dispo view (kept) */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card2{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.18);border-radius:16px;padding:12px}
    .offer-card{display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,.18);background:#0f2a3a;border-radius:12px;padding:10px}
    .offer-title{font-weight:900}
    .offer-badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;background:#112f45;border:1px solid rgba(255,255,255,.18);padding:4px 8px;border-radius:999px}

    @media (max-width:680px){
      .actions{grid-template-columns:repeat(3,1fr)}
      .navrow{grid-template-columns:repeat(3,1fr)}
      .sv{height:230px} .map{height:200px}
      .grid{grid-template-columns:1fr}
    }

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;
      color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);font-size:14px;display:none;z-index:70}

    /* Source switcher */
    .seg{display:inline-flex;border:1px solid rgba(255,255,255,.22);border-radius:999px;overflow:hidden}
    .seg button{background:#0f2a3a;color:#cde1f3;border:0;padding:8px 12px;cursor:pointer}
    .seg button.active{background:linear-gradient(180deg,#2b74ff,#0a58ca);color:#fff}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="top">
        <div class="crumbs">
          <span>Wholesaler</span><span class="dot"></span><span id="modeCrumb">Acquisition</span>
        </div>
        <div class="status" id="status">Loading‚Ä¶</div>
      </div>

      <!-- STICKY ACTIONS (Acq only; hidden in Dispo) -->
      <div class="sticky" id="acqBar" style="display:none">
        <div class="actions">
          <a class="btn btn-gold" href="#" id="actCall"  title="Call"><span class="ico">üìû</span><span class="label">Call</span></a>
          <a class="btn btn-gold" href="#" id="actSMS"   title="Text"><span class="ico">üí¨</span><span class="label">Text</span></a>
          <button class="btn btn-ghost" id="actCopy"     title="Copy number"><span class="ico">üìã</span><span class="label">Copy</span></button>
          <a class="btn btn-ghost" href="https://drive.google.com" target="_blank" rel="noopener" title="Drive"><span class="ico">üìÅ</span><span class="label">Drive</span></a>
          <button class="btn btn-ghost" id="btnUpload"   title="Upload Leads"><span class="ico">üì§</span><span class="label">Upload</span></button>
          <button class="btn btn-ghost" id="actSettings" title="Settings"><span class="ico">‚öôÔ∏è</span><span class="label">Dial Pref</span></button>
        </div>
        <div class="navrow">
          <button class="btn btn-ghost" id="btnPrev"   title="Prev">‚óÄ <span class="label">Prev</span></button>
          <button class="btn btn-ghost" id="btnRandom" title="Random">üé≤ <span class="label">Random</span></button>
          <button class="btn btn-green" id="btnNext"   title="Next">‚ñ∂ <span class="label">Next</span></button>
        </div>

        <!-- Source switcher -->
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div class="seg">
            <button id="srcHouse" class="active">House</button>
            <button id="srcMine">My Uploads</button>
          </div>
          <div class="muted" id="srcMeta" style="font-size:12px">Source: House</div>
        </div>
      </div>

      <!-- ACQ: Lead viewer -->
      <div class="lead-wrap" id="acqWrap" style="display:none">
        <div id="leadCard" class="lead">
          <div class="body">Initializing‚Ä¶</div>
        </div>
      </div>

      <!-- DISPO (unchanged demo, shortened for brevity) -->
      <div id="dispoWrap" style="display:none; padding:12px">
        <div class="grid">
          <div class="card2">
            <h3 style="margin:0 0 8px">Active Offerings</h3>
            <div class="offer-card" style="margin-bottom:10px">
              <div style="font-size:28px">üõ¢Ô∏è</div>
              <div style="flex:1">
                <div class="offer-title">Virgin D6 Lift ‚Äî FOB Houston</div>
                <div class="offer-badges">
                  <span class="badge">Capital Need: $300k</span>
                  <span class="badge">Repay: 7‚Äì10 days</span>
                  <span class="badge">100M gallons</span>
                </div>
                <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
                  <a class="btn btn-gold" href="offering-memo2.html?sof=https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview" target="_blank" rel="noopener">Open Offering Memo</a>
                  <a class="btn btn-ghost" href="offering-memo2.html?sof=https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview#interest" target="_blank" rel="noopener">Submit Interest</a>
                </div>
              </div>
            </div>
          </div>

          <div class="card2">
            <h3 style="margin:0 0 8px">Statement of Facts (Inline Preview)</h3>
            <iframe id="dispoSOF" title="SOF" style="width:100%;height:520px;border:0;border-radius:12px;background:#fff"
              src="https://drive.google.com/file/d/1GybST-_K4XW3Q3H6QNd6cdPGw8J5XVtT/preview" allow="autoplay"></iframe>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Dial preference dialog -->
  <dialog id="settingsDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:14px;max-width:520px;width:92%">
    <h3 style="margin:0 0 8px">Phone Link Preference</h3>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="device"> Device Phone (tel:)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="textnow"> TextNow (web)</label>
    <label style="display:flex;gap:8px;align-items:center;margin:8px 0"><input type="radio" name="mode" value="gvoice"> Google Voice (web)</label>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="saveMode" class="btn" style="flex:1">Save</button>
      <button id="closeMode" class="btn" style="flex:1">Close</button>
    </div>
  </dialog>

  <!-- Upload leads dialog -->
  <dialog id="uploadDlg" style="border:none;border-radius:16px;background:#0f1a24;color:#eaf6ff;padding:16px;max-width:760px;width:92%">
    <h3 style="margin:0 0 8px">Upload My Leads</h3>
    <p style="margin:0 0 8px;color:#c7d7e6;font-size:13px">
      Paste CSV or JSON, or choose a file. Columns recognized: <b>address, name, phone, type, notes, zip</b>.
      We‚Äôll store these under your account and show them in ‚ÄúMy Uploads‚Äù.
    </p>
    <div style="display:grid;gap:10px">
      <textarea id="uploadPaste" class="textarea" placeholder="Paste CSV or JSON array here‚Ä¶"></textarea>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="uploadFile" type="file" accept=".csv,.json" />
        <button id="uploadParse" class="btn btn-gold">Import</button>
        <button id="uploadClose" class="btn">Close</button>
      </div>
      <details>
        <summary style="cursor:pointer;color:#c7d7e6">CSV template</summary>
        <pre style="white-space:pre-wrap;color:#a9c7dd;background:#0a1a26;border:1px solid #24445c;padding:8px;border-radius:8px;margin:8px 0 0">
address,name,phone,type,notes,zip
3014 El Paso St, San Antonio, TX 78207,Kevin Holdsworth,2105551234,residential,"pier foundation; 1945 build",78207
        </pre>
      </details>
    </div>
  </dialog>

  <div id="toast"></div>

  <!-- Firebase (dedicated instance for this page) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    // Dedicated app for gating + user uploads
    const gateApp = firebase.initializeApp(
      {apiKey:"AIzaSyAoidTIHZZwOJ_FrXXMZd_hPAuoxDJJncs",authDomain:"deal-bankers.firebaseapp.com",databaseURL:"https://deal-bankers-default-rtdb.firebaseio.com",projectId:"deal-bankers"},
      "whGate"
    );
    const gateDb = gateApp.database();

    // Query params
    const urlp     = new URL(location.href).searchParams;
    const sub      = (urlp.get('sub')||urlp.get('mode')||'acq').toLowerCase();   // 'acq' | 'dispo'
    const uidParam = urlp.get('uid') || 'anon';

    // Lead filter params (from profile)
    const whTypes = (urlp.get('whTypes')||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    const whZips  = (urlp.get('whZips')||'').split(',').map(s=>s.trim()).filter(Boolean);
    const hasTypeFilter = whTypes.length>0;
    const zipSet = new Set(whZips);

    // UI helpers
    const $=s=>document.querySelector(s);
    const statusEl=$('#status'); const toastEl=$('#toast'); const dlg=$('#settingsDlg');
    const uploadDlg=$('#uploadDlg');
    function toast(t){ toastEl.textContent=t; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1600); }
    function setStatus(t){statusEl.textContent=t;}
    function showAcq(){ $('#modeCrumb').textContent='Acquisition'; $('#acqBar').style.display='block'; $('#acqWrap').style.display='block'; $('#dispoWrap').style.display='none'; }
    function showDispo(){ $('#modeCrumb').textContent='Dispo'; $('#acqBar').style.display='none'; $('#acqWrap').style.display='none'; $('#dispoWrap').style.display='block'; setStatus('Offerings'); }

    if(sub==='dispo'){ showDispo(); } else { showAcq(); }

    // ------- Lead sources -------
    let houseAllowed=false;
    let source='house'; // 'house' | 'mine'
    $('#srcHouse').onclick=()=>{ source='house'; refreshSource(); };
    $('#srcMine').onclick =()=>{ source='mine';  refreshSource(); };

    function refreshSource(){
      $('#srcHouse').classList.toggle('active',source==='house');
      $('#srcMine').classList.toggle('active',source==='mine');
      $('#srcMeta').textContent = `Source: ${source==='house'?'House':'My Uploads'}`;
      if(sub==='acq'){
        if(source==='house') bootHouseLeads();
        else bootMyLeads();
      }
    }

    // ----- Gate per sub-tab (leadsEnabled or specific flag) -----
    if(sub==='acq' || sub==='dispo'){
      gateDb.ref(`userSettings/${uidParam}/wholesaler`).once('value').then(snap=>{
        const v = snap.val() || {};
        houseAllowed = !!(v.leadsEnabled || v.acqLeadsEnabled);
        if(!houseAllowed){
          // Encourage uploads and default to "mine"
          showAcq();
          source='mine';
          refreshSource();
          promptUploadCTA();
          return;
        }
        // Default to House when allowed
        refreshSource();
      }).catch(()=>{
        // Fallback to uploads
        source='mine'; refreshSource();
      });
    }

    function promptUploadCTA(){
      $('#leadCard').innerHTML = `
        <div class="body">
          <b>House leads are disabled for this account.</b>
          <div style="margin-top:6px">You can still work your own list. Upload CSV or JSON and we‚Äôll show them here.</div>
          <div style="margin-top:10px"><button class="btn btn-gold" id="ctaUpload">Upload My Leads</button></div>
        </div>`;
      setStatus('Uploads available');
      $('#ctaUpload').onclick=()=>uploadDlg.showModal();
    }

    // ----- ACQ logic (filters, notes, dialing) -----
    let idx=0, currentLead=null;
    const MODE_KEY='db_phone_link_mode_wh';
    const getMode=()=>localStorage.getItem(MODE_KEY)||'device';
    const setMode=m=>localStorage.setItem(MODE_KEY,m);
    const clean=s=>(s||'').trim();
    const phoneOf=l=>clean(l?.contacts?.[0]?.phone||'');

    function phoneHref(number, mode){
      const num=(number||'').replace(/[^\d+]/g,'');
      if(!num) return '#';
      if(mode==='device') return `tel:${num}`;
      if(mode==='textnow'){ navigator.clipboard?.writeText(num); return 'https://www.textnow.com/messaging'; }
      if(mode==='gvoice'){ navigator.clipboard?.writeText(num); return 'https://voice.google.com/u/0/messages'; }
      return `tel:${num}`;
    }
    function svSrc(addr){ return `https://www.google.com/maps?output=svembed&layer=c&q=${encodeURIComponent(addr)}`; }
    function mapSrc(addr){ return `https://www.google.com/maps?output=embed&q=${encodeURIComponent(addr)}`; }

    const noteKey = addr => 'db_notes_'+(addr||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
    const loadNotes = addr => localStorage.getItem(noteKey(addr)) || '';
    const saveNotes = (addr,text)=>localStorage.setItem(noteKey(addr), text||'');
    const saveTimeKey = addr => noteKey(addr)+'_ts';
    const saveTimeSet = (addr,ts)=>localStorage.setItem(saveTimeKey(addr), String(ts));
    const saveTimeGet = addr => Number(localStorage.getItem(saveTimeKey(addr))||0);
    function fmtTime(ts){ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getMonth()+1}/${d.getDate()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function autoGrow(el){ el.style.height='auto'; el.style.height=(el.scrollHeight+6)+'px'; }

    const extractZip = (addr='') => { const m = String(addr).match(/\b\d{5}\b/); return m ? m[0] : ''; };
    const leadType = (lead='') => {
      const t = (lead?.type || lead?.category || lead?.tags || '').toString().toLowerCase();
      if(t.includes('comm')) return 'commercial';
      if(t.includes('resi') || t.includes('sfr') || t.includes('home') || t.includes('house')) return 'residential';
      return '';
    };

    function applyFilters(all){
      let arr = all;
      if(hasTypeFilter){
        arr = arr.filter(l=>{
          const lt = leadType(l);
          return lt ? whTypes.includes(lt) : true;
        });
      }
      if(zipSet.size){
        arr = arr.filter(l=>{
          const z = extractZip(l?.address||'') || l?.zip || '';
          return z && zipSet.has(z);
        });
      }
      return arr;
    }

    function initAcqFromArray(all){
      const filtered = applyFilters(all||[]);
      if(!filtered.length){
        $('#leadCard').innerHTML = `
          <div class="body">
            <b>No leads match your filters.</b>
            <div style="margin-top:6px;font-size:13px;opacity:.85">
              Types: ${hasTypeFilter ? whTypes.join(', ') : 'any'} ‚Ä¢ Zips: ${whZips.length?whZips.join(', '):'any'}
            </div>
          </div>`;
        setStatus('0 after filters');
        return;
      }
      window.__filteredLeads = filtered;
      showAcq(); setStatus(`Loaded ${filtered.length} lead(s)`);
      render(0);
    }

    function render(i){
      const arr = window.__filteredLeads || [];
      if(!arr.length){
        $('#leadCard').innerHTML='<div class="body">No leads loaded.</div>';
        setStatus('No leads found'); return;
      }
      if(i<0) i=arr.length-1;
      if(i>=arr.length) i=0;
      idx=i;

      const lead=arr[idx];
      currentLead=lead;

      const name  = clean(lead?.contacts?.[0]?.name || lead?.name || 'Unknown');
      const phone = phoneOf(lead) || clean(lead?.phone || '');
      const addr  = clean(lead?.address||'');

      setStatus(`Lead ${idx+1} of ${arr.length}`);

      const mode=getMode();
      $('#actCall').href = phoneHref(phone, mode);
      $('#actSMS').href  = mode==='device' && phone ? `sms:${phone}` : phoneHref(phone, mode);

      const lastSaved = saveTimeGet(addr);
      const lastSavedText = lastSaved ? `Saved ${fmtTime(lastSaved)}` : 'Not saved yet';

      $('#leadCard').innerHTML = `
        <div class="title">${addr || name}</div>
        <div class="body">
          <div style="margin-bottom:6px;font-weight:800">${name}</div>

          <div class="chips">
            <div class="chip">UID: ${(uidParam||'anon').slice(0,8)}</div>
            <div class="chip">${phone ? 'Phone on file' : 'Phone missing'}</div>
            <div class="chip">Dial: ${mode}</div>
            ${hasTypeFilter ? `<div class="chip">Type: ${leadType(lead)||'n/a'}</div>` : '' }
            ${zipSet.size ? `<div class="chip">ZIP: ${extractZip(addr)||lead?.zip||'n/a'}</div>` : '' }
          </div>

          <h3 style="margin:10px 0 6px;font-size:16px">Lead details</h3>
          <div class="notesBox">
            <textarea id="noteInput" class="textarea" placeholder="Type notes here‚Ä¶"></textarea>
            <div class="notesRow">
              <button id="inlineSave" class="btn btn-gold"><span class="ico">üíæ</span><span class="label">Save Notes</span></button>
              <span id="savedTag" class="savedTag">${lastSavedText}</span>
            </div>
          </div>

          <iframe class="sv"  src="${svSrc(addr)}"   loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Street View"></iframe>
          <iframe class="map" src="${mapSrc(addr)}"  loading="lazy" referrerpolicy="no-referrer-when-downgrade" title="Map"></iframe>
        </div>
      `;

      const ta=$('#noteInput');
      ta.value = loadNotes(addr) || (lead?.notes || '');
      autoGrow(ta);
      ta.addEventListener('input',()=>autoGrow(ta));

      $('#inlineSave').onclick = ()=>doSaveNotes();
    }

    function doSaveNotes(){
      const addr = (currentLead?.address)||'';
      const text = ($('#noteInput')?.value||'').trim();
      saveNotes(addr, text);
      const ts=Date.now(); saveTimeSet(addr, ts);
      const tag=$('#savedTag'); if(tag){ tag.textContent=`Saved ${fmtTime(ts)}`; tag.style.display='inline'; }
      toast('Notes saved');
    }

    // actions (Acq)
    document.addEventListener('click',e=>{
      if(e.target.id==='btnPrev')   render(idx-1);
      if(e.target.id==='btnNext')   render(idx+1);
      if(e.target.id==='btnRandom') render(Math.floor(Math.random()*((window.__filteredLeads||[]).length||1)));
    });

    $('#actCopy')?.addEventListener('click', ()=>{
      const arr = window.__filteredLeads||[];
      const p= phoneOf(arr[idx]||{}) || clean((arr[idx]||{}).phone||'');
      if(!p) return alert('No phone on this lead.');
      navigator.clipboard.writeText(p).then(()=>toast('Phone copied'));
    });

    $('#actSettings')?.addEventListener('click', ()=>{
      dlg.showModal();
      const cur=getMode();
      dlg.querySelectorAll('input[name="mode"]').forEach(r=>r.checked=(r.value===cur));
    });
    $('#saveMode')?.addEventListener('click', ()=>{
      const m=dlg.querySelector('input[name="mode"]:checked')?.value||'device';
      setMode(m); dlg.close(); render(idx);
    });
    $('#closeMode')?.addEventListener('click', ()=>dlg.close());

    document.addEventListener('keydown',e=>{
      if(sub!=='acq') return;
      if(e.key==='ArrowLeft') return render(idx-1);
      if(e.key==='ArrowRight') return render(idx+1);
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); return doSaveNotes(); }
    });

    window.addEventListener('beforeunload',()=>{ if(currentLead && sub==='acq'){ doSaveNotes(); } });

    // ---------- HOUSE LEADS ----------
    let houseLoaded=false;
    function bootHouseLeads(){
      if(!houseAllowed){
        promptUploadCTA();
        return;
      }
      if(houseLoaded && window.__houseCache){ initAcqFromArray(window.__houseCache); return; }
      const s=document.createElement('script');
      s.src='/leads.js?v='+Date.now();
      s.onload=()=>{
        const arr = Array.isArray(window.leads) ? window.leads.slice() : [];
        window.__houseCache = arr;
        houseLoaded=true;
        initAcqFromArray(arr);
      };
      s.onerror=()=>{ setStatus('Could not load /leads.js'); };
      document.head.appendChild(s);
    }

    // ---------- MY UPLOADS ----------
    let mineLoaded=false;
    function bootMyLeads(){
      gateDb.ref(`userLeads/${uidParam}`).once('value').then(snap=>{
        const arr = Array.isArray(snap.val()) ? snap.val() : (snap.val()?.items || []);
        mineLoaded=true;
        window.__mineCache = arr;
        if(!arr.length){
          // invite upload
          promptUploadCTA();
        } else {
          initAcqFromArray(arr);
        }
      }).catch(()=>promptUploadCTA());
    }

    // Upload dialog wiring
    $('#btnUpload').onclick = ()=>uploadDlg.showModal();
    $('#uploadClose').onclick = ()=>uploadDlg.close();

    $('#uploadFile').addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const text = await f.text();
      $('#uploadPaste').value = text;
    });

    $('#uploadParse').onclick = async ()=>{
      const raw = ($('#uploadPaste').value||'').trim();
      if(!raw) return alert('Paste CSV or JSON, or choose a file first.');
      let items=[];
      try{
        if(raw.trim().startsWith('[')){
          items = normalizeArray(JSON.parse(raw));
        }else{
          items = parseCSV(raw);
        }
      }catch(err){
        console.error(err); return alert('Could not parse. Check format.');
      }
      if(!items.length) return alert('No rows found.');
      // Save under userLeads/{uid}
      try{
        await gateDb.ref(`userLeads/${uidParam}`).set({ items, ts: Date.now() });
        uploadDlg.close();
        toast(`Imported ${items.length} lead(s)`);
        source='mine'; refreshSource();
      }catch(e){
        alert('Could not save right now.');
      }
    };

    function normalizeArray(arr){
      return (arr||[]).map(r=>{
        const address = r.address || r.addr || '';
        const name    = r.name || r.contact || (r.contacts?.[0]?.name)||'';
        const phone   = r.phone || r.phoneNumber || (r.contacts?.[0]?.phone)||'';
        const type    = r.type || r.category || '';
        const notes   = r.notes || '';
        const zip     = r.zip || extractZip(address) || '';
        return {
          address,
          contacts: [{ name, phone }],
          type, notes, zip
        };
      }).filter(r=>r.address);
    }

    function parseCSV(text){
      // Tiny CSV parser (no quotes inside fields edge-cases)
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      if(!lines.length) return [];
      const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const idxOf = k => headers.indexOf(k);
      const iAddr=firstOf(['address','addr'],headers);
      const iName=firstOf(['name','contact'],headers);
      const iPhone=firstOf(['phone','phonenumber','phone_number'],headers);
      const iType=firstOf(['type','category'],headers);
      const iNotes=firstOf(['notes','note'],headers);
      const iZip=firstOf(['zip','zipcode','postal'],headers);

      const out=[];
      for(let i=1;i<lines.length;i++){
        const cols = splitRow(lines[i]);
        const address = pick(cols,iAddr);
        if(!address) continue;
        const name  = pick(cols,iName);
        const phone = pick(cols,iPhone);
        const type  = pick(cols,iType);
        const notes = pick(cols,iNotes);
        const zip   = pick(cols,iZip) || extractZip(address);
        out.push({
          address,
          contacts:[{name, phone}],
          type, notes, zip
        });
      }
      return out;

      function firstOf(keys, hdrs){ for(const k of keys){ const j=hdrs.indexOf(k); if(j>-1) return j; } return -1; }
      function pick(arr, idx){ return idx>-1 ? (arr[idx]||'').trim() : ''; }
      function splitRow(row){
        // basic CSV with quoted fields support
        const res=[]; let cur=''; let q=false;
        for(let j=0;j<row.length;j++){
          const ch=row[j];
          if(ch==='\"'){ q=!q; continue; }
          if(ch===',' && !q){ res.push(cur); cur=''; continue; }
          cur+=ch;
        }
        res.push(cur);
        return res;
      }
    }

    // Kickoff by source
    function start(){
      if(sub==='acq') refreshSource();
    }
    start();
  </script>
</body>
</html>
