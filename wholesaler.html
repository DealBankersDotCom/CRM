<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DealBankers • Wholesaler</title>
  <link rel="icon" type="image/jpeg" href="icon (1).jpg"/>
  <meta name="robots" content="noindex"/>

  <!-- Firebase compat SDKs (match versions used across repo) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- Your firebaseConfig (same file as other pages) -->
  <script src="config.js?v=2025-08-25"></script>

  <style>
    :root{
      --bg:#0d1620; --panel:#0f1a24; --line:#1b3245;
      --text:#eaf1f6; --muted:#9fb3c7; --green:#26cf84;
      --r:16px; --shadow:0 24px 64px rgba(0,0,0,.5);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 90% -10%, #123043 0%, transparent 60%),
        linear-gradient(135deg,#0b1118,#0e1a24 55%,#10283a);
      min-height:100vh; padding:12px;
    }
    .shell{max-width:1100px;margin:0 auto; background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03)); border:1px solid var(--line); border-radius:20px; box-shadow:var(--shadow)}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:32px;height:32px;border-radius:8px;object-fit:cover}
    .brand h1{margin:0;font-size:14px;letter-spacing:.18em;color:#cfe0f2}

    .wrap{padding:12px; display:grid; grid-template-columns:1.2fr .8fr; gap:12px}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }

    .card{background:#10222e;border:1px solid var(--line);border-radius:var(--r);padding:12px}
    .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:flex-start;margin:8px 0}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
    .input,.textarea,select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0c1620; color:#eaf1f6}
    .textarea{min-height:120px; resize:vertical}
    .muted{color:var(--muted); font-size:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f1a24;color:#cfe2f3;cursor:pointer}
    .btn.green{background:linear-gradient(180deg,#26cf84,#1a9b61); color:#fff; border:none; font-weight:800}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:#9fb3c7}
    .preview{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .preview img{width:100%;height:90px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#0b141b}

    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0b1218;color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:9999;display:none}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <img src="icon (1).jpg" alt="DealBankers"/>
        <h1>DEALBANKERS • WHOLESALER</h1>
      </div>
      <div class="small" id="who">Loading…</div>
    </header>

    <div class="wrap">
      <!-- Deal editor -->
      <div class="card">
        <h3 style="margin:0 0 8px">＋ New Deal / Offering</h3>
        <div class="row">
          <div class="muted">Title</div>
          <div><input id="dealTitle" class="input" placeholder="e.g., 3/2 in Alamo Heights • Off-market"/></div>
        </div>
        <div class="row">
          <div class="muted">Address</div>
          <div><input id="dealAddress" class="input" placeholder="123 Main St, City ST"/></div>
        </div>
        <div class="row">
          <div class="muted">Price</div>
          <div><input id="dealPrice" class="input" placeholder="$275,000"/></div>
        </div>
        <div class="row">
          <div class="muted">Kind</div>
          <div>
            <select id="dealKind" class="input">
              <option value="deal">deal</option>
              <option value="wholesale">wholesale</option>
              <option value="seller-finance">seller-finance</option>
              <option value="rental">rental</option>
              <option value="land">land</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="muted">Memo URL</div>
          <div><input id="dealMemoUrl" class="input" placeholder="Google Doc / drive link (optional)"/></div>
        </div>
        <div class="row">
          <div class="muted">Photo URLs</div>
          <div>
            <textarea id="dealPhotos" class="textarea" placeholder="Comma-separated image URLs"></textarea>
            <div class="small">Tip: paste up to 6 for the public preview.</div>
          </div>
        </div>
        <div class="row">
          <div class="muted">Share Live</div>
          <div class="inline">
            <label class="inline" style="gap:6px">
              <input id="shareLive" type="checkbox"/> <span>List on the public Live Deals feed</span>
            </label>
            <span id="shareStatus" class="small"></span>
          </div>
        </div>
        <div class="inline" style="justify-content:flex-end;margin-top:8px">
          <button id="saveDeal" class="btn green">Save Deal</button>
        </div>
      </div>

      <!-- Preview -->
      <div class="card">
        <h3 style="margin:0 0 8px">Preview</h3>
        <div class="small" id="prevMeta">Nothing yet.</div>
        <div class="preview" id="prevGrid"></div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ---------- Firebase init ----------
    (function initFirebase(){
      try{
        if(!window.firebaseConfig){ throw new Error('Missing window.firebaseConfig — check config.js'); }
        if(!firebase?.apps?.length){ firebase.initializeApp(window.firebaseConfig); }
        window.auth = firebase.auth();
        window.db   = firebase.database();
        window.store= firebase.storage();
      }catch(e){
        console.error(e);
        const t=document.getElementById('toast'); t.textContent='Firebase init error: ' + (e?.message||e); t.style.display='block';
      }
    })();

    // ---------- helpers ----------
    const qs = new URL(location.href).searchParams;
    function toast(t){ const el=document.getElementById('toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',1500); }
    function getVal(id){ const el=document.getElementById(id); return el ? el.value.trim() : ''; }
    function getChecked(id){ const el=document.getElementById(id); return !!(el && el.checked); }
    function parsePhotos(){ const raw=getVal('dealPhotos'); if(!raw) return []; return raw.split(',').map(s=>s.trim()).filter(Boolean); }
    function newDealId(){ return db.ref('_ids').push().key; }

    function updatePreview(){
      const meta = document.getElementById('prevMeta');
      const grid = document.getElementById('prevGrid');
      const photos = parsePhotos();
      const title = getVal('dealTitle') || 'Untitled';
      const price = getVal('dealPrice') || '';
      const address = getVal('dealAddress') || '';
      meta.textContent = `${title}${price?(' • '+price):''}${address?(' • '+address):''}`;
      grid.innerHTML = photos.slice(0,6).map(u=>`<img loading="lazy" src="${u}" alt="photo">`).join('');
    }

    ['dealTitle','dealPrice','dealAddress','dealPhotos'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('input', updatePreview);
    });

    // ---------- Build + save ----------
    function buildDeal(uid, dealId){
      const now = Date.now();
      const title = getVal('dealTitle');
      const address = getVal('dealAddress');
      const price = getVal('dealPrice');
      const kind = getVal('dealKind') || 'deal';
      const memoUrl = getVal('dealMemoUrl');
      const photos = parsePhotos();
      const shareLive = getChecked('shareLive');

      // Private record (source of truth)
      const privateDeal = {
        ownerUid: uid,
        dealId,
        title,
        address,
        price,
        kind,
        memoUrl,
        photos,
        shareLive,
        updatedAt: now
      };

      // Public mirror (lighter)
      const publicDeal = {
        ownerUid: uid,
        dealId,
        title,
        address,
        price,
        kind,
        photos: photos.slice(0,6),
        updatedAt: now
      };

      return { privateDeal, publicDeal, shareLive };
    }

    async function savePrivate(uid, dealId, obj){
      await db.ref(`dispo/${uid}/deals/${dealId}`).set(obj);
    }
    async function mirrorPublic(dealId, objOrNull){
      const ref = db.ref(`live/deals/${dealId}`);
      if(objOrNull) await ref.set(objOrNull); else await ref.remove();
    }

    async function handleSave(){
      const u = auth.currentUser;
      if(!u){ toast('Please sign in'); location.href='index.html'; return; }

      let dealId = document.getElementById('saveDeal')?.dataset?.dealId;
      if(!dealId) dealId = newDealId();

      const { privateDeal, publicDeal, shareLive } = buildDeal(u.uid, dealId);

      try{
        await savePrivate(u.uid, dealId, privateDeal);
        if(shareLive){ await mirrorPublic(dealId, publicDeal); }
        else { await mirrorPublic(dealId, null); }

        const btn = document.getElementById('saveDeal'); if(btn) btn.dataset.dealId = dealId;
        document.getElementById('shareStatus').textContent = shareLive ? 'Listed LIVE' : 'Not live';
        toast('Deal saved ' + (shareLive ? 'and shared LIVE ✔' : '✔'));
      }catch(e){
        console.error(e);
        toast('Save failed: ' + (e?.message || e));
      }
    }

    async function handleShareToggle(){
      const u = auth.currentUser;
      if(!u){ toast('Please sign in'); location.href='index.html'; return; }

      const btn = document.getElementById('saveDeal');
      const dealId = btn?.dataset?.dealId;
      if(!dealId){ toast('Save the deal first'); return; }

      const snap = await db.ref(`dispo/${u.uid}/deals/${dealId}`).get();
      const cur = snap.val();
      if(!cur){ toast('Deal not found'); return; }

      const on = getChecked('shareLive');
      const now = Date.now();
      await db.ref(`dispo/${u.uid}/deals/${dealId}/shareLive`).set(on);
      await db.ref(`dispo/${u.uid}/deals/${dealId}/updatedAt`).set(now);

      if(on){
        const publicDeal = {
          ownerUid: u.uid,
          dealId,
          title: cur.title || 'Untitled',
          address: cur.address || '',
          price: cur.price || '',
          kind: cur.kind || 'deal',
          photos: Array.isArray(cur.photos) ? cur.photos.slice(0,6) : [],
          updatedAt: now
        };
        await mirrorPublic(dealId, publicDeal);
        document.getElementById('shareStatus').textContent = 'Listed LIVE';
        toast('Shared LIVE ✔');
      }else{
        await mirrorPublic(dealId, null);
        document.getElementById('shareStatus').textContent = 'Not live';
        toast('Removed from LIVE ✔');
      }
    }

    function wire(){
      const saveBtn = document.getElementById('saveDeal');
      if(saveBtn && !saveBtn.dataset.wired){
        saveBtn.dataset.wired='1';
        saveBtn.addEventListener('click', handleSave);
      }
      const share = document.getElementById('shareLive');
      if(share && !share.dataset.wired){
        share.dataset.wired='1';
        share.addEventListener('change', handleShareToggle);
      }
    }

    // ---------- Auth + whoami ----------
    auth.onAuthStateChanged(u=>{
      const who=document.getElementById('who');
      if(!u){
        who.textContent = 'Not signed in';
        return;
      }
      const label = (u.displayName || u.email || 'User') + ' • UID: ' + u.uid;
      who.textContent = label;
      wire();
    });

    // Pre-fill name/uid if parent passed them (optional)
    (function showFromQuery(){
      const qName = qs.get('name'); const qUid = qs.get('uid');
      if(qName || qUid){
        const who=document.getElementById('who');
        who.textContent = decodeURIComponent(qName||'User') + (qUid ? (' • UID: ' + decodeURIComponent(qUid)) : '');
      }
    })();
  </script>
</body>
</html>
